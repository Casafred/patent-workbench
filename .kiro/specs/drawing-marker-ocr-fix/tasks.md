# 实施计划：专利附图标记识别修复

## 概述

本实施计划将修复专利附图标记识别功能（功能八）的OCR识别失败问题。主要工作包括：修正后端变量引用错误、优化OCR识别流程、修复前端数据显示、实现Canvas标注功能、增强错误处理和日志记录。

实施将采用增量方式，每个任务都建立在前一个任务的基础上，确保功能逐步完善并通过测试验证。

## 任务

- [x] 1. 修复后端OCR识别逻辑核心错误
  - 修正`backend/routes/drawing_marker.py`中的变量引用错误
  - 将第155行之后使用未定义的`ocr_result`变量改为使用`all_detected_numbers`
  - 确保所有预处理方法的OCR结果正确收集到`all_detected_numbers`列表
  - 移除重复的OCR调用代码
  - _需求: 1.1, 1.2, 1.5_

- [ ]* 1.1 编写单元测试验证变量使用正确性
  - 测试OCR结果正确存储在`all_detected_numbers`中
  - 测试不会引用未定义的变量
  - _需求: 1.1, 1.2_

- [x] 2. 实现结果去重和过滤功能
  - [x] 2.1 实现`deduplicate_results`函数
    - 创建`backend/utils/ocr_utils.py`文件
    - 实现基于位置和置信度的去重逻辑
    - 位置阈值设为20像素
    - 保留置信度最高的结果
    - _需求: 1.3_
  
  - [ ]* 2.2 编写属性测试验证去重逻辑
    - **属性 1：去重保留最高置信度**
    - **验证：需求 1.3**
  
  - [x] 2.3 实现置信度过滤
    - 在`drawing_marker.py`中添加置信度过滤逻辑
    - 过滤掉置信度低于60的结果
    - _需求: 2.3_
  
  - [ ]* 2.4 编写属性测试验证置信度过滤
    - **属性 3：置信度过滤**
    - **验证：需求 2.3**

- [x] 3. 优化图像预处理和OCR配置
  - [x] 3.1 实现图像尺寸自适应调整
    - 在`ocr_utils.py`中添加`resize_image_for_ocr`函数
    - 将图像调整到800-2000像素范围
    - 保持宽高比
    - _需求: 2.5_
  
  - [ ]* 3.2 编写属性测试验证尺寸调整
    - **属性 5：图像尺寸自适应**
    - **验证：需求 2.5**
  
  - [x] 3.3 优化Tesseract OCR配置
    - 更新OCR配置字符串以提高识别率
    - 添加对字母后缀的支持（如"3L"）
    - 测试不同PSM模式的效果
    - _需求: 2.2, 2.4_
  
  - [ ]* 3.4 编写属性测试验证字母后缀识别
    - **属性 4：字母后缀标记识别**
    - **验证：需求 2.4**

- [x] 4. 增强错误处理和日志记录
  - [x] 4.1 添加异常容错机制
    - 在每个预处理方法的OCR调用中添加try-except
    - 记录详细错误日志但继续处理
    - 确保至少返回部分成功的结果
    - _需求: 1.4_
  
  - [ ]* 4.2 编写属性测试验证异常容错
    - **属性 2：异常容错性**
    - **验证：需求 1.4, 1.5**
  
  - [x] 4.3 添加详细日志记录
    - 记录处理开始时的图片信息
    - 记录每种预处理方法的识别统计
    - 记录说明书解析结果
    - 使用适当的日志级别（DEBUG/INFO/WARNING/ERROR）
    - _需求: 5.1, 5.2, 5.3, 5.4_

- [ ] 5. 检查点 - 确保后端修复完成
  - 运行所有后端单元测试和属性测试
  - 验证OCR识别能够返回真实结果
  - 检查日志输出是否完整
  - 如有问题请询问用户

- [ ] 6. 优化说明书文本解析
  - [ ] 6.1 重构`extract_reference_markers`函数
    - 改进正则表达式模式以支持更多格式
    - 确保支持"数字+分隔符+名称"格式
    - 确保支持"数字+中文"格式（无分隔符）
    - 确保支持"数字+字母+中文"格式
    - 确保支持"数字+空格+中文"格式
    - 实现去重逻辑避免重复提取
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_
  
  - [ ]* 6.2 编写属性测试验证文本解析
    - **属性 9：说明书文本解析通用性**
    - **验证：需求 6.1, 6.2, 6.3, 6.4, 6.5**
  
  - [ ]* 6.3 编写单元测试验证各种格式
    - 测试标准格式："1. 底座"
    - 测试无分隔符格式："1电动工具"
    - 测试字母后缀格式："2L左侧外壳"
    - 测试混合格式
    - _需求: 6.1, 6.2, 6.3, 6.4_

- [x] 7. 实现识别结果验证和统计
  - [x] 7.1 添加统计信息计算
    - 计算total_numbers（识别总数）
    - 计算match_rate（匹配率）
    - 计算matched_count（匹配数量）
    - 识别unknown_markers（未知标记）
    - 识别missing_markers（缺失标记）
    - _需求: 7.1, 7.3, 7.4_
  
  - [ ]* 7.2 编写属性测试验证统计完整性
    - **属性 10：统计信息完整性**
    - **验证：需求 7.1**
  
  - [ ]* 7.3 编写属性测试验证未知标记识别
    - **属性 12：未知标记识别**
    - **验证：需求 7.3**
  
  - [ ]* 7.4 编写属性测试验证缺失标记检测
    - **属性 13：缺失标记检测**
    - **验证：需求 7.4**
  
  - [x] 7.5 实现改进建议生成
    - 当match_rate < 50%时添加建议
    - 当平均置信度 < 70时添加建议
    - 列出缺失的标记编号
    - _需求: 7.2, 7.5_
  
  - [ ]* 7.6 编写属性测试验证建议生成
    - **属性 11：低匹配率建议**
    - **属性 14：低置信度建议**
    - **验证：需求 7.2, 7.5**

- [ ] 8. 检查点 - 确保后端功能完整
  - 运行所有后端测试
  - 使用真实专利附图测试API
  - 验证返回的统计信息准确
  - 验证建议生成正确
  - 如有问题请询问用户

- [x] 9. 修复前端数据显示
  - [x] 9.1 移除硬编码的模拟数据
    - 在`frontend/index.html`的`displayProcessingResult`函数中
    - 移除硬编码的"23个数字序号，95%匹配率"
    - 使用`data.total_numbers`和`data.match_rate`
    - 使用`data.message`显示处理消息
    - _需求: 3.1, 3.2, 3.3_
  
  - [ ]* 9.2 编写单元测试验证数据绑定
    - 测试前端正确读取API返回的字段
    - 测试空结果的显示
    - _需求: 3.1, 3.2, 3.3, 3.5_
  
  - [x] 9.3 添加空结果提示
    - 当total_numbers为0时显示明确提示
    - 提示用户检查图片质量或说明书格式
    - _需求: 3.5_

- [ ] 10. 实现Canvas标注功能
  - [ ] 10.1 创建Canvas标注函数
    - 在`frontend/index.html`中创建`annotateDrawing`函数
    - 接收Canvas元素、图片URL、识别结果和缩放因子
    - 在Canvas上绘制原始图片
    - _需求: 4.1_
  
  - [ ] 10.2 实现标记点绘制
    - 计算坐标缩放比例
    - 为每个识别结果绘制红色圆圈（半径10px）
    - 添加白色边框（2px）提高可见度
    - 在圆圈旁显示数字和部件名称
    - _需求: 4.1, 4.2, 4.3, 4.5_
  
  - [ ]* 10.3 编写属性测试验证Canvas标注
    - **属性 7：Canvas标注完整性**
    - **属性 8：Canvas标注内容完整性**
    - **验证：需求 3.4, 4.1, 4.3, 4.5**
  
  - [ ] 10.4 添加悬停交互
    - 监听Canvas的鼠标移动事件
    - 检测鼠标是否在标记点上
    - 显示详细信息（数字、名称、置信度）
    - _需求: 4.4_
  
  - [ ] 10.5 更新`displayProcessingResult`函数
    - 移除硬编码的标注点HTML
    - 为每张图片创建Canvas元素
    - 调用`annotateDrawing`函数绘制标注
    - 使用真实的`data.drawings[].detected_numbers`数据
    - _需求: 3.4_

- [ ] 11. 检查点 - 确保前端功能完整
  - 在浏览器中测试完整流程
  - 验证Canvas标注正确显示
  - 验证悬停交互正常工作
  - 验证统计信息显示准确
  - 如有问题请询问用户

- [ ] 12. 集成测试和端到端验证
  - [ ]* 12.1 编写端到端测试
    - 测试完整流程：上传 → 处理 → 显示
    - 测试多图片处理
    - 测试复杂说明书
    - 测试低质量图片
    - 测试错误恢复
    - _需求: 所有需求_
  
  - [ ] 12.2 准备测试数据集
    - 收集不同质量的专利附图
    - 准备不同格式的说明书文本
    - 创建测试用例文档
  
  - [ ] 12.3 性能测试
    - 测试处理大图片的性能
    - 测试同时处理多张图片的性能
    - 优化性能瓶颈

- [ ] 13. 文档和部署准备
  - [ ] 13.1 更新API文档
    - 更新响应格式说明
    - 添加新字段的说明（unknown_markers、missing_markers、suggestions）
    - 添加错误码说明
  
  - [ ] 13.2 创建用户指南
    - 说明如何获得最佳识别效果
    - 说明支持的说明书格式
    - 提供故障排除建议
  
  - [ ] 13.3 创建部署清单
    - 列出需要更新的文件
    - 列出需要安装的依赖（确保Tesseract已安装）
    - 提供部署步骤

- [ ] 14. 最终检查点 - 确保所有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行集成测试
  - 在真实环境中测试
  - 确认所有功能正常工作
  - 如有问题请询问用户

## 注意事项

- 标记为`*`的任务是可选的测试任务，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边缘情况
