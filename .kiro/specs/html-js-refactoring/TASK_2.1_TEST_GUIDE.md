# 任务2.1测试指南 - API模块提取

## 📋 完成的工作

### 1. 创建了新文件
- ✅ **`js/core/api.js`** (200行)
  - 从 `js/main.js` 中提取了API相关代码
  - 包含 `initApiKeyConfig()` 函数 - 管理API Key配置
  - 包含 `apiCall()` 函数 - 统一的API调用接口

### 2. 修改了现有文件
- ✅ **`js/main.js`**
  - 删除了原有的 `initApiKeyConfig()` 和 `apiCall()` 函数
  - 添加了注释说明这些函数现在在 `api.js` 中

- ✅ **`frontend/index.html`**
  - 在脚本加载顺序中添加了 `<script src="../js/core/api.js?v=20260206"></script>`
  - 确保在 `main.js` 之前加载

## 🎯 重构目标

将API相关代码从 `main.js` 中分离出来，形成独立的模块，提高代码的：
- **可维护性** - API逻辑集中在一个文件中
- **可复用性** - 其他模块可以直接使用API函数
- **可测试性** - 独立模块更容易测试

## ✅ 测试步骤

### 第1步：检查文件是否正确创建

```bash
# 检查新文件是否存在
ls js/core/api.js
```

**预期结果：** 文件存在，大约200行代码

### 第2步：启动应用程序

```bash
# 启动后端服务器（如果还没启动）
python app.py
# 或
python run_app.py
```

### 第3步：在浏览器中打开应用

1. 打开浏览器，访问 `http://localhost:5000` 或你的应用地址
2. 打开浏览器开发者工具（F12）
3. 切换到 **Console（控制台）** 标签

### 第4步：检查是否有加载错误

**在控制台中查找：**

✅ **正常情况：**
```
[API] API Key配置初始化完成
开始初始化所有模块
```

❌ **错误情况：**
```
Uncaught ReferenceError: initApiKeyConfig is not defined
Uncaught ReferenceError: apiCall is not defined
404 (Not Found) - js/core/api.js
```

### 第5步：测试API Key配置功能

1. **点击右上角的 ⚙️ 图标**
   - 应该弹出API Key配置面板
   
2. **输入测试API Key**
   - 在输入框中输入任意文本
   - 点击"保存"按钮
   - 应该看到"已保存!"提示

3. **测试可见性切换**
   - 点击眼睛图标
   - API Key应该在明文和密码之间切换

4. **测试复制功能**
   - 点击复制按钮
   - 应该看到复制成功的提示

5. **测试删除功能**
   - 点击删除按钮
   - 输入框应该被清空

### 第6步：测试API调用功能

**测试任何需要API调用的功能，例如：**

1. **功能一：即时对话**
   - 输入一条消息
   - 点击发送
   - 如果没有配置API Key，应该看到提示："API Key 未配置。请点击右上角 ⚙️ 设置并保存您的 API Key。"
   - 如果配置了API Key，应该正常发送请求

2. **功能六：批量专利解读**
   - 输入专利号
   - 点击查询
   - 应该正常调用API

3. **功能七：权利要求处理**
   - 上传文件
   - 应该正常处理

## 🔍 详细检查清单

### 控制台检查
- [ ] 没有 `404` 错误（api.js加载成功）
- [ ] 没有 `ReferenceError` 错误（函数定义正确）
- [ ] 看到 `[API] API Key配置初始化完成` 日志
- [ ] 看到 `开始初始化所有模块` 日志

### 功能检查
- [ ] API Key配置面板可以打开/关闭
- [ ] API Key可以保存到localStorage
- [ ] API Key可见性可以切换
- [ ] API Key可以复制
- [ ] API Key可以删除
- [ ] 点击配置面板外部可以关闭面板

### API调用检查
- [ ] 未配置API Key时，调用API会显示提示
- [ ] 配置API Key后，可以正常调用API
- [ ] FormData请求正常工作（文件上传）
- [ ] JSON请求正常工作（普通API调用）
- [ ] 流式响应正常工作（聊天功能）

## 🐛 常见问题排查

### 问题1：控制台显示 `404 - api.js`

**原因：** 文件路径不正确或文件未创建

**解决方案：**
```bash
# 检查文件是否存在
ls js/core/api.js

# 检查index.html中的路径
grep "api.js" frontend/index.html
```

### 问题2：`initApiKeyConfig is not defined`

**原因：** api.js未在main.js之前加载

**解决方案：**
- 检查 `frontend/index.html` 中的脚本加载顺序
- 确保 `api.js` 在 `main.js` 之前加载

### 问题3：API调用失败

**原因：** `apiCall` 函数未正确导出或加载

**解决方案：**
- 在浏览器控制台中测试：
```javascript
console.log(typeof apiCall); // 应该输出 "function"
console.log(typeof initApiKeyConfig); // 应该输出 "function"
```

### 问题4：功能正常但看不到日志

**原因：** 这是正常的，说明重构成功

**确认方法：**
- 所有功能都正常工作
- 没有控制台错误
- API调用正常

## 📊 测试结果记录

### 基础测试
- [ ] ✅ 文件加载成功
- [ ] ✅ 无控制台错误
- [ ] ✅ API Key配置功能正常
- [ ] ✅ API调用功能正常

### 功能测试
- [ ] ✅ 功能一（即时对话）正常
- [ ] ✅ 功能二（小批量异步）正常
- [ ] ✅ 功能三（大批量处理）正常
- [ ] ✅ 功能四（本地专利库）正常
- [ ] ✅ 功能五（权利要求对比）正常
- [ ] ✅ 功能六（批量专利解读）正常
- [ ] ✅ 功能七（权利要求处理）正常
- [ ] ✅ 功能八（专利附图标记）正常

## 🎉 测试通过标准

**所有以下条件都满足，说明重构成功：**

1. ✅ 应用正常启动，无控制台错误
2. ✅ API Key配置功能完全正常
3. ✅ 所有8个功能标签页都能正常使用
4. ✅ API调用（包括FormData、JSON、Stream）都正常工作
5. ✅ 用户体验与重构前完全一致

## 📝 注意事项

1. **零破坏性更改** - 这次重构不应该改变任何用户可见的行为
2. **向后兼容** - 所有现有功能都应该继续工作
3. **性能无影响** - 加载速度和运行速度应该与之前相同

## 🔄 下一步

如果测试全部通过，可以继续进行：
- **任务2.3** - 提取标签导航模块
- **任务3** - 开始HTML组件化

如果测试失败，请记录错误信息并报告问题。
