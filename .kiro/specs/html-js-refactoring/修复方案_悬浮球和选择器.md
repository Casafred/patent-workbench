# 修复方案：悬浮球拖动和选择器失效问题

## 问题分析

### 1. 悬浮球拖动交互问题
用户反馈当前拖动感觉"太怪了"，需要参考拆分前的代码。

**当前实现问题**：
- 拖动阈值设置为5px，可能太敏感
- 使用`transition: none`禁用过渡，但恢复时机可能不对
- 边界检测可能过于严格
- 没有拖动时的视觉反馈（除了cursor）

**原始版本**：
- 检查备份文件发现，原始版本**没有拖动功能**
- 这是新增的功能，所以用户可能是指"拖动体验不好"

### 2. 模型选择器失效
各功能的模型选择器总是失效，无法正确显示模型列表。

**根本原因**：
- `loadModelsConfig()` 是异步函数，从`config/models.json`加载
- `updateAllModelSelectors()` 在模型加载完成前就被调用
- DOM元素可能还未渲染完成

**影响范围**：
- 功能一：即时对话 (`chat_model_select`)
- 功能二：小批量异步 (`async_template_model_select`)
- 功能三：大批量处理 (`api-model`)
- 功能五：权利要求对比 (`comparison_model_select`)
- 功能六：批量专利解读 (`patent_batch_model_selector`)

### 3. 预置模板选择器失效
各功能的预置提示词模板选择器无法正常工作。

**根本原因**：
- 模板数据在`appState`中定义，但选择器初始化时机不对
- 组件加载是异步的，但模板选择器初始化是同步的
- 没有等待DOM元素准备好

**影响范围**：
- 功能二：小批量异步 (`async_preset_template_select`)
- 功能三：大批量处理 (`large_batch_template_selector`)
- 功能六：批量专利解读 (`patent_template_selector`)

## 修复方案

### 方案1：优化悬浮球拖动体验

**改进点**：
1. 增加拖动阈值到10px，减少误触
2. 添加拖动时的视觉反馈（阴影、缩放）
3. 优化边界检测，留出一定边距
4. 改进过渡效果的恢复时机
5. 添加拖动开始/结束的动画效果

### 方案2：修复模型选择器

**核心思路**：确保模型加载完成后再更新选择器

**实现步骤**：
1. 在`state.js`中，`loadModelsConfig()`完成后触发自定义事件
2. 各功能模块监听该事件，然后更新自己的模型选择器
3. 添加重试机制，如果DOM元素未准备好，延迟重试

### 方案3：修复模板选择器

**核心思路**：在组件加载完成后初始化模板选择器

**实现步骤**：
1. 在各功能的初始化函数中，添加DOM就绪检查
2. 使用`MutationObserver`监听DOM变化
3. 确保模板数据加载完成后再填充选择器

## 实施计划

### 第一步：修复悬浮球拖动（优先级：中）
- 文件：`js/main.js`
- 修改：`initDraggableHelpButton()`函数
- 测试：拖动流畅度、边界检测、位置保存

### 第二步：修复模型选择器（优先级：高）
- 文件：`js/state.js`, `js/main.js`, 各功能初始化文件
- 修改：添加事件机制，确保加载顺序
- 测试：所有功能的模型选择器是否正确显示

### 第三步：修复模板选择器（优先级：高）
- 文件：`js/asyncBatch.js`, `js/largeBatch.js`, `js/patentTemplate.js`
- 修改：添加DOM就绪检查，延迟初始化
- 测试：所有功能的模板选择器是否正确显示

## 测试清单

### 悬浮球拖动测试
- [ ] 拖动流畅，无卡顿
- [ ] 点击不会误触发拖动
- [ ] 边界检测正确，不会超出屏幕
- [ ] 位置保存和恢复正常
- [ ] 拖动后点击不会打开链接

### 模型选择器测试
- [ ] 功能一：即时对话 - 模型列表正确显示
- [ ] 功能二：小批量异步 - 模型列表正确显示
- [ ] 功能三：大批量处理 - 模型列表正确显示
- [ ] 功能五：权利要求对比 - 模型列表正确显示
- [ ] 功能六：批量专利解读 - 模型列表正确显示
- [ ] 刷新页面后模型列表仍然正确

### 模板选择器测试
- [ ] 功能二：小批量异步 - 预置模板正确显示
- [ ] 功能三：大批量处理 - 预置模板正确显示
- [ ] 功能六：批量专利解读 - 预置模板正确显示
- [ ] 选择模板后，字段正确填充
- [ ] 自定义模板保存和加载正常

## 下一步行动

1. 用户确认修复方案
2. 依次实施三个修复
3. 每个修复完成后进行测试
4. 全部完成后进行集成测试
