<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专利分析智能工作台 v3.9</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #28a745; /* 主色调 - 绿色 */
            --primary-hover-color: #218838; /* 悬停/激活色 */
            --primary-dark-color: #1e7e34; /* 标题/深色 */
            --secondary-color: #007bff; /* 用于自定义模板的颜色 */
            --secondary-hover-color: #0056b3;
            --background-color: #f4f8f5; /* 背景色 */
            --container-bg-color: #ffffff;
            --border-color: #dce5dd;
            --text-color: #333;
            --light-info-bg: #e9f5ec;
            --white-glow-color: rgba(255, 255, 255, 0.8);
            --code-bg-color: #2d2d2d;
            --code-text-color: #e6e6e6;
            --error-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; line-height: 1.6; color: var(--text-color); background-color: var(--background-color); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: var(--container-bg-color); padding: 0; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: hidden; }
        .app-banner { display: flex; flex-direction: column; align-items: center; padding: 15px 20px; background-color: var(--primary-dark-color); color: #fff; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .banner-text-logo { font-family: 'Orbitron', sans-serif; font-size: 2.8rem; font-weight: 900; margin: 0; padding: 0; letter-spacing: 4px; background: linear-gradient(145deg, #ffffff, #e0ffe8); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 6px var(--white-glow-color), 0 0 15px rgba(255, 255, 255, 0.5); }
        .copyright-info { margin-top: 8px; display: flex; flex-direction: column; align-items: center; font-size: 11px; font-weight: normal; color: rgba(255, 255, 255, 0.7); }
        .version-number { font-size: 10px; opacity: 0.8; margin-top: 2px; }
        .main-content { padding: 25px; }
        .tab-container { border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-button { background-color: transparent; border: 1px solid transparent; border-bottom: none; padding: 10px 20px; cursor: pointer; font-size: 1.1em; border-radius: 5px 5px 0 0; color: #495057; }
        .tab-button.active { background-color: var(--container-bg-color); border-color: var(--border-color); border-bottom: 1px solid var(--container-bg-color); margin-bottom: -1px; font-weight: bold; color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .step { margin-bottom: 25px; padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; background-color: #ffffff; }
        .step-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #495057; }
        input[type="file"] { border: 1px solid #ccc; display: inline-block; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; text-align: center; }
        button:hover { background-color: var(--primary-hover-color); }
        button:disabled { background-color: #a0c7af; cursor: not-allowed; }
        .action-button { min-width: 220px; display: inline-block; margin: 5px; }
        .small-button { padding: 5px 10px; font-size: 0.9em; margin-left: 10px; }
        .custom-template-button { background-color: var(--secondary-color); }
        .custom-template-button:hover { background-color: var(--secondary-hover-color); }
        .delete-button { background-color: var(--error-color); }
        .config-item { margin-bottom: 15px; display: flex; align-items: flex-start; }
        .config-item label { display: inline-block; width: 170px; font-weight: 500; flex-shrink: 0; padding-top: 8px; }
        .config-item .input-wrapper { width: 100%; }
        .config-item select, .config-item input, .config-item textarea { padding: 8px; border-radius: 4px; border: 1px solid #ced4da; width: 100%; box-sizing: border-box; }
        .preview-output { background-color: var(--code-bg-color); color: var(--code-text-color); padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-family: "Courier New", Courier, monospace; white-space: pre-wrap; word-break: break-all; }
        .preview-item { padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px dashed #4a4a4a; }
        .preview-item:last-child { border-bottom: none; margin-bottom: 0; }
        .info { font-size: 0.9em; color: var(--primary-dark-color); margin-top: 15px; background-color: var(--light-info-bg); padding: 10px; border-radius: 4px; border-left: 4px solid var(--primary-color); }
        .info.success { border-left-color: var(--success-color); background-color: #e9f5ec;}
        .info.warning { border-left-color: var(--warning-color); background-color: #fff8e1;}
        .reporter-uploads { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        details { border: 1px solid var(--border-color); border-radius: 5px; margin-top: 25px; background-color: #fafdfb; }
        summary { font-size: 1.2em; font-weight: bold; color: #495057; padding: 15px 20px; cursor: pointer; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: '▶ '; font-size: 0.8em; margin-right: 8px; transition: transform 0.2s; display: inline-block; }
        details[open] > summary::before { transform: rotate(90deg); }
        #batch_log { margin-top: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 4px; min-height: 100px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; font-family: monospace; }
        .log-entry { margin-bottom: 8px; }
        .log-entry.error { color: var(--error-color); }
        .log-entry.success { color: var(--success-color); font-weight: bold; }
        .log-entry.auto-check { color: #007bff; font-style: italic; }
        hr { border: none; border-top: 1px solid var(--border-color); margin: 20px 0; }
        .template-actions { margin-top: 15px; }
        .auto-check-controls { margin-top: 15px; }
        .auto-check-controls button { background-color: var(--warning-color); color: #212529;}
        .auto-check-controls button:hover { background-color: #e0a800; }
    </style>
</head>
<body>

<div class="container">
    <header class="app-banner">
        <h1 class="banner-text-logo">ALFRED X IP</h1>
        <div class="copyright-info">
            <span>Copyright © 2025 Alfred Shi 保留所有权利.</span>
            <span class="version-number">版本号: v3.9 (健壮版)</span>
        </div>
    </header>

    <div class="main-content">
        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('generator')">功能一：生成请求文件</button>
            <button class="tab-button" onclick="switchTab('batch')">功能二：批量请求与结果获取</button>
            <button class="tab-button" onclick="switchTab('reporter')">功能三：解析结果生成报告</button>
        </div>

        <!-- 功能一：生成请求文件 -->
        <div id="generator-tab" class="tab-content active">
            <div class="step">
                <div class="step-header">步骤 1: 上传包含专利数据的 Excel 文件</div>
                <input type="file" id="gen_file-input" accept=".xlsx, .xls">
                <select id="gen_sheet-selector" style="display:none; margin-left: 10px;"></select>
                <div class="info">请确保Excel文件中包含名为 '摘要' 和 '权利要求' 的列。</div>
            </div>
            
            <div class="step">
                <div class="step-header">步骤 2: 配置 API 请求参数</div>
                <div class="config-item"><label for="api-model">模型 (model):</label><div class="input-wrapper"><input type="text" id="api-model" value="glm-4"></div></div>
                <div class="config-item"><label for="api-temperature">温度 (temperature):</label><div class="input-wrapper"><input type="number" id="api-temperature" value="0.7" step="0.1" min="0" max="1"></div></div>
                <div class="config-item">
                    <label for="api-system-prompt">系统提示 (system prompt):</label>
                    <div class="input-wrapper"><textarea id="api-system-prompt" rows="3">你是一个精通全球专利业务的AI助手，擅长阅读、理解和分析专利文件。你的任务是根据用户提供的专利“摘要”和“权利要求”内容，精准地识别出该专利的核心技术主题，并以简洁的短语形式返回。你必须严格遵循输出格式要求。</textarea></div>
                </div>
                <div class="config-item">
                    <label for="api-user-prompt">用户提示 (user prompt):</label>
                    <div class="input-wrapper">
                        <textarea id="api-user-prompt" rows="8">这是专利的详细信息：
摘要：
{摘要}

权利要求：
{权利要求}

请基于以上信息，分析并总结出该专利的核心技术主题。
要求：
1. 结果必须是3-5个字的中文短语。
2. 仅输出这个短语，不要包含任何其他解释、前缀或标点符号。</textarea>
                        <div class="template-actions">
                            <button id="save_template_btn" class="small-button custom-template-button">保存为自定义模板</button>
                            <select id="template_selector" style="margin-left: 10px;"></select>
                            <button id="delete_template_btn" class="small-button delete-button">删除选中模板</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-header">步骤 3: 生成并预览 JSONL 请求文件</div>
                <button id="gen_generate-btn" disabled>生成 JSONL 文件</button>
                <div class="preview-output" id="gen_preview_output" style="display:none; margin-top: 15px;"></div>
                <button id="gen_download-btn" style="display:none; margin-top: 15px;">下载 JSONL 文件</button>
                <div class="info" id="gen_ready_info" style="display:none; margin-top: 15px;">文件已在内存中准备就绪，请切换到【功能二】进行上传。</div>
            </div>
        </div>
        
        <!-- 功能二：批量请求 -->
        <div id="batch-tab" class="tab-content">
            <div class="step">
                <div class="step-header">准备工作：输入您的API Key</div>
                <div class="config-item"><label for="batch_api_key_input">API Key:</label><div class="input-wrapper"><input type="password" id="batch_api_key_input" placeholder="请在此处粘贴您的智谱AI API Key"></div></div>
            </div>
            <div class="step">
                <div class="step-header">批量任务工作流</div>
                <p>请按照1-4的顺序执行。点击步骤2后将启动自动状态检查。</p>
                <button id="batch_step1_upload" class="action-button">1. 上传请求文件</button>
                <button id="batch_step2_create" class="action-button" disabled>2. 创建Batch任务</button>
                <button id="batch_step3_check" class="action-button" disabled>3. 手动检查状态</button>
                <button id="batch_step4_download" class="action-button" disabled>4. 获取结果内容</button>

                <div class="auto-check-controls" id="auto-check-container" style="display:none;">
                    <span id="auto_check_status" style="margin-right: 15px; color: #007bff; font-weight: bold;"></span>
                    <button id="batch_stop_check_btn" class="small-button">停止自动检查</button>
                </div>
            </div>
            
            <details>
                <summary>断点续查 / 结果恢复</summary>
                <div class="step" style="border-top: none; margin-top: 0;">
                    <p class="info warning">如果您因关闭浏览器等原因中断了流程，但已记录下 Output File ID，可在此直接加载结果。</p>
                    <div class="config-item">
                        <label for="direct_output_id_input">Output File ID:</label>
                        <div class="input-wrapper"><input type="text" id="direct_output_id_input" placeholder="粘贴已完成任务的 Output File ID"></div>
                    </div>
                    <button id="direct_download_btn" class="action-button custom-template-button">直接加载结果</button>
                </div>
            </details>

            <div class="step">
                <div class="step-header">执行日志与结果</div>
                <div id="batch_log">等待操作...</div>
            </div>
        </div>

        <!-- 功能三：生成报告 -->
        <div id="reporter-tab" class="tab-content">
            <div class="step">
                <div class="step-header">步骤 1: 准备数据源</div>
                <div class="reporter-uploads">
                    <div>
                        <p><strong>A. 上传原始 Excel 文件</strong></p>
                        <input type="file" id="rep_excel-input" accept=".xlsx, .xls">
                        <div class="info">请上传您在【功能一】中使用的同一个Excel文件，用于数据匹配。</div>
                    </div>
                    <div>
                        <p><strong>B. 加载 Batch 任务结果文件</strong></p>
                        <input type="file" id="rep_jsonl-input" accept=".jsonl">
                        <div class="info success" id="reporter-info-box" style="display:none;">
                            检测到来自【功能二】的结果文件已在内存中，将优先使用此数据。
                        </div>
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-header">步骤 2: 解析并生成最终报告</div>
                <button id="rep_generate-report-btn" disabled>解析并生成最终报告</button>
                <div class="preview-output" id="rep_output_preview" style="display:none; margin-top: 15px;"></div>
                <button id="rep_download-report-btn" style="display:none; margin-top: 15px;">下载最终报告 (Excel)</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- 全局配置 ---
// !!! 关键修改: 如果您将后端部署到云服务 (如 Render), 请在此处粘贴您后端的 URL
// 例如: const BACKEND_URL = 'https://your-backend-app-name.onrender.com';
const BACKEND_URL = 'https://patent-workbench-backend.onrender.com'; // 本地运行时留空即可

// --- 全局变量 ---
let gen_workbook = null, gen_currentSheetData = null, gen_jsonlContent = "";
let rep_workbook = null, rep_sheetData = null, rep_jsonlData = null;
let rep_finalOutputData = [], rep_outputHeaders = [];
let batch_fileId = null, batch_batchId = null, batch_outputFileId = null, batch_errorFileId = null;
let batch_result_jsonl_content = null;
let custom_templates = [];
let autoCheckTimer = null; // 用于自动检查的计时器

// --- DOM 元素获取 ---
const genFileInput = document.getElementById('gen_file-input');
const genSheetSelector = document.getElementById('gen_sheet-selector');
const genGenerateBtn = document.getElementById('gen_generate-btn');
const genPreviewOutput = document.getElementById('gen_preview_output');
const genDownloadBtn = document.getElementById('gen_download-btn');
const genReadyInfo = document.getElementById('gen_ready_info');
const apiModelInput = document.getElementById('api-model');
const apiTempInput = document.getElementById('api-temperature');
const apiSystemInput = document.getElementById('api-system-prompt');
const apiUserInput = document.getElementById('api-user-prompt');

const batch_log = document.getElementById('batch_log');
const btnUpload = document.getElementById('batch_step1_upload');
const btnCreate = document.getElementById('batch_step2_create');
const btnCheck = document.getElementById('batch_step3_check');
const btnDownload = document.getElementById('batch_step4_download');
const autoCheckContainer = document.getElementById('auto-check-container');
const autoCheckStatusEl = document.getElementById('auto_check_status');

const repExcelInput = document.getElementById('rep_excel-input');
const repJsonlInput = document.getElementById('rep_jsonl-input');
const repGenerateBtn = document.getElementById('rep_generate-report-btn');
const repPreview = document.getElementById('rep_output_preview');
const repDownloadBtn = document.getElementById('rep_download-report-btn');
const repInfoBox = document.getElementById('reporter-info-box');

// =================================================================================
// 初始化
// =================================================================================
document.addEventListener('DOMContentLoaded', () => {
    // 功能一
    genFileInput.addEventListener('change', handleFile);
    genSheetSelector.addEventListener('change', (e) => loadSheet(e.target.value));
    genGenerateBtn.addEventListener('click', generateJsonl);
    genDownloadBtn.addEventListener('click', downloadJsonl);
    document.getElementById('save_template_btn').addEventListener('click', saveTemplate);
    document.getElementById('template_selector').addEventListener('change', loadTemplate);
    document.getElementById('delete_template_btn').addEventListener('click', deleteTemplate);
    initTemplates();

    // 功能二
    btnUpload.addEventListener('click', runStep1_Upload);
    btnCreate.addEventListener('click', runStep2_Create);
    btnCheck.addEventListener('click', runStep3_Check);
    btnDownload.addEventListener('click', runStep4_Download);
    document.getElementById('batch_stop_check_btn').addEventListener('click', stopAutoCheck);
    document.getElementById('direct_download_btn').addEventListener('click', runDirectDownload);


    // 功能三
    repExcelInput.addEventListener('change', handleReporterExcel);
    repJsonlInput.addEventListener('change', handleReporterJsonl);
    repGenerateBtn.addEventListener('click', parseAndGenerateReport);
    repDownloadBtn.addEventListener('click', downloadFinalReport);
});

// =================================================================================
// 通用函数
// =================================================================================
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

    document.getElementById(`${tabName}-tab`).classList.add('active');
    document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');

    if (tabName === 'reporter') {
        if (batch_result_jsonl_content) {
            repInfoBox.style.display = 'block';
            rep_jsonlData = parseJsonl(batch_result_jsonl_content);
            checkReporterReady();
        } else {
            repInfoBox.style.display = 'none';
        }
    }
}

async function apiCall(endpoint, body) {
    const url = BACKEND_URL ? `${BACKEND_URL}${endpoint}` : `/api${endpoint.split('/api')[1]}`;
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || '未知错误');
        }
        return result.data;
    } catch (error) {
        const errorMessage = `请求失败: ${error.message}`;
        addLog(errorMessage, 'error');
        console.error(errorMessage, error);
        return null;
    }
}

function addLog(message, type = 'info') {
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${type}`;
    const timestamp = new Date().toLocaleTimeString();
    logEntry.textContent = `[${timestamp}] ${message}`;
    batch_log.appendChild(logEntry);
    batch_log.scrollTop = batch_log.scrollHeight;
}


// =================================================================================
// 功能一：生成请求文件
// =================================================================================
function handleFile(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        gen_workbook = XLSX.read(data, { type: 'array' });
        genSheetSelector.innerHTML = '';
        gen_workbook.SheetNames.forEach(name => {
            const option = document.createElement('option');
            option.value = option.textContent = name;
            genSheetSelector.appendChild(option);
        });
        genSheetSelector.style.display = 'inline-block';
        loadSheet(gen_workbook.SheetNames[0]);
    };
    reader.readAsArrayBuffer(file);
}

function loadSheet(sheetName) {
    const worksheet = gen_workbook.Sheets[sheetName];
    gen_currentSheetData = XLSX.utils.sheet_to_json(worksheet);
    genGenerateBtn.disabled = !gen_currentSheetData || gen_currentSheetData.length === 0;
}

function generateJsonl() {
    if (!gen_currentSheetData) return;
    const abstractCol = '摘要';
    const claimsCol = '权利要求';

    let missingCols = [];
    if (!gen_currentSheetData[0] || gen_currentSheetData[0][abstractCol] === undefined) missingCols.push(abstractCol);
    if (!gen_currentSheetData[0] || gen_currentSheetData[0][claimsCol] === undefined) missingCols.push(claimsCol);
    if (missingCols.length > 0) {
        alert(`错误：Excel中缺少必需的列: ${missingCols.join(', ')}`);
        return;
    }

    const requests = gen_currentSheetData.map((row, index) => {
        const userPrompt = apiUserInput.value
            .replace('{摘要}', row[abstractCol] || '')
            .replace('{权利要求}', row[claimsCol] || '');
        
        return {
            custom_id: `request-${index + 1}`,
            request_id: `request-${index + 1}`,
            body: {
                model: apiModelInput.value,
                messages: [
                    { role: 'system', content: apiSystemInput.value },
                    { role: 'user', content: userPrompt }
                ],
                temperature: parseFloat(apiTempInput.value)
            }
        };
    });

    gen_jsonlContent = requests.map(JSON.stringify).join('\n');
    genPreviewOutput.style.display = 'block';
    genPreviewOutput.innerHTML = '';
    requests.slice(0, 3).forEach(req => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'preview-item';
        itemDiv.textContent = JSON.stringify(req, null, 2);
        genPreviewOutput.appendChild(itemDiv);
    });
    genDownloadBtn.style.display = 'inline-block';
    genReadyInfo.style.display = 'block';
}

function downloadJsonl() {
    if (!gen_jsonlContent) return;
    const blob = new Blob([gen_jsonlContent], { type: 'application/jsonl' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'batch_requests.jsonl';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 模板管理
function initTemplates() {
    custom_templates = JSON.parse(localStorage.getItem('custom_templates') || '[]');
    updateTemplateSelector();
}

function saveTemplate() {
    const name = prompt("请输入模板名称:", `模板_${Date.now()}`);
    if (!name) return;
    const template = {
        name: name,
        system: apiSystemInput.value,
        user: apiUserInput.value
    };
    custom_templates.push(template);
    localStorage.setItem('custom_templates', JSON.stringify(custom_templates));
    updateTemplateSelector();
    alert("模板已保存！");
}

function loadTemplate() {
    const selector = document.getElementById('template_selector');
    const selectedName = selector.value;
    const template = custom_templates.find(t => t.name === selectedName);
    if (template) {
        apiSystemInput.value = template.system;
        apiUserInput.value = template.user;
    }
}

function deleteTemplate() {
    const selector = document.getElementById('template_selector');
    const selectedName = selector.value;
    if (!selectedName || !confirm(`确定要删除模板 "${selectedName}" 吗？`)) return;
    custom_templates = custom_templates.filter(t => t.name !== selectedName);
    localStorage.setItem('custom_templates', JSON.stringify(custom_templates));
    updateTemplateSelector();
    alert("模板已删除！");
}

function updateTemplateSelector() {
    const selector = document.getElementById('template_selector');
    selector.innerHTML = '<option value="">--选择自定义模板--</option>';
    custom_templates.forEach(t => {
        const option = document.createElement('option');
        option.value = t.name;
        option.textContent = t.name;
        selector.appendChild(option);
    });
}

// =================================================================================
// 功能二：批量请求
// =================================================================================
async function runStep1_Upload() {
    addLog('开始执行步骤1：上传请求文件...');
    if (!gen_jsonlContent) { addLog('错误：请先在【功能一】中生成请求文件内容。', 'error'); return; }
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey) { addLog('错误：请输入API Key。', 'error'); return; }
    
    btnUpload.disabled = true;
    const data = await apiCall('/api/upload', { 
        apiKey: apiKey,
        jsonlContent: gen_jsonlContent,
        fileName: `patent_requests_${Date.now()}.jsonl`
    });
    btnUpload.disabled = false;

    if (data) {
        batch_fileId = data.fileId;
        addLog(`成功: ${data.message}`, 'success');
        addLog(`获取到 File ID: ${batch_fileId}`);
        btnCreate.disabled = false;
        btnCheck.disabled = true;
        btnDownload.disabled = true;
        stopAutoCheck(); // 如果重新上传，停止旧的检查
    }
}

async function runStep2_Create() {
    addLog('开始执行步骤2：创建Batch任务...');
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey || !batch_fileId) { addLog('错误：API Key 或 File ID 缺失。', 'error'); return; }

    btnCreate.disabled = true;
    const data = await apiCall('/api/create_batch', { apiKey, fileId: batch_fileId });
    btnCreate.disabled = false;

    if (data) {
        batch_batchId = data.id;
        addLog(`成功: Batch任务创建成功！`, 'success');
        addLog(`获取到 Batch ID: ${batch_batchId}`);
        addLog(`任务初始状态: ${data.status}`);
        btnCheck.disabled = false;
        btnDownload.disabled = true;
        
        startAutoCheck();
    }
}

async function runStep3_Check() {
    addLog('正在检查任务状态...', 'auto-check');
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey || !batch_batchId) {
        addLog('错误：API Key 或 Batch ID 缺失，无法检查状态。', 'error');
        stopAutoCheck(); 
        return;
    }

    const data = await apiCall('/api/check_status', { apiKey, batchId: batch_batchId });

    if (data) {
        addLog(`任务状态: ${data.status}`, data.status === 'completed' ? 'success' : 'info');
        if (data.status === 'completed') {
            batch_outputFileId = data.output_file_id;
            batch_errorFileId = data.error_file_id;
            addLog(`任务完成! Output File ID: ${batch_outputFileId}`, 'success');
            if(batch_errorFileId) addLog(`错误文件 ID: ${batch_errorFileId}`);
            btnDownload.disabled = false;
            stopAutoCheck(); 
        } else if (['failed', 'expired', 'cancelled'].includes(data.status)) {
            addLog(`任务失败或已终止。状态: ${data.status}`, 'error');
            stopAutoCheck(); 
        }
    } else {
        addLog('检查状态时发生网络或服务器错误。', 'error');
    }
}

async function runStep4_Download() {
    addLog('开始执行步骤4：获取结果内容...');
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey || !batch_outputFileId) { addLog('错误：API Key 或 Output File ID 缺失。', 'error'); return; }
    
    btnDownload.disabled = true;
    const data = await apiCall('/api/download_result', { apiKey, fileId: batch_outputFileId });
    btnDownload.disabled = false;

    if (data && data.fileContent) {
        batch_result_jsonl_content = data.fileContent;
        addLog('成功: 已将结果文件内容加载到浏览器内存中！', 'success');
        addLog('请切换到【功能三】，您将看到直接解析的选项。');
        switchTab('reporter');
    } else {
        addLog('获取结果内容失败，请检查日志。', 'error');
    }
}

async function runDirectDownload() {
    addLog('开始执行直接加载...');
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    const directFileId = document.getElementById('direct_output_id_input').value.trim();

    if (!apiKey) { addLog('错误：请输入API Key。', 'error'); return; }
    if (!directFileId) { addLog('错误：请输入Output File ID。', 'error'); return; }
    
    const btn = document.getElementById('direct_download_btn');
    btn.disabled = true;
    const data = await apiCall('/api/download_result', { apiKey, fileId: directFileId });
    btn.disabled = false;

    if (data && data.fileContent) {
        batch_result_jsonl_content = data.fileContent;
        addLog(`成功: 已通过ID ${directFileId} 将结果文件加载到内存！`, 'success');
        addLog('请切换到【功能三】，您将看到直接解析的选项。');
        switchTab('reporter');
    } else {
        addLog('通过直接ID获取结果内容失败，请检查ID是否正确或查看日志。', 'error');
    }
}

function startAutoCheck() {
    stopAutoCheck(); 
    addLog('已启动自动状态检查（每分钟一次）。', 'info');
    autoCheckContainer.style.display = 'block';
    autoCheckStatusEl.textContent = '自动检查已激活...';
    runStep3_Check(); 
    autoCheckTimer = setInterval(runStep3_Check, 60000);
}

function stopAutoCheck() {
    if (autoCheckTimer) {
        clearInterval(autoCheckTimer);
        autoCheckTimer = null;
        autoCheckStatusEl.textContent = '自动检查已停止。';
        addLog('自动检查已停止。', 'info');
        setTimeout(() => { autoCheckContainer.style.display = 'none'; }, 3000);
    }
}


// =================================================================================
// 功能三：解析结果生成报告
// =================================================================================
function handleReporterExcel(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        rep_workbook = XLSX.read(data, { type: 'array' });
        // 假设使用第一个sheet
        const worksheet = rep_workbook.Sheets[rep_workbook.SheetNames[0]];
        rep_sheetData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
        checkReporterReady();
    };
    reader.readAsArrayBuffer(file);
}

function handleReporterJsonl(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
        const content = e.target.result;
        rep_jsonlData = parseJsonl(content);
        checkReporterReady();
    };
    reader.readAsText(file);
}

function parseJsonl(content) {
    return content.trim().split('\n').map(line => {
        try { return JSON.parse(line); } 
        catch (e) { console.error("Failed to parse line:", line); return null; }
    }).filter(item => item !== null);
}

function checkReporterReady() {
    repGenerateBtn.disabled = !(rep_sheetData && rep_jsonlData);
}

function parseAndGenerateReport() {
    if (!rep_sheetData || !rep_jsonlData) return;

    const resultMap = new Map();
    rep_jsonlData.forEach(item => {
        if(item.response && item.response.body && item.response.body.choices && item.response.body.choices[0]){
            const content = item.response.body.choices[0].message.content;
            resultMap.set(item.custom_id, content.trim());
        }
    });

    rep_finalOutputData = rep_sheetData.map((row, index) => {
        const requestId = `request-${index + 1}`;
        const newRow = { ...row };
        newRow['核心技术主题'] = resultMap.get(requestId) || '未找到结果';
        return newRow;
    });

    if (rep_finalOutputData.length > 0) {
        rep_outputHeaders = Object.keys(rep_finalOutputData[0]);
        repPreview.style.display = 'block';
        repPreview.innerHTML = `
            <p><strong>预览前 5 条合并结果:</strong></p>
            <pre>${JSON.stringify(rep_finalOutputData.slice(0, 5), null, 2)}</pre>
        `;
        repDownloadBtn.style.display = 'inline-block';
    } else {
        alert("处理完成，但没有生成任何数据。请检查文件内容。");
    }
}

function downloadFinalReport() {
    if (rep_finalOutputData.length === 0) return;
    const newSheet = XLSX.utils.json_to_sheet(rep_finalOutputData, { header: rep_outputHeaders });
    const newWorkbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(newWorkbook, newSheet, "分析结果");
    XLSX.writeFile(newWorkbook, "专利分析报告_最终版.xlsx");
}

</script>
</body>
</html>
