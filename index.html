<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专利分析智能工作台 v12.0 REFACTORED</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
    /* --- [v12.0 REFACTORED Design System] --- */
    :root {
        --bg-color: #F0FDF4; 
        --surface-color: #FFFFFF;
        --border-color: rgba(34, 197, 94, 0.3);
        --text-color: #14532D; 
        --text-color-secondary: #166534;
        --primary-color: #22C55E;
        --primary-color-dark: #16A34A;
        --primary-color-glow: rgba(34, 197, 94, 0.2);
        --primary-color-hover-bg: rgba(34, 197, 94, 0.08);
        --error-color: #EF4444;
        --success-color: var(--primary-color);
        --warning-color: #F59E0B;
        --chat-bg: var(--bg-color);
        --chat-user-bubble: #DCF8C6;
        --chat-assistant-bubble: #FFFFFF;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Noto Sans SC', sans-serif; line-height: 1.7; color: var(--text-color); background-color: var(--bg-color); margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background-color: var(--surface-color); border-radius: 12px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05); overflow: hidden; border: 1px solid var(--border-color); }
    .app-header { padding: 20px 30px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .app-branding { text-align: left; }
    .logo-container { display: flex; align-items: center; gap: 35px; }
    .image-logo { height: 80px; }
    .banner-text-logo { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; margin: 0; background: linear-gradient(45deg, var(--primary-color-dark), var(--primary-color)); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .version-number { font-size: 12px; color: var(--text-color-secondary); opacity: 0.8; margin-top: 2px; }
    .api-config-section { position: relative; }
    .api-config-toggle { background: transparent; border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; color: var(--text-color-secondary); }
    .api-config-toggle:hover { background-color: var(--primary-color-hover-bg); border-color: var(--primary-color); color: var(--primary-color); }
    .api-config-container { display: none; position: absolute; top: calc(100% + 10px); right: 0; width: 400px; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 100; }
    .api-config-container.visible { display: block; }
    .api-key-wrapper { position: relative; display: flex; align-items: center; gap: 5px; }
    #global_api_key_input { flex-grow: 1; }
    .api-key-actions { display: flex; align-items: center; gap: 5px; }
    .api-key-action-btn, .password-toggle-btn { background: transparent; border: 1px solid var(--border-color); border-radius: 50%; width: 32px; height: 32px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; color: var(--text-color-secondary); flex-shrink: 0; }
    .api-key-action-btn:hover, .password-toggle-btn:hover { background-color: var(--primary-color-hover-bg); color: var(--primary-color); }
    .api-config-footer { display: flex; justify-content: flex-end; align-items: center; margin-top: 15px; gap: 10px; }
    #api_key_save_status { color: var(--success-color); font-weight: bold; }
    .main-content { padding: 0 30px 30px 30px; }
    .tab-navigation { padding-top: 30px; margin-bottom: -1px; position: relative; z-index: 1; }
    .main-tab-container, .sub-tab-container { display: flex; justify-content: flex-start; gap: 8px; border-bottom: 1px solid var(--border-color); margin-bottom: 30px; }
    .sub-tab-container { margin-bottom: 25px; }
    .tab-button, .sub-tab-button { background-color: transparent; border: 1px solid transparent; border-bottom: none; padding: 12px 20px; cursor: pointer; font-size: 1.05em; font-weight: 500; color: var(--text-color-secondary); transition: all 0.3s ease; border-radius: 8px 8px 0 0; position: relative; bottom: -1px; }
    .tab-button:hover, .sub-tab-button:hover { color: var(--primary-color); background-color: var(--primary-color-hover-bg); }
    .tab-button.active, .sub-tab-button.active { background-color: var(--primary-color); color: white; font-weight: 700; border-color: var(--border-color); border-bottom-color: var(--primary-color); }
    .tab-content, .sub-tab-content { display: none; }
    .tab-content.active, .sub-tab-content.active { display: block; animation: fade-in 0.5s ease; border-top: 1px solid var(--border-color); padding-top: 30px; margin-top: -31px; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .step { margin-bottom: 30px; padding: 25px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--surface-color); }
    .step-header { font-size: 1.1em; font-weight: 700; color: #FFFFFF; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25); background: linear-gradient(90deg, var(--primary-color-dark), var(--primary-color)); margin: -25px -25px 20px -25px; padding: 12px 25px; border-radius: 8px 8px 0 0; }
    button { background: linear-gradient(45deg, var(--primary-color-dark), var(--primary-color)); color: #FFFFFF; font-weight: bold; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; box-shadow: 0 4px 12px var(--primary-color-glow); }
    button:hover { transform: translateY(-2px); box-shadow: 0 7px 20px var(--primary-color-glow); filter: brightness(1.05); }
    button:disabled { background: rgba(34, 197, 94, 0.4); color: rgba(255, 255, 255, 0.7); cursor: not-allowed; transform: none; box-shadow: none; }
    .action-button { min-width: 200px; margin: 5px; }
    .small-button { padding: 8px 16px; font-size: 0.9em; }
    .icon-button { background: transparent; border: none; cursor: pointer; color: var(--text-color-secondary); padding: 4px; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; transition: all .2s; box-shadow: none; }
    .icon-button:hover { background: var(--primary-color-hover-bg); color: var(--primary-color); }
    .delete-button { background: linear-gradient(45deg, #FF7171, var(--error-color)); }
    .delete-button:hover { box-shadow: 0 7px 20px rgba(239, 68, 68, 0.3); }
    select, input, textarea { background-color: #FFFFFF; border: 1px solid var(--border-color); color: var(--text-color); padding: 12px; border-radius: 8px; width: 100%; font-size: 1em; transition: all 0.3s ease; }
    select:focus, input:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-color-glow); }
    textarea { min-height: 120px; resize: vertical; }
    .config-item { margin-bottom: 15px; }
    .config-item label { font-weight: 500; margin-bottom: 8px; display: block; color: var(--text-color-secondary); }
    .config-item.row-flex { display: flex; align-items: center; gap: 15px; }
    .config-item.row-flex label { width: 170px; flex-shrink: 0; margin-bottom: 0; }
    .preview-output { background-color: var(--bg-color); padding: 15px; border-radius: 8px; max-height: 500px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; margin-top: 15px; border: 1px solid var(--border-color); font-family: monospace; }
    .info { font-size: 0.95em; padding: 15px 20px; border-radius: 8px; border-left: 5px solid; }
    .info.success { border-color: var(--success-color); background-color: rgba(34, 197, 94, 0.05); }
    .info.error { border-color: var(--error-color); background-color: rgba(239, 68, 68, 0.05); }
    .info.warning { border-color: var(--warning-color); background-color: rgba(245, 158, 11, 0.05); }
    details { border: 1px solid var(--border-color); border-radius: 8px; margin-top: 25px; }
    summary { font-size: 1.2em; font-weight: 500; padding: 15px 20px; cursor: pointer; list-style: none; }
    summary::-webkit-details-marker { display: none; }
    .prompt-section { border: 1px dashed var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .prompt-section-title { font-weight: bold; margin-bottom: 15px; color: var(--primary-color-dark); }
    /* --- Chat UI --- */
    #chat_container { display: flex; flex-direction: column; height: 65vh; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    #chat_window { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: var(--chat-bg); display: flex; flex-direction: column;}
    .chat-message { display: flex; margin-bottom: 20px; max-width: 85%; position: relative;}
    .chat-message .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
    .chat-message .message-content { margin-left: 15px; padding: 12px 18px; border-radius: 18px; word-break: break-word; }
    .chat-message .message-actions { position: absolute; top: -10px; display: flex; gap: 5px; background: var(--surface-color); border-radius: 20px; padding: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); opacity: 0; visibility: hidden; transition: all .2s; }
    .chat-message:hover .message-actions { opacity: 1; visibility: visible; }
    .chat-message.user-message { align-self: flex-end; flex-direction: row-reverse; }
    .chat-message.user-message .message-content { background-color: var(--chat-user-bubble); margin-left: 0; margin-right: 15px; }
    .chat-message.user-message .message-actions { right: 55px; }
    .chat-message.assistant-message { align-self: flex-start; }
    .chat-message.assistant-message .message-content { background-color: var(--chat-assistant-bubble); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .chat-message.assistant-message .message-actions { left: 55px; }
    .message-content p { margin: 0 0 10px 0; }
    .message-content pre { background-color: #2D3748; color: #F7F9FC; padding: 15px; border-radius: 8px; overflow-x: auto;}
    .blinking-cursor { animation: blink 1s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    #chat_input_area { display: flex; padding: 15px; border-top: 1px solid var(--border-color); background-color: var(--surface-color); align-items: flex-end; gap: 15px; }
    #chat_input_wrapper { position: relative; flex-grow: 1; }
    #chat_input { min-height: 50px; max-height: 300px; height: 50px; padding: 12px 50px 12px 20px; overflow-y: auto; }
    #chat_char_count { position: absolute; bottom: 8px; right: 15px; font-size: 12px; color: var(--text-color-secondary); pointer-events: none; }
    #chat_send_btn { height: 50px; flex-shrink: 0; }
    .chat-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;}
    .chat-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
    /* --- NEW Async Batch Styles --- */
    .async-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    @media (max-width: 992px) { .async-layout { grid-template-columns: 1fr; } }
    .async-column .step-header { margin-top: 0; }
    .scrollable-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; }
    .list-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid var(--border-color); gap: 10px; }
    .list-item:last-child { border-bottom: none; }
    .list-item input[type="text"] { flex-grow: 1; }
    .list-item .item-content { flex-grow: 1; font-size: 0.9em; line-height: 1.4; word-break: break-all; }
    #async_results_table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    #async_results_table th, #async_results_table td { border: 1px solid var(--border-color); padding: 12px; text-align: left; vertical-align: top;}
    .status-processing { color: var(--warning-color); font-weight: bold; }
    .status-success { color: var(--success-color); font-weight: bold; }
    .status-fail { color: var(--error-color); font-weight: bold; }
    .result-cell pre { white-space: pre-wrap; word-break: break-all; margin: 0; font-size: 0.9em; }
</style>
</head>
<body>

<div class="container">
    <header class="app-header">
        <div class="app-branding">
            <div class="logo-container">
                <h1 class="banner-text-logo">ALFRED X IP</h1>
                <img src="Alfred X IP LOGO.webp" alt="Alfred X IP Logo" class="image-logo">
            </div>
            <div class="version-number">版本号: v12.0 REFACTORED</div>
        </div>
        <div class="api-config-section">
            <button id="api_config_toggle_btn" class="api-config-toggle" title="API Key 设置">⚙️</button>
            <div id="api_config_container" class="api-config-container">
                <div class="config-item">
                    <label for="global_api_key_input">您的智谱AI API Key:</label>
                    <div class="api-key-wrapper">
                        <input type="password" id="global_api_key_input" placeholder="在此处粘贴以启用所有功能">
                        <div class="api-key-actions">
                            <button type="button" id="api_key_copy_btn" class="api-key-action-btn" title="复制">📋</button>
                            <button type="button" id="api_key_delete_btn" class="api-key-action-btn" title="删除">🗑️</button>
                            <button type="button" id="api_key_toggle_visibility_btn" class="password-toggle-btn" title="显示/隐藏">👁️</button>
                        </div>
                    </div>
                </div>
                <div class="api-config-footer">
                    <span id="api_key_save_status"></span>
                    <button id="api_key_save_btn" class="small-button">保存</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="main-content">
        <div class="tab-navigation">
            <div class="main-tab-container">
                <button class="tab-button" onclick="switchTab('instant', this)">功能一：即时对话</button>
                <button class="tab-button" onclick="switchTab('async_batch', this)">功能二：小批量异步</button>
                <button class="tab-button" onclick="switchTab('large_batch', this)">功能三：大批量处理</button>
            </div>
        </div>

        <!-- 功能一：即时对话 -->
        <div id="instant-tab" class="tab-content">
            <div class="step">
                <div class="step-header">对话参数配置</div>
                <div class="chat-controls">
                    <div class="config-item"><label for="chat_model_select">模型:</label><select id="chat_model_select"></select></div>
                    <div class="config-item"><label for="chat_context_count">上下文条数 (最近N条):</label><input type="number" id="chat_context_count" value="10" min="0" max="50"></div>
                    <div class="config-item"><label for="chat_persona_select">对话角色:</label><select id="chat_persona_select"></select></div>
                    <div class="config-item"><label for="chat_temperature">温度:</label><input type="number" id="chat_temperature" value="0.7" step="0.1" min="0" max="1"></div>
                </div>
                 <div class="chat-actions">
                    <button id="chat_new_btn" class="small-button">开启新对话</button>
                    <button id="chat_export_btn" class="small-button">导出聊天记录</button>
                    <button id="chat_add_persona_btn" class="small-button">新增角色</button>
                    <button id="chat_edit_persona_btn" class="small-button">编辑当前角色</button>
                    <button id="chat_delete_persona_btn" class="small-button delete-button">删除当前角色</button>
                </div>
            </div>
            <div id="chat_container">
                <div id="chat_window"></div>
                <div id="chat_input_area">
                    <div id="chat_input_wrapper">
                        <textarea id="chat_input" placeholder="输入您的问题 (Shift+Enter 换行)..." rows="1"></textarea>
                        <span id="chat_char_count">0</span>
                    </div>
                    <button id="chat_send_btn">发送</button>
                </div>
            </div>
        </div>
        
        <!-- 功能二：小批量异步 (已重构) -->
        <div id="async_batch-tab" class="tab-content">
            <div class="step">
                <div class="step-header">步骤 1: 通用配置</div>
                <div class="config-item row-flex"><label for="async_model_select">模型 (推荐 Flash):</label><select id="async_model_select"></select></div>
                 <div class="config-item row-flex"><label for="async_temperature">温度:</label><input type="number" id="async_temperature" value="0.1" step="0.1" min="0" max="1" style="width: 120px;"></div>
            </div>

            <div class="async-layout">
                <div class="async-column">
                    <div class="step">
                        <div class="step-header">步骤 2: 添加处理模板</div>
                        <div class="config-item">
                            <label for="async_template_name">模板名称:</label>
                            <input type="text" id="async_template_name" placeholder="例如：技术方案总结">
                        </div>
                        <div class="config-item">
                            <label for="async_system_prompt">系统提示 (System Prompt):</label>
                            <textarea id="async_system_prompt" rows="3">你是一个高效的专利文本分析助手。</textarea>
                        </div>
                        <div class="config-item">
                            <label for="async_user_prompt">用户提示模板 (User Prompt Template):</label>
                            <textarea id="async_user_prompt" rows="4" placeholder="例如：请根据以下文本，总结其核心技术点：\n\n{{INPUT}}"></textarea>
                            <div class="info" style="font-size: 0.85em; padding: 8px; margin-top: 5px;">请务必使用 `{{INPUT}}`作为占位符，它将被替换为下方的每条输入内容。</div>
                        </div>
                        <button id="async_add_template_btn" class="small-button">保存为新模板</button>
                        <hr style="margin: 20px 0; border-color: var(--border-color);">
                        <label><strong>已保存的模板 (勾选以使用):</strong></label>
                        <div id="async_templates_list" class="scrollable-list"></div>
                    </div>
                </div>

                <div class="async-column">
                     <div class="step">
                        <div class="step-header">步骤 3: 添加输入内容</div>
                        <!-- Sub-tabs for input method -->
                        <div class="sub-tab-container" style="margin-bottom: 20px;">
                            <button class="sub-tab-button active" onclick="switchAsyncInput(event, 'manual')">手动添加</button>
                            <button class="sub-tab-button" onclick="switchAsyncInput(event, 'excel')">Excel导入</button>
                        </div>
                        <div id="async-input-manual" class="sub-tab-content active">
                            <div class="config-item">
                                <label for="async_manual_input">新输入 (一行一条):</label>
                                <textarea id="async_manual_input" rows="5" placeholder="输入1...&#10;输入2..."></textarea>
                            </div>
                            <button id="async_add_input_btn" class="small-button">添加输入</button>
                        </div>
                        <div id="async-input-excel" class="sub-tab-content">
                            <div class="config-item">
                                <label for="async_excel_file">上传Excel文件:</label>
                                <input type="file" id="async_excel_file" accept=".xlsx, .xls">
                            </div>
                             <div class="config-item">
                                <label for="async_excel_sheet">选择Sheet:</label>
                                <select id="async_excel_sheet" disabled></select>
                            </div>
                             <div class="config-item">
                                <label for="async_excel_column">选择列作为输入:</label>
                                <select id="async_excel_column" disabled></select>
                            </div>
                            <button id="async_load_excel_btn" class="small-button" disabled>从Excel加载输入</button>
                        </div>
                        <hr style="margin: 20px 0; border-color: var(--border-color);">
                        <label><strong>已添加的输入 (勾选以使用):</strong></label>
                        <div id="async_inputs_list" class="scrollable-list"></div>
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-header">步骤 4: 组合并提交任务</div>
                <button id="async_prepare_requests_btn">1. 生成请求预览</button>
                <div class="info" id="async_requests_preview" style="margin-top:15px; display:none;"></div>
                <button id="async_submit_batch_btn" style="margin-top:15px; display:none;">2. 提交全部请求</button>
            </div>

            <div class="step">
                <div class="step-header">步骤 5: 任务进度与结果</div>
                <div id="async_progress_info" class="info" style="text-align:center;">等待提交任务...</div>
                <div style="overflow-x:auto;">
                    <table id="async_results_table">
                        <thead><tr><th>请求ID</th><th>输入预览</th><th>使用模板</th><th>状态</th><th>结果 / 错误</th></tr></thead>
                        <tbody id="async_results_tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 功能三：大批量处理 -->
        <div id="large_batch-tab" class="tab-content">
            <div class="sub-tab-container">
                <button class="sub-tab-button" onclick="switchSubTab('generator', this)">1. 生成请求文件</button>
                <button class="sub-tab-button" onclick="switchSubTab('batch', this)">2. 执行批处理</button>
                <button class="sub-tab-button" onclick="switchSubTab('reporter', this)">3. 解析报告</button>
            </div>
            
            <div id="sub-tab-generator" class="sub-tab-content">
                 <div class="step">
                    <div class="step-header">步骤 1: 上传专利数据 Excel 并配置分析列</div>
                    <input type="file" id="gen_file-input" accept=".xlsx, .xls">
                    <select id="gen_sheet-selector" style="display:none; margin-left: 10px;"></select>
                    <div id="column-config-container" style="display:none; margin-top: 20px;">
                        <div class="config-item row-flex">
                            <label for="column-count">分析列数量:</label>
                            <input type="number" id="column-count" value="2" min="1" max="10" style="width: 100px;">
                        </div>
                        <div id="column-config-area"></div>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-header">步骤 2: 配置 API 请求模板</div>
                    <div class="template-actions" style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <select id="template_selector" style="flex-grow: 1;"></select>
                        <button id="save_template_btn" class="small-button">保存</button>
                        <button id="import_template_btn" class="small-button">导入</button>
                        <input type="file" id="template_file_input" accept=".json" style="display:none;">
                        <button id="export_template_btn" class="small-button">导出</button>
                        <button id="delete_template_btn" class="small-button delete-button">删除</button>
                    </div>

                    <div class="config-item row-flex"><label for="api-model">模型 (model):</label><select id="api-model"></select></div>
                    <div class="config-item row-flex"><label for="api-temperature">温度 (temperature):</label><input type="number" id="api-temperature" value="0.1" step="0.1" min="0" max="1"></div>
                    
                    <div class="config-item">
                        <label for="api-system-prompt">系统提示 (System Prompt):</label>
                        <textarea id="api-system-prompt" rows="3"></textarea>
                    </div>

                    <div class="config-item">
                        <label>用户提示 (User Prompt):</label>
                        <div class="prompt-section">
                            <div class="prompt-section-title">A. 规则要求</div>
                            <textarea id="prompt-rules" rows="4" placeholder="请在此处输入任务的核心指令、要求和背景信息。"></textarea>
                        </div>
                        <div class="prompt-section">
                            <div class="prompt-section-title">B. 内容插入 (自动生成)</div>
                            <div id="content-insertion-preview" class="preview-output" style="min-height: 80px;">待上传Excel并配置分析列后自动显示...</div>
                        </div>
                        <div class="prompt-section">
                            <div class="prompt-section-title">C. 输出格式 (JSON)</div>
                            <div id="output-fields-container"></div>
                            <button id="add-output-field-btn" class="small-button" type="button">添加输出字段</button>
                            <div class="info" style="margin-top: 10px;">系统将自动把此处的字段包装成JSON格式要求。</div>
                        </div>
                    </div>
                </div>

                <div class="step">
                    <div class="step-header">步骤 3: 生成并预览 JSONL 请求文件</div>
                    <button id="gen_generate-btn" disabled>生成 JSONL 文件</button>
                    <div class="preview-output" id="gen_preview_output" style="display:none;"></div>
                    <button id="gen_download-btn" style="display:none; margin-top: 15px;">下载 JSONL 文件</button>
                    <div class="info success" id="gen_ready_info" style="display:none;">文件已在内存中准备就绪，请切换到【2. 执行批处理】进行上传。</div>
                </div>
            </div>

            <div id="sub-tab-batch" class="sub-tab-content">
                 <div class="step">
                    <div class="step-header">批量任务工作流</div>
                    <p>请按照1-4的顺序执行。点击步骤2后将启动自动状态检查。</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; justify-content: center;">
                        <button id="batch_step1_upload" class="action-button">1. 上传请求文件</button>
                        <button id="batch_step2_create" class="action-button" disabled>2. 创建Batch任务</button>
                        <button id="batch_step3_check" class="action-button" disabled>3. 手动检查状态</button>
                        <button id="batch_step4_download" class="action-button" disabled>4. 获取结果内容</button>
                    </div>
                    <div id="batch_id_reminder" class="info" style="display: none; margin-top: 20px; text-align: center;"></div>

                    <div id="auto-check-container" style="display:none; margin-top: 20px; text-align: center;">
                        <span id="auto_check_status" style="margin-right: 15px; color: var(--primary-color-dark); font-weight: bold;"></span>
                        <button id="batch_stop_check_btn" class="small-button" style="background: var(--warning-color); color: #fff;">停止自动检查</button>
                    </div>
                </div>
                
                <details>
                    <summary>断点续查 / 任务恢复</summary>
                    <div class="step" style="border-top: none; margin-top: 0;">
                        <p class="info warning">如果您因关闭浏览器等原因中断了流程，但已记录下 Batch ID，可在此恢复任务状态。</p>
                        <div class="config-item row-flex">
                            <label for="recover_batch_id_input">Batch ID:</label>
                            <input type="text" id="recover_batch_id_input" placeholder="粘贴您记录的 Batch ID">
                        </div>
                        <button id="recover_state_btn">恢复查询状态</button>
                    </div>
                </details>

                <div class="step">
                    <div class="step-header">执行日志</div>
                    <div id="batch_log" class="preview-output">等待操作...</div>
                </div>
            </div>

            <div id="sub-tab-reporter" class="sub-tab-content">
                <div class="step">
                    <div class="step-header">步骤 1: 准备数据源</div>
                    <div class="reporter-uploads">
                        <div>
                            <p><strong>A. 上传原始 Excel 文件</strong> (用于数据匹配)</p>
                            <input type="file" id="rep_excel-input" accept=".xlsx, .xls">
                            <select id="rep_sheet-selector" style="display:none; margin-top: 10px;"></select>
                        </div>
                        <div style="margin-top:20px;">
                            <p><strong>B. 加载 Batch 任务结果文件</strong></p>
                            <input type="file" id="rep_jsonl-input" accept=".jsonl">
                            <div class="info success" id="reporter-info-box" style="display:none;">
                                检测到来自【2. 执行批处理】的结果文件已在内存中，将优先使用此数据。
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step">
                    <div class="step-header">步骤 2: 解析并生成最终报告</div>
                    <button id="rep_generate-report-btn" disabled>解析并生成最终报告</button>
                    <div class="preview-output" id="rep_output_preview" style="display:none;"></div>
                    <button id="rep_download-report-btn" style="display:none; margin-top: 15px;">下载最终报告 (Excel)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// =================================================================================
// v12.0 - 全局应用状态与配置
// =================================================================================
const appState = {
    apiKey: '',
    chat: {
        personas: {},
        histories: {},
        currentPersonaId: null,
    },
    // [REFACTORED] asyncBatch state
    asyncBatch: {
        model: 'glm-4-flash',
        temperature: 0.1,
        inputs: [], // { id, content }
        templates: [], // { id, name, systemPrompt, userPromptTemplate }
        requests: [], // { requestId, input, template }
        tasks: {}, // { zhipuTaskId, status, result... } for a local requestId
        pollingInterval: null,
        nextInputId: 1,
        nextTemplateId: 1,
        excelFile: null,
    },
    batch: {
        jsonlContent: "",
        fileId: null,
        batchId: null,
        outputFileId: null,
        resultContent: null,
        autoCheckTimer: null,
    },
    generator: {
        workbook: null,
        currentSheetData: null,
        columnHeaders: [],
        customTemplates: [],
        presetTemplates: [
            { name: "专利文本翻译", isPreset: true, system: "你是一个专业精通各技术领域术语的、精通多国语言的专利文本翻译引擎。你的任务是自动检测用户输入专利文本的语言并将其翻译成中文。请直接返回翻译后的文本，不要添加任何额外的解释或说明。你必须严格遵循输出格式要求。", user: { rules: "请基于以下文本，直接输出翻译后的内容。\n要求：\n1. 结果必须是直接的翻译后中文文本，必须忠实于原文不得臆测，并选择贴合技术领域的专业术语表达", outputFields: [] }},
            { name: "技术方案解读", isPreset: true, system: "你是一位资深的专利技术分析师。你的任务是基于专利内容，梳理总结其要解决的技术问题，采用的核心方案内容、以及实现的技术效果和最重要的核心关键词短语。", user: { rules: "请分析此专利并按以下JSON格式输出：", outputFields: [ { name: "技术方案", desc: "此处填写技术方案，总结专利的主要方案内容" }, { name: "技术问题", desc: "此处填写该专利可能主要解决的技术问题" }, { name: "技术效果", desc: "此处填写该专利可能带来的技术效果" }, { name: "技术关键词", desc: "此处按照专利文本中构成核心方案的重要程度输出15个关键词或短语" }] }}
        ]
    },
    reporter: {
        workbook: null,
        sheetData: null,
        jsonlData: null,
        finalOutputData: [],
        outputHeaders: [],
    }
};

const BACKEND_URL = 'https://patent-workbench-backend.onrender.com';
const AVAILABLE_MODELS = ["glm-4-flash-250414", "glm-4-flashX-250414", "glm-4-flash", "glm-4-long"];
const BATCH_MODELS = ["glm-4-flashX-250414" , "glm-4-flash","glm-4-long"];
const ASYNC_MODELS = ["glm-4-flash", "glm-4-flashX-250414", "glm-4-flash-250414"];

// --- DOM 元素缓存 ---
const getEl = id => document.getElementById(id);
const globalApiKeyInput = getEl('global_api_key_input');
const apiKeyToggleVisibilityBtn = getEl('api_key_toggle_visibility_btn');
const apiKeyCopyBtn = getEl('api_key_copy_btn');
const apiKeyDeleteBtn = getEl('api_key_delete_btn');
const apiKeySaveBtn = getEl('api_key_save_btn');
const apiKeySaveStatus = getEl('api_key_save_status');
const apiConfigToggleBtn = getEl('api_config_toggle_btn');
const apiConfigContainer = getEl('api_config_container');
// Chat
const chatModelSelect = getEl('chat_model_select'), chatContextCount = getEl('chat_context_count');
const chatPersonaSelect = getEl('chat_persona_select'), chatTempInput = getEl('chat_temperature');
const chatNewBtn = getEl('chat_new_btn'), chatExportBtn = getEl('chat_export_btn');
const chatAddPersonaBtn = getEl('chat_add_persona_btn'), chatEditPersonaBtn = getEl('chat_edit_persona_btn'), chatDeletePersonaBtn = getEl('chat_delete_persona_btn');
const chatWindow = getEl('chat_window'), chatInput = getEl('chat_input'), chatCharCount = getEl('chat_char_count'), chatSendBtn = getEl('chat_send_btn');
// Large Batch (Generator)
const genFileInput = getEl('gen_file-input'), genSheetSelector = getEl('gen_sheet-selector');
const columnConfigContainer = getEl('column-config-container'), columnCountInput = getEl('column-count'), columnConfigArea = getEl('column-config-area');
const genGenerateBtn = getEl('gen_generate-btn'), genPreviewOutput = getEl('gen_preview_output'), genDownloadBtn = getEl('gen_download-btn'), genReadyInfo = getEl('gen_ready_info');
const apiModelSelect = getEl('api-model'), apiTempInput = getEl('api-temperature'), apiSystemInput = getEl('api-system-prompt');
const templateSelector = getEl('template_selector'), templateFileInput = getEl('template_file_input');
const promptRules = getEl('prompt-rules'), contentInsertionPreview = getEl('content-insertion-preview'), outputFieldsContainer = getEl('output-fields-container');
// Large Batch (Workflow)
const batchLog = getEl('batch_log'), batchIdReminder = getEl('batch_id_reminder');
const btnUpload = getEl('batch_step1_upload'), btnCreate = getEl('batch_step2_create'), btnCheck = getEl('batch_step3_check'), btnDownload = getEl('batch_step4_download');
const autoCheckContainer = getEl('auto-check-container'), autoCheckStatusEl = getEl('auto_check_status'), btnStopCheck = getEl('batch_stop_check_btn');
const recoverIdInput = getEl('recover_batch_id_input'), btnRecover = getEl('recover_state_btn');
// Large Batch (Reporter)
const repExcelInput = getEl('rep_excel-input'), repSheetSelector = getEl('rep_sheet-selector'), repJsonlInput = getEl('rep_jsonl-input');
const repGenerateBtn = getEl('rep_generate-report-btn'), repPreview = getEl('rep_output_preview'), repDownloadBtn = getEl('rep_download-report-btn'), repInfoBox = getEl('reporter-info-box');

// =================================================================================
// 初始化
// =================================================================================
document.addEventListener('DOMContentLoaded', () => {
    initApiKeyConfig();
    initChat();
    initAsyncBatch();
    initLargeBatch();

    // 默认打开第一个Tab
    switchTab('instant', document.querySelector('.tab-button'));
});

// =================================================================================
// API Key配置 与 统一API调用函数
// =================================================================================
function initApiKeyConfig() {
    appState.apiKey = localStorage.getItem('globalApiKey') || '';
    globalApiKeyInput.value = appState.apiKey;

    apiKeySaveBtn.addEventListener('click', () => {
        appState.apiKey = globalApiKeyInput.value.trim();
        localStorage.setItem('globalApiKey', appState.apiKey);
        apiKeySaveStatus.textContent = "已保存!";
        setTimeout(() => { apiKeySaveStatus.textContent = ""; }, 2000);
    });
    
    apiConfigToggleBtn.addEventListener('click', () => {
        apiConfigContainer.classList.toggle('visible');
    });

    apiKeyToggleVisibilityBtn.addEventListener('click', () => {
        const isPassword = globalApiKeyInput.type === 'password';
        globalApiKeyInput.type = isPassword ? 'text' : 'password';
        apiKeyToggleVisibilityBtn.textContent = isPassword ? '🙈' : '👁️';
    });
    
    apiKeyCopyBtn.addEventListener('click', () => {
        if (!globalApiKeyInput.value) return;
        navigator.clipboard.writeText(globalApiKeyInput.value).then(() => {
            apiKeyCopyBtn.textContent = '✅';
            setTimeout(() => { apiKeyCopyBtn.textContent = '📋'; }, 1500);
        });
    });

    apiKeyDeleteBtn.addEventListener('click', () => {
        globalApiKeyInput.value = '';
    });

    document.addEventListener('click', (event) => {
        if (!apiConfigContainer.contains(event.target) && !apiConfigToggleBtn.contains(event.target)) {
            apiConfigContainer.classList.remove('visible');
        }
    });
}

async function apiCall(endpoint, body, method = 'POST', isStream = false) {
    if (!appState.apiKey) {
        alert("请点击右上角 ⚙️ 设置并保存您的 API Key。");
        throw new Error("API Key 未配置。");
    }

    const headers = {
        'Authorization': `Bearer ${appState.apiKey}`
    };
    
    if (!(body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
    }

    const fullUrl = `${BACKEND_URL}/api${endpoint}`;

    try {
        const fetchOptions = {
            method,
            headers,
        };
        
        if (body) {
            fetchOptions.body = (body instanceof FormData) ? body : JSON.stringify(body);
        }

        const response = await fetch(fullUrl, fetchOptions);

        if (isStream) {
            // For streams, we handle errors differently. We don't try to parse JSON on failure.
            // The stream reader itself will receive the error message if backend sends it correctly.
            if (!response.ok) {
                // We'll let the streaming function handle the error message from the body
                 throw new Error(`请求失败 (Stream): ${response.statusText}`);
            }
            return response.body.getReader();
        }
        
        const result = await response.json();
        if (!response.ok || result.success === false) {
            throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
        }
        return result.data;

    } catch (error) {
        console.error(`API Call Error to ${endpoint}:`, error);
        throw error;
    }
}

// =================================================================================
// 功能一: 即时对话 (已修复BUG并增加新功能)
// =================================================================================
function initChat() {
    chatModelSelect.innerHTML = AVAILABLE_MODELS.map(m => `<option value="${m}">${m}</option>`).join('');
    
    const savedPersonas = JSON.parse(localStorage.getItem('chatPersonas'));
    if (savedPersonas && Object.keys(savedPersonas).length > 0) {
        appState.chat.personas = savedPersonas;
    } else {
        appState.chat.personas = {
            "patent_analyzer": { "name": "资深专利分析师", "system": "你是一位顶级的专利分析师和信息架构师，极其擅长从复杂、冗长的专利文本中快速提炼核心技术原理、解决方案、技术问题和效果。你的回答应该专业、结构清晰、逻辑严谨。" },
            "translator": { "name": "专业技术翻译", "system": "你是一个专业精通各技术领域术语的、精通多国语言的专利文本翻译引擎。你的任务是自动检测用户输入专利文本的语言并将其翻译成中文或英文。请直接返回翻译后的文本，不要添加任何额外的解释或说明。" },
            "keyword_expander": { "name": "专利检索词专家", "system": "你是一名资深的专利检索专家。你的任务是根据用户提供的技术点，拓展出一系列用于专利数据库检索的中英文同义词、近义词、上下位概念和相关技术术语。输出应该清晰、格式化，便于复制使用。" },
            "general_assistant": { "name": "通用助手", "system": "你是一个乐于助人的通用AI助手，可以回答各种问题。" }
        };
        savePersonas();
    }

    chatSendBtn.addEventListener('click', handleStreamChatRequest);
    chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleStreamChatRequest(); }});
    chatInput.addEventListener('input', () => {
        chatCharCount.textContent = chatInput.value.length;
        chatInput.style.height = 'auto';
        chatInput.style.height = `${Math.min(chatInput.scrollHeight, 300)}px`;
    });
    chatPersonaSelect.addEventListener('change', switchPersona);
    chatNewBtn.addEventListener('click', () => startNewChat(true));
    chatExportBtn.addEventListener('click', exportChatHistory);
    chatAddPersonaBtn.addEventListener('click', addPersona);
    chatEditPersonaBtn.addEventListener('click', editPersona);
    chatDeletePersonaBtn.addEventListener('click', deletePersona);

    updatePersonaSelector();
    switchPersona();
}

function updatePersonaSelector() {
    const currentVal = chatPersonaSelect.value;
    chatPersonaSelect.innerHTML = Object.keys(appState.chat.personas).map(id => `<option value="${id}">${appState.chat.personas[id].name}</option>`).join('');
    if (appState.chat.personas[currentVal]) chatPersonaSelect.value = currentVal;
    else if (Object.keys(appState.chat.personas).length > 0) chatPersonaSelect.value = Object.keys(appState.chat.personas)[0];
    appState.chat.currentPersonaId = chatPersonaSelect.value;
}

function savePersonas() {
    localStorage.setItem('chatPersonas', JSON.stringify(appState.chat.personas));
}

function switchPersona() {
    appState.chat.currentPersonaId = chatPersonaSelect.value;
    if (!appState.chat.histories[appState.chat.currentPersonaId]) {
        startNewChat(false);
    } else {
        renderChatHistory();
    }
}

function startNewChat(showNotification) {
    const personaId = appState.chat.currentPersonaId;
    if (!personaId) return;
    const persona = appState.chat.personas[personaId];
    appState.chat.histories[personaId] = [{ role: 'system', content: persona.system }];
    renderChatHistory();
    if (showNotification) {
         const notification = document.createElement('div');
         notification.className = 'info';
         notification.style.alignSelf = 'center';
         notification.style.margin = '10px 0';
         notification.innerHTML = `新对话已开始。当前角色：<strong>${appState.chat.personas[personaId].name}</strong>`;
         chatWindow.appendChild(notification);
    }
}

function renderChatHistory() {
    const personaId = appState.chat.currentPersonaId;
    const history = appState.chat.histories[personaId];
    chatWindow.innerHTML = '';
    
    if (history) {
        // Start from index 1 to skip system message
        for (let i = 1; i < history.length; i++) {
            const msg = history[i];
            addMessageToDOM(msg.role, msg.content, i);
        }
    }
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

function addMessageToDOM(role, content, index, isStreaming = false) {
    const messageId = `msg-${Date.now()}-${Math.random()}`;
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}-message`;
    messageDiv.id = messageId;
    // Add index as a data attribute for easy access later
    if (index) {
        messageDiv.dataset.index = index;
    }

    const avatar = `<div class="avatar">${role === 'user' ? 'U' : 'AI'}</div>`;
    
    // [FIX] Use innerHTML for streaming content to render the cursor span
    const renderedContent = (isStreaming) 
        ? content 
        : (window.marked ? window.marked.parse(content) : content.replace(/</g, "&lt;").replace(/>/g, "&gt;"));
    
    const contentDiv = `<div class="message-content">${renderedContent}</div>`;
    
    // [NEW] Add action buttons
    const actionsDiv = `
        <div class="message-actions">
            <button class="icon-button" title="复制" onclick="copyMessage(this)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6Z M2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z"></path></svg>
            </button>
            <button class="icon-button" title="删除" onclick="deleteMessage(this)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path></svg>
            </button>
        </div>`;
    
    messageDiv.innerHTML = (role === 'user') ? contentDiv + actionsDiv + avatar : avatar + actionsDiv + contentDiv;
    
    chatWindow.appendChild(messageDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
    return messageId;
}

async function handleStreamChatRequest() {
    const userInput = chatInput.value.trim();
    if (!userInput) return;

    chatSendBtn.disabled = true;
    chatInput.disabled = true;
    
    const personaId = appState.chat.currentPersonaId;
    const history = appState.chat.histories[personaId];
    history.push({ role: 'user', content: userInput });
    renderChatHistory(); // Re-render to show new user message with correct index
    chatInput.value = '';
    chatInput.style.height = '50px';
    chatCharCount.textContent = '0';

    const assistantMessageId = addMessageToDOM('assistant', '<div class="message-content"><span class="blinking-cursor">|</span></div>', history.length, true);
    const assistantContentEl = getEl(assistantMessageId).querySelector('.message-content');
    
    let fullResponse = "";
    try {
        const contextCount = parseInt(chatContextCount.value, 10);
        const messagesToSend = [
            history[0], // System prompt
            ...history.slice(1).slice(-(contextCount * 2)) // Get user+asst pairs
        ];
        
        const reader = await apiCall('/stream_chat', {
            model: chatModelSelect.value,
            temperature: parseFloat(chatTempInput.value),
            messages: messagesToSend
        }, 'POST', true);

        const decoder = new TextDecoder();
        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n\n').filter(line => line.startsWith('data: '));

            for (const line of lines) {
                const data = line.substring(6);
                if (data === '[DONE]') continue;
                
                try {
                    const parsed = JSON.parse(data);
                    if (parsed.error) {
                        // If the stream itself returns a structured error
                        throw new Error(parsed.error.message || JSON.stringify(parsed.error));
                    }
                    const delta = parsed.choices[0]?.delta?.content || "";
                    if (delta) {
                        fullResponse += delta;
                        if (window.marked) {
                           assistantContentEl.innerHTML = window.marked.parse(fullResponse + '<span class="blinking-cursor">|</span>');
                        } else {
                           assistantContentEl.textContent = fullResponse + '|'; // Fallback for no marked
                        }
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                } catch(e) {
                     console.error("Error parsing stream data:", data, e);
                     // This could be a malformed JSON chunk, we'll just skip it
                }
            }
        }
        
        // Final render, removing the cursor
        if (window.marked) {
            assistantContentEl.innerHTML = window.marked.parse(fullResponse);
        } else {
            assistantContentEl.textContent = fullResponse;
        }

        history.push({ role: 'assistant', content: fullResponse });
        getEl(assistantMessageId).dataset.index = history.length - 1; // Set the final index

    } catch (error) {
        assistantContentEl.innerHTML = `<div class="info error">请求失败: ${error.message}</div>`;
        // Add a placeholder to history so indexes don't get messed up if user continues chat
        history.push({ role: 'assistant', content: `[ERROR] ${error.message}` });
        getEl(assistantMessageId).dataset.index = history.length - 1;
    } finally {
        chatSendBtn.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
    }
}

function exportChatHistory() {
    const history = appState.chat.histories[appState.chat.currentPersonaId];
    if (!history || history.length <= 1) {
        alert("没有聊天记录可导出。");
        return;
    }
    const personaName = appState.chat.personas[appState.chat.currentPersonaId].name;
    let content = `聊天记录 - ${personaName}\n========================\n\n`;
    history.forEach(msg => {
        if (msg.role !== 'system') {
           content += `[${msg.role.toUpperCase()}]\n${msg.content}\n\n------------------------\n\n`;
        }
    });
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `聊天记录_${personaName}_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
}

function addPersona() {
    const name = prompt("请输入新角色的名称：");
    if (!name) return;
    const system = prompt(`请输入角色 "${name}" 的系统提示 (System Prompt):`);
    if (system === null) return;
    
    const id = `custom-${Date.now()}`;
    appState.chat.personas[id] = { name, system, isCustom: true };
    savePersonas();
    updatePersonaSelector();
    chatPersonaSelect.value = id;
    switchPersona();
    alert("新角色已添加！");
}

function editPersona() {
    const id = appState.chat.currentPersonaId;
    const persona = appState.chat.personas[id];
    const newSystem = prompt(`正在编辑角色 "${persona.name}" 的系统提示:`, persona.system);
    if (newSystem !== null) {
        persona.system = newSystem;
        if (appState.chat.histories[id]) {
            appState.chat.histories[id][0].content = newSystem;
        }
        savePersonas();
        alert("角色已更新！当前对话将使用新的系统提示。");
    }
}

function deletePersona() {
    const id = appState.chat.currentPersonaId;
    const persona = appState.chat.personas[id];
    if (!persona.isCustom) {
        alert("抱歉，不能删除预设角色。");
        return;
    }
    if (confirm(`确定要删除角色 "${persona.name}" 吗？该角色的聊天记录也将被删除。`)) {
        delete appState.chat.personas[id];
        delete appState.chat.histories[id];
        savePersonas();
        updatePersonaSelector();
        switchPersona();
        alert("角色已删除。");
    }
}

function copyMessage(buttonElement) {
    const messageDiv = buttonElement.closest('.chat-message');
    const contentDiv = messageDiv.querySelector('.message-content');
    navigator.clipboard.writeText(contentDiv.innerText).then(() => {
        const originalTitle = buttonElement.title;
        buttonElement.title = '已复制!';
        setTimeout(() => { buttonElement.title = originalTitle; }, 1500);
    }).catch(err => {
        console.error('Failed to copy text: ', err);
        alert('复制失败!');
    });
}

function deleteMessage(buttonElement) {
    if (!confirm('确定要删除这条消息吗？')) return;
    const messageDiv = buttonElement.closest('.chat-message');
    const index = parseInt(messageDiv.dataset.index, 10);
    const personaId = appState.chat.currentPersonaId;

    if (!isNaN(index) && appState.chat.histories[personaId] && appState.chat.histories[personaId][index]) {
        appState.chat.histories[personaId].splice(index, 1);
        renderChatHistory(); // Re-render the entire chat
    }
}

// =================================================================================
// 功能二: 小批量异步 (完全重构)
// =================================================================================
function initAsyncBatch() {
    // Cache DOM elements
    const modelSelect = getEl('async_model_select');
    const tempInput = getEl('async_temperature');
    const templateNameInput = getEl('async_template_name');
    const systemPromptInput = getEl('async_system_prompt');
    const userPromptInput = getEl('async_user_prompt');
    const addTemplateBtn = getEl('async_add_template_btn');
    const templatesListDiv = getEl('async_templates_list');
    const manualInput = getEl('async_manual_input');
    const addInputBtn = getEl('async_add_input_btn');
    const excelFile = getEl('async_excel_file');
    const excelSheet = getEl('async_excel_sheet');
    const excelColumn = getEl('async_excel_column');
    const loadExcelBtn = getEl('async_load_excel_btn');
    const inputsListDiv = getEl('async_inputs_list');
    const prepareBtn = getEl('async_prepare_requests_btn');
    const previewDiv = getEl('async_requests_preview');
    const submitBtn = getEl('async_submit_batch_btn');

    modelSelect.innerHTML = ASYNC_MODELS.map(m => `<option value="${m}">${m}</option>`).join('');
    modelSelect.value = appState.asyncBatch.model;

    modelSelect.addEventListener('change', e => appState.asyncBatch.model = e.target.value);
    tempInput.addEventListener('change', e => appState.asyncBatch.temperature = parseFloat(e.target.value));

    addTemplateBtn.addEventListener('click', () => {
        const name = templateNameInput.value.trim();
        const system = systemPromptInput.value.trim();
        const user = userPromptInput.value.trim();
        if (!name || !user) {
            alert('模板名称和用户提示模板不能为空！');
            return;
        }
        if (!user.includes('{{INPUT}}')) {
            alert('用户提示模板必须包含 {{INPUT}} 占位符！');
            return;
        }
        appState.asyncBatch.templates.push({
            id: `t${appState.asyncBatch.nextTemplateId++}`,
            name: name,
            systemPrompt: system,
            userPromptTemplate: user
        });
        renderTemplatesList();
        templateNameInput.value = '';
    });
    
    addInputBtn.addEventListener('click', () => {
        const lines = manualInput.value.trim().split('\n').filter(Boolean);
        lines.forEach(line => {
             appState.asyncBatch.inputs.push({
                id: `i${appState.asyncBatch.nextInputId++}`,
                content: line.trim()
            });
        });
        renderInputsList();
        manualInput.value = '';
    });

    excelFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        appState.asyncBatch.excelFile = file;
        const formData = new FormData();
        formData.append('file', file);
        try {
            const data = await apiCall('/parse_excel', formData, 'POST');
            excelSheet.innerHTML = data.sheet_names.map(name => `<option value="${name}">${name}</option>`).join('');
            excelColumn.innerHTML = data.columns.map(name => `<option value="${name}">${name}</option>`).join('');
            excelSheet.disabled = false;
            excelColumn.disabled = false;
            loadExcelBtn.disabled = false;
        } catch (error) {
            alert(`解析Excel失败: ${error.message}`);
        }
    });

    loadExcelBtn.addEventListener('click', async () => {
        const formData = new FormData();
        formData.append('file', appState.asyncBatch.excelFile);
        formData.append('sheet', excelSheet.value);
        formData.append('column', excelColumn.value);
        loadExcelBtn.disabled = true;
        loadExcelBtn.textContent = '加载中...';
        try {
            const data = await apiCall('/get_excel_column', formData, 'POST');
            data.column_data.forEach(item => {
                 appState.asyncBatch.inputs.push({
                    id: `i${appState.asyncBatch.nextInputId++}`,
                    content: item
                });
            });
            renderInputsList();
        } catch (error) {
             alert(`加载Excel列数据失败: ${error.message}`);
        } finally {
            loadExcelBtn.disabled = false;
            loadExcelBtn.textContent = '从Excel加载输入';
        }
    });

    prepareBtn.addEventListener('click', () => {
        const selectedInputIds = Array.from(inputsListDiv.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedTemplateIds = Array.from(templatesListDiv.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

        if (selectedInputIds.length === 0 || selectedTemplateIds.length === 0) {
            alert('请至少勾选一个输入和一个模板！');
            return;
        }

        appState.asyncBatch.requests = [];
        let requestIdCounter = 1;
        for (const inputId of selectedInputIds) {
            for (const templateId of selectedTemplateIds) {
                const input = appState.asyncBatch.inputs.find(i => i.id === inputId);
                const template = appState.asyncBatch.templates.find(t => t.id === templateId);
                if (input && template) {
                    appState.asyncBatch.requests.push({
                        requestId: `req-${requestIdCounter++}`,
                        input: input,
                        template: template,
                    });
                }
            }
        }
        
        previewDiv.innerHTML = `将创建 <strong>${appState.asyncBatch.requests.length}</strong> 个请求。<br>点击“提交全部请求”按钮开始处理。`;
        previewDiv.style.display = 'block';
        submitBtn.style.display = 'inline-block';
    });
    
    submitBtn.addEventListener('click', handleAsyncBatchSubmit);
}

function renderTemplatesList() {
    const listDiv = getEl('async_templates_list');
    listDiv.innerHTML = appState.asyncBatch.templates.map(t => `
        <div class="list-item">
            <input type="checkbox" value="${t.id}" id="tpl-${t.id}" checked>
            <label for="tpl-${t.id}" class="item-content" style="cursor:pointer;"><strong>${t.name}</strong></label>
            <button class="icon-button" title="删除模板" onclick="deleteAsyncTemplate('${t.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
            </button>
        </div>
    `).join('') || '<div class="info" style="padding: 10px;">暂无模板</div>';
}

function deleteAsyncTemplate(templateId) {
    appState.asyncBatch.templates = appState.asyncBatch.templates.filter(t => t.id !== templateId);
    renderTemplatesList();
}

function renderInputsList() {
    const listDiv = getEl('async_inputs_list');
    listDiv.innerHTML = appState.asyncBatch.inputs.map(i => `
        <div class="list-item">
            <input type="checkbox" value="${i.id}" id="inp-${i.id}" checked>
            <label for="inp-${i.id}" class="item-content" style="cursor:pointer;">
                <strong>${i.id.replace('i', '#')}:</strong> ${i.content.substring(0, 100)}${i.content.length > 100 ? '...' : ''}
            </label>
            <button class="icon-button" title="删除输入" onclick="deleteAsyncInput('${i.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
            </button>
        </div>
    `).join('') || '<div class="info" style="padding: 10px;">暂无输入</div>';
}

function deleteAsyncInput(inputId) {
    appState.asyncBatch.inputs = appState.asyncBatch.inputs.filter(i => i.id !== inputId);
    renderInputsList();
}

function switchAsyncInput(event, type) {
    const parent = event.target.closest('.sub-tab-container');
    parent.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    const contentParent = parent.parentElement;
    contentParent.querySelectorAll('.sub-tab-content').forEach(el => el.classList.remove('active'));
    getEl(`async-input-${type}`).classList.add('active');
}

async function handleAsyncBatchSubmit() {
    if (appState.asyncBatch.requests.length === 0) {
        alert("没有准备好的请求。请先点击“生成请求预览”。");
        return;
    }

    getEl('async_submit_batch_btn').disabled = true;
    getEl('async_results_tbody').innerHTML = '';
    appState.asyncBatch.tasks = {};

    const submissionPromises = appState.asyncBatch.requests.map(request => {
        const row = getEl('async_results_tbody').insertRow();
        row.id = `row-${request.requestId}`;
        row.innerHTML = `
            <td>${request.requestId}</td>
            <td>${request.input.content.substring(0, 50)}...</td>
            <td>${request.template.name}</td>
            <td class="status-cell">提交中...</td>
            <td class="result-cell">...</td>
        `;

        const userPrompt = request.template.userPromptTemplate.replace('{{INPUT}}', request.input.content);
        const messages = [{ role: 'user', content: userPrompt }];
        if (request.template.systemPrompt) {
            messages.unshift({ role: 'system', content: request.template.systemPrompt });
        }
        
        return apiCall("/async_submit", {
            model: appState.asyncBatch.model,
            temperature: appState.asyncBatch.temperature,
            messages: messages,
            request_id: request.requestId,
        }).then(data => {
            appState.asyncBatch.tasks[request.requestId] = { 
                zhipuTaskId: data.task_id, 
                status: 'processing',
            };
            updateAsyncTableRow(request.requestId, 'processing', '已提交，等待处理...');
        }).catch(error => {
            appState.asyncBatch.tasks[request.requestId] = { status: 'fail' };
            updateAsyncTableRow(request.requestId, 'fail', `提交失败: ${error.message}`);
        });
    });

    await Promise.all(submissionPromises);
    startAsyncPolling();
}

function updateAsyncTableRow(localRequestId, status, content) {
    const row = getEl(`row-${localRequestId}`);
    if (!row) return;
    
    let statusText = status.toUpperCase();
    let statusClass = `status-${status.toLowerCase()}`;
    
    if (status === 'processing') statusText = "处理中";
    if (status === 'success') statusText = "成功";
    if (status === 'fail') statusText = "失败";

    row.querySelector('.status-cell').innerHTML = `<span class="${statusClass}">${statusText}</span>`;
    row.querySelector('.result-cell').innerHTML = content;
}

function startAsyncPolling() {
    const progressInfo = getEl('async_progress_info');
    if (appState.asyncBatch.pollingInterval) clearInterval(appState.asyncBatch.pollingInterval);
    
    const poll = async () => {
        const total = Object.keys(appState.asyncBatch.tasks).length;
        const tasksToCheck = Object.entries(appState.asyncBatch.tasks).filter(([_, task]) => task.status === 'processing');
        
        let completed = total - tasksToCheck.length;
        progressInfo.innerHTML = `任务轮询中... 已完成 ${completed} / ${total}`;

        if (tasksToCheck.length === 0) {
            clearInterval(appState.asyncBatch.pollingInterval);
            appState.asyncBatch.pollingInterval = null;
            progressInfo.innerHTML = `所有任务处理完成！共 ${total} 条。`;
            getEl('async_submit_batch_btn').disabled = false;
            return;
        }

        for (const [localId, task] of tasksToCheck) {
            try {
                const data = await apiCall(`/async_retrieve`, { task_id: task.zhipuTaskId }, "POST");
                
                if (data.task_status === 'SUCCESS') {
                    appState.asyncBatch.tasks[localId].status = 'success';
                    const content = data.choices[0].message.content;
                    updateAsyncTableRow(localId, 'success', `<pre>${content}</pre>`);
                } else if (data.task_status === 'FAIL') {
                    appState.asyncBatch.tasks[localId].status = 'fail';
                    updateAsyncTableRow(localId, 'fail', `任务失败: ${data.error?.message || '未知错误'}`);
                }
            } catch (error) {
                 appState.asyncBatch.tasks[localId].status = 'fail';
                 updateAsyncTableRow(localId, 'fail', `查询失败: ${error.message}`);
            }
        }
    };

    appState.asyncBatch.pollingInterval = setInterval(poll, 5000);
    poll();
}


// =================================================================================
// 功能三: 大批量处理
// =================================================================================
function initLargeBatch() {
    initGenerator();
    initBatchWorkflow();
    initReporter();
    switchSubTab('generator', document.querySelector('.sub-tab-button'));
}

function initGenerator() {
    apiModelSelect.innerHTML = BATCH_MODELS.map(m => `<option value="${m}">${m}</option>`).join('');
    genFileInput.addEventListener('change', handleGenFile);
    genSheetSelector.addEventListener('change', e => loadGenSheet(e.target.value));
    columnCountInput.addEventListener('input', () => { updateColumnSelectors(); updateContentInsertionPreview(); });
    genGenerateBtn.addEventListener('click', generateJsonl);
    genDownloadBtn.addEventListener('click', downloadJsonl);
    templateSelector.addEventListener('change', loadTemplate);
    getEl('save_template_btn').addEventListener('click', saveTemplate);
    getEl('delete_template_btn').addEventListener('click', deleteTemplate);
    getEl('export_template_btn').addEventListener('click', exportTemplate);
    getEl('import_template_btn').addEventListener('click', () => templateFileInput.click());
    templateFileInput.addEventListener('change', importTemplate);
    getEl('add-output-field-btn').addEventListener('click', () => addOutputField());
    initTemplates();
}

function handleGenFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = new Uint8Array(e.target.result);
            appState.generator.workbook = XLSX.read(data, { type: 'array' });
            genSheetSelector.innerHTML = '';
            appState.generator.workbook.SheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = option.textContent = name;
                genSheetSelector.appendChild(option);
            });
            genSheetSelector.style.display = 'inline-block';
            loadGenSheet(appState.generator.workbook.SheetNames[0]);
        } catch (err) {
            alert('无法解析文件，请确保是有效的Excel文件。');
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
}

function loadGenSheet(sheetName) {
    const worksheet = appState.generator.workbook.Sheets[sheetName];
    appState.generator.currentSheetData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
    genGenerateBtn.disabled = !appState.generator.currentSheetData || appState.generator.currentSheetData.length === 0;
    if (appState.generator.currentSheetData.length > 0) {
        appState.generator.columnHeaders = Object.keys(appState.generator.currentSheetData[0]);
        columnConfigContainer.style.display = 'block';
        updateColumnSelectors();
    } else {
        columnConfigContainer.style.display = 'none';
    }
}

function updateColumnSelectors() {
    columnConfigArea.innerHTML = '';
    const count = parseInt(columnCountInput.value, 10);
    for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'config-item row-flex';
        div.innerHTML = `<label for="column-selector-${i}">配置列 ${i}:</label><div style="flex-grow:1;"><select id="column-selector-${i}" class="column-selector">${appState.generator.columnHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}</select></div>`;
        columnConfigArea.appendChild(div);
        const select = div.querySelector('select');
        select.addEventListener('change', updateContentInsertionPreview);
        if (appState.generator.columnHeaders.length >= i) {
            select.value = appState.generator.columnHeaders[i - 1];
        }
    }
    updateContentInsertionPreview();
}

function updateContentInsertionPreview() {
    const selectors = document.querySelectorAll('.column-selector');
    let placeholders = [];
    selectors.forEach((sel, i) => { placeholders.push(`{${sel.value || `配置列${i+1}`}}`); });
    contentInsertionPreview.textContent = `专利内容如下：\n${placeholders.join('\n\n')}`;
}

function buildUserPrompt() {
    const rules = promptRules.value.trim();
    const columnSelectors = document.querySelectorAll('.column-selector');
    let contentInsertionTemplate = "专利内容如下：\n" + Array.from(columnSelectors).map(sel => `{${sel.value}}`).join('\n\n');
    
    const outputFields = getOutputFieldsFromUI();
    let outputFormat = "";
    if (outputFields.length > 0) {
        const jsonFields = outputFields.map(f => `  "${f.name}": "[${f.desc}]"`).join(',\n');
        outputFormat = `请严格按照以下JSON格式输出，不要添加任何其他说明或markdown标记：\n{\n${jsonFields}\n}`;
    }
    return [rules, contentInsertionTemplate.trim(), outputFormat].filter(Boolean).join('\n\n');
}

function generateJsonl() {
    if (!appState.generator.currentSheetData) return;
    const userPromptTemplate = buildUserPrompt();
    const selectedColumns = Array.from(document.querySelectorAll('.column-selector')).map(sel => sel.value);
    
    const requests = appState.generator.currentSheetData.map((row, index) => {
        let finalUserPrompt = userPromptTemplate;
        selectedColumns.forEach(colName => {
            finalUserPrompt = finalUserPrompt.replace(new RegExp(`{${colName}}`, 'g'), row[colName] || '');
        });

        return {
            "custom_id": `request-${index + 1}`, "method": "POST", "url": "/v4/chat/completions",
            "body": {
                model: apiModelSelect.value,
                messages: [{ role: 'system', content: apiSystemInput.value }, { role: 'user', content: finalUserPrompt }],
                temperature: parseFloat(apiTempInput.value)
            }
        };
    });

    appState.batch.jsonlContent = requests.map(JSON.stringify).join('\n');
    genPreviewOutput.style.display = 'block';
    genPreviewOutput.innerHTML = requests.slice(0, 3).map(req => JSON.stringify(req, null, 2).replace(/</g, '&lt;')).join('<hr style="border-color: var(--border-color); margin: 10px 0;">');
    genDownloadBtn.style.display = 'inline-block';
    genReadyInfo.style.display = 'block';
}

function addOutputField(name = '', desc = '') {
    const fieldId = `field-${Date.now()}`;
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'output-field';
    fieldDiv.style = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
    fieldDiv.id = fieldId;
    fieldDiv.innerHTML = `<input type="text" class="output-field-name" placeholder="字段名" value="${name}" style="flex-grow: 1;"><input type="text" class="output-field-desc" placeholder="字段描述" value="${desc}" style="flex-grow: 2;"><button type="button" class="small-button delete-button" onclick="document.getElementById('${fieldId}').remove()">删除</button>`;
    outputFieldsContainer.appendChild(fieldDiv);
}
function getOutputFieldsFromUI() {
    return Array.from(document.querySelectorAll('.output-field')).map(div => ({
        name: div.querySelector('.output-field-name').value.trim(),
        desc: div.querySelector('.output-field-desc').value.trim()
    })).filter(f => f.name);
}
function downloadJsonl(){
    if(!appState.batch.jsonlContent)return;
    const blob = new Blob([appState.batch.jsonlContent],{type:"application/jsonl"});
    const a = document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="batch_requests.jsonl";
    a.click();
    URL.revokeObjectURL(a.href);
}
function loadTemplateUI(template) {
    if (!template) return;
    apiSystemInput.value = template.system || '';
    if (typeof template.user === 'string') {
        promptRules.value = template.user;
        outputFieldsContainer.innerHTML = '';
    } else if (template.user && typeof template.user === 'object') {
        promptRules.value = template.user.rules || '';
        outputFieldsContainer.innerHTML = '';
        if(template.user.outputFields) {
           template.user.outputFields.forEach(f => addOutputField(f.name, f.desc));
        }
    }
}
function initTemplates() {
    appState.generator.customTemplates = JSON.parse(localStorage.getItem('custom_templates') || '[]');
    updateTemplateSelector();
    loadTemplate();
}
function updateTemplateSelector() {
    const selectedValue = templateSelector.value;
    templateSelector.innerHTML = '';
    const allTemplates = [...appState.generator.presetTemplates, ...appState.generator.customTemplates];
    ['预设模板', '自定义模板'].forEach(groupName => {
        const templatesInGroup = allTemplates.filter(t => (t.isPreset && groupName === '预设模板') || (!t.isPreset && groupName === '自定义模板'));
        if (templatesInGroup.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = groupName;
            templatesInGroup.forEach(t => optgroup.innerHTML += `<option value="${t.name}">${t.name}</option>`);
            templateSelector.appendChild(optgroup);
        }
    });
    if (allTemplates.some(t => t.name === selectedValue)) templateSelector.value = selectedValue;
}
function loadTemplate() {
    const selectedName = templateSelector.value;
    const template = [...appState.generator.presetTemplates, ...appState.generator.customTemplates].find(t => t.name === selectedName);
    loadTemplateUI(template);
}
function saveTemplate() {
    const name = prompt("请输入新模板的名称:", `自定义模板_${new Date().toISOString().slice(0, 10)}`);
    if (!name || !name.trim()) return;
    if ([...appState.generator.presetTemplates, ...appState.generator.customTemplates].some(t => t.name === name)) {
        return alert("错误：该模板名称已存在！");
    }
    const template = { name: name.trim(), system: apiSystemInput.value, user: { rules: promptRules.value, outputFields: getOutputFieldsFromUI() } };
    appState.generator.customTemplates.push(template);
    localStorage.setItem('custom_templates', JSON.stringify(appState.generator.customTemplates));
    updateTemplateSelector();
    templateSelector.value = name;
    alert("模板已保存！");
}
function deleteTemplate() {
    const selectedName = templateSelector.value;
    const template = appState.generator.customTemplates.find(t => t.name === selectedName);
    if (!template) return alert("错误：只能删除自定义模板。");
    if (confirm(`确定要删除模板 "${selectedName}" 吗？`)) {
        appState.generator.customTemplates = appState.generator.customTemplates.filter(t => t.name !== selectedName);
        localStorage.setItem('custom_templates', JSON.stringify(appState.generator.customTemplates));
        initTemplates();
        alert("模板已删除！");
    }
}
function exportTemplate() {
    const selectedName = templateSelector.value;
    const template = [...appState.generator.presetTemplates, ...appState.generator.customTemplates].find(t => t.name === selectedName);
    if (!template) return alert("请先选择一个要导出的模板");
    const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${template.name.replace(/[\/\\?%*:|"<>]/g, '-')}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
}
function importTemplate(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const t = JSON.parse(e.target.result);
            if (!t.name || !t.system || !t.user) throw new Error("模板文件格式不正确。");
            let newName = t.name;
            if ([...appState.generator.presetTemplates, ...appState.generator.customTemplates].some(temp => temp.name === newName)) { 
                newName = `${t.name}_imported_${Date.now()}`;
                alert(`模板名称冲突，已重命名为 "${newName}"`);
            }
            t.name = newName;
            delete t.isPreset;
            appState.generator.customTemplates.push(t);
            localStorage.setItem('custom_templates', JSON.stringify(appState.generator.customTemplates));
            updateTemplateSelector();
            templateSelector.value = newName;
            loadTemplate();
            alert("模板导入成功！");
        } catch (err) { alert(`导入失败: ${err.message}`); }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function initBatchWorkflow() {
    btnUpload.addEventListener('click', runStep1_Upload);
    btnCreate.addEventListener('click', runStep2_Create);
    btnCheck.addEventListener('click', runStep3_Check);
    btnDownload.addEventListener('click', runStep4_Download);
    btnStopCheck.addEventListener('click', stopAutoCheck);
    btnRecover.addEventListener('click', recoverBatchState);
}

function addLog(message,type="info"){
    if (batchLog.textContent === '等待操作...') batchLog.innerHTML = '';
    const logEntry = document.createElement("div");
    logEntry.className = `info ${type}`;
    logEntry.style.marginBottom = '8px';
    logEntry.innerHTML = `<span style="color: var(--text-color-secondary); margin-right: 10px;">[${new Date().toLocaleTimeString()}]</span> ${message}`;
    batchLog.appendChild(logEntry);
    batchLog.scrollTop = batchLog.scrollHeight;
}

async function runStep1_Upload(){
    addLog("开始执行步骤1：上传请求文件...");
    if(!appState.batch.jsonlContent) return addLog("错误：请先在【1. 生成请求文件】中生成内容。","error");
    btnUpload.disabled = true;
    try {
        const data = await apiCall("/upload", { 
            jsonlContent: appState.batch.jsonlContent,
            fileName: `patent_requests_${Date.now()}.jsonl`
        });
        appState.batch.fileId = data.fileId;
        addLog(`成功: ${data.message}`,"success");
        addLog(`获取到 File ID: ${appState.batch.fileId}`);
        btnCreate.disabled = false;
        btnCheck.disabled = true;
        btnDownload.disabled = true;
        batchIdReminder.style.display = "none";
        stopAutoCheck();
    } catch(e) {
        addLog(`错误: ${e.message}`, "error");
    } finally {
        btnUpload.disabled = false;
    }
}

async function runStep2_Create(){
    addLog("开始执行步骤2：创建Batch任务...");
    if(!appState.batch.fileId) return addLog("错误：File ID 缺失。","error");
    btnCreate.disabled = true;
    try {
        const data = await apiCall("/create_batch",{ fileId: appState.batch.fileId });
        appState.batch.batchId = data.id;
        addLog("成功: Batch任务创建成功！","success");
        addLog(`获取到 Batch ID: ${appState.batch.batchId}`);
        batchIdReminder.innerHTML=`<strong>任务已创建！请务必记录您的 Batch ID: <span style="user-select:all; background: #eee; padding: 2px 6px;">${appState.batch.batchId}</span></strong>`;
        batchIdReminder.style.display = "block";
        addLog(`任务初始状态: ${data.status}`);
        btnCheck.disabled = false;
        btnDownload.disabled = true;
        startAutoCheck();
    } catch(e) {
        addLog(`错误: ${e.message}`, "error");
    } finally {
        btnCreate.disabled = false;
    }
}

async function runStep3_Check(){
    addLog("正在检查任务状态...");
    if(!appState.batch.batchId) {
        addLog("错误：Batch ID 缺失，无法检查状态。","error");
        stopAutoCheck();
        return;
    }
    btnCheck.disabled = true;
    try {
        const data = await apiCall(`/check_status`, { batchId: appState.batch.batchId });
        addLog(`任务状态: <strong style="color: var(--primary-color-dark)">${data.status.toUpperCase()}</strong>`);
        if(data.status === "completed"){
            appState.batch.outputFileId = data.output_file_id;
            addLog(`任务完成! Output File ID: ${data.output_file_id}`,"success");
            btnDownload.disabled = false;
            stopAutoCheck();
        } else if(["failed","expired","cancelling","cancelled"].includes(data.status)){
            addLog(`任务终止。状态: ${data.status.toUpperCase()}`,"error");
            stopAutoCheck();
        }
    } catch(e) {
        addLog(`检查状态时发生错误: ${e.message}`, "error");
    } finally {
        btnCheck.disabled = false;
    }
}

async function runStep4_Download(){
    addLog("开始执行步骤4：获取结果内容...");
    if(!appState.batch.outputFileId) return addLog("错误：Output File ID 缺失。","error");
    btnDownload.disabled = true;
    try {
        const data = await apiCall(`/download_result`, { fileId: appState.batch.outputFileId });
        appState.batch.resultContent = data.fileContent;
        addLog("成功: 已将结果文件内容加载到浏览器内存中！","success");
        addLog("请切换到【3. 解析报告】，您将看到直接解析的选项。");
        switchSubTab('reporter', document.querySelector('.sub-tab-button[onclick*="reporter"]'));
    } catch(e) {
        addLog(`错误: ${e.message}`, "error");
    } finally {
        btnDownload.disabled = false;
    }
}

function startAutoCheck(){
    stopAutoCheck();
    addLog("已启动自动状态检查（每分钟一次）。");
    autoCheckContainer.style.display = "block";
    autoCheckStatusEl.textContent = "自动检查已激活...";
    runStep3_Check();
    appState.batch.autoCheckTimer = setInterval(runStep3_Check, 60000);
}

function stopAutoCheck(){
    if(appState.batch.autoCheckTimer){
        clearInterval(appState.batch.autoCheckTimer);
        appState.batch.autoCheckTimer = null;
        autoCheckStatusEl.textContent = "自动检查已停止。";
        addLog("自动检查已停止。");
        setTimeout(() => { autoCheckContainer.style.display="none" }, 3000);
    }
}

async function recoverBatchState(){
    const recoverId = recoverIdInput.value.trim();
    if(!recoverId) return addLog("错误：请输入要恢复的 Batch ID。","error");
    addLog(`正在尝试恢复 Batch ID: ${recoverId}...`);
    appState.batch.batchId = recoverId;
    btnCheck.disabled = false;
    await runStep3_Check();
    const lastLogEntry = batchLog.lastChild?.textContent || "";
    if(!/completed|failed|expired|cancelled|cancelling/i.test(lastLogEntry)){
        startAutoCheck();
    }
}

function initReporter() {
    repExcelInput.addEventListener('change', handleReporterExcel);
    repSheetSelector.addEventListener('change', e => loadReporterSheet(e.target.value));
    repJsonlInput.addEventListener('change', handleReporterJsonl);
    repGenerateBtn.addEventListener('click', parseAndGenerateReport);
    repDownloadBtn.addEventListener('click', downloadFinalReport);
}

function handleReporterExcel(event){
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = new Uint8Array(e.target.result);
            appState.reporter.workbook = XLSX.read(data, {type:"array"});
            repSheetSelector.innerHTML = "";
            appState.reporter.workbook.SheetNames.forEach(name => {
                repSheetSelector.innerHTML += `<option value="${name}">${name}</option>`;
            });
            repSheetSelector.style.display="block";
            loadReporterSheet(appState.reporter.workbook.SheetNames[0]);
        } catch (err) {
            alert('无法解析文件，请确保是有效的Excel文件。');
        }
    };
    reader.readAsArrayBuffer(file);
}
function loadReporterSheet(sheetName){
    const worksheet = appState.reporter.workbook.Sheets[sheetName];
    appState.reporter.sheetData = XLSX.utils.sheet_to_json(worksheet,{defval:""});
    checkReporterReady();
}
function handleReporterJsonl(event){
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        appState.reporter.jsonlData = parseJsonl(e.target.result);
        checkReporterReady();
    };
    reader.readAsText(file);
}
function parseJsonl(content){
    if(!content) return [];
    return content.trim().split("\n").map(line => {
        try { return JSON.parse(line) } catch(e) { console.error("Failed to parse JSONL line:", line); return null }
    }).filter(item => item);
}
function checkReporterReady(){
    repGenerateBtn.disabled = !(appState.reporter.sheetData && appState.reporter.jsonlData && appState.reporter.jsonlData.length > 0);
}
function parseAndGenerateReport() {
    if (!appState.reporter.sheetData || !appState.reporter.jsonlData) {
        return alert("请先上传原始Excel和结果JSONL文件。");
    }
    const resultMap = new Map(appState.reporter.jsonlData.map(item => {
        const content = item?.response?.body?.choices?.[0]?.message?.content?.trim();
        return [item.custom_id, content];
    }));
    
    const allGeneratedHeaders = new Set();
    
    appState.reporter.finalOutputData = appState.reporter.sheetData.map((row, index) => {
        const newRow = { ...row };
        const ai_content = resultMap.get(`request-${index + 1}`);
        if (ai_content) {
            try {
                // More robust JSON parsing
                const jsonMatch = ai_content.match(/```json\s*([\s\S]*?)\s*```|({[\s\S]*})/);
                if (!jsonMatch) throw new Error("No JSON block found");
                const jsonString = jsonMatch[1] || jsonMatch[2];
                const ai_json = JSON.parse(jsonString);
                Object.keys(ai_json).forEach(key => {
                    newRow[key] = (typeof ai_json[key] === 'object') ? JSON.stringify(ai_json[key]) : ai_json[key];
                    allGeneratedHeaders.add(key);
                });
            } catch (e) {
                newRow['AI原始返回'] = ai_content;
                allGeneratedHeaders.add('AI原始返回');
            }
        }
        return newRow;
    });

    if (appState.reporter.finalOutputData.length > 0) {
        appState.reporter.outputHeaders = [...Object.keys(appState.reporter.sheetData[0] || {}), ...Array.from(allGeneratedHeaders)];
        repPreview.style.display = 'block';
        const previewText = JSON.stringify(appState.reporter.finalOutputData.slice(0, 5), null, 2).replace(/</g, '&lt;');
        repPreview.innerHTML = `<p><strong>解析完成！预览前 5 条:</strong></p><pre>${previewText}</pre>`;
        repDownloadBtn.style.display = 'inline-block';
    } else {
        alert("处理完成，但没有生成任何数据。");
    }
}
function downloadFinalReport(){
    if(appState.reporter.finalOutputData.length === 0) return;
    const consistentData = appState.reporter.finalOutputData.map(row => {
        let newRow = {};
        appState.reporter.outputHeaders.forEach(header => { newRow[header] = row[header] || ""; });
        return newRow;
    });
    const newSheet = XLSX.utils.json_to_sheet(consistentData, {header: appState.reporter.outputHeaders});
    const newWorkbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(newWorkbook, newSheet, "分析结果");
    XLSX.writeFile(newWorkbook, "专利分析报告_最终版.xlsx");
}

// =================================================================================
// 页面布局与导航
// =================================================================================
function switchTab(tabId, clickedButton) {
    document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
    document.querySelectorAll(".tab-button").forEach(el => el.classList.remove("active"));
    getEl(`${tabId}-tab`).classList.add("active");
    if (clickedButton) {
        clickedButton.classList.add("active");
    }

    if (tabId !== 'async_batch' && appState.asyncBatch.pollingInterval) {
        clearInterval(appState.asyncBatch.pollingInterval);
        appState.asyncBatch.pollingInterval = null;
        getEl('async_progress_info').textContent = "轮询已暂停。";
    }
}

function switchSubTab(subTabId, clickedButton) {
    const parent = getEl('large_batch-tab');
    parent.querySelectorAll(".sub-tab-content").forEach(el => el.classList.remove("active"));
    parent.querySelectorAll(".sub-tab-button").forEach(el => el.classList.remove("active"));
    getEl(`sub-tab-${subTabId}`).classList.add("active");
    if(clickedButton) {
        clickedButton.classList.add("active");
    }
    
    if (subTabId === 'reporter' && appState.batch.resultContent) {
        repInfoBox.style.display = 'block';
        appState.reporter.jsonlData = parseJsonl(appState.batch.resultContent);
        checkReporterReady();
    } else if(subTabId !== 'reporter') {
        repInfoBox.style.display = 'none';
    }
}
</script>

</body>
</html>
