<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专利分析智能工作台 v3.9</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #28a745; --primary-hover-color: #218838; --primary-dark-color: #1e7e34;
            --background-color: #f4f8f5; --container-bg-color: #ffffff; --border-color: #dce5dd;
            --text-color: #333; --light-info-bg: #e9f5ec; --white-glow-color: rgba(255, 255, 255, 0.8);
            --code-bg-color: #2d2d2d; --code-text-color: #e6e6e6; --error-color: #dc3545;
            --success-color: #28a745; --secondary-color: #6c757d; --secondary-hover-color: #5a6268;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; line-height: 1.6; color: var(--text-color); background-color: var(--background-color); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: var(--container-bg-color); padding: 0; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: hidden; }
        .app-banner { display: flex; flex-direction: column; align-items: center; padding: 15px 20px; background-color: var(--primary-dark-color); color: #fff; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .banner-text-logo { font-family: 'Orbitron', sans-serif; font-size: 2.8rem; font-weight: 900; margin: 0; padding: 0; letter-spacing: 4px; background: linear-gradient(145deg, #ffffff, #e0ffe8); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 6px var(--white-glow-color), 0 0 15px rgba(255, 255, 255, 0.5); }
        .copyright-info { margin-top: 8px; display: flex; flex-direction: column; align-items: center; font-size: 11px; font-weight: normal; color: rgba(255, 255, 255, 0.7); }
        .version-number { font-size: 10px; opacity: 0.8; margin-top: 2px; }
        .main-content { padding: 25px; }
        h2 { color: var(--primary-dark-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 0; }
        .tab-container { border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-button { background-color: transparent; border: 1px solid transparent; border-bottom: none; padding: 10px 20px; cursor: pointer; font-size: 1.1em; border-radius: 5px 5px 0 0; color: #495057; }
        .tab-button.active { background-color: var(--container-bg-color); border-color: var(--border-color); border-bottom: 1px solid var(--container-bg-color); margin-bottom: -1px; font-weight: bold; color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .step { margin-bottom: 25px; padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; background-color: #ffffff; }
        .step-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #495057; }
        input[type="file"] { border: 1px solid #ccc; display: inline-block; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; text-align: center; }
        button:hover { background-color: var(--primary-hover-color); }
        button:disabled { background-color: #a0c7af; cursor: not-allowed; }
        .action-button { width: 240px; display: inline-block; }
        .preset-button { background-color: var(--secondary-color); margin: 0 8px 8px 0; padding: 8px 15px; font-size: 0.9em; }
        .preset-button:hover { background-color: var(--secondary-hover-color); }
        .io-button { background-color: var(--secondary-color); margin: 0 8px 8px 0; }
        .io-button:hover { background-color: var(--secondary-hover-color); }
        .config-item { margin-bottom: 15px; display: flex; align-items: flex-start; }
        .config-item label { display: inline-block; width: 170px; font-weight: 500; flex-shrink: 0; padding-top: 8px; }
        .config-item .input-wrapper { width: 100%; }
        .config-item select, .config-item input, .config-item textarea { padding: 8px; border-radius: 4px; border: 1px solid #ced4da; width: 100%; box-sizing: border-box; }
        textarea { min-height: 150px; font-family: "Courier New", Courier, monospace; font-size: 0.9em; }
        .preview-output { background-color: var(--code-bg-color); color: var(--code-text-color); padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-family: "Courier New", Courier, monospace; white-space: pre-wrap; word-break: break-all; }
        .preview-item { padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px dashed #4a4a4a; }
        .preview-item:last-child { border-bottom: none; margin-bottom: 0; }
        .info { font-size: 0.9em; color: var(--primary-dark-color); margin-top: 15px; background-color: var(--light-info-bg); padding: 10px; border-radius: 4px; border-left: 4px solid var(--primary-color); }
        .reporter-uploads { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        details { border: 1px solid var(--border-color); border-radius: 5px; margin-top: 25px; background-color: #fafdfb; }
        summary { font-size: 1.2em; font-weight: bold; color: #495057; padding: 15px 20px; cursor: pointer; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: '▶ '; font-size: 0.8em; margin-right: 8px; transition: transform 0.2s; display: inline-block; }
        details[open] > summary::before { transform: rotate(90deg); }
        #batch_log { margin-top: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 4px; min-height: 100px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; font-family: monospace; }
        .log-entry { margin-bottom: 8px; }
        .log-entry.error { color: var(--error-color); }
        .log-entry.success { color: var(--success-color); font-weight: bold; }
        hr.dashed { border: none; border-top: 1px dashed var(--border-color); margin: 20px 0; }
        .delete-btn { font-size: 0.8em; color: var(--error-color); cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header class="app-banner">
        <h1 class="banner-text-logo">ALFRED X IP</h1>
        <div class="copyright-info">
            <span>Copyright © 2025 Alfred Shi 保留所有权利.</span>
            <span class="version-number">版本号: v3.9</span>
        </div>
    </header>

    <div class="main-content">
        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('generator')">功能一：生成请求文件</button>
            <button class="tab-button" onclick="switchTab('batch')">功能二：批量请求与结果获取</button>
            <button class="tab-button" onclick="switchTab('reporter')">功能三：解析结果生成报告</button>
        </div>

        <div id="generator-tab" class="tab-content active">
            <div class="step">
                <div class="step-header">第一步：上传原始Excel文件</div>
                <input type="file" id="gen-excel-input" accept=".xlsx, .xls">
            </div>
            <div class="step" id="gen-sheet-selection-area" style="display:none;">
                <div class="step-header">第二步：选择要处理的工作表(Sheet)</div>
                <div id="gen-sheet-list"></div>
            </div>
            <div class="step" id="gen-column-config-area" style="display:none;">
                <div class="step-header">第三步：配置数据列</div>
                <div class="config-item"><label for="gen-select-id-col">专利号/ID所在列:</label><select id="gen-select-id-col"></select></div>
                <hr class="dashed">
                <div class="config-item">
                    <label for="gen-num-fields">选择分析的列数量:</label>
                    <div class="input-wrapper"><input type="number" id="gen-num-fields" value="2" min="1" max="10" style="width: 80px;"></div>
                </div>
                <div id="gen-dynamic-fields-container"></div>
                <p class="info">将在下方模板的 `{{field_1}}`, `{{field_2}}` 等位置填入您选择的列数据。</p>
                <br>
                <button id="gen-process-btn" class="action-button">处理并预览</button>
            </div>
            <div class="step" id="gen-preview-area" style="display:none;">
                <div class="step-header">第四步：预览生成的数据（最多显示前3条）</div>
                <pre class="preview-output" id="gen-preview-output"></pre>
                <p class="info" style="margin-top: 15px;">请确认预览内容无误。后续步骤将直接使用全部生成的数据。</p>
            </div>
            <details open>
                <summary>API模板配置</summary>
                <div class="details-content">
                    <div class="step" style="margin-top: 20px;">
                        <div><strong>预设模板:</strong><div id="preset-buttons-container" style="margin-top: 10px;"></div></div>
                        <hr class="dashed">
                        <div><strong>自定义模板:</strong><div id="custom-buttons-container" style="margin-top: 10px;"></div></div>
                        <hr class="dashed">
                        <div class="config-item"><label for="api-model">Model:</label><div class="input-wrapper"><input type="text" id="api-model"></div></div>
                        <div class="config-item"><label for="api-temperature">Temperature:</label><div class="input-wrapper"><input type="number" id="api-temperature" step="0.1"></div></div>
                        <div class="config-item"><label for="api-system-prompt">System Role:</label><div class="input-wrapper"><textarea id="api-system-prompt"></textarea></div></div>
                        <div class="config-item"><label for="api-user-prompt">User Role:</label><div class="input-wrapper"><textarea id="api-user-prompt"></textarea></div></div>
                        <div>
                            <button id="save-template-btn" class="io-button">保存为自定义模板</button>
                            <button id="import-template-btn" class="io-button">导入模板 (.txt)</button>
                            <button id="export-template-btn" class="io-button">导出当前模板 (.txt)</button>
                            <input type="file" id="import-template-input" style="display: none;" accept=".txt">
                        </div>
                    </div>
                </div>
            </details>
        </div>
        
        <div id="batch-tab" class="tab-content">
            <div class="step">
                <div class="step-header">准备工作：输入您的API Key</div>
                <div class="config-item"><label for="batch_api_key_input">API Key:</label><div class="input-wrapper"><input type="password" id="batch_api_key_input" placeholder="请在此处粘贴您的API Key"></div></div>
                <p class="info">您的API Key将发送到本地/云端后端服务进行处理，不会存储在浏览器中。</p>
            </div>
            <div class="step">
                <div class="step-header">批量任务工作流</div>
                <p>请按照1-4的顺序执行。点击按钮将直接与后端服务通信以执行相应操作。</p>
                <button id="batch_step1_upload" class="action-button">1. 上传请求文件</button>
                <button id="batch_step2_create" class="action-button" disabled>2. 创建Batch任务</button>
                <button id="batch_step3_check" class="action-button" disabled>3. 检查任务状态</button>
                <button id="batch_step4_download" class="action-button" disabled>4. 获取结果</button>
            </div>
            <div class="step">
                <div class="step-header">执行日志与结果</div>
                <div id="batch_log">等待操作...</div>
            </div>
        </div>

        <div id="reporter-tab" class="tab-content">
            <div id="reporter-data-status" class="info" style="display: none;"></div>
             <div class="step">
                <div class="step-header">第一步：上传文件</div>
                <div class="reporter-uploads">
                    <div>
                        <label for="rep-excel-input"><strong>1. 原始Excel文件</strong> (用于匹配行)</label><br>
                        <input type="file" id="rep-excel-input" accept=".xlsx, .xls" style="width: 100%;">
                    </div>
                    <div>
                        <label for="rep-jsonl-input"><strong>2. 结果文件 (可选)</strong></label><br>
                        <input type="file" id="rep-jsonl-input" accept=".jsonl" style="width: 100%;">
                    </div>
                </div>
                 <p class="info">如果已通过【功能二】获取结果，结果内容会自动加载，您只需上传原始Excel文件即可。手动上传将覆盖自动加载的数据。</p>
            </div>
            <div class="step" id="rep-sheet-selection-area" style="display:none;">
                <div class="step-header">第二步：选择要处理的原始数据工作表(Sheet)</div>
                <div id="rep-sheet-list"></div>
            </div>
            <div class="step" id="rep-config-area" style="display:none;">
                <div class="step-header">第三步：配置报告列</div>
                <div class="config-item"><label for="rep-select-id-col">选择专利号/ID所在列:</label><select id="rep-select-id-col"></select></div>
                <button id="rep-process-btn" class="action-button">生成并预览报告</button>
            </div>
            <div class="step" id="rep-preview-area" style="display:none;">
                <div class="step-header">第四步：预览最终报告数据（最多显示前5行）</div>
                <pre class="preview-output" id="rep-preview-output"></pre><br>
                <button id="rep-download-btn" class="action-button" style="display:none;">下载完整Excel报告</button>
            </div>
            <div class="step" id="rep-status-area" style="display:none;">
                <div class="step-header">处理状态日志</div>
                <pre id="rep-status-log" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>
</div>

<script>
// --- 全局配置 ---
const BACKEND_URL = 'https://patent-workbench-backend.onrender.com'; // <-- 部署完后端后，到这里来填写URL

// --- 预设模板 ---
const PRESET_TEMPLATES = [
    { name:"核心发明点提取", model:"glm-4", temperature:0.4, systemPrompt:"你是一位资深专利技术分析专家，面向企业研发工程师，帮助他们快速、精准地提取专利的核心发明信息。", userPrompt:`\n请基于以下【专利数据】，严格按照【输出格式JSON】的要求，输出结构化的中文数据。所有输出内容必须严格来源于原文，禁止添加任何编造或推测信息，但可以基于从属权利要求或说明书的暗示进行少量的技术效果推测。\n\n【输出格式JSON】：\n{\n  "技术问题": "一句话，最大80字",\n  "技术方案": "一句话，最大200字",\n  "技术效果": "一句话，最大80字，如原文未提及则写“未明确提及”",\n  "核心关键词": ["关键词1", "关键词2", "关键词3", "关键词4", "关键词5", "关键词6", "关键词7", "关键词8", "关键词9", "关键词10"],\n  "一句话发明摘要": "技术问题：[xxx] 技术方案：[xxx]"\n}\n\n【抽取要求】：\n1.  **技术问题**: 明确该专利要解决的关键技术难题，简洁明了。\n2.  **技术方案**: 用技术人员易懂的语言，结合从属权利要求，提炼最核心、最具创新性的技术方案。\n3.  **技术效果**: 概括技术方案带来的主要改进。若原文无明确描述，则填写“未明确提及”。\n4.  **核心关键词**: 提取10个最能代表技术焦点的关键词，按重要性排序。\n5.  **一句话发明摘要**: 结合“技术问题”和“技术方案”，格式固定为 "技术问题：[xxx] 技术方案：[xxx]"。\n6.  **通用要求**: 输出必须是严格的JSON格式，不含任何额外文本，且全部为中文。\n\n---\n\n【专利数据】\n{{field_1}}\n\n{{field_2}}\n` },
    { name:"摘要和权要翻译", model:"glm-4", temperature:0.1, systemPrompt:"你是一个专业的科技文献翻译引擎，专注于专利领域的翻译，确保术语准确、语句通顺。", userPrompt:`\n请将以下【专利数据】的内容翻译成流畅、专业的简体中文。\n请严格按照【输出格式JSON】返回结果，不要包含任何额外的解释或说明。\n\n【输出格式JSON】：\n{\n  "翻译结果_1": "此处为field_1的中文翻译结果",\n  "翻译结果_2": "此处为field_2的中文翻译结果"\n}\n\n---\n\n【专利数据】\nfield_1:\n{{field_1}}\n\nfield_2:\n{{field_2}}\n` }
];

// --- 全局变量 ---
let gen_workbook=null, gen_currentSheetData=null, gen_jsonlContent="";
let rep_workbook=null, rep_sheetData=null, rep_jsonlData=null; // rep_jsonlData is now our shared data
let rep_finalOutputData=[], rep_outputHeaders=[];
let batch_fileId = null, batch_batchId = null, batch_outputFileId = null, batch_errorFileId = null;
let customTemplates = [];

const apiModelInput=document.getElementById('api-model'), apiTempInput=document.getElementById('api-temperature'), apiSystemInput=document.getElementById('api-system-prompt'), apiUserInput=document.getElementById('api-user-prompt');

// =================================================================================
// 初始化
// =================================================================================
document.addEventListener('DOMContentLoaded', ()=>{
    // 功能一
    setupGeneratorTab();
    // 功能二
    setupBatchTab();
    // 功能三
    setupReporterTab();
});

function setupGeneratorTab() {
    loadCustomTemplates();
    createPresetButtons();
    document.getElementById('gen-excel-input').addEventListener('change',(e)=>handleFileSelect(e,'gen'));
    document.getElementById('gen-num-fields').addEventListener('change', (e) => renderDynamicColumnSelectors(e.target.value));
    document.getElementById('gen-process-btn').addEventListener('click',processDataForJsonl);
    document.getElementById('save-template-btn').addEventListener('click', saveCustomTemplate);
    document.getElementById('import-template-btn').addEventListener('click', ()=>document.getElementById('import-template-input').click());
    document.getElementById('import-template-input').addEventListener('change', importTemplateFromFile);
    document.getElementById('export-template-btn').addEventListener('click', exportTemplateAsTxt);
    renderDynamicColumnSelectors(document.getElementById('gen-num-fields').value);
}

function setupBatchTab() {
    document.getElementById('batch_step1_upload').addEventListener('click', runStep1_Upload);
    document.getElementById('batch_step2_create').addEventListener('click', runStep2_Create);
    document.getElementById('batch_step3_check').addEventListener('click', runStep3_Check);
    document.getElementById('batch_step4_download').addEventListener('click', runStep4_Download);
}

function setupReporterTab() {
    document.getElementById('rep-excel-input').addEventListener('change',(e)=>handleFileSelect(e,'rep'));
    document.getElementById('rep-jsonl-input').addEventListener('change', handleJsonlUpload);
    document.getElementById('rep-process-btn').addEventListener('click', previewReport);
    document.getElementById('rep-download-btn').addEventListener('click', downloadReport);
}


// =================================================================================
// 模板管理 (新增 & 增强)
// =================================================================================
function createPresetButtons(){const c=document.getElementById('preset-buttons-container');c.innerHTML='';PRESET_TEMPLATES.forEach((p,i)=>{const b=document.createElement('button');b.textContent=p.name;b.className='preset-button';b.onclick=()=>loadTemplate(p);c.appendChild(b)})}
function renderCustomTemplates(){const c=document.getElementById('custom-buttons-container');c.innerHTML='';if(customTemplates.length===0){c.textContent='暂无自定义模板';return}customTemplates.forEach((p,i)=>{const w=document.createElement('span');const b=document.createElement('button');b.textContent=p.name;b.className='preset-button';b.onclick=()=>loadTemplate(p);const d=document.createElement('span');d.textContent='[删除]';d.className='delete-btn';d.onclick=(e)=>{e.stopPropagation();deleteCustomTemplate(i)};w.appendChild(b);w.appendChild(d);c.appendChild(w)})}
function loadTemplate(t){apiModelInput.value=t.model;apiTempInput.value=t.temperature;apiSystemInput.value=t.systemPrompt.trim();apiUserInput.value=t.userPrompt.trim()}
function saveCustomTemplate(){const n=prompt("请输入模板名称:");if(!n||!n.trim())return;const t={name:n.trim(),model:apiModelInput.value.trim(),temperature:parseFloat(apiTempInput.value),systemPrompt:apiSystemInput.value.trim(),userPrompt:apiUserInput.value.trim()};customTemplates.push(t);localStorage.setItem('customTemplates',JSON.stringify(customTemplates));renderCustomTemplates();alert('模板保存成功！')}
function loadCustomTemplates(){const t=localStorage.getItem('customTemplates');if(t){customTemplates=JSON.parse(t)}renderCustomTemplates()}
function deleteCustomTemplate(i){if(confirm(`确定要删除模板 "${customTemplates[i].name}" 吗？`)){customTemplates.splice(i,1);localStorage.setItem('customTemplates',JSON.stringify(customTemplates));renderCustomTemplates()}}
function exportTemplateAsTxt(){const c=`[Model]\n${apiModelInput.value.trim()}\n\n[Temperature]\n${apiTempInput.value}\n\n[System Role Content]\n${apiSystemInput.value.trim()}\n\n[User Role Content]\n${apiUserInput.value.trim()}\n`;downloadFile(c,`template_${apiModelInput.value}_${Date.now()}.txt`,'text/plain;charset=utf-8;')}
function importTemplateFromFile(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(evt)=>{const c=evt.target.result;try{const m=c.match(/\[Model\]\s*([\s\S]*?)(?=\s*\[Temperature\])/)?.[1].trim();const t=c.match(/\[Temperature\]\s*([\s\S]*?)(?=\s*\[System Role Content\])/)?.[1].trim();const s=c.match(/\[System Role Content\]\s*([\s\S]*?)(?=\s*\[User Role Content\])/)?.[1].trim();const u=c.match(/\[User Role Content\]\s*([\s\S]*)$/)?.[1].trim();if(m&&t&&s&&u){const n=prompt("请为导入的模板命名:",f.name.replace(/\.[^/.]+$/,""));if(n&&n.trim()){const p={name:n.trim(),model:m,temperature:parseFloat(t),systemPrompt:s,userPrompt:u};customTemplates.push(p);localStorage.setItem('customTemplates',JSON.stringify(customTemplates));renderCustomTemplates();loadTemplate(p);alert('模板导入并加载成功！')}else{alert('导入已取消。')}}else{throw new Error('文件格式不正确，缺少必要的字段。')}}catch(err){alert(`模板导入失败: ${err.message}`)}finally{e.target.value=''}};r.readAsText(f)}

// =================================================================================
// 功能一：生成请求 (动态列配置)
// =================================================================================
function renderDynamicColumnSelectors(count) {
    const container = document.getElementById('gen-dynamic-fields-container');
    container.innerHTML = '';
    const headers = gen_currentSheetData && gen_currentSheetData.length > 0 ? gen_currentSheetData[0] : [];
    for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'config-item';
        const label = document.createElement('label');
        label.htmlFor = `gen-field-${i}-col`;
        label.textContent = `{{field_${i}}} 对应列:`;
        const wrapper = document.createElement('div');
        wrapper.className = 'input-wrapper';
        const select = document.createElement('select');
        select.id = `gen-field-${i}-col`;
        
        headers.forEach((hdr, idx) => {
            if (hdr) {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = hdr;
                select.appendChild(opt);
            }
        });
        
        wrapper.appendChild(select);
        div.appendChild(label);
        div.appendChild(wrapper);
        container.appendChild(div);
    }
}
function processDataForJsonl() {
    if (!gen_currentSheetData || gen_currentSheetData.length < 2) return alert('没有可处理的数据行。');
    let requests = [];
    const dataRows = gen_currentSheetData.slice(1);
    const numFields = parseInt(document.getElementById('gen-num-fields').value, 10);

    dataRows.forEach((row, rowIndex) => {
        let request = {
            custom_id: `request-${rowIndex}`,
            method: "POST",
            url: "/v4/chat/completions",
            body: {
                model: apiModelInput.value.trim(),
                messages: [
                    { role: "system", content: apiSystemInput.value.trim() },
                    { role: "user", content: apiUserInput.value.trim() }
                ],
                temperature: parseFloat(apiTempInput.value)
            }
        };

        let userPromptContent = request.body.messages[1].content;
        for (let i = 1; i <= numFields; i++) {
            const selector = document.getElementById(`gen-field-${i}-col`);
            if (!selector) continue;
            const colIndex = selector.value;
            const cellData = (row[colIndex] || "").toString().trim();
            const placeholder = `{{field_${i}}}`;
            userPromptContent = userPromptContent.replace(new RegExp(placeholder, 'g'), cellData.replace(/"/g, '\\"'));
        }
        request.body.messages[1].content = userPromptContent;
        requests.push(request);
    });

    gen_jsonlContent = requests.map(q => JSON.stringify(q)).join('\n');
    const preview = requests.slice(0, 3).map(q => `<div class="preview-item">${JSON.stringify(q, null, 2)}</div>`).join('');
    document.getElementById('gen-preview-output').innerHTML = preview || "没有生成任何数据。";
    document.getElementById('gen-preview-area').style.display = 'block';
    if (requests.length > 0) {
        if(window.addLog) addLog('请求文件内容已在内存中生成，可以进行下一步上传操作。', 'success');
    }
}


// =================================================================================
// 功能二：批量请求 (无缝数据流)
// =================================================================================
const batchLog = document.getElementById('batch_log');
const btnUpload = document.getElementById('batch_step1_upload');
const btnCreate = document.getElementById('batch_step2_create');
const btnCheck = document.getElementById('batch_step3_check');
const btnDownload = document.getElementById('batch_step4_download');

function addLog(message, type = 'info') { const entry = document.createElement('div'); entry.className = `log-entry ${type}`; entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`; batchLog.appendChild(entry); batchLog.scrollTop = batchLog.scrollHeight; }
async function apiCall(endpoint, body) { if (!BACKEND_URL) { alert("错误：后端URL未配置！请联系管理员。"); return null; } try { const response = await fetch(`${BACKEND_URL}${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); const result = await response.json(); if (!result.success) { throw new Error(result.error); } return result.data; } catch (error) { addLog(`请求失败: ${error.message}`, 'error'); console.error(`API Call Error to ${endpoint}:`, error); return null; } }
async function runStep1_Upload() { addLog('开始执行步骤1：上传请求文件...'); if (!gen_jsonlContent) { addLog('错误：请先在【功能一】中生成请求文件内容。', 'error'); return; } const apiKey = document.getElementById('batch_api_key_input').value.trim(); if (!apiKey) { addLog('错误：请输入API Key。', 'error'); return; } this.disabled = true; const data = await apiCall('/api/upload', { apiKey: apiKey, jsonlContent: gen_jsonlContent, fileName: `patent_requests_${Date.now()}.jsonl` }); this.disabled = false; if (data) { batch_fileId = data.fileId; addLog(`成功: ${data.message}`, 'success'); addLog(`获取到 File ID: ${batch_fileId}`); btnCreate.disabled = false; } }
async function runStep2_Create() { addLog('开始执行步骤2：创建Batch任务...'); const apiKey = document.getElementById('batch_api_key_input').value.trim(); if (!apiKey || !batch_fileId) { addLog('错误：API Key 或 File ID 缺失。', 'error'); return; } this.disabled = true; const data = await apiCall('/api/create_batch', { apiKey, fileId: batch_fileId }); this.disabled = false; if (data) { batch_batchId = data.id; addLog(`成功: Batch任务创建成功！`, 'success'); addLog(`获取到 Batch ID: ${batch_batchId}`); addLog(`任务当前状态: ${data.status}`); btnCheck.disabled = false; } }
async function runStep3_Check() { addLog('开始执行步骤3：检查任务状态...'); const apiKey = document.getElementById('batch_api_key_input').value.trim(); if (!apiKey || !batch_batchId) { addLog('错误：API Key 或 Batch ID 缺失。', 'error'); return; } this.disabled = true; const data = await apiCall('/api/check_status', { apiKey, batchId: batch_batchId }); this.disabled = false; if (data) { addLog(`任务状态: ${data.status}`, data.status === 'completed' ? 'success' : 'info'); if (data.status === 'completed') { batch_outputFileId = data.output_file_id; batch_errorFileId = data.error_file_id; addLog(`任务完成! Output File ID: ${batch_outputFileId}`, 'success'); if(batch_errorFileId) addLog(`错误文件 ID: ${batch_errorFileId}`); btnDownload.disabled = false; } else if (['failed', 'expired', 'cancelled'].includes(data.status)) { addLog(`任务失败或已终止。`, 'error'); } else { addLog(`任务仍在进行中，请稍后重试。`); } } }
async function runStep4_Download() {
    addLog('开始执行步骤4：获取结果文件内容...');
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey || !batch_outputFileId) { addLog('错误：API Key 或 Output File ID 缺失。', 'error'); return; }
    
    this.disabled = true;
    const data = await apiCall('/api/download_result', { apiKey, fileId: batch_outputFileId });
    this.disabled = false;

    if (data && data.fileContent) {
        rep_jsonlData = data.fileContent; // **核心：将结果内容存入全局变量**
        addLog('成功获取结果内容!', 'success');
        addLog('现在可以前往【功能三】，上传您的原始Excel文件以生成最终报告。');
        updateReporterDataStatus();
    } else {
        addLog('未能从后端获取结果文件内容。', 'error');
    }
}

// =================================================================================
// 功能三：解析结果 (鲁棒排序 & 无缝/手动双模式)
// =================================================================================
function handleJsonlUpload(e) { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(evt)=>{ rep_jsonlData=evt.target.result; addLogToReporter('手动上传的JSONL文件已加载。','success'); updateReporterDataStatus(); }; r.readAsText(f); }
function updateReporterDataStatus() { const statusDiv = document.getElementById('reporter-data-status'); if (rep_jsonlData) { statusDiv.textContent = '✓ 结果文件已加载，请上传原始Excel文件进行解析。'; statusDiv.style.display = 'block'; statusDiv.style.borderColor = 'var(--success-color)'; } else { statusDiv.textContent = '尚未加载结果文件。请从功能二获取或手动上传。'; statusDiv.style.display = 'block'; statusDiv.style.borderColor = 'var(--error-color)'; } }
function addLogToReporter(message, type = 'info') { const statusLog = document.getElementById('rep-status-log'); statusLog.textContent += `${message}\n`; }
function previewReport(){
    if(!rep_sheetData){ return alert('请先上传原始Excel文件并选择工作表。'); }
    if(!rep_jsonlData){ updateReporterDataStatus(); return alert('请先加载结果文件（通过功能二获取或手动上传）。'); }

    const statusArea = document.getElementById('rep-status-area'), statusLog = document.getElementById('rep-status-log');
    statusArea.style.display='block'; statusLog.textContent='开始处理和生成预览...\n';
    
    try {
        const resultsMap = new Map();
        rep_jsonlData.split('\n').forEach(line => {
            if (line.trim() === '') return;
            try {
                const entry = JSON.parse(line);
                const customId = entry.custom_id;
                const match = customId.match(/request-(\d+)/);
                if (match) {
                    const rowIndex = parseInt(match[1], 10);
                    const content = entry.response?.body?.choices?.[0]?.message?.content;
                    if (content) {
                        let parsedContent;
                        try {
                            const cleanContent = content.replace(/^```json\s*|```\s*$/g, '').trim();
                            parsedContent = JSON.parse(cleanContent);
                        } catch (jsonError) {
                            parsedContent = {"解析失败的原始回应": content};
                        }
                        resultsMap.set(rowIndex, parsedContent);
                    }
                }
            } catch (lineError) { console.warn("Skipping invalid JSONL line:", line, lineError); }
        });
        addLogToReporter(`JSONL文件解析完毕，共找到 ${resultsMap.size} 条有效结果。`);

        const idColIndex = document.getElementById('rep-select-id-col').value;
        const originalHeaders = rep_sheetData[0];
        const originalDataRows = rep_sheetData.slice(1);
        
        let finalData = [];
        let outputHeadersSet = new Set([originalHeaders[idColIndex]]);
        
        // First pass to determine all possible headers from results
        resultsMap.forEach(result => {
            Object.keys(result).forEach(key => outputHeadersSet.add(key));
        });
        rep_outputHeaders = Array.from(outputHeadersSet);
        addLogToReporter(`已识别并设定报告列: ${rep_outputHeaders.slice(1).join(', ')}`);

        // Second pass to build data, ensuring order and gaps
        originalDataRows.forEach((row, index) => {
            let outputRow = {};
            // Initialize all header columns with empty string
            rep_outputHeaders.forEach(h => outputRow[h] = '');

            // Fill the ID column
            outputRow[originalHeaders[idColIndex]] = row[idColIndex] || `Row-${index + 2}`;
            
            // If result exists for this row, fill the data
            if (resultsMap.has(index)) {
                const resultData = resultsMap.get(index);
                for (const key in resultData) {
                    if (outputRow.hasOwnProperty(key)) {
                        let value = resultData[key];
                        if (Array.isArray(value)) value = value.join('; ');
                        if (typeof value === 'string') value = value.replace(/\\n|\n/g, ' ').replace(/\s+/g, ' ').trim();
                        outputRow[key] = value;
                    }
                }
            }
            finalData.push(outputRow);
        });

        rep_finalOutputData = finalData;
        addLogToReporter('数据匹配完成，正在生成预览...');
        const previewContent = rep_finalOutputData.slice(0, 5).map(row => `<div class="preview-item">${JSON.stringify(row, null, 2)}</div>`).join('');
        document.getElementById('rep-preview-output').innerHTML = previewContent || "没有可预览的数据。";
        document.getElementById('rep-preview-area').style.display='block';
        if(rep_finalOutputData.length > 0) {
            document.getElementById('rep-download-btn').style.display = 'inline-block';
        }
        addLogToReporter('预览已生成。确认无误后可点击下载完整报告。');
    } catch(e) {
        addLogToReporter(`发生严重错误: ${e.message}\n请检查文件格式或控制台输出。`, 'error');
        console.error("Error during report preview generation:", e);
    }
}
function downloadReport(){ if(!rep_finalOutputData||rep_finalOutputData.length===0){alert('没有可下载的数据。');return} addLogToReporter('\n开始生成并下载Excel文件...'); try{ const ws=XLSX.utils.json_to_sheet(rep_finalOutputData,{header:rep_outputHeaders}); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'分析报告'); const excelBuffer=XLSX.write(wb,{bookType:'xlsx',type:'array'}); downloadFile(new Blob([excelBuffer]),`patent_report_${Date.now()}.xlsx`,'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'); addLogToReporter('报告生成成功并已开始下载！','success');}catch(e){addLogToReporter(`下载Excel时发生错误: ${e.message}`,'error');console.error("Error during report download:",e)}}

// =================================================================================
// 通用UI和文件处理函数
// =================================================================================
function switchTab(t){document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));document.getElementById(t+'-tab').classList.add('active');document.querySelector(`.tab-button[onclick="switchTab('${t}')"]`).classList.add('active');if(t==='reporter')updateReporterDataStatus()}
function handleFileSelect(e,p){const f=e.target.files[0];if(!f)return;const s=document.getElementById(`${p}-sheet-selection-area`),c=document.getElementById(`${p}-column-config-area`)||document.getElementById(`${p}-config-area`);s.style.display='none';c.style.display='none';const r=new FileReader();r.onload=function(evt){const d=new Uint8Array(evt.target.result),w=XLSX.read(d,{type:'array'});if(p==='gen'){gen_workbook=w}else{rep_workbook=w}const n=w.SheetNames;if(n.length===1){loadSheet(n[0],p)}else{displaySheetSelection(n,p)}};r.readAsArrayBuffer(f)}
function displaySheetSelection(n,p){const l=document.getElementById(`${p}-sheet-list`),a=document.getElementById(`${p}-sheet-selection-area`);l.innerHTML='';n.forEach(name=>{const b=document.createElement('button');b.textContent=name;b.className='preset-button';b.style.margin='5px';b.onclick=()=>loadSheet(name,p);l.appendChild(b)});a.style.display='block'}
function loadSheet(s,p){const w=(p==='gen')?gen_workbook:rep_workbook,k=w.Sheets[s],d=XLSX.utils.sheet_to_json(k,{header:1});if(d.length>0&&d[0].length>0){if(p==='gen'){gen_currentSheetData=d;document.getElementById('gen-column-config-area').style.display='block';renderDynamicColumnSelectors(document.getElementById('gen-num-fields').value);}else{rep_sheetData=d;document.getElementById('rep-config-area').style.display='block'}populateColumnSelectors(d[0],p);const l=document.getElementById(`${p}-sheet-list`);if(l.children.length>0){Array.from(l.children).forEach(b=>{b.style.backgroundColor=b.textContent===s?'var(--primary-hover-color)':'var(--primary-color)'})}}else{alert(`工作表 "${s}" 中没有数据或表头为空。`)}}
function populateColumnSelectors(h,p){const selIds = p === 'gen' ? ['gen-select-id-col'] : ['rep-select-id-col']; selIds.forEach(id=>{const l=document.getElementById(id);if(l){l.innerHTML='';h.forEach((hdr,i)=>{if(hdr){const o=document.createElement('option');o.value=i;o.textContent=hdr;l.appendChild(o)}})}});
function downloadFile(c,f,t){const b=new Blob([c],{type:t}),l=document.createElement("a");l.href=URL.createObjectURL(b);l.download=f;l.style.visibility='hidden';document.body.appendChild(l);l.click();document.body.removeChild(l)}
</script>
</body>
</html>
