<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专利分析智能工作台 v4.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #28a745; --primary-hover-color: #218838; --primary-dark-color: #1e7e34;
            --background-color: #f4f8f5; --container-bg-color: #ffffff; --border-color: #dce5dd;
            --text-color: #333; --light-info-bg: #e9f5ec; --white-glow-color: rgba(255, 255, 255, 0.8);
            --code-bg-color: #2d2d2d; --code-text-color: #e6e6e6; --error-color: #dc3545; --success-color: #28a745;
            --secondary-button-bg: #6c757d; --secondary-button-hover-bg: #5a6268;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; line-height: 1.6; color: var(--text-color); background-color: var(--background-color); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: var(--container-bg-color); padding: 0; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: hidden; }
        .app-banner { display: flex; flex-direction: column; align-items: center; padding: 15px 20px; background-color: var(--primary-dark-color); color: #fff; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .banner-text-logo { font-family: 'Orbitron', sans-serif; font-size: 2.8rem; font-weight: 900; margin: 0; padding: 0; letter-spacing: 4px; background: linear-gradient(145deg, #ffffff, #e0ffe8); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 6px var(--white-glow-color), 0 0 15px rgba(255, 255, 255, 0.5); }
        .copyright-info { margin-top: 8px; display: flex; flex-direction: column; align-items: center; font-size: 11px; font-weight: normal; color: rgba(255, 255, 255, 0.7); }
        .version-number { font-size: 10px; opacity: 0.8; margin-top: 2px; }
        .main-content { padding: 25px; }
        .tab-container { border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-button { background-color: transparent; border: 1px solid transparent; border-bottom: none; padding: 10px 20px; cursor: pointer; font-size: 1.1em; border-radius: 5px 5px 0 0; color: #495057; }
        .tab-button.active { background-color: var(--container-bg-color); border-color: var(--border-color); border-bottom: 1px solid var(--container-bg-color); margin-bottom: -1px; font-weight: bold; color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .step { margin-bottom: 25px; padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; background-color: #ffffff; }
        .step-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #495057; }
        input[type="file"] { border: 1px solid #ccc; display: inline-block; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; text-align: center; margin: 4px; }
        button:hover { background-color: var(--primary-hover-color); }
        button:disabled { background-color: #a0c7af; cursor: not-allowed; }
        .action-button { min-width: 200px; display: inline-block; }
        .secondary-button { background-color: var(--secondary-button-bg); } .secondary-button:hover { background-color: var(--secondary-button-hover-bg); }
        .config-item { margin-bottom: 15px; display: flex; align-items: flex-start; }
        .config-item label { display: inline-block; width: 170px; font-weight: 500; flex-shrink: 0; padding-top: 8px; }
        .config-item .input-wrapper { width: 100%; }
        .config-item select, .config-item input, .config-item textarea { padding: 8px; border-radius: 4px; border: 1px solid #ced4da; width: 100%; box-sizing: border-box; }
        .preview-output { background-color: var(--code-bg-color); color: var(--code-text-color); padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-family: "Courier New", Courier, monospace; white-space: pre-wrap; word-break: break-all; }
        .info { font-size: 0.9em; color: var(--primary-dark-color); margin-top: 15px; background-color: var(--light-info-bg); padding: 10px; border-radius: 4px; border-left: 4px solid var(--primary-color); }
        details { border: 1px solid var(--border-color); border-radius: 5px; margin-top: 25px; background-color: #fafdfb; }
        summary { font-size: 1.2em; font-weight: bold; color: #495057; padding: 15px 20px; cursor: pointer; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: '▶ '; font-size: 0.8em; margin-right: 8px; transition: transform 0.2s; display: inline-block; }
        details[open] > summary::before { transform: rotate(90deg); }
        #batch_log { margin-top: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 4px; min-height: 100px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; font-family: monospace; }
        .log-entry.error { color: var(--error-color); } .log-entry.success { color: var(--success-color); font-weight: bold; }
        #custom-templates-container { margin-top: 10px; padding: 10px; border: 1px dashed var(--border-color); border-radius: 4px; }
        .template-button { margin: 5px; } .delete-template-btn { background-color: #dc3545; color: white; border: none; padding: 2px 6px; font-size: 12px; border-radius: 50%; cursor: pointer; margin-left: 8px; }
    </style>
</head>
<body>

<div class="container">
    <header class="app-banner">
        <h1 class="banner-text-logo">ALFRED X IP</h1>
        <div class="copyright-info">
            <span>Copyright © 2025 Alfred Shi 保留所有权利.</span>
            <span class="version-number">版本号: v4.0 (集成增强版)</span>
        </div>
    </header>

    <div class="main-content">
        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('generator')">功能一：生成请求文件</button>
            <button class="tab-button" onclick="switchTab('batch')">功能二：批量请求与结果获取</button>
            <button class="tab-button" onclick="switchTab('reporter')">功能三：解析结果生成报告</button>
        </div>

        <!-- 功能一: 生成请求文件 -->
        <div id="generator-tab" class="tab-content active">
            <div class="step">
                <div class="step-header">第一步：上传原始Excel文件</div>
                <input type="file" id="gen-excel-input" accept=".xlsx, .xls">
                <p class="info">此步骤上传的文件数据将被缓存，用于【功能二】的自动分析流程。</p>
            </div>
            <div class="step" id="gen-sheet-selection-area" style="display:none;">
                <div class="step-header">第二步：选择要处理的工作表(Sheet)</div>
                <div id="gen-sheet-list"></div>
            </div>
            <!-- **核心修改**: 配置数据列区域 -->
            <div class="step" id="gen-column-config-area" style="display:none;">
                <div class="step-header">第三步：配置数据列</div>
                <div class="config-item"><label for="gen-select-id-col">专利号所在列:</label><select id="gen-select-id-col"></select></div>
                <div class="config-item">
                    <label for="gen-num-analysis-cols">选择分析列数量:</label>
                    <input type="number" id="gen-num-analysis-cols" value="2" min="1" max="10" style="width: 80px;">
                </div>
                <div id="gen-dynamic-cols-container"></div>
                <p class="info">请在下方的API模板中，使用 <code>{{column_1}}</code>, <code>{{column_2}}</code> ... 等占位符来引用您在此处选择的分析列。</p>
                <br>
                <button id="gen-process-btn" class="action-button">处理并预览</button>
            </div>
            <div class="step" id="gen-preview-area" style="display:none;">
                <div class="step-header">第四步：预览生成的数据（最多显示前3条）</div>
                <pre class="preview-output" id="gen-preview-output"></pre>
            </div>
            <!-- **核心修改**: API模板配置 -->
            <details open>
                <summary>API模板配置 (点击展开/收起)</summary>
                <div class="details-content" style="padding: 20px;">
                    <div><strong>预设模板:</strong><div id="preset-buttons-container" style="margin-top: 10px;"></div></div>
                    <hr style="margin: 20px 0;">
                    <div><strong>自定义模板:</strong><div id="custom-templates-container"></div></div>
                    <div style="margin-top: 15px;">
                        <button id="save-template-btn" class="secondary-button">保存当前为新模板</button>
                        <button id="import-template-btn" class="secondary-button">导入模板</button>
                        <input type="file" id="template-file-input" style="display:none" accept=".json">
                        <button id="export-template-btn" class="secondary-button">导出自定义模板</button>
                    </div>
                    <hr style="margin: 20px 0;">
                    <div class="config-item"><label for="api-model">Model:</label><div class="input-wrapper"><input type="text" id="api-model"></div></div>
                    <div class="config-item"><label for="api-temperature">Temperature:</label><div class="input-wrapper"><input type="number" id="api-temperature" step="0.1"></div></div>
                    <div class="config-item"><label for="api-system-prompt">System Role:</label><div class="input-wrapper"><textarea id="api-system-prompt" rows="4"></textarea></div></div>
                    <div class="config-item"><label for="api-user-prompt">User Role:</label><div class="input-wrapper"><textarea id="api-user-prompt" rows="8"></textarea></div></div>
                </div>
            </details>
        </div>
        
        <!-- 功能二: 批量请求 -->
        <div id="batch-tab" class="tab-content">
            <div class="step">
                <div class="step-header">准备工作：输入您的API Key</div>
                <div class="config-item"><label for="batch_api_key_input">API Key:</label><div class="input-wrapper"><input type="password" id="batch_api_key_input" placeholder="请在此处粘贴您的API Key"></div></div>
            </div>
            <div class="step">
                <div class="step-header">批量任务工作流</div>
                <p>请按照1-3的顺序执行。任务完成后，您可以选择“下载并直接分析”或手动下载结果。</p>
                <button id="batch_step1_upload" class="action-button">1. 上传请求文件</button>
                <button id="batch_step2_create" class="action-button" disabled>2. 创建Batch任务</button>
                <button id="batch_step3_check" class="action-button" disabled>3. 检查任务状态</button>
            </div>
             <div class="step">
                <div class="step-header">任务完成：获取结果</div>
                <!-- **核心修改**: 新增直接分析按钮 -->
                <button id="batch_step4_analyze" class="action-button" disabled>下载并直接分析</button>
                <p class="info">点击“下载并直接分析”将自动获取结果并跳转到【功能三】进行解析。您也可以选择手动上传结果文件。</p>
             </div>
            <div class="step">
                <div class="step-header">执行日志与结果</div>
                <div id="batch_log">等待操作...</div>
            </div>
        </div>

        <!-- 功能三: 解析报告 -->
        <div id="reporter-tab" class="tab-content">
            <div class="step">
                <div class="step-header">第一步：上传文件 (手动模式)</div>
                <p>如果您在【功能二】中选择了“下载并直接分析”，则无需在此手动上传。</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label for="rep-excel-input"><strong>1. 原始Excel文件</strong></label><br>
                        <input type="file" id="rep-excel-input" accept=".xlsx, .xls" style="width: 100%;">
                    </div>
                    <div>
                        <label for="rep-jsonl-input"><strong>2. API返回的JSONL结果文件</strong></label><br>
                        <input type="file" id="rep-jsonl-input" accept=".jsonl" style="width: 100%;">
                    </div>
                </div>
            </div>
            <div class="step" id="rep-sheet-selection-area" style="display:none;">
                <div class="step-header">第二步：选择原始数据工作表(Sheet)</div>
                <div id="rep-sheet-list"></div>
            </div>
            <div class="step" id="rep-config-area" style="display:none;">
                <div class="step-header">第三步：确认配置并生成报告</div>
                <div class="config-item"><label for="rep-select-id-col">确认专利号所在列:</label><select id="rep-select-id-col"></select></div>
                <button id="rep-process-btn" class="action-button">生成并预览报告</button>
            </div>
            <div class="step" id="rep-preview-area" style="display:none;">
                <div class="step-header">第四步：预览与下载</div>
                <pre class="preview-output" id="rep-preview-output"></pre><br>
                <button id="rep-download-btn" class="action-button" style="display:none;">下载完整Excel报告</button>
            </div>
            <div class="step" id="rep-status-area" style="display:none;">
                <div class="step-header">处理状态日志</div>
                <pre id="rep-status-log" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>
</div>

<script>
// --- 全局配置 ---
const BACKEND_URL = 'https://patent-workbench-frontend.onrender.com/'; // 本地开发URL
const PRESET_TEMPLATES = [
    { name: "核心发明点提取", model: "glm-4-flash", temperature: 0.4, systemPrompt: "你是一位资深专利技术分析专家，任务是精准、客观、精炼地从专利的摘要和权利要求中提取核心发明点。请以JSON格式输出，包含三个字段：'technical_problem'（所解决的技术问题）、'technical_solution'（技术方案关键特征）、'beneficial_effects'（有益效果）。", userPrompt: "请根据以下专利信息提取核心发明点。\n\n摘要：\n{{column_1}}\n\n权利要求：\n{{column_2}}" },
    { name: "摘要和权要翻译", model: "glm-4-flash", temperature: 0.1, systemPrompt: "你是一个专业的科技文献翻译引擎，请将用户提供的文本翻译成流畅、专业的英文。请以JSON格式输出，包含两个字段：'abstract_en'（摘要的英文翻译）和'claims_en'（权利要求的英文翻译）。", userPrompt: "请将以下内容翻译成英文。\n\n摘要原文：\n{{column_1}}\n\n权利要求原文：\n{{column_2}}" }
];

// --- 全局变量 ---
let gen_workbook = null, gen_currentSheetData = null, gen_jsonlContent = "", gen_headers = [];
let rep_workbook = null, rep_sheetData = null, rep_jsonlData = null, rep_finalOutputData = [], rep_outputHeaders = [];
let batch_fileId = null, batch_batchId = null, batch_outputFileId = null;

// DOM 元素引用
const apiModelInput = document.getElementById('api-model'), apiTempInput = document.getElementById('api-temperature'),
      apiSystemInput = document.getElementById('api-system-prompt'), apiUserInput = document.getElementById('api-user-prompt');

// =================================================================================
// 初始化
// =================================================================================
document.addEventListener('DOMContentLoaded', () => {
    // 功能一
    document.getElementById('gen-excel-input').addEventListener('change', (e) => handleFileSelect(e, 'gen'));
    document.getElementById('gen-num-analysis-cols').addEventListener('change', updateDynamicColumns);
    document.getElementById('gen-process-btn').addEventListener('click', processDataForJsonl);
    // 模板
    createPresetButtons();
    loadCustomTemplates();
    loadPreset(0);
    document.getElementById('save-template-btn').addEventListener('click', saveCustomTemplate);
    document.getElementById('import-template-btn').addEventListener('click', () => document.getElementById('template-file-input').click());
    document.getElementById('template-file-input').addEventListener('change', importTemplates);
    document.getElementById('export-template-btn').addEventListener('click', exportTemplates);
    
    // 功能二
    document.getElementById('batch_step1_upload').addEventListener('click', runStep1_Upload);
    document.getElementById('batch_step2_create').addEventListener('click', runStep2_Create);
    document.getElementById('batch_step3_check').addEventListener('click', runStep3_Check);
    document.getElementById('batch_step4_analyze').addEventListener('click', runStep4_Analyze);

    // 功能三
    document.getElementById('rep-excel-input').addEventListener('change', (e) => handleFileSelect(e, 'rep'));
    document.getElementById('rep-jsonl-input').addEventListener('change', (e) => {
        const f = e.target.files[0]; if (!f) return;
        const r = new FileReader();
        r.onload = (e) => { rep_jsonlData = e.target.result; };
        r.readAsText(f);
    });
    document.getElementById('rep-process-btn').addEventListener('click', previewReport);
    document.getElementById('rep-download-btn').addEventListener('click', downloadReport);
});

// =================================================================================
// 通用函数
// =================================================================================
function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.getElementById(`${tabId}-tab`).classList.add('active');
    document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`).classList.add('active');
}

async function apiCall(endpoint, body) {
    const logContainer = document.getElementById('batch_log');
    try {
        const response = await fetch(`${BACKEND_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const result = await response.json();
        if (!result.success) { throw new Error(result.error); }
        return result.data;
    } catch (error) {
        addLog(`请求失败: ${error.message}`, 'error');
        return null;
    }
}

function addLog(message, type = 'info') {
    const logContainer = document.getElementById('batch_log');
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    logContainer.appendChild(entry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// =================================================================================
// 功能一: 生成请求文件 + 模板管理 + 动态列
// =================================================================================
function handleFileSelect(e, prefix) {
    const file = e.target.files[0];
    if (!file) return;
    const sheetArea = document.getElementById(`${prefix}-sheet-selection-area`);
    const configArea = document.getElementById(`${prefix}-column-config-area`) || document.getElementById(`${prefix}-config-area`);
    sheetArea.style.display = 'none';
    configArea.style.display = 'none';

    const reader = new FileReader();
    reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        if (prefix === 'gen') {
            gen_workbook = workbook;
        } else {
            rep_workbook = workbook;
        }
        const sheetNames = workbook.SheetNames;
        if (sheetNames.length === 1) {
            loadSheet(sheetNames[0], prefix);
        } else {
            displaySheetSelection(sheetNames, prefix);
        }
    };
    reader.readAsArrayBuffer(file);
}

function displaySheetSelection(sheetNames, prefix) {
    const listDiv = document.getElementById(`${prefix}-sheet-list`);
    const area = document.getElementById(`${prefix}-sheet-selection-area`);
    listDiv.innerHTML = '';
    sheetNames.forEach(name => {
        const button = document.createElement('button');
        button.textContent = name;
        button.onclick = () => loadSheet(name, prefix);
        listDiv.appendChild(button);
    });
    area.style.display = 'block';
}

function loadSheet(sheetName, prefix) {
    const workbook = (prefix === 'gen') ? gen_workbook : rep_workbook;
    const worksheet = workbook.Sheets[sheetName];
    const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    
    if (data.length > 0 && data[0].length > 0) {
        const headers = data[0];
        if (prefix === 'gen') {
            gen_currentSheetData = data;
            gen_headers = headers;
            document.getElementById('gen-column-config-area').style.display = 'block';
            populateColumnSelectors(headers, 'gen-select-id-col');
            updateDynamicColumns();
        } else {
            rep_sheetData = data;
            document.getElementById('rep-config-area').style.display = 'block';
            populateColumnSelectors(headers, 'rep-select-id-col');
        }
        
        const listDiv = document.getElementById(`${prefix}-sheet-list`);
        if (listDiv.children.length > 0) {
            Array.from(listDiv.children).forEach(b => {
                b.style.fontWeight = b.textContent === sheetName ? 'bold' : 'normal';
            });
        }
    } else {
        alert(`工作表 "${sheetName}" 中没有数据。`);
    }
}

function populateColumnSelectors(headers, selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    headers.forEach((header, index) => {
        if (header) {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = header;
            select.appendChild(option);
        }
    });
}

function updateDynamicColumns() {
    const count = parseInt(document.getElementById('gen-num-analysis-cols').value, 10);
    const container = document.getElementById('gen-dynamic-cols-container');
    container.innerHTML = '';
    for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'config-item';
        const label = document.createElement('label');
        label.textContent = `分析列 ${i} ({{column_${i}}}):`;
        const select = document.createElement('select');
        select.id = `gen-select-dynamic-col-${i}`;
        select.className = 'dynamic-col-select';
        gen_headers.forEach((header, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = header;
            select.appendChild(option);
        });
        div.appendChild(label);
        div.appendChild(select);
        container.appendChild(div);
    }
}

function processDataForJsonl() {
    if (!gen_currentSheetData || gen_currentSheetData.length < 2) {
        return alert('没有可处理的数据行。');
    }
    const dynamicColSelects = document.querySelectorAll('.dynamic-col-select');
    let requests = [];
    const dataRows = gen_currentSheetData.slice(1);

    dataRows.forEach((row, index) => {
        let userPromptContent = apiUserInput.value.trim();
        dynamicColSelects.forEach((select, i) => {
            const colIndex = select.value;
            const cellValue = row[colIndex] || "";
            const placeholder = new RegExp(`{{column_${i + 1}}}`, 'g');
            userPromptContent = userPromptContent.replace(placeholder, cellValue.toString().replace(/"/g, '\\"'));
        });

        let req = {
            custom_id: `request-${index}`,
            method: "POST",
            url: "/v4/chat/completions",
            body: {
                model: apiModelInput.value.trim(),
                messages: [
                    { role: "system", content: apiSystemInput.value.trim() },
                    { role: "user", content: userPromptContent }
                ],
                temperature: parseFloat(apiTempInput.value)
            }
        };
        requests.push(req);
    });

    gen_jsonlContent = requests.map(q => JSON.stringify(q)).join('\n');
    const preview = requests.slice(0, 3).map(q => `<div class="preview-item">${JSON.stringify(q, null, 2)}</div>`).join('');
    document.getElementById('gen-preview-output').innerHTML = preview || "没有生成任何数据。";
    document.getElementById('gen-preview-area').style.display = 'block';
    if (requests.length > 0) {
        addLog('请求文件内容已在内存中生成，可以进行下一步上传操作。', 'success');
    }
}

// --- Template Management ---
function createPresetButtons() {
    const container = document.getElementById('preset-buttons-container');
    PRESET_TEMPLATES.forEach((template, index) => {
        const button = document.createElement('button');
        button.textContent = template.name;
        button.className = 'template-button';
        button.onclick = () => loadPreset(index);
        container.appendChild(button);
    });
}
function loadPreset(index) {
    const template = PRESET_TEMPLATES[index];
    if (!template) return;
    apiModelInput.value = template.model;
    apiTempInput.value = template.temperature;
    apiSystemInput.value = template.systemPrompt;
    apiUserInput.value = template.userPrompt;
}
function loadCustomTemplates() {
    const templates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
    const container = document.getElementById('custom-templates-container');
    container.innerHTML = '';
    templates.forEach((template, index) => {
        const button = document.createElement('button');
        button.textContent = template.name;
        button.className = 'template-button';
        button.onclick = () => {
            apiModelInput.value = template.model;
            apiTempInput.value = template.temperature;
            apiSystemInput.value = template.systemPrompt;
            apiUserInput.value = template.userPrompt;
        };
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'x';
        deleteBtn.className = 'delete-template-btn';
        deleteBtn.title = '删除此模板';
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteCustomTemplate(index); };
        button.appendChild(deleteBtn);
        container.appendChild(button);
    });
}
function saveCustomTemplate() {
    const name = prompt("请输入新模板的名称:");
    if (!name) return;
    const newTemplate = {
        name,
        model: apiModelInput.value,
        temperature: apiTempInput.value,
        systemPrompt: apiSystemInput.value,
        userPrompt: apiUserInput.value
    };
    const templates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
    templates.push(newTemplate);
    localStorage.setItem('customTemplates', JSON.stringify(templates));
    loadCustomTemplates();
}
function deleteCustomTemplate(index) {
    if (!confirm("确定要删除这个模板吗？")) return;
    const templates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
    templates.splice(index, 1);
    localStorage.setItem('customTemplates', JSON.stringify(templates));
    loadCustomTemplates();
}
function exportTemplates() {
    const templates = localStorage.getItem('customTemplates') || '[]';
    const blob = new Blob([templates], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'patent_templates.json';
    a.click();
    URL.revokeObjectURL(url);
}
function importTemplates(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) throw new Error("文件格式不正确，应为JSON数组。");
            const existing = JSON.parse(localStorage.getItem('customTemplates') || '[]');
            const combined = existing.concat(imported); // Simple merge, can be improved with duplicate checks
            localStorage.setItem('customTemplates', JSON.stringify(combined));
            loadCustomTemplates();
            alert("模板导入成功！");
        } catch (err) {
            alert(`导入失败: ${err.message}`);
        }
    };
    reader.readAsText(file);
    event.target.value = ''; // Reset file input
}


// =================================================================================
// 功能二: 批量请求
// =================================================================================
const btnUpload = document.getElementById('batch_step1_upload');
const btnCreate = document.getElementById('batch_step2_create');
const btnCheck = document.getElementById('batch_step3_check');
const btnAnalyze = document.getElementById('batch_step4_analyze');

async function runStep1_Upload() {
    addLog('开始执行步骤1：上传请求文件...');
    if (!gen_jsonlContent) {
        addLog('错误：请先在【功能一】中生成请求文件内容。', 'error');
        return;
    }
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey) {
        addLog('错误：请输入API Key。', 'error'); return;
    }
    
    this.disabled = true;
    const data = await apiCall('/api/upload', { 
        apiKey: apiKey, jsonlContent: gen_jsonlContent, fileName: `patent_requests_${Date.now()}.jsonl`
    });
    this.disabled = false;

    if (data) {
        batch_fileId = data.fileId;
        addLog(`成功: ${data.message} File ID: ${batch_fileId}`, 'success');
        btnCreate.disabled = false;
    }
}

async function runStep2_Create() {
    addLog('开始执行步骤2：创建Batch任务...');
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey || !batch_fileId) { addLog('错误：API Key 或 File ID 缺失。', 'error'); return; }

    this.disabled = true;
    const data = await apiCall('/api/create_batch', { apiKey, fileId: batch_fileId });
    this.disabled = false;

    if (data) {
        batch_batchId = data.id;
        addLog(`成功: Batch任务创建成功！Batch ID: ${batch_batchId}`, 'success');
        addLog(`任务当前状态: ${data.status}`);
        btnCheck.disabled = false;
    }
}

async function runStep3_Check() {
    addLog('开始执行步骤3：检查任务状态...');
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey || !batch_batchId) { addLog('错误：API Key 或 Batch ID 缺失。', 'error'); return; }

    this.disabled = true;
    const data = await apiCall('/api/check_status', { apiKey, batchId: batch_batchId });
    this.disabled = false;

    if (data) {
        addLog(`任务状态: ${data.status}`, data.status === 'completed' ? 'success' : 'info');
        if (data.status === 'completed') {
            batch_outputFileId = data.output_file_id;
            addLog(`任务完成! Output File ID: ${batch_outputFileId}`, 'success');
            btnAnalyze.disabled = false;
        } else if (['failed', 'expired', 'cancelled'].includes(data.status)) {
            addLog(`任务失败或已终止。`, 'error');
        } else {
            addLog(`任务仍在进行中，请稍后重试。`);
        }
    }
}

async function runStep4_Analyze() {
    addLog('开始执行步骤4：下载结果并直接分析...');
    if (!gen_workbook) {
        addLog('错误：无法找到在【功能一】中上传的原始Excel文件数据，无法自动分析。', 'error');
        alert('请先在【功能一】中上传原始Excel文件！');
        return;
    }
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey || !batch_outputFileId) { addLog('错误：API Key 或 Output File ID 缺失。', 'error'); return; }

    this.disabled = true;
    const data = await apiCall('/api/get_result_content', { apiKey, fileId: batch_outputFileId });
    this.disabled = false;

    if (data && data.content) {
        addLog('结果内容获取成功！正在跳转到【功能三】进行分析...', 'success');
        
        // 关键步骤：将缓存和获取的数据赋给功能三的变量
        rep_workbook = gen_workbook;
        rep_jsonlData = data.content;

        // 切换到功能三
        switchTab('reporter');
        
        // 自动填充功能三的UI并触发解析
        document.getElementById('rep-excel-input').disabled = true;
        document.getElementById('rep-jsonl-input').disabled = true;
        
        const sheetNames = rep_workbook.SheetNames;
        if (sheetNames.length === 1) {
            loadSheet(sheetNames[0], 'rep');
        } else {
            displaySheetSelection(sheetNames, 'rep');
        }
        alert("数据已准备就绪。请在【功能三】中选择工作表（如果需要），然后点击“生成并预览报告”。");
    }
}


// =================================================================================
// 功能三: 解析结果生成报告 (已重构)
// =================================================================================
function previewReport() {
    if (!rep_sheetData || !rep_jsonlData) {
        return alert('请确保原始Excel数据和JSONL结果数据都已加载。');
    }
    const statusArea = document.getElementById('rep-status-area');
    const statusLog = document.getElementById('rep-status-log');
    statusArea.style.display = 'block';
    statusLog.textContent = '开始处理和生成预览...\n';

    try {
        // 1. 解析JSONL到Map，键为request序号
        const resultMap = new Map();
        rep_jsonlData.split('\n').filter(line => line.trim() !== '').forEach(line => {
            try {
                const parsedLine = JSON.parse(line);
                const customId = parsedLine.custom_id;
                const match = customId && customId.match(/request-(\d+)/);
                if (match) {
                    const reqIndex = parseInt(match[1], 10);
                    const content = parsedLine.response?.body?.choices?.[0]?.message?.content;
                    if (content) {
                        let resultJson;
                        try {
                            const cleanedContent = content.replace(/^```json\s*|```\s*$/g, '').trim();
                            resultJson = JSON.parse(cleanedContent);
                        } catch { resultJson = { "解析失败的原始回应": content }; }
                        resultMap.set(reqIndex, resultJson);
                    }
                }
            } catch (e) { console.warn("Skipping invalid JSONL line:", line, e); }
        });
        statusLog.textContent += `JSONL文件解析完毕，共找到 ${resultMap.size} 条有效结果。\n`;
        
        // 2. 确定所有可能的表头
        const idColIndex = document.getElementById('rep-select-id-col').value;
        const idHeader = rep_sheetData[0][idColIndex];
        const analysisHeaders = new Set();
        resultMap.forEach(result => {
            Object.keys(result).forEach(key => analysisHeaders.add(key));
        });
        rep_outputHeaders = [idHeader, ...Array.from(analysisHeaders)];
        statusLog.textContent += `已识别并设定报告列: ${Array.from(analysisHeaders).join(', ')}\n`;

        // 3. 遍历原始数据，匹配结果，保留空行
        const dataRows = rep_sheetData.slice(1);
        rep_finalOutputData = dataRows.map((row, index) => {
            const baseData = { [idHeader]: row[idColIndex] || `Row-${index + 2}` };
            const result = resultMap.get(index);
            
            const finalRow = { ...baseData };
            rep_outputHeaders.slice(1).forEach(header => {
                 // 如果有结果且结果包含该表头，则填充，否则为空字符串
                if (result && result.hasOwnProperty(header)) {
                    let value = result[header];
                    if (Array.isArray(value)) value = value.join('; ');
                    finalRow[header] = value;
                } else {
                    finalRow[header] = '';
                }
            });
            return finalRow;
        });

        statusLog.textContent += '数据匹配完成，正在生成预览...\n';
        const previewContent = rep_finalOutputData.slice(0, 3).map(row => `<div class="preview-item">${JSON.stringify(row, null, 2)}</div>`).join('');
        document.getElementById('rep-preview-output').innerHTML = previewContent || "没有可预览的数据。";
        document.getElementById('rep-preview-area').style.display = 'block';
        if (rep_finalOutputData.length > 0) {
            document.getElementById('rep-download-btn').style.display = 'inline-block';
        }
        statusLog.textContent += '预览已生成。确认无误后可下载完整报告。';
    } catch (e) {
        statusLog.textContent += `发生严重错误: ${e.message}\n请检查文件格式或控制台输出。`;
        console.error("Error during report preview:", e);
    }
}

function downloadReport() {
    if (!rep_finalOutputData || rep_finalOutputData.length === 0) return alert('没有数据可供下载。');
    
    const ws = XLSX.utils.json_to_sheet(rep_finalOutputData, { header: rep_outputHeaders });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '分析报告');
    const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    
    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `patent_report_${Date.now()}.xlsx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

</script>
</body>
</html>
