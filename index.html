<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专利分析智能工作台 v8.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
        /* --- [v8.2 FUSION Design System] --- */
        :root {
            --bg-color: #F7F9FC;
            --surface-color: #FFFFFF;
            --border-color: #CBD5E0;
            --text-color: #2D3748;
            --text-color-secondary: #718096;
            
            --primary-color: #4CAF50;
            --primary-color-dark: #45a049;
            --primary-color-glow: rgba(76, 175, 80, 0.4);
            
            --error-color: #EF4444;
            --success-color: #22C55E;
            --warning-color: #F59E0B;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--bg-color);
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.04) 1px, transparent 1px);
            background-size: 25px 25px;
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transform: scale(0.8);
            transform-origin: top center;
        }

        .app-banner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
        }
        .banner-text-logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.2rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--primary-color-dark), var(--primary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 20px var(--primary-color-glow);
        }
        .copyright-info { margin-top: 2px; font-size: 14px; color: var(--text-color-secondary); }
        .version-number { font-size: 12px; opacity: 0.8; margin-top: 2px; }

        .main-content { padding: 30px; }

        .tab-container {
            display: flex;
            justify-content: center; 
            gap: 15px; 
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }
        .tab-button {
            background-color: transparent;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 500;
            color: #d4d9e0;
            transition: all 0.3s ease;
            
            border-radius: 8px 8px 0 0;
            margin-bottom: -1px;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover {
            color: var(--primary-color-dark);
        }
        .tab-button.active {
            background: linear-gradient(45deg, var(--primary-color-dark), var(--primary-color));
            color: #FFFFFF;
            font-weight: 700;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
            border-bottom-color: transparent;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fade-in 0.5s ease; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .step {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--surface-color);
        }
        .step-header {
            font-size: 1.1em;
            font-weight: 700;
            color: #FFFFFF;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
            background: linear-gradient(90deg, var(--primary-color-dark), var(--primary-color));
            
            margin: -25px -25px 20px -25px;
            padding: 12px 25px;
            
            border-radius: 8px 8px 0 0;
            border-bottom: none;
        }

        button {
            background: linear-gradient(45deg, var(--primary-color-dark), var(--primary-color));
            color: #FFFFFF;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            font-weight: bold;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0,0,0,0.08);
            display: inline-block;
            text-align: center;
            font-family: inherit;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px var(--primary-color-glow), 0 2px 6px rgba(0,0,0,0.1);
            filter: brightness(1.05);
        }
        button:active { transform: translateY(-1px); filter: brightness(1); }
        button:disabled { background: #BCC5D3; color: #F7F9FC; cursor: not-allowed; transform: none; box-shadow: none; filter: none; text-shadow: none; }
        .action-button { min-width: 200px; margin: 5px; }

        .small-button { padding: 8px 16px; font-size: 0.9em; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); }
        .small-button:hover { box-shadow: 0 4px 12px var(--primary-color-glow); }
        .delete-button { background: linear-gradient(45deg, #FF7171, var(--error-color)); }
        .delete-button:hover { box-shadow: 0 7px 20px rgba(239, 68, 68, 0.3); }

        input[type="file"] { border: 1px solid var(--border-color); display: inline-block; padding: 8px 12px; cursor: pointer; border-radius: 6px; color: var(--text-color-secondary); transition: all 0.3s ease; }
        input[type="file"]:hover { color: var(--primary-color); border-color: var(--primary-color); }
        
        select, input[type="text"], input[type="number"], input[type="password"], textarea {
            background-color: #FFFFFF;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        select:focus, input:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-color-glow); }
        textarea { resize: vertical; min-height: 120px; }
        #instant_input { min-height: 300px; width: 100%; }

        .config-item { margin-bottom: 15px; }
        .config-item label { font-weight: 500; margin-bottom: 8px; display: block; color: var(--text-color-secondary); }
        .config-item.row-flex { display: flex; align-items: center; gap: 15px; }
        .config-item.row-flex label { width: 170px; flex-shrink: 0; margin-bottom: 0; }
        .config-item .input-wrapper { width: 100%; }

        .preview-output { background-color: var(--bg-color); color: var(--text-color); padding: 15px; border-radius: 8px; max-height: 500px; overflow-y: auto; font-family: "SF Mono", "Fira Code", "Courier New", monospace; white-space: pre-wrap; word-break: break-all; margin-top: 15px; border: 1px solid var(--border-color); }
        
        .info { font-size: 0.95em; margin-top: 15px; padding: 15px 20px; border-radius: 8px; border-left: 5px solid; background-color: var(--surface-color); border-color: var(--text-color-secondary); }
        .info.success { border-color: var(--success-color); background-color: rgba(34, 197, 94, 0.05); }
        .info.warning { border-color: var(--warning-color); background-color: rgba(245, 158, 11, 0.05); }
        .info.error { border-color: var(--error-color); background-color: rgba(239, 68, 68, 0.05); }
        
        details { border: 1px solid var(--border-color); border-radius: 8px; margin-top: 25px; background-color: transparent; transition: background-color 0.3s ease; }
        details[open] { background-color: var(--surface-color); }
        summary { font-size: 1.2em; font-weight: 500; color: var(--text-color); padding: 15px 20px; cursor: pointer; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: '▶ '; font-size: 0.8em; margin-right: 8px; transition: transform 0.2s; display: inline-block; color: var(--primary-color); }
        details[open] > summary::before { transform: rotate(90deg); }
        
        #batch_log { margin-top: 15px; background-color: #f1f5f9; padding: 15px; border-radius: 4px; min-height: 100px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; font-family: monospace; }
        .prompt-section { border: 1px dashed var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .prompt-section-title { font-weight: bold; margin-bottom: 15px; color: var(--primary-color); }

        .spinner { border: 4px solid var(--border-color); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s ease-in-out infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="container">
    <header class="app-banner">
        <h1 class="banner-text-logo">ALFRED X IP</h1>
        <div class="copyright-info">
            <span>Copyright © 2025 Alfred Shi 保留所有权利.</span>
            <span class="version-number">版本号: v8.1 (Flex-Prompt)</span>
        </div>
    </header>

    <div class="main-content">
        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('generator')">功能一：生成请求文件</button>
            <button class="tab-button" onclick="switchTab('batch')">功能二：批量请求</button>
            <button class="tab-button" onclick="switchTab('reporter')">功能三：生成报告</button>
            <button class="tab-button" onclick="switchTab('instant')">功能四：即时工具</button>
        </div>

        <!-- 功能一：生成请求文件 -->
        <div id="generator-tab" class="tab-content active">
            <div class="step">
                <div class="step-header">步骤 1: 上传专利数据 Excel 并配置分析列</div>
                <div class="step-content">
                    <input type="file" id="gen_file-input" accept=".xlsx, .xls">
                    <select id="gen_sheet-selector" style="display:none; margin-left: 10px;"></select>
                    <div id="column-config-container" style="display:none; margin-top: 20px;">
                        <div class="config-item row-flex">
                            <label for="column-count">分析列数量:</label>
                            <div class="input-wrapper">
                                <input type="number" id="column-count" value="2" min="1" max="10" style="width: 100px;">
                            </div>
                        </div>
                        <div id="column-config-area"></div>
                    </div>
                </div>
            </div>
            
            <div class="step">
                <div class="step-header">步骤 2: 配置 API 请求模板</div>
                <div class="step-content">
                    <div class="template-actions" style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <select id="template_selector" style="flex-grow: 1;"></select>
                        <button id="save_template_btn" class="small-button">保存</button>
                        <button id="import_template_btn" class="small-button">导入</button>
                        <input type="file" id="template_file_input" accept=".json" style="display:none;">
                        <button id="export_template_btn" class="small-button">导出</button>
                        <button id="delete_template_btn" class="small-button delete-button">删除</button>
                    </div>

                    <div class="config-item row-flex"><label for="api-model">模型 (model):</label><div class="input-wrapper"><select id="api-model"></select></div></div>
                    <div class="config-item row-flex"><label for="api-temperature">温度 (temperature):</label><div class="input-wrapper"><input type="number" id="api-temperature" value="0.1" step="0.1" min="0" max="1"></div></div>
                    
                    <div class="config-item">
                        <label for="api-system-prompt">系统提示 (System Prompt):</label>
                        <div class="input-wrapper"><textarea id="api-system-prompt" rows="3"></textarea></div>
                    </div>

                    <div class="config-item">
                        <label>用户提示 (User Prompt):</label>
                        <div class="input-wrapper">
                            <div class="prompt-section">
                                <div class="prompt-section-title">A. 规则要求</div>
                                <textarea id="prompt-rules" rows="4" placeholder="请在此处输入任务的核心指令、要求和背景信息。"></textarea>
                            </div>
                            <div class="prompt-section">
                                <div class="prompt-section-title">B. 内容插入 (自动生成)</div>
                                <div id="content-insertion-preview" class="preview-output" style="min-height: 80px;">待上传Excel并配置分析列后自动显示...</div>
                            </div>
                            <div class="prompt-section">
                                <div class="prompt-section-title">C. 输出格式 (JSON)</div>
                                <div id="output-fields-container"></div>
                                <button id="add-output-field-btn" class="small-button" type="button">添加输出字段</button>
                                <div class="info" style="margin-top: 10px;">系统将自动把此处的字段包装成JSON格式要求。</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-header">步骤 3: 生成并预览 JSONL 请求文件</div>
                <div class="step-content">
                    <button id="gen_generate-btn" disabled>生成 JSONL 文件</button>
                    <div class="preview-output" id="gen_preview_output" style="display:none;"></div>
                    <button id="gen_download-btn" style="display:none; margin-top: 15px;">下载 JSONL 文件</button>
                    <div class="info success" id="gen_ready_info" style="display:none;">文件已在内存中准备就绪，请切换到【功能二】进行上传。</div>
                </div>
            </div>
        </div>
        
        <!-- 功能二: 批量请求与结果获取 -->
        <div id="batch-tab" class="tab-content">
             <div class="step">
                <div class="step-header">准备工作：输入您的API Key</div>
                <div class="step-content">
                    <div class="config-item row-flex"><label for="batch_api_key_input">API Key:</label><div class="input-wrapper"><input type="password" id="batch_api_key_input" placeholder="请在此处粘贴您的智谱AI API Key"></div></div>
                </div>
            </div>
            <div class="step">
                <div class="step-header">批量任务工作流</div>
                <div class="step-content">
                    <p>请按照1-4的顺序执行。点击步骤2后将启动自动状态检查。</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; justify-content: center;">
                        <button id="batch_step1_upload" class="action-button">1. 上传请求文件</button>
                        <button id="batch_step2_create" class="action-button" disabled>2. 创建Batch任务</button>
                        <button id="batch_step3_check" class="action-button" disabled>3. 手动检查状态</button>
                        <button id="batch_step4_download" class="action-button" disabled>4. 获取结果内容</button>
                    </div>
                    <div id="batch_id_reminder" class="info warning" style="display: none; margin-top: 20px; text-align: center;"></div>

                    <div id="auto-check-container" style="display:none; margin-top: 20px; text-align: center;">
                        <span id="auto_check_status" style="margin-right: 15px; color: var(--primary-color-dark); font-weight: bold;"></span>
                        <button id="batch_stop_check_btn" class="small-button" style="background: var(--warning-color); color: #fff;">停止自动检查</button>
                    </div>
                </div>
            </div>
            
            <details>
                <summary>断点续查 / 任务恢复</summary>
                <div class="step" style="border-top: none; margin-top: 0;">
                    <p class="info warning">如果您因关闭浏览器等原因中断了流程，但已记录下 Batch ID，可在此恢复任务状态。</p>
                    <div class="config-item row-flex">
                        <label for="recover_batch_id_input">Batch ID:</label>
                        <div class="input-wrapper"><input type="text" id="recover_batch_id_input" placeholder="粘贴您记录的 Batch ID"></div>
                    </div>
                    <button id="recover_state_btn">恢复查询状态</button>
                </div>
            </details>

            <div class="step">
                <div class="step-header">执行日志与结果</div>
                <div id="batch_log">等待操作...</div>
            </div>
        </div>

        <!-- 功能三: 解析结果生成报告 -->
        <div id="reporter-tab" class="tab-content">
            <div class="step">
                <div class="step-header">步骤 1: 准备数据源</div>
                <div class="step-content">
                    <div class="reporter-uploads" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <p><strong>A. 上传原始 Excel 文件</strong> (用于数据匹配)</p>
                            <input type="file" id="rep_excel-input" accept=".xlsx, .xls">
                            <select id="rep_sheet-selector" style="display:none; margin-left: 10px; margin-top: 10px;"></select>
                        </div>
                        <div>
                            <p><strong>B. 加载 Batch 任务结果文件</strong></p>
                            <input type="file" id="rep_jsonl-input" accept=".jsonl">
                            <div class="info success" id="reporter-info-box" style="display:none;">
                                检测到来自【功能二】的结果文件已在内存中，将优先使用此数据。
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-header">步骤 2: 解析并生成最终报告</div>
                <div class="step-content">
                    <button id="rep_generate-report-btn" disabled>解析并生成最终报告</button>
                    <div class="preview-output" id="rep_output_preview" style="display:none;"></div>
                    <button id="rep_download-report-btn" style="display:none; margin-top: 15px;">下载最终报告 (Excel)</button>
                </div>
            </div>
        </div>

        <!-- 功能四：即时工具 -->
        <div id="instant-tab" class="tab-content">
            <div class="step">
                <div class="step-header">步骤 1: 参数配置</div>
                <div class="step-content">
                    <div class="config-item row-flex"><label for="instant_api_key_input">API Key:</label><div class="input-wrapper"><input type="password" id="instant_api_key_input" placeholder="请在此处粘贴您的智谱AI API Key"></div></div>
                    <div class="config-item row-flex"><label for="instant_model_select">模型 (model):</label><div class="input-wrapper"><select id="instant_model_select"></select></div></div>
                    <div class="config-item row-flex"><label for="instant_temperature_input">温度 (temperature):</label><div class="input-wrapper"><input type="number" id="instant_temperature_input" value="0.1" step="0.1" min="0" max="1"></div></div>
                    
                    <details open>
                        <summary>可编辑的请求模板</summary>
                         <div class="info warning">您可以按需修改下方的System和User提示。User提示中的 <strong>{userInput}</strong> 会被自动替换为下方输入框中的实际内容。</div>
                         <div class="prompt-section">
                            <div class="prompt-section-title">任务一：一键翻译</div>
                            <div class="config-item"><label for="instant_translate_system">System Prompt:</label><textarea id="instant_translate_system" rows="3"></textarea></div>
                            <div class="config-item"><label for="instant_translate_user">User Prompt:</label><textarea id="instant_translate_user" rows="2"></textarea></div>
                        </div>
                        <div class="prompt-section">
                            <div class="prompt-section-title">任务二：核心总结</div>
                            <div class="config-item"><label for="instant_summarize_system">System Prompt:</label><textarea id="instant_summarize_system" rows="3"></textarea></div>
                            <div class="config-item"><label for="instant_summarize_user">User Prompt:</label><textarea id="instant_summarize_user" rows="2"></textarea></div>
                        </div>
                        <div class="prompt-section">
                            <div class="prompt-section-title">任务三：专利词拓展</div>
                            <div class="config-item"><label for="instant_expand_keywords_system">System Prompt:</label><textarea id="instant_expand_keywords_system" rows="3"></textarea></div>
                            <div class="config-item"><label for="instant_expand_keywords_user">User Prompt:</label><textarea id="instant_expand_keywords_user" rows="2"></textarea></div>
                        </div>
                    </details>
                </div>
            </div>
            <div class="step">
                <div class="step-header">步骤 2: 输入内容并选择操作</div>
                <div class="step-content">
                     <textarea id="instant_input" placeholder="在此处粘贴或输入您想处理的内容..."></textarea>
                     <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                        <button id="instant_translate_btn" class="action-button">一键翻译</button>
                        <button id="instant_summarize_btn" class="action-button">核心总结</button>
                        <button id="instant_keywords_btn" class="action-button">专利词拓展</button>
                     </div>
                </div>
            </div>
            <div class="step">
                <div class="step-header">步骤 3: 即时结果</div>
                <div class="step-content">
                    <div id="instant_output" class="preview-output" style="min-height: 150px;">
                        请在上方输入内容并选择操作...
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// --- 全局配置与变量 ---
const BACKEND_URL = 'https://patent-workbench-backend.onrender.com';
const AVAILABLE_MODELS = ["glm-4-flashX-250414", "glm-4-flash", "glm-4-long"];
const INSTANT_PROMPT_TEMPLATES = {
    "translate": {
        "system": "你是一个专业精通各技术领域术语的、精通多国语言的专利文本翻译引擎。你的任务是自动检测用户输入专利文本的语言并将其翻译成中文。请直接返回翻译后的文本，不要添加任何额外的解释或说明。",
        "user": "请翻译以下内容：\n\n{userInput}"
    },
    "summarize": {
        "system": "你是一位顶级的专利分析师和信息架构师，极其擅长从复杂、冗长的专利文本中快速提炼核心技术原理、技术方案摘要。你的输出应该是结构清晰、逻辑严谨、高度浓缩的技术方案摘要和原理内容。",
        "user": "请深入分析以下专利文本，并总结其核心原理和内容摘要：\n\n{userInput}"
    },
    "expand_keywords": {
        "system": "你是一名资深的专利检索专家和技术分析师。你的任务是根据用户提供的技术方案点，拓展出一系列用于专利数据库检索的中文以及英文同义词、近义词、上下位概念、相关技术术语以及不同表达方式。输出应该是一个清晰、逗号分隔的中英文关键词或短语列表，并附上相关简单例句。",
        "user": "请围绕以下核心关键词进行专利检索词拓展，提供一个全面的关键词列表：\n\n{userInput}"
    }
};

let gen_workbook = null, gen_currentSheetData = null, gen_columnHeaders = [], gen_jsonlContent = "";
let rep_workbook = null, rep_sheetData = null, rep_jsonlData = null;
let rep_finalOutputData = [], rep_outputHeaders = [];
let batch_fileId = null, batch_batchId = null, batch_outputFileId = null, batch_errorFileId = null;
let batch_result_jsonl_content = null;
let custom_templates = [];
const preset_templates = [
    { name: "专利文本翻译", isPreset: true, system: "是一个专业精通各技术领域术语的、精通多国语言的专利文本翻译引擎。你的任务是自动检测用户输入专利文本的语言并将其翻译成中文。请直接返回翻译后的文本，不要添加任何额外的解释或说明。你必须严格遵循输出格式要求。", user: { rules: "请基于以下文本，直接输出翻译后的内容。\n要求：\n1. 结果必须是直接的翻译后中文文本，必须忠实于原文不得臆测，并选择贴合技术领域的专业术语表达", outputFields: [] }},
    { name: "技术方案解读", isPreset: true, system: "你是一位资深的专利技术分析师。你的任务是基于专利内容，梳理总结其要解决的技术问题，采用的核心方案内容、以及实现的技术效果和最重要的核心关键词短语。", user: { rules: "请分析此专利并按以下JSON格式输出：", outputFields: [ { name: "技术方案", desc: "此处填写技术方案，总结专利的主要方案内容" }, { name: "技术问题", desc: "此处填写该专利可能主要解决的技术问题" }, { name: "技术效果", desc: "此处填写该专利可能带来的技术效果" }, { name: "技术关键词", desc: "此处按照专利文本中构成核心方案的重要程度输出15个关键词或短语" }] }}
];
let autoCheckTimer = null;

// --- DOM 元素缓存 ---
const getEl = id => document.getElementById(id);
const genFileInput = getEl('gen_file-input'), genSheetSelector = getEl('gen_sheet-selector');
const columnConfigContainer = getEl('column-config-container'), columnCountInput = getEl('column-count'), columnConfigArea = getEl('column-config-area');
const genGenerateBtn = getEl('gen_generate-btn'), genPreviewOutput = getEl('gen_preview_output'), genDownloadBtn = getEl('gen_download-btn'), genReadyInfo = getEl('gen_ready_info');
const apiModelSelect = getEl('api-model'), apiTempInput = getEl('api-temperature'), apiSystemInput = getEl('api-system-prompt');
const templateSelector = getEl('template_selector'), templateFileInput = getEl('template_file_input');
const promptRules = getEl('prompt-rules'), contentInsertionPreview = getEl('content-insertion-preview'), outputFieldsContainer = getEl('output-fields-container');
const batchLog = getEl('batch_log'), batchIdReminder = getEl('batch_id_reminder');
const btnUpload = getEl('batch_step1_upload'), btnCreate = getEl('batch_step2_create'), btnCheck = getEl('batch_step3_check'), btnDownload = getEl('batch_step4_download');
const autoCheckContainer = getEl('auto-check-container'), autoCheckStatusEl = getEl('auto_check_status');
const recoverIdInput = getEl('recover_batch_id_input');
const repExcelInput = getEl('rep_excel-input'), repSheetSelector = getEl('rep_sheet-selector'), repJsonlInput = getEl('rep_jsonl-input');
const repGenerateBtn = getEl('rep_generate-report-btn'), repPreview = getEl('rep_output_preview'), repDownloadBtn = getEl('rep_download-report-btn'), repInfoBox = getEl('reporter-info-box');
const instantApiKeyInput = getEl('instant_api_key_input');
const instantModelSelect = getEl('instant_model_select');
const instantTempInput = getEl('instant_temperature_input');
const instantInput = getEl('instant_input');
const instantOutput = getEl('instant_output');
const instantTranslateBtn = getEl('instant_translate_btn');
const instantSummarizeBtn = getEl('instant_summarize_btn');
const instantKeywordsBtn = getEl('instant_keywords_btn');

// =================================================================================
// 初始化
// =================================================================================
document.addEventListener('DOMContentLoaded', () => {
    // 功能一
    initModelSelector();
    genFileInput.addEventListener('change', handleGenFile);
    genSheetSelector.addEventListener('change', e => loadGenSheet(e.target.value));
    columnCountInput.addEventListener('input', () => {
        updateColumnSelectors();
        updateContentInsertionPreview();
    });
    genGenerateBtn.addEventListener('click', generateJsonl);
    genDownloadBtn.addEventListener('click', downloadJsonl);
    
    // 模板和Prompt UI
    templateSelector.addEventListener('change', loadTemplate);
    getEl('save_template_btn').addEventListener('click', saveTemplate);
    getEl('delete_template_btn').addEventListener('click', deleteTemplate);
    getEl('export_template_btn').addEventListener('click', exportTemplate);
    getEl('import_template_btn').addEventListener('click', () => templateFileInput.click());
    templateFileInput.addEventListener('change', importTemplate);
    getEl('add-output-field-btn').addEventListener('click', () => addOutputField());
    initTemplates();

    // 功能二
    btnUpload.addEventListener('click', runStep1_Upload);
    btnCreate.addEventListener('click', runStep2_Create);
    btnCheck.addEventListener('click', runStep3_Check);
    btnDownload.addEventListener('click', runStep4_Download);
    getEl('batch_stop_check_btn').addEventListener('click', stopAutoCheck);
    getEl('recover_state_btn').addEventListener('click', recoverBatchState);

    // 功能三
    repExcelInput.addEventListener('change', handleReporterExcel);
    repSheetSelector.addEventListener('change', e => loadReporterSheet(e.target.value));
    repJsonlInput.addEventListener('change', handleReporterJsonl);
    repGenerateBtn.addEventListener('click', parseAndGenerateReport);
    repDownloadBtn.addEventListener('click', downloadFinalReport);

    // 功能四
    initInstantTools();
    instantTranslateBtn.addEventListener('click', () => handleInstantRequest('translate'));
    instantSummarizeBtn.addEventListener('click', () => handleInstantRequest('summarize'));
    instantKeywordsBtn.addEventListener('click', () => handleInstantRequest('expand_keywords'));
});

// =================================================================================
// 功能四：即时工具
// =================================================================================
function initInstantTools() {
    instantModelSelect.innerHTML = AVAILABLE_MODELS.map(m => `<option value="${m}">${m}</option>`).join('');
    instantModelSelect.value = "glm-4";

    for (const taskType in INSTANT_PROMPT_TEMPLATES) {
        getEl(`instant_${taskType}_system`).value = INSTANT_PROMPT_TEMPLATES[taskType].system;
        getEl(`instant_${taskType}_user`).value = INSTANT_PROMPT_TEMPLATES[taskType].user;
    }
}

async function handleInstantRequest(taskType) {
    // 1. 从UI获取所有需要的参数，包括可编辑的模板内容
    const apiKey = instantApiKeyInput.value.trim();
    const mainInputText = instantInput.value.trim();
    const model = instantModelSelect.value;
    const temperature = parseFloat(instantTempInput.value);
    
    // 实时读取用户可能已经修改过的模板
    const systemPrompt = getEl(`instant_${taskType}_system`).value.trim();
    const userPromptTemplate = getEl(`instant_${taskType}_user`).value.trim();

    // 2. 输入验证
    if (!apiKey) { instantOutput.innerHTML = `<div class="info error">错误：请输入您的 API Key。</div>`; return; }
    if (!mainInputText) { instantOutput.innerHTML = `<div class="info error">错误：请输入需要处理的内容。</div>`; return; }
    if (!systemPrompt || !userPromptTemplate) { instantOutput.innerHTML = `<div class="info error">错误：System 或 User 提示模板不能为空。</div>`; return; }
    if (userPromptTemplate.indexOf('{userInput}') === -1) {
        instantOutput.innerHTML = `<div class="info error">错误：User 提示模板中必须包含 {userInput} 占位符。</div>`;
        return;
    }

    // 3. 构建符合智谱API v4规范的 `messages` 数组
    const finalUserPrompt = userPromptTemplate.replace('{userInput}', mainInputText);
    const messages = [
        { "role": "system", "content": systemPrompt },
        { "role": "user", "content": finalUserPrompt }
    ];

    const allButtons = [instantTranslateBtn, instantSummarizeBtn, instantKeywordsBtn];
    allButtons.forEach(btn => btn.disabled = true);
    instantOutput.innerHTML = '<div class="spinner"></div><p style="text-align:center;">正在请求，请稍候...</p>';
    
    try {
        // 4. 构建发送到后端代理的请求体 (需要后端支持)
        const requestBody = {
            apiKey: apiKey,
            model: model,
            messages: messages,
            temperature: temperature
        };

        const response = await fetch(`${BACKEND_URL}/api/instant_request`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        const result = await response.json();

        // 5. 处理响应
        if (!response.ok || !result.success) { 
            const errorMessage = result.error || (result.data ? JSON.stringify(result.data) : '请求失败，未知错误。');
            throw new Error(errorMessage); 
        }
        
        const content = result.data?.choices?.[0]?.message?.content || result.data?.content || JSON.stringify(result.data);
        instantOutput.style.whiteSpace = 'pre-wrap';
        instantOutput.textContent = content;

    } catch (error) {
        instantOutput.innerHTML = `<div class="info error">请求失败: ${error.message}</div>`;
    } finally {
        allButtons.forEach(btn => btn.disabled = false);
    }
}

// =================================================================================
// 功能三：解析结果生成报告
// =================================================================================
function parseFaultTolerantJson(text) {
    try {
        return JSON.parse(text);
    } catch (e) {
        const startIndex = text.indexOf('{');
        const endIndex = text.lastIndexOf('}');
        if (startIndex > -1 && endIndex > -1 && endIndex > startIndex) {
            const potentialJson = text.substring(startIndex, endIndex + 1);
            try {
                return JSON.parse(potentialJson);
            } catch (e2) {
                 console.warn("Falling back to regex-based JSON parsing for:", text);
                 const result = {};
                 const regex = /"([^"]+)"\s*:\s*"((\\"|[^"])*)"/g;
                 let match;
                 while ((match = regex.exec(potentialJson)) !== null) {
                     result[match[1]] = match[2].replace(/\\"/g, '"').replace(/\\n/g, '\n');
                 }
                 return Object.keys(result).length > 0 ? result : null;
            }
        }
    }
    return null;
}
function parseAndGenerateReport() {
    if (!rep_sheetData || !rep_jsonlData) {
        alert("请先上传原始Excel和结果JSONL文件。");
        return;
    }
    const resultMap = new Map();
    rep_jsonlData.forEach(item => {
        if (item?.response?.body?.choices?.[0]?.message?.content) {
            resultMap.set(item.custom_id, item.response.body.choices[0].message.content.trim());
        }
    });
    const allGeneratedHeaders = new Set();
    const processedData = rep_sheetData.map((row, index) => {
        const newRow = { ...row };
        const ai_content = resultMap.get(`request-${index + 1}`) || '';
        if (ai_content) {
            const ai_json = parseFaultTolerantJson(ai_content);
            if (ai_json && typeof ai_json === 'object') {
                Object.keys(ai_json).forEach(key => {
                    newRow[key] = ai_json[key];
                    allGeneratedHeaders.add(key);
                });
            } else {
                newRow['AI原始返回'] = ai_content;
                allGeneratedHeaders.add('AI原始返回');
            }
        }
        return newRow;
    });
    rep_finalOutputData = processedData;
    if (rep_finalOutputData.length > 0) {
        const originalHeaders = Object.keys(rep_sheetData[0] || {});
        rep_outputHeaders = [...originalHeaders, ...Array.from(allGeneratedHeaders)];
        repPreview.style.display = 'block';
        repPreview.innerHTML = `<p><strong>智能解析完成！预览前 5 条合并结果:</strong></p><pre>${JSON.stringify(rep_finalOutputData.slice(0, 5), null, 2)}</pre>`;
        repDownloadBtn.style.display = 'inline-block';
    } else {
        alert("处理完成，但没有生成任何数据。请检查文件内容。");
    }
}
function handleReporterExcel(event){
    const file=event.target.files[0];
    if(!file)return;
    const reader=new FileReader;
    reader.onload=e=>{
        const data=new Uint8Array(e.target.result);
        rep_workbook=XLSX.read(data,{type:"array"});
        repSheetSelector.innerHTML="";
        rep_workbook.SheetNames.forEach(name=>{
            const option=document.createElement("option");
            option.value=option.textContent=name;
            repSheetSelector.appendChild(option)
        });
        repSheetSelector.style.display="inline-block";
        loadReporterSheet(rep_workbook.SheetNames[0])
    };
    reader.readAsArrayBuffer(file)
}
function loadReporterSheet(sheetName){
    const worksheet=rep_workbook.Sheets[sheetName];
    rep_sheetData=XLSX.utils.sheet_to_json(worksheet,{defval:""});
    checkReporterReady();
}
function handleReporterJsonl(event){
    const file=event.target.files[0];
    if(!file)return;
    const reader=new FileReader;
    reader.onload=e=>{
        rep_jsonlData=parseJsonl(e.target.result);
        checkReporterReady();
    };
    reader.readAsText(file)
}
function parseJsonl(content){
    return content.trim().split("\n").map(line=>{
        try{return JSON.parse(line)}
        catch(e){console.error("Failed to parse line:",line);return null}
    }).filter(item=>item)
}
function checkReporterReady(){
    repGenerateBtn.disabled=!(rep_sheetData&&rep_jsonlData);
}
function downloadFinalReport(){
    if(0!==rep_finalOutputData.length){
        const consistentData = rep_finalOutputData.map(row => {
            let newRow = {};
            rep_outputHeaders.forEach(header => {
                newRow[header] = row[header] || "";
            });
            return newRow;
        });
        const newSheet=XLSX.utils.json_to_sheet(consistentData,{header:rep_outputHeaders});
        const newWorkbook=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook,newSheet,"分析结果");
        XLSX.writeFile(newWorkbook,"专利分析报告_最终版.xlsx");
    }
}

// =================================================================================
// 功能二：批量处理
// =================================================================================
async function apiCall(endpoint,body){
    const apiPath=`/api${endpoint.startsWith("/")?endpoint:"/"+endpoint}`;
    const url=BACKEND_URL?`${BACKEND_URL}${apiPath}`:apiPath;
    try{
        const response=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
        if(!response.ok){
            const errorData = await response.json().catch(() => ({ error: 'Failed to parse error response.' }));
            const errorMessage = errorData.error || response.statusText;
            throw new Error(`服务器错误: ${response.status}. ${errorMessage}`);
        }
        const result=await response.json();
        if(!result.success)throw new Error(result.error||"后端返回操作失败");
        return result.data
    }catch(error){
        const errorMessage=`请求失败: ${error.message}`;
        if(batchLog) addLog(errorMessage,"error");
        console.error(`API 调用失败，目标: ${endpoint}`,error);
        return null
    }
}
function addLog(message,type="info"){
    if (batchLog.textContent === '等待操作...') batchLog.innerHTML = '';
    const logEntry=document.createElement("div");
    logEntry.className=`info ${type}`;
    logEntry.style.marginBottom = '8px';
    logEntry.innerHTML=`<span style="color: var(--text-color-secondary); margin-right: 10px;">[${new Date().toLocaleTimeString()}]</span> ${message}`;
    batchLog.appendChild(logEntry);
    batchLog.scrollTop=batchLog.scrollHeight;
}
async function runStep1_Upload(){
    addLog("开始执行步骤1：上传请求文件...");
    const apiKey=getEl("batch_api_key_input").value.trim();
    if(!gen_jsonlContent)return void addLog("错误：请先在【功能一】中生成请求文件内容。","error");
    if(!apiKey)return void addLog("错误：请输入API Key。","error");
    btnUpload.disabled=!0;
    const data=await apiCall("/upload",{apiKey,jsonlContent:gen_jsonlContent,fileName:`patent_requests_${Date.now()}.jsonl`});
    btnUpload.disabled=!1;
    if(data){
        batch_fileId=data.fileId;
        addLog(`成功: ${data.message}`,"success");
        addLog(`获取到 File ID: ${batch_fileId}`);
        btnCreate.disabled=!1;
        btnCheck.disabled=!0;
        btnDownload.disabled=!0;
        batchIdReminder.style.display="none";
        stopAutoCheck();
    }
}
async function runStep2_Create(){
    addLog("开始执行步骤2：创建Batch任务...");
    const apiKey=getEl("batch_api_key_input").value.trim();
    if(!apiKey||!batch_fileId)return void addLog("错误：API Key 或 File ID 缺失。","error");
    btnCreate.disabled=!0;
    const data=await apiCall("/create_batch",{apiKey,fileId:batch_fileId});
    if(data){
        batch_batchId=data.id;
        addLog("成功: Batch任务创建成功！","success");
        addLog(`获取到 Batch ID: ${batch_batchId}`);
        batchIdReminder.innerHTML=`<strong>任务已创建！请务必记录您的 Batch ID: <span style="color:var(--warning-color); user-select:all; background: #eee; padding: 2px 6px; border-radius: 4px;">${batch_batchId}</span></strong>，以便在关闭浏览器后可以恢复任务状态。`;
        batchIdReminder.style.display="block";
        addLog(`任务初始状态: ${data.status}`);
        btnCheck.disabled=!1;
        btnDownload.disabled=!0;
        startAutoCheck();
    }
    btnCreate.disabled=!1;
}
async function runStep3_Check(){
    addLog("正在检查任务状态...","auto-check");
    const apiKey=getEl("batch_api_key_input").value.trim();
    if(!apiKey||!batch_batchId)return addLog("错误：API Key 或 Batch ID 缺失，无法检查状态。","error"),void stopAutoCheck();
    const data=await apiCall("/check_status",{apiKey,batchId:batch_batchId});
    if(data){
        addLog(`任务状态: <strong style="color: var(--primary-color-dark)">${data.status}</strong>`);
        if("completed"===data.status){
            batch_outputFileId=data.output_file_id;
            batch_errorFileId=data.error_file_id;
            addLog(`任务完成! Output File ID: ${batch_outputFileId}`,"success");
            batch_errorFileId&&addLog(`错误文件 ID: ${batch_errorFileId}`, 'warning');
            btnDownload.disabled=!1;
            stopAutoCheck();
        } else if(["failed","expired","cancelled"].includes(data.status)){
            addLog(`任务终止。状态: ${data.status}`,"error");
            stopAutoCheck();
        }
    } else {
        addLog("检查状态时发生网络或服务器错误。","error");
    }
}
async function runStep4_Download(){
    addLog("开始执行步骤4：获取结果内容...");
    const apiKey=getEl("batch_api_key_input").value.trim();
    if(!apiKey||!batch_outputFileId)return void addLog("错误：API Key 或 Output File ID 缺失。","error");
    btnDownload.disabled=!0;
    const data=await apiCall("/download_result",{apiKey,fileId:batch_outputFileId});
    if(data&&data.fileContent){
        batch_result_jsonl_content=data.fileContent;
        addLog("成功: 已将结果文件内容加载到浏览器内存中！","success");
        addLog("请切换到【功能三】，您将看到直接解析的选项。");
        switchTab("reporter");
    } else {
        addLog("获取结果内容失败，请检查日志。","error");
    }
    btnDownload.disabled=!1;
}
function startAutoCheck(){
    stopAutoCheck();
    addLog("已启动自动状态检查（每分钟一次）。","info");
    autoCheckContainer.style.display="block";
    autoCheckStatusEl.textContent="自动检查已激活...";
    runStep3_Check();
    autoCheckTimer=setInterval(runStep3_Check,60000);
}
function stopAutoCheck(){
    if(autoCheckTimer){
        clearInterval(autoCheckTimer);
        autoCheckTimer=null;
        autoCheckStatusEl.textContent="自动检查已停止。";
        addLog("自动检查已停止。","info");
        setTimeout(()=>{autoCheckContainer.style.display="none"},3000);
    }
}
async function recoverBatchState(){
    const recoverId=recoverIdInput.value.trim();
    if(!recoverId)return void addLog("错误：请输入要恢复的 Batch ID。","error");
    addLog(`正在尝试恢复 Batch ID: ${recoverId}...`);
    batch_batchId=recoverId;
    btnCheck.disabled=!1;
    await runStep3_Check();
    const jobStatus = batchLog.lastChild?.textContent || "";
    if(!jobStatus.includes("completed") && !jobStatus.includes("failed") && !jobStatus.includes("expired") && !jobStatus.includes("cancelled")){
        startAutoCheck();
    }
}

// =================================================================================
// 功能一：生成请求文件
// =================================================================================
function initModelSelector() {
    const batchModels = ["glm-4-flashX-250414" , "glm-4-flash","glm-4-long"];
    apiModelSelect.innerHTML = batchModels.map(m => `<option value="${m}">${m}</option>`).join('');
}
function handleGenFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        gen_workbook = XLSX.read(data, { type: 'array' });
        genSheetSelector.innerHTML = '';
        gen_workbook.SheetNames.forEach(name => {
            const option = document.createElement('option');
            option.value = option.textContent = name;
            genSheetSelector.appendChild(option);
        });
        genSheetSelector.style.display = 'inline-block';
        loadGenSheet(gen_workbook.SheetNames[0]);
    };
    reader.readAsArrayBuffer(file);
}
function loadGenSheet(sheetName) {
    const worksheet = gen_workbook.Sheets[sheetName];
    gen_currentSheetData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
    genGenerateBtn.disabled = !gen_currentSheetData || gen_currentSheetData.length === 0;
    if (gen_currentSheetData.length > 0) {
        gen_columnHeaders = Object.keys(gen_currentSheetData[0]);
        columnConfigContainer.style.display = 'block';
        updateColumnSelectors();
        updateContentInsertionPreview();
    }
}
function updateColumnSelectors() {
    columnConfigArea.innerHTML = '';
    const count = parseInt(columnCountInput.value, 10);
    for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'config-item row-flex';
        div.innerHTML = `
            <label for="column-selector-${i}">配置列 ${i}:</label>
            <div class="input-wrapper">
                <select id="column-selector-${i}" class="column-selector">
                    ${gen_columnHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}
                </select>
            </div>`;
        columnConfigArea.appendChild(div);
        const select = div.querySelector('select');
        if (i === 1 && gen_columnHeaders.includes('摘要')) select.value = '摘要';
        if (i === 2 && gen_columnHeaders.includes('权利要求')) select.value = '权利要求';
        select.addEventListener('change', updateContentInsertionPreview);
    }
    updateContentInsertionPreview();
}
function updateContentInsertionPreview() {
    const selectors = document.querySelectorAll('.column-selector');
    let placeholders = [];
    selectors.forEach((sel, i) => {
        placeholders.push(`{${sel.value || `配置列${i+1}`}}`);
    });
    contentInsertionPreview.textContent = `专利内容如下：\n${placeholders.join('\n\n')}`;
}
function buildUserPrompt() {
    const rules = promptRules.value.trim();
    
    const columnSelectors = document.querySelectorAll('.column-selector');
    let contentInsertionTemplate = "专利内容如下：\n";
    columnSelectors.forEach(sel => {
        contentInsertionTemplate += `{${sel.value}}\n\n`;
    });

    const outputFields = getOutputFieldsFromUI();
    let outputFormat = "";
    if (outputFields.length > 0) {
        const jsonFields = outputFields.map(f => `  "${f.name}": "[${f.desc}]"`).join(',\n');
        outputFormat = `请严格按照以下JSON格式输出，不要添加任何其他说明或markdown标记：\n{\n${jsonFields}\n}`;
    }
    return [rules, contentInsertionTemplate.trim(), outputFormat].filter(Boolean).join('\n\n');
}
function generateJsonl() {
    if (!gen_currentSheetData) return;
    const userPromptTemplate = buildUserPrompt();
    const columnSelectors = document.querySelectorAll('.column-selector');
    const selectedColumns = Array.from(columnSelectors).map(sel => sel.value);
    
    const requests = gen_currentSheetData.map((row, index) => {
        let finalUserPrompt = userPromptTemplate;
        selectedColumns.forEach(colName => {
            const placeholder = new RegExp(`{${colName}}`, 'g');
            finalUserPrompt = finalUserPrompt.replace(placeholder, row[colName] || '');
        });

        return {
            custom_id: `request-${index + 1}`,
            request_id: `request-${index + 1}`,
            body: {
                model: apiModelSelect.value,
                messages: [
                    { role: 'system', content: apiSystemInput.value },
                    { role: 'user', content: finalUserPrompt }
                ],
                temperature: parseFloat(apiTempInput.value)
            }
        };
    });
    gen_jsonlContent = requests.map(JSON.stringify).join('\n');
    genPreviewOutput.style.display = 'block';
    genPreviewOutput.innerHTML = requests.slice(0, 3).map(req => `<div class="preview-item">${JSON.stringify(req, null, 2)}</div>`).join('');
    genDownloadBtn.style.display = 'inline-block';
    genReadyInfo.style.display = 'block';
}
function addOutputField(name = '', desc = '') {
    const fieldId = `field-${Date.now()}`;
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'output-field';
    fieldDiv.style.display = 'flex';
    fieldDiv.style.gap = '10px';
    fieldDiv.style.marginBottom = '10px';
    fieldDiv.style.alignItems = 'center';
    fieldDiv.id = fieldId;
    fieldDiv.innerHTML = `
        <input type="text" class="output-field-name" placeholder="字段名 (英文/数字)" value="${name}" style="flex-grow: 1;">
        <input type="text" class="output-field-desc" placeholder="字段描述/注释" value="${desc}" style="flex-grow: 2;">
        <button type="button" class="small-button delete-button" onclick="document.getElementById('${fieldId}').remove()">删除</button>
    `;
    outputFieldsContainer.appendChild(fieldDiv);
}
function getOutputFieldsFromUI() {
    const fields = [];
    document.querySelectorAll('.output-field').forEach(div => {
        const name = div.querySelector('.output-field-name').value.trim();
        const desc = div.querySelector('.output-field-desc').value.trim();
        if (name) fields.push({ name, desc });
    });
    return fields;
}
function downloadJsonl(){
    if(!gen_jsonlContent)return;
    const blob=new Blob([gen_jsonlContent],{type:"application/jsonl"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="batch_requests.jsonl";
    a.click();
    URL.revokeObjectURL(a.href);
}

// =================================================================================
// 模板管理
// =================================================================================
function loadTemplateUI(template) {
    if (!template) return;
    apiSystemInput.value = template.system || '';
    if (typeof template.user === 'string') {
        promptRules.value = template.user;
        outputFieldsContainer.innerHTML = '';
    } else if (template.user && typeof template.user === 'object') {
        promptRules.value = template.user.rules || '';
        outputFieldsContainer.innerHTML = '';
        if(template.user.outputFields) {
           template.user.outputFields.forEach(f => addOutputField(f.name, f.desc));
        }
    }
}
function initTemplates() {
    custom_templates = JSON.parse(localStorage.getItem('custom_templates') || '[]');
    updateTemplateSelector();
    loadTemplate();
}
function updateTemplateSelector() {
    const selectedValue = templateSelector.value;
    templateSelector.innerHTML = '';
    const allTemplates = [...preset_templates, ...custom_templates];
    const groups = { '预设模板': [], '自定义模板': [] };
    allTemplates.forEach(t => {
        groups[t.isPreset ? '预设模板' : '自定义模板'].push(t);
    });
    for (const groupName in groups) {
        if (groups[groupName].length > 0) {
            const group = document.createElement('optgroup');
            group.label = groupName;
            groups[groupName].forEach(t => {
                const option = document.createElement('option');
                option.value = t.name;
                option.textContent = t.name;
                group.appendChild(option);
            });
            templateSelector.appendChild(group);
        }
    }
    if (allTemplates.some(t => t.name === selectedValue)) {
        templateSelector.value = selectedValue;
    }
}
function loadTemplate() {
    const selectedName = templateSelector.value;
    const template = [...preset_templates, ...custom_templates].find(t => t.name === selectedName);
    loadTemplateUI(template);
}
function saveTemplate() {
    const name = prompt("请输入新模板的名称:", `自定义模板_${Date.now()}`);
    if (!name || !name.trim()) return;
    if ([...preset_templates, ...custom_templates].some(t => t.name === name)) {
        alert("错误：该模板名称已存在！"); return;
    }
    const template = { name: name.trim(), system: apiSystemInput.value, user: { rules: promptRules.value, outputFields: getOutputFieldsFromUI() } };
    custom_templates.push(template);
    localStorage.setItem('custom_templates', JSON.stringify(custom_templates));
    updateTemplateSelector();
    templateSelector.value = name;
    alert("模板已保存！");
}
function deleteTemplate() {
    const selectedName = templateSelector.value;
    const template = custom_templates.find(t => t.name === selectedName);
    if (!template) {
        alert("错误：只能删除自定义模板。"); return;
    }
    if (confirm(`确定要删除模板 "${selectedName}" 吗？`)) {
        custom_templates = custom_templates.filter(t => t.name !== selectedName);
        localStorage.setItem('custom_templates', JSON.stringify(custom_templates));
        initTemplates();
        alert("模板已删除！");
    }
}
function exportTemplate() {
    const selectedName = templateSelector.value;
    const template = [...preset_templates, ...custom_templates].find(t => t.name === selectedName);
    if (!template) { alert("请先选择一个要导出的模板"); return; }
    const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${template.name.replace(/[\/\\?%*:|"<>]/g, '-')}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
}
function importTemplate(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const t = JSON.parse(e.target.result);
            if (!t.name || !t.system || !t.user) throw new Error("模板文件格式不正确。");
            let newName = t.name;
            if ([...preset_templates, ...custom_templates].some(temp => temp.name === newName)) { 
                newName = `${t.name}_imported_${Date.now()}`;
                alert(`模板名称冲突，已重命名为 "${newName}"`);
            }
            t.name = newName;
            delete t.isPreset;
            custom_templates.push(t);
            localStorage.setItem('custom_templates', JSON.stringify(custom_templates));
            updateTemplateSelector();
            templateSelector.value = newName;
            loadTemplate();
            alert("模板导入成功！");
        } catch (err) {
            alert(`导入失败: ${err.message}`);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// =================================================================================
// 通用工具
// =================================================================================
function switchTab(tabName) {
    document.querySelectorAll(".tab-content, .tab-button").forEach(el => el.classList.remove("active"));
    getEl(`${tabName}-tab`).classList.add("active");
    document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add("active");

    if (tabName === 'reporter' && batch_result_jsonl_content) {
        repInfoBox.style.display = 'block';
        rep_jsonlData = parseJsonl(batch_result_jsonl_content);
        checkReporterReady();
    } else if (tabName !== 'reporter') {
        repInfoBox.style.display = 'none';
    }
}
</script>

</body>
</html>
