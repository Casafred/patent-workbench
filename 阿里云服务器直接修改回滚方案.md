# 阿里云服务器直接修改文件的回滚方案

## 问题分析

根据 `20260130.md` 记录，你在服务器上直接修改了以下文件：
1. `backend/utils/ocr_utils.py` - 修复了OCR的elapse格式化和置信度转换bug
2. `js/drawingMarkerInteractive.js` - 新增交互式标注功能
3. `frontend/index.html` - 集成交互式标注
4. `/etc/systemd/system/patent-app.service` - 切换到Python 3.11环境
5. 创建了 `venv311` 虚拟环境

这些修改**没有提交到Git**，所以简单的 `git reset` 会丢失这些工作。

## 解决方案

### 方案1：先备份服务器修改，再回滚（推荐）

```bash
# 1. SSH连接到服务器
ssh root@43.99.101.195

# 2. 切换到项目目录
cd /home/appuser/patent-app

# 3. 查看当前有哪些未提交的修改
git status

# 4. 创建一个备份分支保存当前所有修改
git add -A
git commit -m "服务器直接修改的内容备份 - OCR修复和交互式标注"
git branch backup-server-changes-20260130

# 5. 查看提交历史，找到同步GitHub之前的commit
git log --oneline -20

# 6. 回滚到同步前的版本（假设是 abc1234）
git reset --hard abc1234

# 7. 如果需要恢复刚才的修改
# git cherry-pick backup-server-changes-20260130

# 8. 修复文件权限
chown -R appuser:appuser /home/appuser/patent-app

# 9. 重启服务
systemctl restart patent-app
```

### 方案2：只回滚特定文件（保留服务器修改）

如果你只想回滚某些文件，保留OCR和交互式标注的修改：

```bash
cd /home/appuser/patent-app

# 查看某个文件的历史版本
git log --oneline -- 文件路径

# 回滚单个文件到指定版本
git checkout abc1234 -- 文件路径

# 例如：
git checkout abc1234 -- frontend/css/某个文件.css
git checkout abc1234 -- backend/routes/某个文件.py

# 重启服务
systemctl restart patent-app
```

### 方案3：从本地推送覆盖服务器（最安全）

```bash
# 在你的本地Windows电脑上

# 1. 确保本地代码是你想要的版本
git log --oneline -10

# 2. 强制推送到服务器（需要先配置服务器为远程仓库）
# 或者直接用rsync/scp覆盖特定文件

# 3. 使用SCP覆盖特定文件
scp 本地文件路径 root@43.99.101.195:/home/appuser/patent-app/对应路径
```

## 推荐操作步骤

### 第一步：先在服务器上提交当前修改

```bash
ssh root@43.99.101.195

cd /home/appuser/patent-app

# 查看修改了哪些文件
git status

# 提交所有修改
git add -A
git commit -m "服务器直接修改 - OCR修复和交互式标注 (20260130)"

# 创建备份分支
git branch backup-20260130

# 查看提交历史
git log --oneline -20
```

### 第二步：确定要回滚到哪个版本

```bash
# 查看详细的提交信息
git log -10

# 找到"同步GitHub"之前的那个commit的hash值
# 例如：abc1234
```

### 第三步：回滚

```bash
# 回滚到指定版本
git reset --hard abc1234

# 修复权限
chown -R appuser:appuser /home/appuser/patent-app

# 重启服务
systemctl restart patent-app

# 查看服务状态
systemctl status patent-app
```

### 第四步：如果回滚错了，恢复

```bash
# 查看所有操作历史
git reflog

# 恢复到备份分支
git reset --hard backup-20260130

# 或者恢复到某个reflog记录
git reset --hard HEAD@{1}
```

## 特别注意

### 1. Python 3.11 环境不会丢失
- `venv311` 虚拟环境在文件系统中，不受Git影响
- systemd服务配置在 `/etc/systemd/system/`，也不受Git影响
- 回滚后这些仍然保留

### 2. 需要手动处理的文件
如果回滚后发现某些功能不工作，可能需要从备份分支恢复特定文件：

```bash
# 从备份分支恢复特定文件
git checkout backup-20260130 -- backend/utils/ocr_utils.py
git checkout backup-20260130 -- js/drawingMarkerInteractive.js
git checkout backup-20260130 -- frontend/index.html
```

### 3. 数据文件不会丢失
- `backend/user_management/users.json` - 用户数据
- `uploads/` - 上传的文件
- 这些通常在 `.gitignore` 中，不受回滚影响

## 一键回滚脚本（保留服务器修改）

```bash
cd /home/appuser/patent-app && \
git add -A && \
git commit -m "备份服务器修改" && \
git branch backup-20260130 && \
git log --oneline -20
```

执行后会显示提交历史，然后你告诉我要回滚到哪个commit，我再给你回滚命令。

## 快速查看命令

```bash
# 在服务器上执行，查看当前状态
cd /home/appuser/patent-app
git status
git log --oneline -10
git branch -a
```

请先在服务器上执行这些命令，把输出发给我，我会根据实际情况给你准确的回滚命令。
