# 联网搜索可视化增强完成

## 更新日期
2026年1月24日

## 新增功能

### 1. 搜索过程可视化

在启用联网搜索后，用户可以看到完整的搜索过程：

#### 搜索阶段提示
```
🔍 正在联网搜索相关信息...
```
- 显示动态加载动画
- 渐变紫色背景，视觉效果醒目
- 让用户知道AI正在获取最新信息

#### 搜索完成提示
```
✓ 已找到 5 条相关信息，正在生成回答...
```
- 显示找到的结果数量
- 渐变绿色背景，表示成功
- 平滑过渡到AI回答生成

### 2. 搜索来源引用展示

AI回答完成后，会在消息底部显示所有搜索来源：

```
🔍 搜索来源 (5)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[1] 2025年第一季度中东地缘政治冲突分析    搜狐  2025-05-23
[2] 全球能源市场最新动态                  新浪  2025-05-22
[3] 原油价格波动趋势报告                  财经网 2025-05-21
...
```

#### 来源信息包含：
- **序号标签**：[1], [2], [3]... 方便引用
- **标题链接**：点击可直接访问原文
- **来源媒体**：显示信息来源网站
- **发布日期**：显示信息时效性
- **悬停提示**：鼠标悬停显示内容摘要

### 3. 视觉设计特点

#### 渐变色彩系统
- **搜索中**：紫色渐变 (#667eea → #764ba2)
- **搜索完成**：绿色渐变 (#11998e → #38ef7d)
- **来源卡片**：灰蓝渐变 (#f5f7fa → #c3cfe2)

#### 交互动效
- 搜索进度动画（旋转加载器）
- 来源卡片悬停效果（阴影+位移）
- 平滑的淡入动画
- 响应式布局适配

#### 深色模式支持
- 自动适配系统深色模式
- 优化的对比度和可读性
- 保持视觉层次清晰

## 技术实现

### 前端改动 (js/chat.js)

#### 1. 搜索状态管理
```javascript
let searchResults = null;  // 存储搜索结果
let isSearching = false;   // 搜索状态标志
```

#### 2. 搜索进度显示
```javascript
if (appState.chat.searchMode.enabled) {
    isSearching = true;
    assistantContentEl.innerHTML = `
        <div class="search-progress">
            <div class="search-spinner"></div>
            <span>正在联网搜索相关信息...</span>
        </div>
    `;
}
```

#### 3. 捕获搜索结果
```javascript
const toolCalls = parsed.choices[0]?.delta?.tool_calls;
if (toolCalls && toolCalls.length > 0) {
    const webSearchTool = toolCalls.find(t => t.type === 'web_search');
    if (webSearchTool && webSearchTool.web_search) {
        if (webSearchTool.web_search.outputs) {
            searchResults = webSearchTool.web_search.outputs;
            // 显示搜索完成提示
        }
    }
}
```

#### 4. 渲染搜索来源
```javascript
if (searchResults && searchResults.length > 0) {
    const sourcesDiv = document.createElement('div');
    sourcesDiv.className = 'search-sources';
    sourcesDiv.innerHTML = `
        <div class="sources-header">...</div>
        <div class="sources-list">
            ${searchResults.map((result, index) => `
                <div class="source-item">
                    <span class="source-number">[${index + 1}]</span>
                    <a href="${result.link}" ...>${result.title}</a>
                    ...
                </div>
            `).join('')}
        </div>
    `;
    assistantContentEl.appendChild(sourcesDiv);
}
```

#### 5. 持久化搜索结果
```javascript
const assistantMessageData = { 
    role: 'assistant', 
    content: fullResponse, 
    timestamp: Date.now(),
    searchResults: searchResults  // 保存到消息历史
};
```

### 样式改动 (frontend/css/pages/chat.css)

新增了以下CSS类：
- `.search-progress` - 搜索进度提示
- `.search-complete` - 搜索完成提示
- `.search-spinner` - 加载动画
- `.search-sources` - 来源容器
- `.sources-header` - 来源标题
- `.sources-list` - 来源列表
- `.source-item` - 单个来源项
- `.source-number` - 序号标签
- `.source-link` - 来源链接
- `.source-media` - 媒体标签
- `.source-date` - 日期标签

## 用户体验提升

### 1. 透明度提升
- 用户可以清楚看到AI何时在搜索
- 用户知道AI使用了哪些信息源
- 用户可以验证信息的来源和时效性

### 2. 可信度提升
- 所有信息都有明确来源
- 可以点击查看原文验证
- 显示发布日期，确保信息时效性

### 3. 交互性提升
- 悬停显示内容摘要
- 点击直接访问原文
- 视觉反馈清晰直观

### 4. 可访问性
- 支持键盘导航
- 支持屏幕阅读器
- 深色模式友好

## 使用示例

### 测试场景 1：实时新闻查询
```
用户：2026年1月的最新科技新闻有哪些？

AI：[显示搜索进度]
    🔍 正在联网搜索相关信息...
    
    [搜索完成]
    ✓ 已找到 10 条相关信息，正在生成回答...
    
    [AI回答]
    根据最新的网络搜索结果，2026年1月的主要科技新闻包括：
    
    1. OpenAI发布GPT-5模型[1]
    2. 苹果推出AR眼镜新品[2]
    3. 特斯拉自动驾驶技术突破[3]
    ...
    
    [搜索来源]
    🔍 搜索来源 (10)
    [1] OpenAI发布GPT-5：AI新纪元    TechCrunch  2026-01-15
    [2] 苹果AR眼镜正式发布            The Verge   2026-01-12
    [3] 特斯拉FSD Beta 12更新         Electrek    2026-01-10
    ...
```

### 测试场景 2：专业领域查询
```
用户：请分析2026年第一季度全球能源市场趋势

AI：[显示搜索进度]
    🔍 正在联网搜索相关信息...
    
    [搜索完成]
    ✓ 已找到 8 条相关信息，正在生成回答...
    
    [AI回答]
    基于最新的市场数据和分析报告[1][2][3]，2026年第一季度全球能源市场呈现以下趋势：
    
    一、原油价格波动
    - 布伦特原油价格在$75-85/桶区间波动[1]
    - 受中东地缘政治影响，价格波动加剧[2]
    ...
    
    [搜索来源]
    🔍 搜索来源 (8)
    [1] 2026年Q1原油市场分析报告     Bloomberg   2026-01-20
    [2] 中东地缘政治对能源市场影响   Reuters     2026-01-18
    [3] IEA月度石油市场报告          IEA         2026-01-15
    ...
```

## 配置选项

用户可以在搜索配置弹窗中调整：

1. **搜索引擎类型**
   - 智谱基础版 (0.01元/次)
   - 智谱高级版 (0.03元/次) ⭐推荐
   - 搜狗 (0.05元/次)
   - 夸克 (0.05元/次)

2. **返回结果数量**
   - 1-50条可选
   - 建议5-10条

3. **内容长度**
   - 中等（摘要信息）
   - 详细（完整内容）

## 注意事项

1. **搜索结果的准确性**
   - 搜索结果来自第三方网站
   - 建议点击原文链接验证信息
   - 注意查看发布日期

2. **性能考虑**
   - 搜索会增加响应时间（通常2-5秒）
   - 建议根据需要开启搜索功能
   - 过多结果会影响加载速度

3. **费用提示**
   - 每次搜索会产生额外费用
   - 费用取决于选择的搜索引擎
   - 建议合理使用

## 后续优化方向

1. **搜索结果缓存**
   - 相同查询复用结果
   - 减少API调用次数
   - 降低使用成本

2. **智能搜索建议**
   - 根据对话内容自动建议是否搜索
   - 优化搜索关键词提取
   - 提高搜索相关性

3. **来源可信度评分**
   - 显示来源网站的可信度
   - 标注官方/权威来源
   - 帮助用户判断信息质量

4. **搜索历史记录**
   - 保存搜索历史
   - 支持搜索结果回溯
   - 方便信息追踪

## 部署清单

- [x] 修复API参数格式问题
- [x] 添加搜索过程可视化
- [x] 实现搜索来源展示
- [x] 添加CSS样式和动画
- [x] 支持深色模式
- [x] 持久化搜索结果
- [x] 创建使用文档

## 测试建议

1. 启用联网搜索功能
2. 测试不同类型的查询：
   - 实时新闻："今天的科技新闻"
   - 专业分析："2026年能源市场趋势"
   - 事实查询："OpenAI最新产品"
3. 验证搜索过程显示
4. 检查来源链接可访问性
5. 测试深色模式显示效果

## 参考资料

- [智谱AI联网搜索文档](https://docs.bigmodel.cn/cn/guide/tools/web-search)
- [Web Search API参考](https://docs.bigmodel.cn/api-reference/%E5%B7%A5%E5%85%B7-api/%E7%BD%91%E7%BB%9C%E6%90%9C%E7%B4%A2)
- [对话中的网络搜索](https://docs.bigmodel.cn/api-reference/%E6%A8%A1%E5%9E%8B-api/%E5%AF%B9%E8%AF%9D%E8%A1%A5%E5%85%A8)
