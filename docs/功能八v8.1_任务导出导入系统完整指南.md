# 功能八 v8.1 - 任务导出/导入系统

## 🎉 新增功能
2025-02-01 更新

### 任务管理系统
采用**以分析任务为单位**的整体管理方案，支持完整的导出和导入功能。

---

## 📊 系统架构

### 任务结构
```javascript
{
  taskId: "task_1707000000000_abc123def",           // 唯一任务ID
  taskName: "分析任务_2025-02-01 12:00:00",         // 任务名称
  createTime: "2025-02-01T12:00:00.000Z",           // 创建时间
  images: [
    {
      url: "data:image/png;base64,...",             // 图片数据
      title: "附图1",                                 // 图片标题
      detectedNumbers: [...],                        // OCR识别结果
      referenceMap: { "1": "底座", "2": "支架" }    // 说明书标记映射
    },
    // 更多图片...
  ],
  analysisData: {
    "img_12345": {                                   // 图片哈希作为键
      timestamp: 1707000000000,
      imageTitle: "附图1",
      annotations: [                                 // 用户标注
        {
          number: "1",
          name: "底座",
          markerX: 100,
          markerY: 200,
          labelX: 180,
          labelY: 160,
          fontSize: 22,
          color: "#4CAF50",
          userModified: true,
          // ... 其他属性
        }
      ],
      currentFontSize: 22,
      currentColor: "#4CAF50"
    },
    "img_67890": { /* 第二张图的分析数据 */ }
  }
}
```

---

## 🚀 核心功能

### 1. 自动任务创建
- **触发时机**：完成分析后，自动创建新任务
- **任务命名**：`分析任务_时间戳`
- **关联关系**：关联到所有上传的图片和检测结果

### 2. 导出任务

#### 使用步骤
1. 打开功能八后，在工具栏右侧点击**下载图标**（导出任务）
2. 弹出任务列表对话框
3. 可以：
   - ✅ **全选**：一次性导出所有任务
   - ✅ **勾选**：选择特定的任务进行导出
   - ✅ **多选**：勾选多个任务

#### 导出内容
- 所有已选任务的完整数据
- 包括：图片、OCR结果、用户标注、样式设置
- 导出的每个任务是**独立单位**，包含所有图片和分析数据

#### 导出文件
- **格式**：JSON
- **文件名**：`专利标注任务导出_N个任务_时间戳.json`
- **大小**：取决于图片数量和标注内容

#### 导出对话框功能
| 操作 | 说明 |
|------|------|
| 全选 | 一次勾选所有任务 |
| 取消 | 关闭对话框，不导出 |
| 导出 | 导出所有勾选的任务 |

### 3. 导入任务

#### 使用步骤
1. 打开功能八后，在工具栏右侧点击**上传图标**（导入任务）
2. 选择之前导出的JSON文件
3. 系统自动解析并显示预览
4. 确认导入即可恢复所有数据

#### 导入预览
- 显示待导入的任务数量
- 显示每个任务的详细信息
  - 任务名称
  - 包含的图片数量
  - 已分析的图片数量

#### 导入后
- 所有任务添加到本地库
- 自动保存到localStorage
- 可以随时在导出对话框中看到

#### 支持场景
- ✅ **跨浏览器**：在另一个浏览器中导入之前导出的任务
- ✅ **跨设备**：在不同设备上导入任务
- ✅ **备份恢复**：恢复之前的分析数据

---

## 💾 数据持久化

### localStorage存储
```javascript
// 键名
"patent_workbench_tasks"

// 值：JSON数组，包含所有任务
[
  { taskId: "...", taskName: "...", ... },
  { taskId: "...", taskName: "...", ... }
]
```

### 存储特性
- ✅ 浏览器本地存储，无需服务器
- ✅ 自动保存每一次修改
- ✅ 跨标签页同步（同浏览器）
- ⚠️ 不同浏览器不共享数据

### 清除数据
```
打开浏览器开发者工具
→ Application
→ Local Storage
→ 找到 "patent_workbench_tasks"
→ 右键删除
```

---

## 📁 导出文件格式

### 完整JSON结构
```json
{
  "exportTime": "2025-02-01T12:00:00.000Z",
  "exportVersion": "1.0",
  "tasks": [
    {
      "taskId": "task_1707000000000_abc123",
      "taskName": "分析任务_2025-02-01 12:00:00",
      "createTime": "2025-02-01T12:00:00.000Z",
      "images": [
        {
          "url": "data:image/png;base64,...",
          "title": "附图1",
          "detectedNumbers": [
            {
              "number": "1",
              "x": 100,
              "y": 200,
              "width": 20,
              "height": 20,
              "confidence": 95
            }
          ],
          "referenceMap": {
            "1": "底座",
            "2": "支架",
            "3": "连接件"
          }
        },
        // 更多图片...
      ],
      "analysisData": {
        "img_12345": {
          "timestamp": 1707000000000,
          "imageTitle": "附图1",
          "annotations": [
            {
              "id": "annotation_0",
              "markerX": 100,
              "markerY": 200,
              "labelX": 180,
              "labelY": 160,
              "number": "1",
              "name": "底座",
              "confidence": 0.95,
              "isManual": false,
              "fontSize": 22,
              "color": "#4CAF50",
              "userModified": true
            }
          ],
          "currentFontSize": 22,
          "currentColor": "#4CAF50"
        }
      }
    }
  ]
}
```

---

## 🔄 工作流程示例

### 场景1：保存工作进度
```
1. 上传图片和说明书
2. 完成分析（自动创建任务）
3. 标注编辑和调整
4. 点击"导出任务"
5. 勾选当前任务，导出为JSON
6. 保存JSON文件到本地
```

### 场景2：恢复之前的工作
```
1. 打开功能八
2. 点击"导入任务"
3. 选择之前导出的JSON文件
4. 确认导入
5. 任务恢复到系统，可继续编辑
```

### 场景3：团队协作
```
用户A:
1. 分析图片，完成标注
2. 导出任务
3. 发送JSON文件给用户B

用户B:
1. 接收JSON文件
2. 导入任务
3. 查看用户A的分析结果
4. 继续编辑或导出
```

---

## 🎯 高级用法

### 批量导出
- 导出对话框支持勾选多个任务
- 一次导出多个分析结果
- 导出文件包含所有选中任务的完整数据

### 合并任务
```
用户A导出任务X的JSON
用户B导出任务Y的JSON

在用户B的浏览器中：
1. 导入任务X（X被添加到库）
2. 导入任务Y（Y被添加到库）
3. 现在可以一起管理X和Y任务
4. 导出X+Y合并后的JSON
```

### 版本控制
- 每个导出文件都有时间戳标识
- 文件名包含创建时间
- 可以保留多个版本

---

## ⚙️ 技术实现细节

### TaskManager 静态类
```javascript
MultiImageViewerV8.TaskManager = {
  tasks: new Map(),           // 存储所有任务

  createTask(name, images),   // 创建新任务
  getTask(taskId),            // 获取指定任务
  listTasks(),                // 列出所有任务
  deleteTask(taskId),         // 删除任务
  saveAnalysisData(taskId, imageHash, data),  // 保存分析数据
  saveToStorage(),            // 保存到localStorage
  loadFromStorage()           // 从localStorage加载
}
```

### 任务生命周期
1. **创建** → `createTask()` 自动创建
2. **编辑** → 修改标注时自动保存
3. **保存** → `saveAnalysisData()` 保存到任务
4. **导出** → JSON格式导出
5. **导入** → 恢复任务到系统

---

## 🔒 数据安全

### 隐私保护
- 所有数据存储在本地浏览器
- 不上传到服务器
- 不涉及个人信息

### 数据备份
- **本地备份**：定期导出JSON
- **云端备份**：可上传JSON到云存储
- **多副本**：保持多个版本

### 数据恢复
- 导出的JSON可随时导入
- 支持跨浏览器、跨设备导入
- 不受浏览器缓存清理影响

---

## 📝 常见问题

### Q: 导出的JSON文件很大怎么办？
A: JSON包含图片的BASE64编码（很占空间）。建议：
- 只导出需要的任务
- 定期清理旧任务
- 可以压缩JSON文件后保存

### Q: 导入失败提示"无效的文件格式"怎么办？
A: 检查：
- 文件是否被修改或损坏
- 是否选择了正确的JSON文件
- 文件编码是否为UTF-8

### Q: 导入后任务没有显示在导出列表中？
A: 刷新页面后重试，或检查浏览器localStorage是否满。

### Q: 可以部分导出任务吗？
A: 可以。在导出对话框中只勾选需要的任务即可。

### Q: 一次导入多个JSON文件吗？
A: 需要逐个导入，系统会自动合并到库中。

---

## 🐛 故障排除

### localStorage满了
- 症状：导出失败，提示存储空间不足
- 解决：
  1. 打开开发者工具 → Application → Local Storage
  2. 删除不需要的任务
  3. 定期导出重要任务

### 导入后数据不完整
- 症状：导入成功但某些标注丢失
- 解决：
  1. 检查JSON文件完整性
  2. 确保浏览器没有限制localStorage
  3. 清除浏览器缓存后重试

---

## 📊 数据统计

导出文件中会自动统计：
- 总任务数
- 每个任务包含的图片数
- 每个任务的已分析图片数
- 每个任务的标注总数

---

## 🔔 更新日志

### v8.1 (2025-02-01)
- ✨ 新增完整的任务管理系统
- ✨ 支持多任务导出（可勾选）
- ✨ 支持完整的导入功能
- ✨ 修复截图中引线为斜线的问题
- 🐛 改进导出/导入的UI/UX
- ⚡ 优化localStorage使用

### v8.0 (2025-02-01)
- 原始版本，仅支持单个标注导出

---

## 💡 最佳实践

### 定期备份
```
每周导出一次重要任务 → 保存到云存储
```

### 命名规范
```
文件名格式：
分析报告_[项目名]_[日期].json
示例：
分析报告_专利XYZ123_2025-02-01.json
```

### 版本管理
```
导出时包含版本号：
分析报告_v1.0_2025-02-01.json
分析报告_v2.0_2025-02-05.json
```

### 多设备同步
```
1. 在设备A导出任务
2. 通过云存储传输JSON
3. 在设备B导入任务
4. 修改后导出
5. 在设备A导入更新后的版本
```

---

## 🎓 教程

### 导出第一个任务
1. 完成分析
2. 点击工具栏中的**下载图标** ⬇️
3. 选择要导出的任务（默认全选）
4. 点击"导出"按钮
5. 等待下载完成

### 导入之前的任务
1. 点击工具栏中的**上传图标** ⬆️
2. 选择保存的JSON文件
3. 查看导入预览
4. 点击"导入"确认
5. 刷新页面查看新导入的任务

---

**文档版本**: v8.1
**更新时间**: 2025-02-01
**状态**: ✅ 已完成
