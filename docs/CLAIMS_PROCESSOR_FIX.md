# 权利要求处理器修复说明

## 修复日期
2026年1月16日

## 修复的问题

### 问题1：换sheet处理时提示"任务不存在"

**问题描述：**
- 用户完成一次权利要求解析后，切换到另一个sheet重新处理时，会提示"任务不存在"
- 无法重新处理并覆盖原结果

**根本原因：**
- 原有的任务ID生成使用时间戳和随机数，每次都生成新的任务ID
- 前端保存的`currentTaskId`在切换sheet后仍然指向旧任务
- 后端没有清理已完成的任务，导致任务累积

**解决方案：**

1. **后端修改** (`backend/routes/claims.py`)：
   - 改变任务ID生成策略：`task_{file_id}_{sheet_name}`
   - 基于文件ID和工作表名称生成固定的任务ID
   - 在创建新任务前检查是否存在同名任务：
     - 如果旧任务状态为`processing`，返回错误（不允许并发处理）
     - 如果旧任务状态为`completed`或`failed`，删除旧任务并创建新任务
   - 这样同一个文件的同一个sheet可以重复处理，自动覆盖旧结果

2. **前端修改** (`js/claimsProcessor.js`)：
   - 在`updateColumnSelect()`函数中，当用户切换sheet时重置`currentTaskId`
   - 在`validateProcessButton()`函数中，当用户切换列时重置`currentTaskId`
   - 隐藏旧的结果区域，确保用户看到的是新处理的结果

### 问题2：未验证权利要求文本内容

**问题描述：**
- 用户可能选错列，解析了不是权利要求的内容
- 没有提前验证，导致处理后才发现选错了列

**解决方案：**

在`backend/routes/claims.py`的`process_claims()`函数中添加内容验证：

1. **读取选定列的数据**
2. **检查关键词**：
   - 支持中英文关键词：`['权利要求', 'claim', 'claims', 'Claim', 'Claims', 'CLAIM', 'CLAIMS']`
   - 统计包含关键词的单元格数量
3. **计算比例**：
   - 如果少于50%的单元格包含权利要求关键词，返回错误
   - 提示用户："警告：所选列中仅有 X% 的单元格包含"权利要求"相关字样。请核对是否选择了正确的权利要求文本列。"
4. **验证通过后才启动处理任务**

## 修改的文件

### 1. backend/routes/claims.py
- 修改`process_claims()`函数
- 添加权利要求文本内容验证
- 改进任务ID生成和管理逻辑

### 2. js/claimsProcessor.js
- 修改`updateColumnSelect()`函数
- 修改`validateProcessButton()`函数
- 修改`startProcessing()`函数，添加验证提示

## 测试验证

创建了`test_claims_fix.py`测试脚本，验证：

### 测试1：权利要求文本验证（多语言）
- ✓ 正常权利要求文本（中文）- 通过
- ✓ 英文权利要求文本 - 通过
- ✓ 日文权利要求文本 - 通过
- ✓ 德文权利要求文本 - 通过
- ✓ 法文权利要求文本 - 通过
- ✓ 韩文权利要求文本 - 通过
- ✓ 非权利要求文本 - 正确拒绝
- ✓ 混合文本（少于50%）- 正确拒绝
- ✓ 混合文本（超过50%）- 通过

### 测试2：任务ID生成逻辑
- ✓ 相同文件不同sheet生成不同任务ID
- ✓ 相同文件相同sheet生成相同任务ID
- ✓ 不同文件生成不同任务ID
- ✓ 任务覆盖逻辑正确工作

## 使用说明

### 用户操作流程

1. **上传Excel文件**
   - 选择包含权利要求的Excel文件

2. **选择工作表和列**
   - 从下拉菜单选择工作表
   - 从下拉菜单选择包含权利要求文本的列

3. **开始处理**
   - 点击"开始处理"按钮
   - 系统会自动验证所选列是否包含权利要求文本
   - 如果验证失败，会提示用户重新选择

4. **查看结果**
   - 处理完成后查看结果
   - 可以导出Excel或JSON格式

5. **重新处理**
   - 如需处理同一文件的其他sheet，直接切换sheet并重新处理
   - 系统会自动覆盖旧结果
   - 如需处理同一sheet的其他列，直接切换列并重新处理

### 错误提示

#### 权利要求文本验证失败
```
警告：所选列中仅有 X% 的单元格包含"权利要求"相关字样。
请核对是否选择了正确的权利要求文本列。
```

**解决方法：**
- 检查是否选择了正确的列
- 确认该列包含权利要求文本而不是其他内容（如摘要、说明书等）

#### 任务正在进行中
```
该文件和工作表的处理任务正在进行中，请等待完成
```

**解决方法：**
- 等待当前处理任务完成
- 或刷新页面重新开始

## 技术细节

### 任务ID生成规则
```python
task_id = f"task_{file_id}_{sheet_name or 'default'}"
```

示例：
- 文件：`20260116_120000_test.xlsx`，工作表：`Sheet1`
  - 任务ID：`task_20260116_120000_test.xlsx_Sheet1`
- 文件：`20260116_120000_test.xlsx`，工作表：`Sheet2`
  - 任务ID：`task_20260116_120000_test.xlsx_Sheet2`

### 权利要求关键词检测

系统支持多国语言的权利要求关键词检测，覆盖主要专利申请国家：

```python
claims_keywords = [
    # 中文
    '权利要求', '請求項', '請求项',
    # 英文
    'claim', 'claims', 'Claim', 'Claims', 'CLAIM', 'CLAIMS',
    # 日文
    '請求項', 'クレーム',
    # 韩文
    '청구항', '請求項',
    # 德文
    'Anspruch', 'Ansprüche', 'anspruch', 'ansprüche',
    # 法文
    'revendication', 'revendications', 'Revendication', 'Revendications',
    # 西班牙文
    'reivindicación', 'reivindicaciones', 'Reivindicación', 'Reivindicaciones',
    # 葡萄牙文
    'reivindicação', 'reivindicações', 'Reivindicação', 'Reivindicações',
    # 俄文
    'пункт формулы', 'формула изобретения',
    # 意大利文
    'rivendicazione', 'rivendicazioni', 'Rivendicazione', 'Rivendicazioni',
    # 荷兰文
    'conclusie', 'conclusies', 'Conclusie', 'Conclusies',
    # 阿拉伯文
    'مطالبة', 'مطالبات'
]
```

**支持的国家/地区：**
- 🇨🇳 中国（简体中文、繁体中文）
- 🇺🇸 美国（英文）
- 🇬🇧 英国（英文）
- 🇯🇵 日本（日文）
- 🇰🇷 韩国（韩文）
- 🇩🇪 德国（德文）
- 🇫🇷 法国（法文）
- 🇪🇸 西班牙（西班牙文）
- 🇵🇹 葡萄牙（葡萄牙文）
- 🇧🇷 巴西（葡萄牙文）
- 🇷🇺 俄罗斯（俄文）
- 🇮🇹 意大利（意大利文）
- 🇳🇱 荷兰（荷兰文）
- 🇸🇦 沙特阿拉伯（阿拉伯文）

验证逻辑：
```python
keyword_ratio = cells_with_keywords / total_non_empty_cells
if keyword_ratio < 0.5:
    # 返回错误，提示用户
```

## 兼容性说明

- 这些修改向后兼容，不影响现有功能
- 旧的任务ID格式会自动失效，不会造成冲突
- 用户体验得到改善，减少误操作

## 后续建议

1. **考虑添加任务历史记录**
   - 保存最近的处理任务
   - 允许用户查看历史结果

2. **优化任务存储**
   - 当前使用内存存储，服务器重启后任务会丢失
   - 考虑使用Redis或数据库持久化存储

3. **添加任务清理机制**
   - 自动清理超过一定时间的已完成任务
   - 避免内存占用过多

4. **增强验证功能**
   - 可以添加更多的内容验证规则
   - 例如检查权利要求编号的连续性
   - 检查权利要求的基本格式

## 总结

通过这次修复，解决了两个重要的用户体验问题：

1. **任务管理问题**：用户现在可以自由切换sheet和列进行重复处理，系统会自动管理任务状态
2. **内容验证问题**：系统会在处理前验证内容，避免用户选错列浪费时间

这些改进使功能七（权利要求处理器）更加健壮和用户友好。
