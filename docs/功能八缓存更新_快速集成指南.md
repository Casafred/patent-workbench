# åŠŸèƒ½å…«ç¼“å­˜æ›´æ–° - å¿«é€Ÿé›†æˆæŒ‡å—

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿé›†æˆ

### æ­¥éª¤1ï¼šå¼•å…¥ç¼“å­˜ç®¡ç†å™¨è„šæœ¬

åœ¨ `frontend/index.html` çš„ `<head>` éƒ¨åˆ†æ·»åŠ ï¼š

```html
<!-- åŠŸèƒ½å…«ç¼“å­˜ç®¡ç†å™¨ -->
<script src="frontend/js/drawingCacheManager.js"></script>
```

### æ­¥éª¤2ï¼šåˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨

åœ¨åŠŸèƒ½å…«çš„åˆå§‹åŒ–ä»£ç ä¸­æ·»åŠ ï¼š

```javascript
// åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨ï¼ˆå…¨å±€ï¼‰
const drawingCacheManager = new DrawingCacheManager();

// é¡µé¢åŠ è½½æ—¶æ¸…ç†è¿‡æœŸç¼“å­˜
document.addEventListener('DOMContentLoaded', () => {
    const cleaned = drawingCacheManager.cleanupExpired();
    if (cleaned > 0) {
        console.log(`âœ… å·²æ¸…ç† ${cleaned} ä¸ªè¿‡æœŸçš„OCRç¼“å­˜`);
    }
});
```

### æ­¥éª¤3ï¼šä¿®æ”¹å¤„ç†å‡½æ•°

æ‰¾åˆ°åŠŸèƒ½å…«çš„å¤„ç†å‡½æ•°ï¼ˆçº¦åœ¨ `frontend/index.html` ç¬¬2250è¡Œï¼‰ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š

**åŸä»£ç ï¼š**
```javascript
// è°ƒç”¨åç«¯APIè¿›è¡Œå¤„ç†
fetch('/api/drawing-marker/process', {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(processingData)
})
```

**ä¿®æ”¹ä¸ºï¼š**
```javascript
// ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥ç¼“å­˜
let forceRefresh = false;
if (processingData.drawings && processingData.drawings.length > 0) {
    const firstDrawing = processingData.drawings[0];
    const cacheKey = drawingCacheManager.generateCacheKey(
        firstDrawing.data,
        firstDrawing.name
    );
    
    const cachedData = drawingCacheManager.getCache(cacheKey);
    if (cachedData) {
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        forceRefresh = await drawingCacheManager.showCacheUpdateDialog(
            firstDrawing.name,
            cachedData
        );
    }
}

// æ·»åŠ  force_refresh å‚æ•°
processingData.force_refresh = forceRefresh;

// è°ƒç”¨åç«¯APIè¿›è¡Œå¤„ç†
fetch('/api/drawing-marker/process', {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(processingData)
})
.then(response => response.json())
.then(data => {
    if (data.success && data.data) {
        // ğŸ”¥ æ–°å¢ï¼šä¿å­˜ç¼“å­˜ä¿¡æ¯
        if (data.data.cache_info && processingData.drawings) {
            processingData.drawings.forEach(drawing => {
                const cacheInfo = data.data.cache_info[drawing.name];
                if (cacheInfo && !cacheInfo.has_cache) {
                    // æ–°çš„å¤„ç†ç»“æœï¼Œä¿å­˜åˆ°å‰ç«¯ç¼“å­˜
                    const cacheKey = drawingCacheManager.generateCacheKey(
                        drawing.data,
                        drawing.name
                    );
                    drawingCacheManager.setCache(cacheKey, {
                        ocr_detected_count: data.data.ocr_detected_count,
                        matched_count: data.data.matched_count,
                        timestamp: Date.now()
                    });
                }
            });
        }
        
        displayProcessingResult(data.data, aiConfig.aiMode);
    } else {
        // é”™è¯¯å¤„ç†...
    }
})
```

### æ­¥éª¤4ï¼šæ·»åŠ æ¸…é™¤ç¼“å­˜æŒ‰é’®ï¼ˆå¯é€‰ï¼‰

åœ¨åŠŸèƒ½å…«çš„è®¾ç½®é¢æ¿ä¸­æ·»åŠ æ¸…é™¤ç¼“å­˜æŒ‰é’®ï¼š

```html
<div class="cache-management" style="margin-top: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
    <h4 style="margin-bottom: 10px;">ç¼“å­˜ç®¡ç†</h4>
    <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
        OCRè¯†åˆ«ç»“æœä¼šè¢«ç¼“å­˜7å¤©ï¼Œä»¥æé«˜å¤„ç†é€Ÿåº¦ã€‚
    </p>
    <button onclick="clearDrawingCache()" style="
        padding: 8px 16px;
        background-color: #ff9800;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    ">
        ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç¼“å­˜
    </button>
</div>

<script>
function clearDrawingCache() {
    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰OCRç¼“å­˜å—ï¼Ÿä¸‹æ¬¡å¤„ç†å°†é‡æ–°è¯†åˆ«ã€‚')) {
        drawingCacheManager.clearCache();
        alert('âœ… ç¼“å­˜å·²æ¸…é™¤');
    }
}
</script>
```

## ğŸ“‹ å®Œæ•´ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ï¼šå®Œæ•´çš„å¤„ç†å‡½æ•°

```javascript
async function processDrawingMarker() {
    const drawings = getDrawingsData(); // è·å–å›¾ç‰‡æ•°æ®
    const specification = getSpecification(); // è·å–è¯´æ˜ä¹¦
    const aiConfig = getAIConfig(); // è·å–AIé…ç½®
    
    // å‡†å¤‡å¤„ç†æ•°æ®
    const processingData = {
        drawings: drawings,
        specification: specification,
        ai_mode: aiConfig.aiMode,
        model_name: aiConfig.modelName,
        custom_prompt: aiConfig.customPrompt
    };
    
    // ğŸ”¥ æ£€æŸ¥ç¼“å­˜
    let forceRefresh = false;
    if (drawings && drawings.length > 0) {
        const firstDrawing = drawings[0];
        const cacheKey = drawingCacheManager.generateCacheKey(
            firstDrawing.data,
            firstDrawing.name
        );
        
        const cachedData = drawingCacheManager.getCache(cacheKey);
        if (cachedData) {
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            forceRefresh = await drawingCacheManager.showCacheUpdateDialog(
                firstDrawing.name,
                cachedData
            );
        }
    }
    
    // æ·»åŠ  force_refresh å‚æ•°
    processingData.force_refresh = forceRefresh;
    
    // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
    showProcessingStatus('å¤„ç†ä¸­...');
    
    try {
        // è°ƒç”¨API
        const response = await fetch('/api/drawing-marker/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': aiConfig.aiMode ? `Bearer ${getAPIKey()}` : undefined
            },
            body: JSON.stringify(processingData)
        });
        
        const data = await response.json();
        
        if (data.success && data.data) {
            // ğŸ”¥ ä¿å­˜ç¼“å­˜ä¿¡æ¯
            if (data.data.cache_info && drawings) {
                drawings.forEach(drawing => {
                    const cacheInfo = data.data.cache_info[drawing.name];
                    if (cacheInfo && !cacheInfo.has_cache) {
                        const cacheKey = drawingCacheManager.generateCacheKey(
                            drawing.data,
                            drawing.name
                        );
                        drawingCacheManager.setCache(cacheKey, {
                            ocr_detected_count: data.data.ocr_detected_count,
                            matched_count: data.data.matched_count,
                            timestamp: Date.now()
                        });
                    }
                });
            }
            
            // æ˜¾ç¤ºç»“æœ
            displayProcessingResult(data.data);
        } else {
            showError(data.error || 'å¤„ç†å¤±è´¥');
        }
    } catch (error) {
        console.error('å¤„ç†å¤±è´¥:', error);
        showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    }
}
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1ï¼šé¦–æ¬¡å¤„ç†
1. ä¸Šä¼ ä¸€å¼ æ–°å›¾ç‰‡å’Œè¯´æ˜ä¹¦
2. ç‚¹å‡»"å¼€å§‹å¤„ç†"
3. **é¢„æœŸ**ï¼šä¸æ˜¾ç¤ºç¼“å­˜å¯¹è¯æ¡†ï¼Œç›´æ¥å¤„ç†
4. **éªŒè¯**ï¼šæŸ¥çœ‹æ§åˆ¶å°ï¼Œåº”è¯¥æ˜¾ç¤º"Cached OCR results"

### æµ‹è¯•2ï¼šä½¿ç”¨ç¼“å­˜
1. ä¸Šä¼ ç›¸åŒçš„å›¾ç‰‡å’Œè¯´æ˜ä¹¦
2. ç‚¹å‡»"å¼€å§‹å¤„ç†"
3. **é¢„æœŸ**ï¼šæ˜¾ç¤ºç¼“å­˜ç¡®è®¤å¯¹è¯æ¡†
4. ç‚¹å‡»"ä½¿ç”¨ç¼“å­˜"
5. **éªŒè¯**ï¼šå¿«é€Ÿæ˜¾ç¤ºä¹‹å‰çš„ç»“æœ

### æµ‹è¯•3ï¼šé‡æ–°åˆ†æ
1. ä¸Šä¼ ç›¸åŒçš„å›¾ç‰‡ä½†ä¿®æ”¹è¯´æ˜ä¹¦
2. ç‚¹å‡»"å¼€å§‹å¤„ç†"
3. **é¢„æœŸ**ï¼šæ˜¾ç¤ºç¼“å­˜ç¡®è®¤å¯¹è¯æ¡†
4. ç‚¹å‡»"é‡æ–°åˆ†æ"
5. **éªŒè¯**ï¼šæ‰§è¡Œæ–°çš„OCRè¯†åˆ«ï¼Œæ˜¾ç¤ºæ›´æ–°çš„åŒ¹é…ç»“æœ

### æµ‹è¯•4ï¼šæ¸…é™¤ç¼“å­˜
1. ç‚¹å‡»"æ¸…é™¤æ‰€æœ‰ç¼“å­˜"æŒ‰é’®
2. **é¢„æœŸ**ï¼šæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
3. ç¡®è®¤æ¸…é™¤
4. **éªŒè¯**ï¼šå†æ¬¡å¤„ç†ç›¸åŒå›¾ç‰‡æ—¶ä¸æ˜¾ç¤ºç¼“å­˜å¯¹è¯æ¡†

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç¼“å­˜å¯¹è¯æ¡†ä¸æ˜¾ç¤ºï¼Ÿ
**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ç¡®è®¤å·²å¼•å…¥ `drawingCacheManager.js`
2. ç¡®è®¤å·²åˆå§‹åŒ– `drawingCacheManager`
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
4. ç¡®è®¤localStorageæœªè¢«ç¦ç”¨

### Q2: ç¼“å­˜ä¸€ç›´ä¸è¿‡æœŸï¼Ÿ
**A:** é»˜è®¤ç¼“å­˜7å¤©ï¼Œå¯ä»¥æ‰‹åŠ¨æ¸…é™¤æˆ–ä¿®æ”¹è¿‡æœŸæ—¶é—´ï¼š
```javascript
drawingCacheManager.maxCacheAge = 3 * 24 * 60 * 60 * 1000; // æ”¹ä¸º3å¤©
```

### Q3: å¦‚ä½•æŸ¥çœ‹å½“å‰ç¼“å­˜ï¼Ÿ
**A:** åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š
```javascript
console.log(drawingCacheManager._loadAllCache());
```

### Q4: ç¼“å­˜å ç”¨ç©ºé—´å¤ªå¤§ï¼Ÿ
**A:** localStorageæœ‰5MBé™åˆ¶ï¼Œå¯ä»¥ï¼š
1. å‡å°‘ç¼“å­˜è¿‡æœŸæ—¶é—´
2. å®šæœŸæ¸…ç†ç¼“å­˜
3. åªç¼“å­˜å…³é”®ä¿¡æ¯ï¼ˆä¸ç¼“å­˜å›¾ç‰‡æ•°æ®ï¼‰

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | æ— ç¼“å­˜ | æœ‰ç¼“å­˜ | æå‡ |
|------|--------|--------|------|
| é¦–æ¬¡å¤„ç† | 5-10ç§’ | 5-10ç§’ | - |
| é‡å¤å¤„ç† | 5-10ç§’ | <1ç§’ | **90%+** |
| ç½‘ç»œè¯·æ±‚ | å®Œæ•´OCR | ä»…åŒ¹é… | **å‡å°‘80%** |

## âœ… é›†æˆæ£€æŸ¥æ¸…å•

- [ ] å¼•å…¥ `drawingCacheManager.js` è„šæœ¬
- [ ] åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨
- [ ] ä¿®æ”¹å¤„ç†å‡½æ•°ï¼Œæ·»åŠ ç¼“å­˜æ£€æµ‹
- [ ] æ·»åŠ ç¼“å­˜ä¿å­˜é€»è¾‘
- [ ] æ·»åŠ æ¸…é™¤ç¼“å­˜æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
- [ ] æµ‹è¯•é¦–æ¬¡å¤„ç†æµç¨‹
- [ ] æµ‹è¯•ç¼“å­˜ä½¿ç”¨æµç¨‹
- [ ] æµ‹è¯•å¼ºåˆ¶åˆ·æ–°æµç¨‹
- [ ] æµ‹è¯•ç¼“å­˜æ¸…é™¤åŠŸèƒ½
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

## ğŸ¯ é¢„æœŸæ•ˆæœ

é›†æˆå®Œæˆåï¼Œç”¨æˆ·ä½“éªŒå°†å¾—åˆ°æ˜¾è‘—æå‡ï¼š

1. **é¦–æ¬¡å¤„ç†**ï¼šæ­£å¸¸OCRè¯†åˆ«ï¼Œç»“æœè‡ªåŠ¨ç¼“å­˜
2. **é‡å¤å¤„ç†**ï¼šæ™ºèƒ½æ£€æµ‹ç¼“å­˜ï¼Œç”¨æˆ·å¯é€‰æ‹©ä½¿ç”¨æˆ–åˆ·æ–°
3. **è¯´æ˜ä¹¦æ›´æ–°**ï¼šæç¤ºç”¨æˆ·é‡æ–°åˆ†æä»¥è·å–æœ€æ–°åŒ¹é…
4. **æ€§èƒ½æå‡**ï¼šç¼“å­˜å‘½ä¸­æ—¶å“åº”é€Ÿåº¦æå‡90%ä»¥ä¸Š

---

**é›†æˆæ—¶é—´ï¼š** çº¦5-10åˆ†é’Ÿ  
**éš¾åº¦ï¼š** â­â­â˜†â˜†â˜†ï¼ˆç®€å•ï¼‰  
**æ”¶ç›Šï¼š** â­â­â­â­â­ï¼ˆæ˜¾è‘—ï¼‰
