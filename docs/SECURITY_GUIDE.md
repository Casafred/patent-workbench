# 安全配置指南

## 🔐 密码安全

### 问题：默认密码的安全性

#### ❌ 旧版本（不安全）
```python
DEFAULT_USERS = {
    'admin': 'admin123',  # 明文，容易被猜到
    'demo': 'demo123'     # 明文，容易被猜到
}
```

**问题**：
1. 密码太简单，容易被暴力破解
2. 密码以明文形式存储在代码中
3. 如果代码上传到 GitHub，密码就公开了
4. 所有部署使用相同的默认密码

#### ✅ 新版本（安全）
```python
# 从环境变量读取，如果没有则生成随机密码
DEFAULT_ADMIN_PASSWORD = os.environ.get('DEFAULT_ADMIN_PASSWORD', generate_secure_password(20))
DEFAULT_DEMO_PASSWORD = os.environ.get('DEFAULT_DEMO_PASSWORD', generate_secure_password(20))
```

**改进**：
1. ✅ 优先从环境变量读取密码
2. ✅ 如果没有设置环境变量，自动生成20位随机密码
3. ✅ 密码不会出现在代码中
4. ✅ 每个环境可以有不同的密码
5. ✅ 首次启动时会在控制台显示生成的密码

---

## 🔒 密码存储位置

### 1. 源代码中（init_users.py）
- **旧版**：明文密码 `'admin123'`
- **新版**：从环境变量读取或自动生成
- **用途**：仅用于首次初始化 users.json

### 2. users.json 文件中
```json
{
    "admin": "pbkdf2:sha256:260000$fdnUdPMZ66ZtD9MY$023f716ea92033d924c7655b12decb78c8cdeec7871529cc0c17d047deafdba5"
}
```
- **存储方式**：PBKDF2-SHA256 加密哈希
- **安全性**：✅ 即使文件泄露，也无法反推出原始密码
- **迭代次数**：260,000 次（防止暴力破解）

---

## 🚀 部署配置

### 方式一：使用环境变量（推荐）

#### 本地开发
1. 复制 `.env.example` 为 `.env`：
```bash
cp .env.example .env
```

2. 编辑 `.env` 文件：
```bash
DEFAULT_ADMIN_PASSWORD=YourSecurePassword123!@#
DEFAULT_DEMO_PASSWORD=AnotherSecurePassword456$%^
```

3. 启动应用：
```bash
python run_app.py
```

#### 生产环境（Render）
1. 在 Render Dashboard 中设置环境变量：
   - `DEFAULT_ADMIN_PASSWORD` = 你的安全密码
   - `DEFAULT_DEMO_PASSWORD` = 你的安全密码

2. 部署应用

### 方式二：使用自动生成的密码

如果不设置环境变量，系统会自动生成随机密码：

1. 首次启动应用
2. 查看控制台输出：
```
✅ 已创建 users.json
============================================================
⚠️  重要：默认用户账号信息
============================================================

⚠️  使用随机生成的密码（请妥善保存）

默认用户账号：
  用户名: admin
  密码: K9#mP2$xL5@nQ8&wR3!vT7

  用户名: demo
  密码: A4@bC6#dE8$fG1!hI3%jK5

============================================================
🔒 安全建议：
============================================================
1. 请立即保存上述密码到安全的地方
2. 首次登录后请立即修改密码
3. 或者通过环境变量设置密码
============================================================
```

3. **立即保存这些密码**到安全的地方（密码管理器）
4. 首次登录后立即修改密码

---

## 🛡️ 安全最佳实践

### 1. 密码强度要求
- ✅ 至少 12 个字符
- ✅ 包含大小写字母
- ✅ 包含数字
- ✅ 包含特殊字符
- ❌ 不要使用常见密码（password, 123456, admin123 等）

### 2. 首次部署后
1. 立即登录系统
2. 使用"用户管理.html"修改所有默认用户的密码
3. 删除不需要的 demo 账号

### 3. 定期维护
- 定期更换密码
- 删除不活跃的用户
- 备份 users.json 文件

### 4. 环境变量安全
- ✅ 使用 `.env` 文件（本地开发）
- ✅ 使用平台的环境变量功能（生产环境）
- ❌ 不要将 `.env` 文件提交到 Git
- ✅ `.gitignore` 已包含 `.env`

---

## 📋 检查清单

部署前检查：
- [ ] 已设置 `DEFAULT_ADMIN_PASSWORD` 环境变量
- [ ] 已设置 `DEFAULT_DEMO_PASSWORD` 环境变量
- [ ] 密码强度符合要求
- [ ] `.env` 文件未提交到 Git

部署后检查：
- [ ] 已保存自动生成的密码（如果使用）
- [ ] 已成功登录系统
- [ ] 已修改默认密码
- [ ] 已删除不需要的用户
- [ ] 已备份 users.json

---

## ❓ 常见问题

### Q: 如果忘记密码怎么办？
A: 删除 `backend/user_management/users.json` 文件，重启应用会重新生成默认用户。

### Q: 密码存储在哪里？
A: 加密后的密码存储在 `backend/user_management/users.json` 中。

### Q: 可以看到其他用户的密码吗？
A: 不可以。密码经过 PBKDF2-SHA256 加密，无法反推出原始密码。

### Q: 如何修改现有用户的密码？
A: 使用根目录的 `用户管理.html` 工具：
1. 导入 users.json
2. 删除要修改的用户
3. 重新添加该用户（使用新密码）
4. 保存并替换 users.json

### Q: 环境变量中的密码安全吗？
A: 相对安全。环境变量：
- ✅ 不会被提交到 Git
- ✅ 不会出现在代码中
- ✅ 每个环境可以不同
- ⚠️ 但服务器管理员可以看到

---

## 🔗 相关文档

- [用户管理快速访问](../用户管理快速访问.md)
- [用户管理指南](USER_MANAGEMENT_GUIDE.md)
- [部署指南](deployment/RENDER_DEPLOYMENT_GUIDE.md)

---

**更新时间**：2026-01-20
**版本**：v2.0 - 增强安全性
