# 引证图显示问题调试指南

## 问题描述

点击"查看引用关系"时，部分数据显示"正在分析中"，无法显示引证图结果。

## 可能的原因

### 1. 专利号匹配失败

**症状**：后端找不到对应专利的权利要求数据

**原因**：
- 前端传递的专利号与后端存储的专利号不匹配
- 专利号格式不一致（如有无空格、大小写）
- 专利号为空或undefined

**调试方法**：
```javascript
// 前端：查看浏览器控制台
console.log('[claimsGenerateVisualization] 请求参数:', {
    taskId: claimsCurrentTaskId,
    patentNumber: claimsSelectedPatentNumber,
    rowIndex: claimsSelectedPatentRow
});
```

```python
# 后端：查看服务器日志
print(f"[get_visualization_data] Available patents: {list(available_patents)[:10]}")
```

### 2. 行索引不匹配

**症状**：按行索引查找失败

**原因**：
- 行索引为0或null
- 行索引类型不匹配（字符串vs数字）
- 数据处理时未正确保存行索引

**解决方案**：
- 优先使用专利号查找
- 确保行索引正确保存和传递

### 3. 任务数据未加载

**症状**：提示"任务不存在"

**原因**：
- 任务ID错误
- 任务数据未持久化到磁盘
- Worker重启导致内存数据丢失

**解决方案**：
- 检查任务ID是否正确
- 确保任务完成时保存到磁盘
- 从磁盘加载任务数据

### 4. 权利要求数据为空

**症状**：找到0个权利要求

**原因**：
- 处理过程中未正确关联专利号
- 数据筛选条件过于严格
- 数据结构不匹配

**解决方案**：
- 检查处理过程中是否正确设置patent_number
- 放宽筛选条件（如模糊匹配）
- 验证数据结构

## 调试步骤

### 步骤1：检查前端请求

打开浏览器开发者工具（F12），查看Console和Network标签：

```javascript
// 应该看到类似的日志
[claimsGenerateVisualization] 请求参数: {
    taskId: "task_xxx",
    patentNumber: "US202402107869A1",
    rowIndex: 5
}
```

### 步骤2：检查网络请求

在Network标签中找到 `/api/claims/visualization/` 请求：

**请求**：
```json
POST /api/claims/visualization/task_xxx
{
  "patent_number": "US202402107869A1",
  "row_index": 5
}
```

**响应**：
- 成功：`{"success": true, "data": {...}}`
- 失败：`{"success": false, "error": "..."}`

### 步骤3：检查后端日志

查看服务器日志（Render Dashboard或本地终端）：

```
[get_visualization_data] Task: task_xxx, Patent: US202402107869A1, Row: 5
[get_visualization_data] Task status: completed
[get_visualization_data] Total claims in result: 150
[get_visualization_data] Filtering by patent_number: US202402107869A1
[get_visualization_data] Found claim 1 for patent US202402107869A1
[get_visualization_data] Found claim 2 for patent US202402107869A1
...
[get_visualization_data] Found 15 claims
[get_visualization_data] Built visualization with 15 nodes and 12 links
```

### 步骤4：检查数据匹配

如果找不到数据，查看可用的专利号：

```
[get_visualization_data] No claims found for patent_number=US202402107869A1, row_index=5
[get_visualization_data] Available patents: ['US202402107869A1', 'CN123456789A', ...]
[get_visualization_data] Available rows: [0, 1, 2, 3, 4, 5, ...]
```

## 常见问题和解决方案

### 问题1：专利号不匹配

**现象**：
```
Available patents: ['US202402107869A1']
请求的专利号: 'US202402107869A1 '  // 注意末尾有空格
```

**解决方案**：
```javascript
// 前端：清理专利号
claimsSelectedPatentNumber = patentNumber.trim();
```

### 问题2：行索引为0

**现象**：
```javascript
rowIndex: 0  // JavaScript中0被视为falsy
```

**解决方案**：
```javascript
// 使用严格判断
if (row_index !== null && row_index !== undefined) {
    // 处理行索引
}
```

### 问题3：数据未关联专利号

**现象**：
```
Total claims: 150
Available patents: []  // 空列表
```

**解决方案**：
检查处理过程中是否正确设置patent_number：

```python
# 在processing_service.py中
for claim in cell_claims:
    claim.patent_number = patent_number  # 确保设置
    claim.row_index = i
```

### 问题4：加载指示器不消失

**现象**：
- 一直显示"正在分析中"
- 控制台有错误但UI未更新

**解决方案**：
```javascript
// 确保在所有错误情况下都隐藏加载指示器
if (vizLoadingIndicator) {
    vizLoadingIndicator.style.display = 'none';
}
```

## 快速修复检查清单

- [ ] 浏览器控制台是否有错误？
- [ ] Network标签中请求是否成功（200状态码）？
- [ ] 请求参数是否正确（patent_number和row_index）？
- [ ] 后端日志是否显示找到了权利要求？
- [ ] 专利号是否完全匹配（无空格、大小写一致）？
- [ ] 任务是否已完成（status: completed）？
- [ ] 是否有可视化渲染器错误？

## 测试方法

### 本地测试

```bash
# 1. 启动后端
python run_app.py

# 2. 打开浏览器
http://localhost:5000

# 3. 上传测试文件
# 4. 处理权利要求
# 5. 点击"查看引用关系"
# 6. 查看控制台和网络请求
```

### 生产环境测试

```bash
# 1. 访问Render Dashboard
# 2. 查看Logs标签
# 3. 筛选包含 [get_visualization_data] 的日志
# 4. 分析错误信息
```

## 性能优化建议

### 1. 添加缓存

```javascript
// 缓存已生成的可视化数据
const visualizationCache = new Map();

async function claimsGenerateVisualization() {
    const cacheKey = `${claimsCurrentTaskId}_${claimsSelectedPatentNumber}`;
    
    if (visualizationCache.has(cacheKey)) {
        // 使用缓存数据
        const cachedData = visualizationCache.get(cacheKey);
        renderVisualization(cachedData);
        return;
    }
    
    // 获取新数据并缓存
    const data = await fetchVisualizationData();
    visualizationCache.set(cacheKey, data);
    renderVisualization(data);
}
```

### 2. 添加重试机制

```javascript
async function fetchWithRetry(url, options, maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(url, options);
            if (response.ok) return response;
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
    }
}
```

### 3. 添加超时处理

```javascript
async function fetchWithTimeout(url, options, timeout = 30000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    
    try {
        const response = await fetch(url, {
            ...options,
            signal: controller.signal
        });
        return response;
    } finally {
        clearTimeout(timeoutId);
    }
}
```

## 联系支持

如果以上方法都无法解决问题，请提供以下信息：

1. 浏览器控制台完整日志
2. Network标签中的请求和响应
3. 服务器日志（如果可访问）
4. 测试文件（如果可以分享）
5. 操作步骤重现

## 更新日志

- 2026-01-22: 添加详细日志和错误处理
- 2026-01-22: 改进专利号匹配逻辑
- 2026-01-22: 添加调试指南文档
