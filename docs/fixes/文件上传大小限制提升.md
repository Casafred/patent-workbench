# 文件上传大小限制提升

## 问题描述

用户上传包含大量数据（600条）的Excel文件时，遇到以下错误：
```
413 Request Entity Too Large: The data value transmitted exceeds the capacity limit.
```

这是因为文件大小超过了服务器配置的上传限制（16MB）。

## 根本原因

系统在两个地方设置了文件大小限制：
1. **Flask全局配置** (`backend/config.py`): `MAX_CONTENT_LENGTH = 16MB`
2. **Excel上传路由** (`backend/routes/excel_upload.py`): `MAX_FILE_SIZE = 16MB`

对于包含大量权利要求数据的Excel文件，16MB的限制可能不够。

## 解决方案

### 修改内容

**1. 更新Flask全局配置**

**文件**: `backend/config.py` (第43行)

```python
# 修改前
MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB

# 修改后
MAX_CONTENT_LENGTH = 50 * 1024 * 1024  # 50MB - 支持大型Excel文件
```

**2. 更新Excel上传路由配置**

**文件**: `backend/routes/excel_upload.py` (第24行)

```python
# 修改前
MAX_FILE_SIZE = 16 * 1024 * 1024  # 16MB

# 修改后
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50MB - 支持大型Excel文件
```

## 新的限制

- **最大文件大小**: 50MB
- **支持的文件类型**: .xlsx, .xls, .csv
- **适用范围**: 所有文件上传功能

## 容量估算

50MB的Excel文件可以容纳：
- **纯文本数据**: 约100万行（取决于列数和内容）
- **权利要求数据**: 约5000-10000条专利的权利要求（取决于文本长度）
- **一般业务数据**: 足够满足大多数批量处理需求

## 性能考虑

1. **上传时间**: 
   - 50MB文件在正常网络下上传需要30-60秒
   - 建议在上传时显示进度条

2. **处理时间**:
   - 后端处理大文件可能需要几分钟
   - 已实现异步处理和进度跟踪

3. **内存使用**:
   - pandas读取50MB Excel文件约需100-150MB内存
   - 服务器需要足够的内存资源

## 安全考虑

1. **文件类型验证**: 仍然限制只能上传Excel文件
2. **内容验证**: 上传后会验证文件格式和内容
3. **存储管理**: 定期清理旧的上传文件
4. **用户权限**: 需要登录才能上传文件

## 测试建议

1. **小文件测试** (<5MB): 验证正常上传和处理
2. **中等文件测试** (10-20MB): 验证性能可接受
3. **大文件测试** (30-50MB): 验证能够成功上传和处理
4. **超大文件测试** (>50MB): 验证正确拒绝并提示用户

## 后续优化方向

如果需要支持更大的文件，可以考虑：
1. **分块上传**: 将大文件分成多个小块上传
2. **流式处理**: 使用流式读取避免一次性加载整个文件到内存
3. **压缩传输**: 在上传前压缩文件
4. **云存储**: 使用对象存储服务（如阿里云OSS）

## 部署说明

修改后需要重启Flask应用以生效：

**本地开发**:
```bash
python run_app.py
```

**生产环境（Render）**:
```bash
git push origin main  # 自动触发部署
```

## 更新时间

2026-01-21
