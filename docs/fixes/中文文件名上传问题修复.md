# 中文文件名Excel上传问题修复

## 问题描述

用户上传某些Excel文件时会提示"无效的Excel文件格式"错误，特别是文件名为纯中文的情况（如"实际测试.xlsx"）。

### 错误日志
```
Upload response: Object { error: "无效的Excel文件格式", success: false }
[error] 上传失败：无效的Excel文件格式
```

## 根本原因

问题出在 `werkzeug.utils.secure_filename()` 函数的处理逻辑上：

1. **secure_filename的行为**：该函数会删除所有非ASCII字符，只保留字母、数字、下划线和连字符
2. **纯中文文件名的问题**：当文件名是"实际测试.xlsx"时，`secure_filename()`会删除所有中文字符，只保留"xlsx"
3. **扩展名丢失**：处理后的文件名变成"xlsx"（没有点号），导致 `os.path.splitext()` 提取扩展名时返回空字符串
4. **验证失败**：空字符串不在支持的扩展名列表 `['.xlsx', '.xls', '.xlsm']` 中，导致验证失败

### 示例

```python
# 原始逻辑
filename = secure_filename("实际测试.xlsx")  # 返回 "xlsx"
ext = os.path.splitext(filename)[1]          # 返回 ""
is_valid = ext in ['.xlsx', '.xls', '.xlsm'] # False
```

## 解决方案

修改文件名处理逻辑，在使用 `secure_filename()` 之前先提取扩展名：

```python
# 修复后的逻辑
original_filename = file.filename
file_ext = os.path.splitext(original_filename)[1].lower()  # 先提取扩展名
safe_name = secure_filename(original_filename)

# 如果secure_filename删除了所有字符（纯中文文件名），使用时间戳作为文件名
if not safe_name or safe_name == file_ext.lstrip('.'):
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    unique_filename = f"{timestamp}{file_ext}"
else:
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    # 确保文件名有正确的扩展名
    if not safe_name.endswith(file_ext):
        safe_name = os.path.splitext(safe_name)[0] + file_ext
    unique_filename = f"{timestamp}_{safe_name}"
```

## 修改文件

1. `backend/routes/claims.py` - 权利要求处理路由的文件上传逻辑
2. `backend/routes/excel_upload.py` - Excel上传路由的文件上传逻辑
3. `app.py` - 主应用文件的文件上传逻辑

所有涉及 `secure_filename()` 的文件上传逻辑都已修复。

## 测试结果

| 原始文件名 | 处理后文件名 | 扩展名 | 验证结果 |
|-----------|-------------|--------|---------|
| 实际测试.xlsx | 20260120_223926.xlsx | .xlsx | ✓ 有效 |
| test.xlsx | 20260120_223926_test.xlsx | .xlsx | ✓ 有效 |
| 测试test.xlsx | 20260120_223926_test.xlsx | .xlsx | ✓ 有效 |
| 专利数据2024.xlsx | 20260120_223926_2024.xlsx | .xlsx | ✓ 有效 |
| data-file.xlsx | 20260120_223926_data-file.xlsx | .xlsx | ✓ 有效 |
| 文件 名称.xlsx | 20260120_223926.xlsx | .xlsx | ✓ 有效 |

## 优点

1. **兼容性好**：支持纯中文、纯英文、中英混合等各种文件名
2. **安全性高**：仍然使用 `secure_filename()` 处理文件名，防止路径遍历攻击
3. **唯一性保证**：使用时间戳前缀确保文件名唯一
4. **扩展名保留**：无论原始文件名如何，都能正确保留扩展名

## 部署说明

修改已应用到 `backend/routes/claims.py`，需要重启后端服务使修改生效：

```bash
# 本地测试
python run_app.py

# 或使用 Render 部署
git add .
git commit -m "修复中文文件名Excel上传问题"
git push
```

## 相关问题

所有涉及文件上传的路由都已统一修复：
- ✓ `backend/routes/claims.py` - 权利要求处理
- ✓ `backend/routes/excel_upload.py` - Excel上传
- ✓ `app.py` - 主应用文件上传

确保所有文件上传功能都能正确处理中文文件名。

---

**修复日期**: 2026-01-20  
**修复人员**: Kiro AI Assistant
