# 文件上传限制优化 - 行数限制

## 问题描述

用户上传包含大量数据的Excel文件（如60MB文件）时，遇到以下问题：
1. 文件过大导致上传失败（413错误）
2. 处理大量数据消耗过多服务器资源
3. 用户体验不佳

## 根本原因

原来的限制策略：
- 仅限制文件大小（16MB）
- 没有限制数据行数
- 60MB的Excel文件可能包含数万行数据，超出系统处理能力

## 解决方案

### 新的限制策略

采用**行数限制**而非单纯的文件大小限制：

1. **主要限制**: 最多1000行数据
2. **辅助限制**: 最大文件100MB（防止恶意上传）

### 修改内容

**1. 添加行数验证**

**文件**: `backend/routes/claims.py` (第206-215行)

```python
# 验证行数限制（1000行）
row_count = len(df)
MAX_ROWS = 1000

if row_count > MAX_ROWS:
    os.remove(file_path)
    return create_response(
        error=f"数据行数超出限制：文件包含 {row_count} 行数据，系统最多支持 {MAX_ROWS} 行。请减少数据量后重新上传。",
        status_code=400
    )
```

**2. 提升文件大小限制（辅助）**

**文件**: `backend/config.py`
```python
MAX_CONTENT_LENGTH = 100 * 1024 * 1024  # 100MB - 主要通过行数限制（1000行）控制
```

**文件**: `backend/routes/excel_upload.py`
```python
MAX_FILE_SIZE = 100 * 1024 * 1024  # 100MB - 主要通过行数限制（1000行）控制
```

## 为什么选择行数限制？

### 优势

1. **精确控制**: 直接限制处理的数据量
2. **性能可预测**: 1000行数据的处理时间和内存使用是可控的
3. **用户友好**: 清晰告知用户具体限制（行数）而非模糊的文件大小
4. **避免误判**: 不会因为文件格式或压缩率不同而误判

### 容量估算

1000行数据可以支持：
- **权利要求处理**: 约100-200个专利的完整权利要求
- **批量查询**: 1000个专利号的查询
- **处理时间**: 通常在1-3分钟内完成
- **内存使用**: 约50-200MB（取决于文本长度）

## 错误提示

当用户上传超过1000行的文件时，会看到清晰的错误提示：

```
数据行数超出限制：文件包含 1500 行数据，系统最多支持 1000 行。请减少数据量后重新上传。
```

## 用户建议

如果用户需要处理超过1000行的数据，可以：

1. **分批处理**: 将数据分成多个小于1000行的文件
2. **筛选数据**: 只上传需要处理的关键数据
3. **联系支持**: 对于特殊需求，可以申请临时提升限制

## 技术细节

### 验证时机

- 在文件上传后立即验证
- 在读取Excel文件后检查行数
- 如果超限，删除已上传的文件并返回错误

### 性能影响

- 读取Excel文件获取行数：<1秒
- 不影响正常上传流程
- 提前拒绝超大文件，避免浪费处理资源

## 测试建议

1. **正常文件** (<1000行): 验证正常上传和处理
2. **边界文件** (正好1000行): 验证能够成功处理
3. **超限文件** (>1000行): 验证正确拒绝并显示友好错误
4. **大文件小数据**: 验证不会因文件大小被误拒

## 后续优化

如果需要支持更多数据，可以考虑：

1. **分页处理**: 自动将大文件分批处理
2. **后台任务**: 使用队列系统处理大批量数据
3. **流式处理**: 逐行处理而非一次性加载
4. **VIP用户**: 为付费用户提供更高的限制

## 部署说明

修改后需要重启Flask应用以生效：

**本地开发**:
```bash
python run_app.py
```

**生产环境（Render）**:
```bash
git push origin main  # 自动触发部署
```

## 更新时间

2026-01-21
