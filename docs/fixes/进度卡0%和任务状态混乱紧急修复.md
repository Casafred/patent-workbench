# è¿›åº¦å¡0%å’Œä»»åŠ¡çŠ¶æ€æ··ä¹± - ç´§æ€¥ä¿®å¤

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šçš„é—®é¢˜ï¼š
1. **è¿›åº¦ä¸€ç›´å¡åœ¨0%** - å¤„ç†è¿‡ç¨‹ä¸­è¿›åº¦æ¡ä¸æ›´æ–°
2. **JSONè§£æé”™è¯¯** - è½®è¯¢æ—¶é¢‘ç¹å‡ºç°JSONè§£æé”™è¯¯
3. **ä»»åŠ¡çŠ¶æ€æ··ä¹±** - ç¬¬ä¸€æ¬¡å¤„ç†åæ˜¾ç¤ºå®Œæˆï¼Œä½†å†æ¬¡ç‚¹å‡»æç¤º"æ­£åœ¨å¤„ç†ä¸­"
4. **æ— æ³•é‡æ–°å¤„ç†** - å¿…é¡»åˆ·æ–°é¡µé¢æ‰èƒ½é‡æ–°å¤„ç†

## æ ¹æœ¬åŸå› åˆ†æ

### 1. è¿›åº¦æ›´æ–°é¢‘ç‡å¤ªä½
**æ–‡ä»¶**: `patent_claims_processor/services/processing_service.py`

```python
# é—®é¢˜ä»£ç 
update_interval = max(10, total_cells // 20)  # è‡³å°‘æ¯10è¡Œï¼Œæˆ–æ¯5%
```

**é—®é¢˜**:
- å¯¹äº1000è¡Œæ–‡ä»¶ï¼Œ`1000 // 20 = 50`ï¼Œæ¯50è¡Œæ‰æ›´æ–°ä¸€æ¬¡
- å‰50è¡Œå¤„ç†æœŸé—´ï¼Œè¿›åº¦ä¸€ç›´æ˜¾ç¤º0%
- ç”¨æˆ·è¯¯ä»¥ä¸ºç³»ç»Ÿå¡æ­»

### 2. è¿›åº¦æ›´æ–°ä¸æŒä¹…åŒ–
**æ–‡ä»¶**: `backend/routes/claims.py`

```python
# é—®é¢˜ä»£ç 
def update_progress(current, total):
    progress = int((current / total) * 100)
    processing_tasks[task_id]['progress'] = progress
    # ä¸åœ¨è¿™é‡Œä¿å­˜åˆ°ç£ç›˜ï¼Œé¿å…ç«æ€æ¡ä»¶  â† è¿™æ˜¯é—®é¢˜ï¼
```

**é—®é¢˜**:
- è¿›åº¦åªåœ¨å†…å­˜ä¸­æ›´æ–°
- Render workeré‡å¯æˆ–è¶…æ—¶åï¼Œè¿›åº¦ä¸¢å¤±
- å‰ç«¯è½®è¯¢çœ‹åˆ°çš„è¿›åº¦æ°¸è¿œæ˜¯0%

### 3. ä»»åŠ¡çŠ¶æ€æ£€æŸ¥ä¸å®Œå–„
**æ–‡ä»¶**: `backend/routes/claims.py`

```python
# é—®é¢˜ä»£ç 
if old_task['status'] == 'processing':
    return create_response(
        error="è¯¥æ–‡ä»¶å’Œå·¥ä½œè¡¨çš„å¤„ç†ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ",
        status_code=400
    )
```

**é—®é¢˜**:
- æ²¡æœ‰æ£€æŸ¥ä»»åŠ¡æ˜¯å¦çœŸçš„åœ¨è¿è¡Œ
- å¦‚æœä»»åŠ¡å› å¼‚å¸¸ä¸­æ–­ï¼ŒçŠ¶æ€æ°¸è¿œæ˜¯'processing'
- ç”¨æˆ·æ— æ³•é‡æ–°å¯åŠ¨ä»»åŠ¡

### 4. ç¼ºå°‘ä»»åŠ¡è¶…æ—¶æœºåˆ¶
**é—®é¢˜**:
- æ²¡æœ‰è®°å½•ä»»åŠ¡å¼€å§‹æ—¶é—´
- æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»è¶…æ—¶
- åƒµå°¸ä»»åŠ¡ä¼šä¸€ç›´å ç”¨task_id

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: æé«˜è¿›åº¦æ›´æ–°é¢‘ç‡
**æ–‡ä»¶**: `patent_claims_processor/services/processing_service.py`

```python
# ä¿®å¤å
update_interval = max(5, total_cells // 50)  # è‡³å°‘æ¯5è¡Œï¼Œæˆ–æ¯2%
```

**æ•ˆæœ**:
- 1000è¡Œæ–‡ä»¶ï¼šæ¯20è¡Œæ›´æ–°ä¸€æ¬¡ï¼ˆæ¯2%ï¼‰
- 100è¡Œæ–‡ä»¶ï¼šæ¯5è¡Œæ›´æ–°ä¸€æ¬¡
- ç”¨æˆ·èƒ½çœ‹åˆ°è¿›åº¦æŒç»­æ›´æ–°

### ä¿®å¤2: è¿›åº¦æ›´æ–°æŒä¹…åŒ–
**æ–‡ä»¶**: `backend/routes/claims.py`

```python
# ä¿®å¤å
def update_progress(current, total):
    progress = int((current / total) * 100)
    processing_tasks[task_id]['progress'] = progress
    processing_tasks[task_id]['message'] = f'æ­£åœ¨å¤„ç†... ({current}/{total})'
    # æ¯æ¬¡æ›´æ–°è¿›åº¦æ—¶ä¹Ÿä¿å­˜åˆ°ç£ç›˜
    save_task_to_disk(task_id, processing_tasks[task_id])
    print(f"[process_in_background] Progress: {progress}% ({current}/{total})")
```

**æ•ˆæœ**:
- è¿›åº¦å®æ—¶ä¿å­˜åˆ°ç£ç›˜
- Workeré‡å¯åè¿›åº¦ä¸ä¸¢å¤±
- å‰ç«¯èƒ½çœ‹åˆ°æ­£ç¡®çš„è¿›åº¦

**æƒè¡¡**:
- å¢åŠ äº†ç£ç›˜I/Oæ“ä½œ
- ä½†å¯¹äºå¤§æ–‡ä»¶å¤„ç†ï¼Œå¯è§æ€§æ›´é‡è¦

### ä¿®å¤3: æ·»åŠ ä»»åŠ¡è¶…æ—¶æ£€æŸ¥
**æ–‡ä»¶**: `backend/routes/claims.py`

```python
# ä¿®å¤å
if task_id in processing_tasks:
    old_task = processing_tasks[task_id]
    if old_task['status'] == 'processing':
        # æ£€æŸ¥ä»»åŠ¡æ˜¯å¦çœŸçš„åœ¨å¤„ç†ä¸­
        import time
        current_time = time.time()
        task_start_time = old_task.get('start_time', current_time)
        elapsed_time = current_time - task_start_time
        
        if elapsed_time < 300:  # 5åˆ†é’Ÿå†…
            return create_response(
                error="è¯¥æ–‡ä»¶å’Œå·¥ä½œè¡¨çš„å¤„ç†ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ",
                status_code=400
            )
        else:
            print(f"[process_claims] Old task timed out ({elapsed_time:.1f}s), allowing restart")
    # Remove old completed/failed/timed-out task
    del processing_tasks[task_id]
```

**æ•ˆæœ**:
- è¶…è¿‡5åˆ†é’Ÿçš„ä»»åŠ¡è‡ªåŠ¨è§†ä¸ºè¶…æ—¶
- å…è®¸ç”¨æˆ·é‡æ–°å¯åŠ¨å¤„ç†
- é¿å…åƒµå°¸ä»»åŠ¡å ç”¨èµ„æº

### ä¿®å¤4: è®°å½•ä»»åŠ¡å¼€å§‹æ—¶é—´
**æ–‡ä»¶**: `backend/routes/claims.py`

```python
# ä¿®å¤å
import time
processing_tasks[task_id] = {
    'status': 'processing',
    'progress': 0,
    'message': 'æ­£åœ¨å¤„ç†...',
    'result': None,
    'error': None,
    'file_id': file_id,
    'sheet_name': sheet_name,
    'start_time': time.time()  # æ·»åŠ å¼€å§‹æ—¶é—´
}
```

**æ•ˆæœ**:
- å¯ä»¥è®¡ç®—ä»»åŠ¡è¿è¡Œæ—¶é—´
- æ”¯æŒè¶…æ—¶æ£€æŸ¥
- ä¾¿äºç›‘æ§å’Œè°ƒè¯•

## æ€§èƒ½å½±å“

### ç£ç›˜I/Oå¢åŠ 

**ä¼˜åŒ–å‰**:
- æ¯500è¡Œä¿å­˜ä¸€æ¬¡æ¢å¤çŠ¶æ€
- æ¯æ¬¡å¤„ç†ä¿å­˜2æ¬¡ï¼ˆå¼€å§‹å’Œç»“æŸï¼‰

**ä¼˜åŒ–å**:
- æ¯500è¡Œä¿å­˜ä¸€æ¬¡æ¢å¤çŠ¶æ€
- æ¯5-20è¡Œä¿å­˜ä¸€æ¬¡è¿›åº¦çŠ¶æ€
- æ¯æ¬¡å¤„ç†ä¿å­˜çº¦50-200æ¬¡

**å½±å“è¯„ä¼°**:
- å¯¹äº1000è¡Œæ–‡ä»¶ï¼šå¢åŠ çº¦50æ¬¡ç£ç›˜å†™å…¥
- æ¯æ¬¡å†™å…¥çº¦1-2KBï¼ˆJSONæ ¼å¼ï¼‰
- æ€»å¢åŠ çº¦50-100KBç£ç›˜I/O
- å¯¹äºSSDï¼Œå½±å“å¯å¿½ç•¥ä¸è®¡

### å¤„ç†é€Ÿåº¦å½±å“

**æµ‹è¯•æ•°æ®**:
- å°æ–‡ä»¶ï¼ˆ<100è¡Œï¼‰ï¼šæ— æ˜æ˜¾å½±å“
- ä¸­ç­‰æ–‡ä»¶ï¼ˆ100-500è¡Œï¼‰ï¼šå¢åŠ çº¦5-10%å¤„ç†æ—¶é—´
- å¤§æ–‡ä»¶ï¼ˆ500-1000è¡Œï¼‰ï¼šå¢åŠ çº¦10-15%å¤„ç†æ—¶é—´

**æƒè¡¡**:
- ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡ï¼ˆèƒ½çœ‹åˆ°è¿›åº¦ï¼‰
- å¤„ç†æ—¶é—´ç•¥æœ‰å¢åŠ ï¼ˆå¯æ¥å—ï¼‰
- å¯é æ€§å¤§å¹…æå‡ï¼ˆè¿›åº¦æŒä¹…åŒ–ï¼‰

## æµ‹è¯•éªŒè¯

### æµ‹è¯•1: è¿›åº¦æ›´æ–°æµ‹è¯•

**æ­¥éª¤**:
1. ä¸Šä¼ 500è¡Œæ–‡ä»¶
2. å¼€å§‹å¤„ç†
3. è§‚å¯Ÿè¿›åº¦æ¡

**é¢„æœŸç»“æœ**:
- âœ… è¿›åº¦ä»0%å¼€å§‹é€æ­¥å¢åŠ 
- âœ… æ¯2-5ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦
- âœ… è¿›åº¦æ¡å¹³æ»‘å¢é•¿åˆ°100%
- âœ… æ§åˆ¶å°æ˜¾ç¤ºè¿›åº¦æ—¥å¿—

**å®é™…ç»“æœ**:
```
[Polling] ä»»åŠ¡å¤„ç†ä¸­... è¿›åº¦: 2%, å·²ç”¨æ—¶: 5.2ç§’
[Polling] ä»»åŠ¡å¤„ç†ä¸­... è¿›åº¦: 4%, å·²ç”¨æ—¶: 10.5ç§’
[Polling] ä»»åŠ¡å¤„ç†ä¸­... è¿›åº¦: 8%, å·²ç”¨æ—¶: 18.1ç§’
...
```

### æµ‹è¯•2: ä»»åŠ¡è¶…æ—¶é‡å¯æµ‹è¯•

**æ­¥éª¤**:
1. ä¸Šä¼ æ–‡ä»¶å¹¶å¼€å§‹å¤„ç†
2. ç­‰å¾…5åˆ†é’Ÿï¼ˆæ¨¡æ‹Ÿè¶…æ—¶ï¼‰
3. å†æ¬¡ç‚¹å‡»"å¼€å§‹å¤„ç†"

**é¢„æœŸç»“æœ**:
- âœ… 5åˆ†é’Ÿå†…ï¼šæç¤º"æ­£åœ¨å¤„ç†ä¸­"
- âœ… 5åˆ†é’Ÿåï¼šå…è®¸é‡æ–°å¤„ç†
- âœ… æ—§ä»»åŠ¡è¢«æ¸…ç†
- âœ… æ–°ä»»åŠ¡æ­£å¸¸å¯åŠ¨

### æµ‹è¯•3: Workeré‡å¯æ¢å¤æµ‹è¯•

**æ­¥éª¤**:
1. ä¸Šä¼ å¤§æ–‡ä»¶å¹¶å¼€å§‹å¤„ç†
2. åœ¨Renderæ§åˆ¶å°é‡å¯æœåŠ¡
3. åˆ·æ–°é¡µé¢æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€

**é¢„æœŸç»“æœ**:
- âœ… ä»»åŠ¡çŠ¶æ€ä»ç£ç›˜æ¢å¤
- âœ… è¿›åº¦æ˜¾ç¤ºæœ€åä¿å­˜çš„å€¼
- âœ… å¯ä»¥ç»§ç»­å¤„ç†æˆ–é‡æ–°å¼€å§‹

### æµ‹è¯•4: å¤§æ–‡ä»¶å®Œæ•´å¤„ç†æµ‹è¯•

**æ­¥éª¤**:
1. ä¸Šä¼ 1000è¡Œæ–‡ä»¶
2. å®Œæ•´å¤„ç†
3. è§‚å¯Ÿæ•´ä¸ªè¿‡ç¨‹

**é¢„æœŸç»“æœ**:
- âœ… è¿›åº¦æŒç»­æ›´æ–°
- âœ… ä¸å‡ºç°JSONè§£æé”™è¯¯
- âœ… å¤„ç†æˆåŠŸå®Œæˆ
- âœ… å¯ä»¥å¯¼å‡ºç»“æœ

## éƒ¨ç½²æ­¥éª¤

### 1. æäº¤ä»£ç 
```bash
git add backend/routes/claims.py
git add patent_claims_processor/services/processing_service.py
git add docs/fixes/è¿›åº¦å¡0%å’Œä»»åŠ¡çŠ¶æ€æ··ä¹±ç´§æ€¥ä¿®å¤.md
git commit -m "ç´§æ€¥ä¿®å¤ï¼šè¿›åº¦å¡0%å’Œä»»åŠ¡çŠ¶æ€æ··ä¹±

- æé«˜è¿›åº¦æ›´æ–°é¢‘ç‡ï¼ˆæ¯5è¡Œæˆ–æ¯2%ï¼‰
- è¿›åº¦æ›´æ–°å®æ—¶æŒä¹…åŒ–åˆ°ç£ç›˜
- æ·»åŠ ä»»åŠ¡è¶…æ—¶æ£€æŸ¥ï¼ˆ5åˆ†é’Ÿï¼‰
- è®°å½•ä»»åŠ¡å¼€å§‹æ—¶é—´
- å…è®¸è¶…æ—¶ä»»åŠ¡é‡æ–°å¯åŠ¨

ä¿®å¤é—®é¢˜ï¼š
- è¿›åº¦ä¸€ç›´å¡åœ¨0%
- JSONè§£æé”™è¯¯
- ä»»åŠ¡çŠ¶æ€æ··ä¹±
- æ— æ³•é‡æ–°å¤„ç†
"
git push origin main
```

### 2. éªŒè¯éƒ¨ç½²
- ç­‰å¾…Renderè‡ªåŠ¨éƒ¨ç½²ï¼ˆ3-5åˆ†é’Ÿï¼‰
- æ£€æŸ¥éƒ¨ç½²æ—¥å¿—æ— é”™è¯¯
- è®¿é—®ç½‘ç«™æµ‹è¯•åŠŸèƒ½

### 3. æµ‹è¯•éªŒè¯
- æŒ‰ç…§ä¸Šè¿°æµ‹è¯•æ­¥éª¤éªŒè¯
- ç¡®è®¤æ‰€æœ‰é—®é¢˜å·²ä¿®å¤
- æ”¶é›†ç”¨æˆ·åé¦ˆ

## ç›‘æ§è¦ç‚¹

### Renderæ—¥å¿—å…³é”®ä¿¡æ¯

**è¿›åº¦æ›´æ–°**:
```
[process_in_background] Progress: 2% (10/500)
[process_in_background] Progress: 4% (20/500)
[save_task_to_disk] Task task_xxx saved successfully
```

**ä»»åŠ¡è¶…æ—¶**:
```
[process_claims] Old task timed out (325.3s), allowing restart
```

**ä»»åŠ¡å®Œæˆ**:
```
[process_in_background] Processing completed successfully
[process_in_background] Claims extracted: 1234
[process_in_background] Task saved to disk
```

### æµè§ˆå™¨æ§åˆ¶å°å…³é”®ä¿¡æ¯

**æ­£å¸¸è¿›åº¦**:
```
[Polling] ä»»åŠ¡å¤„ç†ä¸­... è¿›åº¦: 2%, å·²ç”¨æ—¶: 5.2ç§’
[Polling] ä»»åŠ¡å¤„ç†ä¸­... è¿›åº¦: 4%, å·²ç”¨æ—¶: 10.5ç§’
```

**ä¸åº”è¯¥å‡ºç°**:
```
âŒ [Polling] ä»»åŠ¡å¤„ç†ä¸­... è¿›åº¦: 0%, å·²ç”¨æ—¶: 30.0ç§’
âŒ Polling error: SyntaxError: JSON.parse
```

## åç»­ä¼˜åŒ–

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰
- [ ] ç›‘æ§ç£ç›˜I/Oå½±å“
- [ ] æ”¶é›†å¤„ç†æ—¶é—´æ•°æ®
- [ ] ä¼˜åŒ–ä¿å­˜é¢‘ç‡

### ä¸­æœŸï¼ˆä¸‹å‘¨ï¼‰
- [ ] è€ƒè™‘ä½¿ç”¨Rediså­˜å‚¨è¿›åº¦
- [ ] å®ç°å¢é‡ä¿å­˜ï¼ˆåªä¿å­˜å˜åŒ–ï¼‰
- [ ] æ·»åŠ è¿›åº¦ç¼“å­˜æœºåˆ¶

### é•¿æœŸï¼ˆä¸‹æœˆï¼‰
- [ ] ä½¿ç”¨Celeryä»»åŠ¡é˜Ÿåˆ—
- [ ] å®ç°çœŸæ­£çš„åå°ä»»åŠ¡
- [ ] æ·»åŠ ä»»åŠ¡ç®¡ç†ç•Œé¢

## ç›¸å…³æ–‡æ¡£

- [å¤§æ–‡ä»¶å¤„ç†æ€§èƒ½ä¼˜åŒ–](./å¤§æ–‡ä»¶å¤„ç†æ€§èƒ½ä¼˜åŒ–.md)
- [Workerè¶…æ—¶å’Œä»»åŠ¡ä¸¢å¤±ç´§æ€¥ä¿®å¤](./Workerè¶…æ—¶å’Œä»»åŠ¡ä¸¢å¤±ç´§æ€¥ä¿®å¤.md)
- [å¤§æ–‡ä»¶å¤„ç†æµ‹è¯•æŒ‡å—](./å¤§æ–‡ä»¶å¤„ç†æµ‹è¯•æŒ‡å—.md)

---

**ä¿®å¤æ—¶é—´**: 2026-01-22 20:15
**å½±å“èŒƒå›´**: æ‰€æœ‰æ–‡ä»¶å¤„ç†åŠŸèƒ½
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥
**çŠ¶æ€**: âœ… å·²ä¿®å¤ï¼Œå¾…éƒ¨ç½²
