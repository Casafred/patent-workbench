# 阿里云服务器代码更新指南

## 🚀 快速更新（推荐）

### 方法一：使用自动脚本（Windows）

1. **双击运行**：`scripts/update_aliyun.bat`
2. **输入密码**：输入服务器root密码
3. **等待完成**：约10-30秒

### 方法二：使用命令行

```bash
# Windows PowerShell 或 CMD
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && git pull origin main' && systemctl restart patent-app"
```

输入密码后，等待更新完成。

---

## 📋 详细步骤

### 步骤1：推送代码到GitHub

```bash
# 在本地项目目录执行
git add .
git commit -m "你的提交信息"
git push origin main
```

✅ **已完成**：代码已推送到GitHub

### 步骤2：SSH连接到阿里云服务器

```bash
ssh root@43.99.101.195
```

输入密码后进入服务器。

### 步骤3：更新代码

```bash
# 切换到appuser用户并拉取代码
su - appuser -c "cd ~/patent-app && git pull origin main"
```

### 步骤4：重启应用

```bash
# 重启应用服务
systemctl restart patent-app
```

### 步骤5：验证更新

```bash
# 查看服务状态
systemctl status patent-app

# 查看最新日志
tail -f /home/appuser/patent-app/logs/error.log
```

### 步骤6：浏览器测试

访问：http://43.99.101.195

测试登录页面的新功能：
- ✅ 首次加载不显示错误提示
- ✅ 密码显示/隐藏按钮使用SVG图标

---

## 🔧 常用维护命令

### 查看服务状态

```bash
systemctl status patent-app
systemctl status nginx
systemctl status postgresql
```

### 查看日志

```bash
# 应用日志
tail -f /home/appuser/patent-app/logs/error.log
tail -f /home/appuser/patent-app/logs/access.log

# 系统日志
journalctl -u patent-app -f
journalctl -u nginx -f
```

### 重启服务

```bash
# 重启应用
systemctl restart patent-app

# 重启Nginx
systemctl restart nginx

# 重启数据库
systemctl restart postgresql
```

### 更新Python依赖

```bash
su - appuser -c "
    cd ~/patent-app
    source venv/bin/activate
    pip install -r requirements.txt
    exit
"
systemctl restart patent-app
```

---

## 🆘 故障排查

### 问题1：git pull失败

**错误信息**：`fatal: detected dubious ownership`

**解决方案**：
```bash
# 方法1：使用appuser用户拉取
su - appuser -c "cd ~/patent-app && git pull origin main"

# 方法2：添加安全目录（不推荐）
git config --global --add safe.directory /home/appuser/patent-app
```

### 问题2：服务重启失败

**检查步骤**：
```bash
# 查看详细错误
journalctl -u patent-app -n 50

# 检查配置文件
cat /etc/systemd/system/patent-app.service

# 手动启动测试
su - appuser -c "
    cd ~/patent-app
    source venv/bin/activate
    gunicorn --config gunicorn_config.py wsgi:app
"
```

### 问题3：无法访问网站

**检查步骤**：
```bash
# 1. 检查应用是否运行
systemctl status patent-app

# 2. 检查Nginx是否运行
systemctl status nginx

# 3. 检查端口占用
netstat -tlnp | grep -E ':(80|5001)'

# 4. 检查防火墙
ufw status

# 5. 检查阿里云安全组
# 登录阿里云控制台 → ECS → 安全组 → 确保80端口已开放
```

### 问题4：更新后功能异常

**回滚步骤**：
```bash
# 1. 查看提交历史
su - appuser -c "cd ~/patent-app && git log --oneline -5"

# 2. 回滚到上一个版本
su - appuser -c "cd ~/patent-app && git reset --hard HEAD~1"

# 3. 重启服务
systemctl restart patent-app
```

---

## 📊 监控和性能

### 查看资源使用

```bash
# CPU和内存
htop

# 磁盘空间
df -h

# 内存详情
free -h

# 进程列表
ps aux | grep gunicorn
```

### 清理临时文件

```bash
# 清理上传的临时文件（7天前）
find /home/appuser/patent-app/uploads -type f -mtime +7 -delete

# 清理日志（保留最近7天）
find /home/appuser/patent-app/logs -name "*.log.*" -mtime +7 -delete
```

---

## 🔒 安全建议

### 1. 使用SSH密钥登录（推荐）

```bash
# 在本地生成SSH密钥
ssh-keygen -t rsa -b 4096

# 复制公钥到服务器
ssh-copy-id root@43.99.101.195

# 之后可以免密码登录
ssh root@43.99.101.195
```

### 2. 禁用root密码登录

```bash
# 编辑SSH配置
nano /etc/ssh/sshd_config

# 修改以下配置
PermitRootLogin prohibit-password
PasswordAuthentication no

# 重启SSH服务
systemctl restart sshd
```

### 3. 定期备份

```bash
# 备份数据库
sudo -u postgres pg_dump patent_db > backup_$(date +%Y%m%d).sql

# 备份代码
tar -czf patent-app-backup-$(date +%Y%m%d).tar.gz /home/appuser/patent-app
```

---

## 📞 获取帮助

### 文档资源

- [阿里云部署指南](ALIYUN_DEPLOYMENT_README.md)
- [故障排查手册](docs/deployment/TROUBLESHOOTING_GUIDE.md)
- [用户管理指南](docs/deployment/USER_MANAGEMENT_ALIYUN.md)

### 联系方式

- 邮箱：freecasafred@outlook.com
- GitHub Issues：提交问题到项目仓库

---

## ✅ 本次更新内容

**更新时间**：2026-01-24

**更新内容**：
1. ✅ 修复登录页面首次加载时显示错误提示的问题
2. ✅ 将密码显示/隐藏按钮从emoji改为SVG图标
3. ✅ 优化登录页面用户体验

**测试步骤**：
1. 访问 http://43.99.101.195
2. 确认登录页面不显示错误提示
3. 测试密码显示/隐藏按钮（SVG图标）
4. 测试正常登录功能

---

**祝更新顺利！** 🎉
