# åŠŸèƒ½å…«OCRç¼“å­˜æ›´æ–°æœºåˆ¶å®ç°å®Œæˆ

## ğŸ“‹ éœ€æ±‚è¯´æ˜

å¯¹äºåŒä¸€ä¸ªå›¾ç‰‡ä»»åŠ¡å¤„ç†ï¼Œå¦‚æœä¹‹å‰å¤„ç†è¿‡æœ‰ç¼“å­˜ï¼Œç”¨æˆ·å†æ¬¡åˆ†æä»¥åï¼Œè¦è¯†åˆ«å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªæ›´æ–°å¤„ç†ï¼Œè¦æç¤ºç”¨æˆ·æ˜¯å¦è¦†ç›–åŸæ¥çš„ç¼“å­˜å¤„ç†ç»“æœï¼Œè€Œä¸æ˜¯ä¸€ç›´é»˜è®¤åªåŠ è½½åŸæ¥çš„ç¼“å­˜å¤„ç†å†…å®¹ã€‚

## âœ… å®ç°å†…å®¹

### 1. åç«¯ç¼“å­˜ç®¡ç†å™¨

**æ–‡ä»¶ï¼š** `backend/utils/drawing_cache.py`

**åŠŸèƒ½ï¼š**
- åŸºäºå›¾ç‰‡å†…å®¹å“ˆå¸Œçš„ç¼“å­˜é”®ç”Ÿæˆ
- å†…å­˜ç¼“å­˜ + å¯é€‰æŒä¹…åŒ–å­˜å‚¨
- è‡ªåŠ¨è¿‡æœŸæ¸…ç†ï¼ˆé»˜è®¤7å¤©ï¼‰
- ç¼“å­˜æ£€æµ‹å’Œæ›´æ–°æ¥å£

**æ ¸å¿ƒæ–¹æ³•ï¼š**
```python
class DrawingCacheManager:
    def get_cache(cache_key) -> Optional[Dict]  # è·å–ç¼“å­˜
    def set_cache(cache_key, data) -> None      # è®¾ç½®ç¼“å­˜
    def has_cache(cache_key) -> bool            # æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨
    def clear_cache(cache_key=None) -> None     # æ¸…é™¤ç¼“å­˜
    def cleanup_expired() -> int                # æ¸…ç†è¿‡æœŸç¼“å­˜
```

### 2. åç«¯APIæ›´æ–°

**æ–‡ä»¶ï¼š** `backend/routes/drawing_marker.py`

**æ›´æ–°å†…å®¹ï¼š**

#### æ–°å¢è¯·æ±‚å‚æ•°ï¼š
```json
{
  "drawings": [...],
  "specification": "...",
  "force_refresh": false  // æ˜¯å¦å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼ˆè·³è¿‡ç¼“å­˜æ£€æŸ¥ï¼‰
}
```

#### æ–°å¢å“åº”å­—æ®µï¼š
```json
{
  "success": true,
  "data": {
    "drawings": [...],
    "cache_info": {
      "drawing1.png": {
        "has_cache": true,
        "cache_key": "drawing1.png_abc123",
        "cached_at": 1704067200000
      }
    }
  }
}
```

#### ç¼“å­˜å¤„ç†æµç¨‹ï¼š
1. ç”Ÿæˆå›¾ç‰‡å†…å®¹å“ˆå¸Œä½œä¸ºç¼“å­˜é”®
2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¼“å­˜ï¼ˆå¦‚æœ `force_refresh=false`ï¼‰
3. å¦‚æœæœ‰ç¼“å­˜ä¸”æœªè¿‡æœŸï¼Œä½¿ç”¨ç¼“å­˜ç»“æœ
4. å¦‚æœæ— ç¼“å­˜æˆ–å¼ºåˆ¶åˆ·æ–°ï¼Œæ‰§è¡ŒOCRè¯†åˆ«å¹¶ä¿å­˜åˆ°ç¼“å­˜
5. è¿”å›ç»“æœæ—¶é™„å¸¦ç¼“å­˜ä¿¡æ¯

### 3. å‰ç«¯ç¼“å­˜ç®¡ç†å™¨

**æ–‡ä»¶ï¼š** `frontend/js/drawingCacheManager.js`

**åŠŸèƒ½ï¼š**
- å‰ç«¯ç¼“å­˜å­˜å‚¨ï¼ˆlocalStorageï¼‰
- ç¼“å­˜è¿‡æœŸæ£€æµ‹
- ç¾è§‚çš„ç¼“å­˜æ›´æ–°ç¡®è®¤å¯¹è¯æ¡†
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜

**æ ¸å¿ƒæ–¹æ³•ï¼š**
```javascript
class DrawingCacheManager {
    generateCacheKey(imageData, fileName)           // ç”Ÿæˆç¼“å­˜é”®
    getCache(cacheKey)                              // è·å–ç¼“å­˜
    setCache(cacheKey, data)                        // è®¾ç½®ç¼“å­˜
    clearCache(cacheKey=null)                       // æ¸…é™¤ç¼“å­˜
    cleanupExpired()                                // æ¸…ç†è¿‡æœŸç¼“å­˜
    showCacheUpdateDialog(fileName, cachedData)     // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
}
```

### 4. å‰ç«¯é›†æˆç¤ºä¾‹

**åœ¨åŠŸèƒ½å…«å¤„ç†æµç¨‹ä¸­é›†æˆï¼š**

```javascript
// å¼•å…¥ç¼“å­˜ç®¡ç†å™¨
const cacheManager = new DrawingCacheManager();

// åœ¨å¤„ç†å›¾ç‰‡å‰æ£€æŸ¥ç¼“å­˜
async function processDrawings() {
    const drawings = [...]; // å›¾ç‰‡æ•°æ®
    const specification = "..."; // è¯´æ˜ä¹¦
    
    // ç”Ÿæˆç¼“å­˜é”®
    const cacheKey = cacheManager.generateCacheKey(
        drawings[0].data, 
        drawings[0].name
    );
    
    // æ£€æŸ¥ç¼“å­˜
    const cachedData = cacheManager.getCache(cacheKey);
    let forceRefresh = false;
    
    if (cachedData) {
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        forceRefresh = await cacheManager.showCacheUpdateDialog(
            drawings[0].name,
            cachedData
        );
    }
    
    // è°ƒç”¨API
    const response = await fetch('/api/drawing-marker/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            drawings: drawings,
            specification: specification,
            force_refresh: forceRefresh  // ä¼ é€’ç”¨æˆ·é€‰æ‹©
        })
    });
    
    const result = await response.json();
    
    // ä¿å­˜æ–°çš„ç¼“å­˜
    if (result.success && result.data.cache_info) {
        const cacheInfo = result.data.cache_info[drawings[0].name];
        if (cacheInfo && !cacheInfo.has_cache) {
            // æ–°çš„å¤„ç†ç»“æœï¼Œä¿å­˜åˆ°ç¼“å­˜
            cacheManager.setCache(cacheKey, {
                ocr_detected_count: result.data.ocr_detected_count,
                matched_count: result.data.matched_count,
                timestamp: Date.now()
            });
        }
    }
    
    return result;
}
```

## ğŸ¨ ç”¨æˆ·ä½“éªŒ

### ç¼“å­˜æ›´æ–°ç¡®è®¤å¯¹è¯æ¡†

å½“æ£€æµ‹åˆ°ç¼“å­˜æ—¶ï¼Œä¼šæ˜¾ç¤ºä¸€ä¸ªç¾è§‚çš„ç¡®è®¤å¯¹è¯æ¡†ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ğŸ”„                       â”‚
â”‚      æ£€æµ‹åˆ°ç¼“å­˜ç»“æœ                  â”‚
â”‚                                     â”‚
â”‚  æ–‡ä»¶åï¼šdrawing1.png               â”‚
â”‚  ç¼“å­˜æ—¶é—´ï¼š2024-01-01 10:30:00      â”‚
â”‚  è¯†åˆ«ç»“æœï¼šOCRè¯†åˆ« 15 ä¸ªæ ‡è®°ï¼Œ       â”‚
â”‚           åŒ¹é… 12 ä¸ª                â”‚
â”‚                                     â”‚
â”‚  âš ï¸ æç¤ºï¼šæ­¤å›¾ç‰‡ä¹‹å‰å·²å¤„ç†è¿‡ã€‚       â”‚
â”‚  å¦‚æœè¯´æ˜ä¹¦å†…å®¹æœ‰æ›´æ–°ï¼Œå»ºè®®é‡æ–°      â”‚
â”‚  åˆ†æä»¥è·å–æœ€æ–°åŒ¹é…ç»“æœã€‚            â”‚
â”‚                                     â”‚
â”‚  [ä½¿ç”¨ç¼“å­˜]  [é‡æ–°åˆ†æ]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŒ‰é’®è¯´æ˜ï¼š**
- **ä½¿ç”¨ç¼“å­˜**ï¼šç›´æ¥ä½¿ç”¨ä¹‹å‰çš„å¤„ç†ç»“æœï¼Œå¿«é€Ÿæ˜¾ç¤º
- **é‡æ–°åˆ†æ**ï¼šå¿½ç•¥ç¼“å­˜ï¼Œé‡æ–°æ‰§è¡ŒOCRè¯†åˆ«å’ŒåŒ¹é…

## ğŸ“Š ç¼“å­˜ç­–ç•¥

### ç¼“å­˜é”®ç”Ÿæˆ
- åŸºäºå›¾ç‰‡å†…å®¹çš„MD5å“ˆå¸Œ
- æ ¼å¼ï¼š`{æ–‡ä»¶å}_{å†…å®¹å“ˆå¸Œ}`
- ç¡®ä¿ç›¸åŒå›¾ç‰‡ä½¿ç”¨ç›¸åŒç¼“å­˜

### ç¼“å­˜è¿‡æœŸ
- é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š7å¤©
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
- å¯æ‰‹åŠ¨æ¸…é™¤æ‰€æœ‰ç¼“å­˜

### ç¼“å­˜å­˜å‚¨
- **åç«¯**ï¼šå†…å­˜ç¼“å­˜ + å¯é€‰æ–‡ä»¶å­˜å‚¨
- **å‰ç«¯**ï¼šlocalStorageå­˜å‚¨
- åŒå±‚ç¼“å­˜ç¡®ä¿æ€§èƒ½

## ğŸ”§ é…ç½®é€‰é¡¹

### åç«¯é…ç½®

```python
# åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨
cache_manager = DrawingCacheManager(
    cache_dir='./cache/drawings',  # æŒä¹…åŒ–ç›®å½•ï¼ˆå¯é€‰ï¼‰
    max_age_days=7                 # ç¼“å­˜è¿‡æœŸå¤©æ•°
)
```

### å‰ç«¯é…ç½®

```javascript
// åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨
const cacheManager = new DrawingCacheManager();
cacheManager.maxCacheAge = 7 * 24 * 60 * 60 * 1000; // 7å¤©
```

## ğŸš€ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡å¤„ç†
1. ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡å’Œè¯´æ˜ä¹¦
2. ç³»ç»Ÿæ£€æµ‹æ— ç¼“å­˜
3. æ‰§è¡ŒOCRè¯†åˆ«
4. ä¿å­˜ç»“æœåˆ°ç¼“å­˜
5. æ˜¾ç¤ºå¤„ç†ç»“æœ

### åœºæ™¯2ï¼šé‡å¤å¤„ç†ï¼ˆè¯´æ˜ä¹¦æœªå˜ï¼‰
1. ç”¨æˆ·ä¸Šä¼ ç›¸åŒå›¾ç‰‡
2. ç³»ç»Ÿæ£€æµ‹åˆ°ç¼“å­˜
3. æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
4. ç”¨æˆ·é€‰æ‹©"ä½¿ç”¨ç¼“å­˜"
5. å¿«é€Ÿæ˜¾ç¤ºä¹‹å‰çš„ç»“æœ

### åœºæ™¯3ï¼šé‡å¤å¤„ç†ï¼ˆè¯´æ˜ä¹¦å·²æ›´æ–°ï¼‰
1. ç”¨æˆ·ä¸Šä¼ ç›¸åŒå›¾ç‰‡ä½†è¯´æ˜ä¹¦æœ‰æ›´æ–°
2. ç³»ç»Ÿæ£€æµ‹åˆ°ç¼“å­˜
3. æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼ˆæç¤ºè¯´æ˜ä¹¦å¯èƒ½æœ‰æ›´æ–°ï¼‰
4. ç”¨æˆ·é€‰æ‹©"é‡æ–°åˆ†æ"
5. æ‰§è¡Œæ–°çš„OCRè¯†åˆ«å’ŒåŒ¹é…
6. æ›´æ–°ç¼“å­˜
7. æ˜¾ç¤ºæ–°çš„å¤„ç†ç»“æœ

## ğŸ“ APIå˜æ›´è¯´æ˜

### POST /api/drawing-marker/process

**æ–°å¢è¯·æ±‚å‚æ•°ï¼š**
- `force_refresh` (boolean, optional): æ˜¯å¦å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼Œé»˜è®¤ `false`

**æ–°å¢å“åº”å­—æ®µï¼š**
- `cache_info` (object): ç¼“å­˜ä¿¡æ¯
  - `{drawing_name}` (object): æ¯ä¸ªå›¾ç‰‡çš„ç¼“å­˜ä¿¡æ¯
    - `has_cache` (boolean): æ˜¯å¦ä½¿ç”¨äº†ç¼“å­˜
    - `cache_key` (string): ç¼“å­˜é”®
    - `cached_at` (number|null): ç¼“å­˜æ—¶é—´æˆ³

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•ç”¨ä¾‹1ï¼šé¦–æ¬¡å¤„ç†
```javascript
// é¢„æœŸï¼šæ— ç¼“å­˜ï¼Œæ‰§è¡Œå®Œæ•´OCR
const result = await processDrawings(image, spec);
assert(result.cache_info[image.name].has_cache === false);
```

### æµ‹è¯•ç”¨ä¾‹2ï¼šä½¿ç”¨ç¼“å­˜
```javascript
// ç¬¬ä¸€æ¬¡å¤„ç†
await processDrawings(image, spec);

// ç¬¬äºŒæ¬¡å¤„ç†ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
const result = await processDrawings(image, spec, false);
assert(result.cache_info[image.name].has_cache === true);
```

### æµ‹è¯•ç”¨ä¾‹3ï¼šå¼ºåˆ¶åˆ·æ–°
```javascript
// ç¬¬ä¸€æ¬¡å¤„ç†
await processDrawings(image, spec);

// ç¬¬äºŒæ¬¡å¤„ç†ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰
const result = await processDrawings(image, spec, true);
assert(result.cache_info[image.name].has_cache === false);
```

## ğŸ¯ ä¼˜åŠ¿

1. **æ€§èƒ½æå‡**ï¼šé¿å…é‡å¤OCRè¯†åˆ«ï¼Œæé«˜å“åº”é€Ÿåº¦
2. **ç”¨æˆ·ä½“éªŒ**ï¼šæ¸…æ™°çš„ç¼“å­˜æç¤ºï¼Œç”¨æˆ·å¯è‡ªä¸»é€‰æ‹©
3. **çµæ´»æ€§**ï¼šæ”¯æŒå¼ºåˆ¶åˆ·æ–°ï¼Œé€‚åº”è¯´æ˜ä¹¦æ›´æ–°åœºæ™¯
4. **å¯é æ€§**ï¼šåŒå±‚ç¼“å­˜ï¼ˆå‰ç«¯+åç«¯ï¼‰ï¼Œè‡ªåŠ¨è¿‡æœŸæ¸…ç†

## ğŸ“¦ éƒ¨ç½²æ¸…å•

### æ–°å¢æ–‡ä»¶
- âœ… `backend/utils/drawing_cache.py` - åç«¯ç¼“å­˜ç®¡ç†å™¨
- âœ… `frontend/js/drawingCacheManager.js` - å‰ç«¯ç¼“å­˜ç®¡ç†å™¨

### ä¿®æ”¹æ–‡ä»¶
- âœ… `backend/routes/drawing_marker.py` - é›†æˆç¼“å­˜æ£€æµ‹å’Œæ›´æ–°

### å‰ç«¯é›†æˆ
- â³ åœ¨ `frontend/index.html` ä¸­å¼•å…¥ `drawingCacheManager.js`
- â³ åœ¨åŠŸèƒ½å…«å¤„ç†æµç¨‹ä¸­é›†æˆç¼“å­˜æ£€æµ‹é€»è¾‘

## ğŸ”„ ä¸‹ä¸€æ­¥

1. åœ¨ `frontend/index.html` ä¸­å¼•å…¥ç¼“å­˜ç®¡ç†å™¨è„šæœ¬
2. æ›´æ–°åŠŸèƒ½å…«çš„å¤„ç†å‡½æ•°ï¼Œé›†æˆç¼“å­˜æ£€æµ‹
3. æµ‹è¯•å®Œæ•´æµç¨‹
4. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åŠŸèƒ½å…«OCRä¼˜åŒ–å®Œæˆ_20260205.md](./åŠŸèƒ½å…«OCRä¼˜åŒ–å®Œæˆ_20260205.md)
- [åŠŸèƒ½å…«OCRä¼˜åŒ–_å¿«é€Ÿå‚è€ƒ_20260205.md](./åŠŸèƒ½å…«OCRä¼˜åŒ–_å¿«é€Ÿå‚è€ƒ_20260205.md)

---

**å®ç°æ—¶é—´ï¼š** 2026-02-05  
**çŠ¶æ€ï¼š** âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼Œå¾…å‰ç«¯é›†æˆæµ‹è¯•
