# åŠŸèƒ½å…«ï¼šç‹¬ç«‹é‡æ–°å¤„ç†æ¨¡å¼ - é›†æˆåˆ°ä¸»ç•Œé¢æŒ‡å—

## ğŸ“‹ é›†æˆæ­¥éª¤

### æ­¥éª¤1ï¼šå¼•å…¥ç®¡ç†å™¨è„šæœ¬

åœ¨ `frontend/index.html` çš„ `<head>` æˆ– `<body>` åº•éƒ¨æ·»åŠ ï¼š

```html
<!-- é‡æ–°å¤„ç†ç®¡ç†å™¨ -->
<script src="frontend/js/drawingReprocessManager.js"></script>
```

---

### æ­¥éª¤2ï¼šæ·»åŠ UIæŒ‰é’®

åœ¨åŠŸèƒ½å…«çš„å¤„ç†ç»“æœåŒºåŸŸæ·»åŠ é‡æ–°å¤„ç†æŒ‰é’®ï¼š

```html
<!-- åœ¨åŠŸèƒ½å…«çš„ç»“æœåŒºåŸŸæ·»åŠ  -->
<div id="feature8Results" style="display: none;">
    <!-- ç°æœ‰çš„ç»“æœæ˜¾ç¤ºä»£ç  -->
    
    <!-- ğŸ†• æ–°å¢ï¼šå¿«é€Ÿé‡æ–°å¤„ç†æŒ‰é’® -->
    <div class="reprocess-section" id="reprocessSection" style="display: none; margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 12px; border-left: 4px solid #2196F3;">
        <h4 style="color: #2196F3; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span>âš¡</span>
            <span>å¿«é€Ÿé‡æ–°å¤„ç†</span>
        </h4>
        
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            å·²æ£€æµ‹åˆ°ç¼“å­˜æ•°æ®ï¼Œå¯ä»¥å•ç‹¬æ›´æ–°è¯´æ˜ä¹¦æˆ–å›¾ç‰‡ï¼Œæ— éœ€å®Œæ•´é‡æ–°å¤„ç†ã€‚
        </p>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <!-- é‡æ–°å¤„ç†è¯´æ˜ä¹¦æŒ‰é’® -->
            <button class="btn btn-secondary" id="reprocessSpecBtn" style="display: none;">
                <span>ğŸ“</span>
                <span>é‡æ–°å¤„ç†è¯´æ˜ä¹¦</span>
            </button>
            
            <!-- é‡æ–°è¯†åˆ«å›¾ç‰‡æŒ‰é’® -->
            <button class="btn btn-success" id="reprocessDrawingsBtn" style="display: none;">
                <span>ğŸ–¼ï¸</span>
                <span>é‡æ–°è¯†åˆ«å›¾ç‰‡æ ‡å·</span>
            </button>
        </div>
        
        <!-- ç¼“å­˜ä¿¡æ¯æç¤º -->
        <div id="cacheInfoTip" style="margin-top: 15px; padding: 12px; background-color: #e3f2fd; border-radius: 8px; font-size: 13px; color: #1565C0;">
            <strong>ğŸ’¡ æç¤ºï¼š</strong>
            <span id="cacheInfoText"></span>
        </div>
    </div>
</div>
```

---

### æ­¥éª¤3ï¼šæ·»åŠ CSSæ ·å¼

åœ¨ `frontend/css/` ç›¸å…³æ–‡ä»¶æˆ– `<style>` æ ‡ç­¾ä¸­æ·»åŠ ï¼š

```css
/* é‡æ–°å¤„ç†æŒ‰é’®æ ·å¼ */
.btn-secondary {
    background-color: #2196F3;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-secondary:hover {
    background-color: #1976D2;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
}

.btn-success {
    background-color: #4CAF50;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-success:hover {
    background-color: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

.reprocess-section {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
```

---

### æ­¥éª¤4ï¼šåˆå§‹åŒ–JavaScript

åœ¨åŠŸèƒ½å…«çš„JavaScriptä»£ç ä¸­æ·»åŠ ï¼š

```javascript
// ğŸ†• åˆå§‹åŒ–é‡æ–°å¤„ç†ç®¡ç†å™¨
let reprocessManager = null;
let currentDrawings = [];
let currentSpecification = '';

// åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    reprocessManager = new DrawingReprocessManager();
    initializeReprocessButtons();
});

// åˆå§‹åŒ–é‡æ–°å¤„ç†æŒ‰é’®
function initializeReprocessButtons() {
    // é‡æ–°å¤„ç†è¯´æ˜ä¹¦
    document.getElementById('reprocessSpecBtn').addEventListener('click', handleReprocessSpecification);
    
    // é‡æ–°è¯†åˆ«å›¾ç‰‡
    document.getElementById('reprocessDrawingsBtn').addEventListener('click', handleReprocessDrawings);
}

// ğŸ†• åœ¨å¤„ç†å®Œæˆåè°ƒç”¨æ­¤å‡½æ•°
function onDrawingMarkerProcessComplete(result, specification, drawings) {
    // ä¿å­˜å½“å‰æ•°æ®
    currentSpecification = specification;
    currentDrawings = drawings;
    
    // æ›´æ–°é‡æ–°å¤„ç†ç®¡ç†å™¨çŠ¶æ€
    reprocessManager.updateState(result, specification, drawings);
    
    // æ£€æŸ¥æŒ‰é’®å¯è§æ€§
    const visibility = reprocessManager.getButtonVisibility();
    
    // æ˜¾ç¤ºé‡æ–°å¤„ç†åŒºåŸŸ
    if (visibility.showReprocessSpec || visibility.showReprocessDrawings) {
        document.getElementById('reprocessSection').style.display = 'block';
        
        // æ˜¾ç¤º/éšè—å…·ä½“æŒ‰é’®
        document.getElementById('reprocessSpecBtn').style.display = 
            visibility.showReprocessSpec ? 'inline-flex' : 'none';
        document.getElementById('reprocessDrawingsBtn').style.display = 
            visibility.showReprocessDrawings ? 'inline-flex' : 'none';
        
        // æ›´æ–°ç¼“å­˜ä¿¡æ¯æç¤º
        updateCacheInfoTip(result);
    }
}

// æ›´æ–°ç¼“å­˜ä¿¡æ¯æç¤º
function updateCacheInfoTip(result) {
    const cacheInfoText = document.getElementById('cacheInfoText');
    const ocrCount = result.ocr_detected_count || 0;
    const specCount = Object.keys(result.reference_map || {}).length;
    
    cacheInfoText.textContent = `å·²ç¼“å­˜ ${ocrCount} ä¸ªOCRè¯†åˆ«ç»“æœå’Œ ${specCount} ä¸ªè¯´æ˜ä¹¦æ ‡è®°ï¼Œå¯å¿«é€Ÿé‡æ–°å¤„ç†ã€‚`;
}

// å¤„ç†é‡æ–°å¤„ç†è¯´æ˜ä¹¦
async function handleReprocessSpecification() {
    // æ–¹å¼1ï¼šä½¿ç”¨promptè·å–æ–°è¯´æ˜ä¹¦
    const newSpecification = prompt('è¯·è¾“å…¥æ–°çš„è¯´æ˜ä¹¦å†…å®¹ï¼š', currentSpecification);
    
    if (!newSpecification || newSpecification.trim() === '') {
        return;
    }
    
    // æ–¹å¼2ï¼šä½¿ç”¨æ¨¡æ€æ¡†ï¼ˆæ›´ç¾è§‚ï¼‰
    // showSpecificationInputModal((newSpec) => {
    //     processReprocessSpecification(newSpec);
    // });
    
    await processReprocessSpecification(newSpecification);
}

// æ‰§è¡Œé‡æ–°å¤„ç†è¯´æ˜ä¹¦
async function processReprocessSpecification(newSpecification) {
    const btn = document.getElementById('reprocessSpecBtn');
    const originalHTML = btn.innerHTML;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<span>â³</span><span>å¤„ç†ä¸­...</span>';
        
        // è°ƒç”¨é‡æ–°å¤„ç†ç®¡ç†å™¨
        const result = await reprocessManager.reprocessSpecification(
            newSpecification,
            false,  // ai_mode
            null,   // model_name
            null    // custom_prompt
        );
        
        if (result) {
            // æ›´æ–°å½“å‰è¯´æ˜ä¹¦
            currentSpecification = newSpecification;
            
            // æ›´æ–°UIæ˜¾ç¤ºç»“æœ
            updateDrawingMarkerResults(result);
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccessMessage('âœ… è¯´æ˜ä¹¦é‡æ–°å¤„ç†å®Œæˆï¼');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showErrorMessage('âŒ å¤„ç†å¤±è´¥ï¼š' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// å¤„ç†é‡æ–°è¯†åˆ«å›¾ç‰‡
async function handleReprocessDrawings() {
    // åˆ›å»ºæ–‡ä»¶è¾“å…¥
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = true;
    
    input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        
        if (files.length === 0) {
            return;
        }
        
        await processReprocessDrawings(files);
    };
    
    input.click();
}

// æ‰§è¡Œé‡æ–°è¯†åˆ«å›¾ç‰‡
async function processReprocessDrawings(files) {
    const btn = document.getElementById('reprocessDrawingsBtn');
    const originalHTML = btn.innerHTML;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<span>â³</span><span>å¤„ç†ä¸­...</span>';
        
        // è°ƒç”¨é‡æ–°å¤„ç†ç®¡ç†å™¨
        const result = await reprocessManager.reprocessDrawings(files);
        
        if (result) {
            // æ›´æ–°å½“å‰å›¾ç‰‡
            currentDrawings = files;
            
            // æ›´æ–°UIæ˜¾ç¤ºç»“æœ
            updateDrawingMarkerResults(result);
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccessMessage('âœ… å›¾ç‰‡é‡æ–°è¯†åˆ«å®Œæˆï¼');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showErrorMessage('âŒ å¤„ç†å¤±è´¥ï¼š' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// æ›´æ–°åŠŸèƒ½å…«ç»“æœæ˜¾ç¤º
function updateDrawingMarkerResults(result) {
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    document.getElementById('ocrDetectedCount').textContent = result.ocr_detected_count || 0;
    document.getElementById('matchedCount').textContent = result.matched_count || 0;
    document.getElementById('unmatchedCount').textContent = result.unmatched_count || 0;
    
    // æ›´æ–°æ¶ˆæ¯
    document.getElementById('resultMessage').textContent = result.message;
    
    // é‡æ–°æ¸²æŸ“å›¾ç‰‡æ ‡æ³¨ï¼ˆå¦‚æœæœ‰äº¤äº’å¼æ ‡æ³¨ç»„ä»¶ï¼‰
    if (typeof renderDrawingAnnotations === 'function') {
        renderDrawingAnnotations(result.drawings);
    }
    
    // æ›´æ–°ç¼“å­˜ä¿¡æ¯
    updateCacheInfoTip(result);
}

// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
function showSuccessMessage(message) {
    // ä½¿ç”¨ç°æœ‰çš„æ¶ˆæ¯æç¤ºç»„ä»¶ï¼Œæˆ–åˆ›å»ºç®€å•çš„alert
    alert(message);
    
    // æˆ–ä½¿ç”¨æ›´ç¾è§‚çš„toastæç¤º
    // showToast(message, 'success');
}

// æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
function showErrorMessage(message) {
    alert(message);
    
    // æˆ–ä½¿ç”¨æ›´ç¾è§‚çš„toastæç¤º
    // showToast(message, 'error');
}
```

---

### æ­¥éª¤5ï¼šä¿®æ”¹ç°æœ‰å¤„ç†å‡½æ•°

åœ¨ç°æœ‰çš„åŠŸèƒ½å…«å¤„ç†å‡½æ•°ä¸­ï¼Œæ·»åŠ å¯¹é‡æ–°å¤„ç†çš„æ”¯æŒï¼š

```javascript
// åŸæœ‰çš„å¤„ç†å‡½æ•°
async function processDrawingMarker() {
    // ... ç°æœ‰ä»£ç  ...
    
    // å¤„ç†æˆåŠŸåï¼Œè°ƒç”¨æ–°å‡½æ•°
    if (result.success) {
        // æ˜¾ç¤ºç»“æœ
        displayDrawingMarkerResults(result.data);
        
        // ğŸ†• æ–°å¢ï¼šåˆå§‹åŒ–é‡æ–°å¤„ç†åŠŸèƒ½
        onDrawingMarkerProcessComplete(
            result.data,
            specificationText,
            uploadedDrawings
        );
    }
}
```

---

## ğŸ¨ å¯é€‰ï¼šç¾åŒ–è¯´æ˜ä¹¦è¾“å…¥æ¨¡æ€æ¡†

å¦‚æœæƒ³è¦æ›´ç¾è§‚çš„è¯´æ˜ä¹¦è¾“å…¥ç•Œé¢ï¼Œå¯ä»¥åˆ›å»ºæ¨¡æ€æ¡†ï¼š

```javascript
function showSpecificationInputModal(callback) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 10001;
        display: flex;
        justify-content: center;
        align-items: center;
    `;
    
    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background-color: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    `;
    
    dialog.innerHTML = `
        <h3 style="margin: 0 0 20px 0; color: #333;">ğŸ“ è¾“å…¥æ–°çš„è¯´æ˜ä¹¦å†…å®¹</h3>
        <textarea id="newSpecTextarea" style="
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        " placeholder="è¯·è¾“å…¥è¯´æ˜ä¹¦å†…å®¹ï¼Œä¾‹å¦‚ï¼š&#10;1. åº•åº§&#10;2. æ—‹è½¬è‡‚&#10;3. å¤¹ç´§è£…ç½®">${currentSpecification}</textarea>
        <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
            <button class="btn" style="background-color: #9E9E9E; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;" onclick="this.closest('.modal-container').remove()">
                å–æ¶ˆ
            </button>
            <button class="btn btn-primary" style="background-color: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;" onclick="
                const text = document.getElementById('newSpecTextarea').value;
                this.closest('.modal-container').remove();
                if (text.trim()) {
                    (${callback.toString()})(text);
                }
            ">
                ç¡®è®¤
            </button>
        </div>
    `;
    
    modal.className = 'modal-container';
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    // èšç„¦åˆ°textarea
    setTimeout(() => {
        document.getElementById('newSpecTextarea').focus();
    }, 100);
}
```

---

## âœ… é›†æˆéªŒæ”¶æ¸…å•

å®Œæˆé›†æˆåï¼Œæ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] å¼•å…¥äº† `drawingReprocessManager.js` è„šæœ¬
- [ ] æ·»åŠ äº†é‡æ–°å¤„ç†æŒ‰é’®UI
- [ ] æ·»åŠ äº†CSSæ ·å¼
- [ ] åˆå§‹åŒ–äº†é‡æ–°å¤„ç†ç®¡ç†å™¨
- [ ] åœ¨å¤„ç†å®Œæˆåè°ƒç”¨ `onDrawingMarkerProcessComplete`
- [ ] é‡æ–°å¤„ç†è¯´æ˜ä¹¦åŠŸèƒ½æ­£å¸¸
- [ ] é‡æ–°è¯†åˆ«å›¾ç‰‡åŠŸèƒ½æ­£å¸¸
- [ ] æŒ‰é’®æ ¹æ®ç¼“å­˜çŠ¶æ€æ˜¾ç¤º/éšè—
- [ ] ç¼“å­˜ä¿¡æ¯æç¤ºæ­£ç¡®æ˜¾ç¤º
- [ ] å¤„ç†ç»“æœæ­£ç¡®æ›´æ–°

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. **æ‰“å¼€ä¸»ç•Œé¢**
2. **ä¸Šä¼ å›¾ç‰‡å’Œè¯´æ˜ä¹¦**
3. **ç‚¹å‡»"å¼€å§‹å¤„ç†"**
4. **æ£€æŸ¥é‡æ–°å¤„ç†åŒºåŸŸæ˜¯å¦æ˜¾ç¤º**
5. **ç‚¹å‡»"é‡æ–°å¤„ç†è¯´æ˜ä¹¦"**
   - è¾“å…¥æ–°å†…å®¹
   - ç¡®è®¤å¤„ç†é€Ÿåº¦å¿«ï¼ˆ2-5ç§’ï¼‰
   - æ£€æŸ¥ç»“æœæ›´æ–°
6. **ç‚¹å‡»"é‡æ–°è¯†åˆ«å›¾ç‰‡"**
   - ä¸Šä¼ æ–°å›¾ç‰‡
   - ç¡®è®¤å¤„ç†é€Ÿåº¦å¿«ï¼ˆ5-10ç§’ï¼‰
   - æ£€æŸ¥ç»“æœæ›´æ–°

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæµç¨‹

```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡å’Œè¯´æ˜ä¹¦
    â†“
ç‚¹å‡»"å¼€å§‹å¤„ç†"ï¼ˆ7-15ç§’ï¼‰
    â†“
æ˜¾ç¤ºå¤„ç†ç»“æœ + é‡æ–°å¤„ç†æŒ‰é’®
    â†“
ç”¨æˆ·å‘ç°è¯´æ˜ä¹¦éœ€è¦è°ƒæ•´
    â†“
ç‚¹å‡»"é‡æ–°å¤„ç†è¯´æ˜ä¹¦"ï¼ˆ2-5ç§’ï¼‰âœ¨
    â†“
ç»“æœç«‹å³æ›´æ–°ï¼Œæ— éœ€é‡æ–°OCR
```

### æ€§èƒ½æå‡

- **å®Œæ•´å¤„ç†**ï¼š7-15ç§’
- **é‡æ–°å¤„ç†è¯´æ˜ä¹¦**ï¼š2-5ç§’ï¼ˆèŠ‚çœ70%ï¼‰âš¡
- **é‡æ–°è¯†åˆ«å›¾ç‰‡**ï¼š5-10ç§’ï¼ˆèŠ‚çœ30%ï¼‰âš¡

---

## ğŸ‰ å®Œæˆï¼

é›†æˆå®Œæˆåï¼ŒåŠŸèƒ½å…«å°†æ”¯æŒï¼š

âœ… å®Œæ•´å¤„ç†æµç¨‹ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰  
âœ… ç‹¬ç«‹é‡æ–°å¤„ç†è¯´æ˜ä¹¦ï¼ˆæ–°åŠŸèƒ½ï¼‰  
âœ… ç‹¬ç«‹é‡æ–°è¯†åˆ«å›¾ç‰‡ï¼ˆæ–°åŠŸèƒ½ï¼‰  
âœ… æ™ºèƒ½ç¼“å­˜ç®¡ç†  
âœ… ç¾è§‚çš„ç”¨æˆ·ç•Œé¢  
âœ… å¿«é€Ÿçš„å¤„ç†é€Ÿåº¦

---

**é›†æˆéš¾åº¦**ï¼šâ­â­â˜†â˜†â˜†ï¼ˆç®€å•ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š15-30åˆ†é’Ÿ  
**å½±å“èŒƒå›´**ï¼šåŠŸèƒ½å…«ï¼ˆäº¤äº’å¼é™„å›¾æ ‡æ³¨ï¼‰  
**å‘åå…¼å®¹**ï¼šâœ… å®Œå…¨å…¼å®¹
