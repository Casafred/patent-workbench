# 联网搜索功能修复说明

## 修复日期
2026年1月24日

## 问题诊断

根据智谱AI官方文档（https://docs.bigmodel.cn/cn/guide/tools/web-search），发现当前实现存在以下关键问题：

### 1. 参数类型错误

**问题**：后端代码中将布尔值和整数转换为字符串
```python
# ❌ 错误的实现
"enable": "True",  # 应该是布尔值 True
"search_result": "True",  # 应该是布尔值 True
"count": str(req_data.get('search_count', 5)),  # 应该是整数 5
```

**正确格式**（根据官方文档）：
```python
# ✅ 正确的实现
"enable": True,  # 布尔值
"search_result": True,  # 布尔值
"count": 5,  # 整数
```

### 2. 前端参数名称错误

**问题**：前端使用了 `search_count` 而不是 `count`
```javascript
// ❌ 错误
requestPayload.search_count = appState.chat.searchMode.count;

// ✅ 正确
requestPayload.count = appState.chat.searchMode.count;
```

### 3. 缺少 search_prompt 参数

**问题**：没有使用 `search_prompt` 参数来指导AI如何使用搜索结果

根据官方文档示例：
```python
"search_prompt": "你是一位财经分析师。请用简洁的语言总结网络搜索{search_result}中的关键信息，按重要性排序并引用来源日期。"
```

## 修复内容

### 1. 后端修复 (backend/routes/chat.py)

修复了两处（流式和非流式接口）：

```python
# 修复前
web_search_config = {
    "type": "web_search",
    "web_search": {
        "enable": "True",  # ❌ 字符串
        "search_result": "True",  # ❌ 字符串
        "count": str(req_data.get('search_count', 5)),  # ❌ 字符串
        "content_size": req_data.get('content_size', 'medium')
    }
}

# 修复后
web_search_config = {
    "type": "web_search",
    "web_search": {
        "enable": True,  # ✅ 布尔值
        "search_result": True,  # ✅ 布尔值
        "count": int(req_data.get('count', 5)),  # ✅ 整数
        "content_size": req_data.get('content_size', 'medium')
    }
}
```

### 2. 前端修复 (js/chat.js)

```javascript
// 修复前
if (appState.chat.searchMode.enabled) {
    requestPayload.enable_web_search = true;
    requestPayload.search_engine = appState.chat.searchMode.searchEngine;
    requestPayload.search_count = appState.chat.searchMode.count;  // ❌ 错误的参数名
    requestPayload.content_size = appState.chat.searchMode.contentSize;
}

// 修复后
if (appState.chat.searchMode.enabled) {
    requestPayload.enable_web_search = true;
    requestPayload.search_engine = appState.chat.searchMode.searchEngine;
    requestPayload.count = appState.chat.searchMode.count;  // ✅ 正确的参数名
    requestPayload.content_size = appState.chat.searchMode.contentSize;
    
    // ✅ 添加搜索提示词
    requestPayload.search_prompt = "你是一个专业的AI助手。请基于网络搜索结果{search_result}回答用户问题，并在回答中引用来源链接。确保信息准确、及时，并标注信息来源。";
}
```

## 官方API规范参考

根据智谱AI官方文档，"对话中的网络搜索"的正确参数格式：

```python
tools = [{
    "type": "web_search",
    "web_search": {
        "enable": True,  # 布尔值：是否启用网络搜索
        "search_engine": "search_pro",  # 字符串：搜索引擎类型
        "search_result": True,  # 布尔值：是否返回搜索结果
        "search_prompt": "...",  # 字符串：指导AI如何使用搜索结果
        "count": 5,  # 整数：返回结果数量（1-50）
        "search_domain_filter": "www.example.com",  # 可选：限定域名
        "search_recency_filter": "noLimit",  # 可选：时间范围
        "content_size": "medium"  # 字符串：内容长度（medium/high）
    }
}]
```

## 搜索引擎选项

| 搜索引擎编码 | 特性 | 价格 |
|------------|------|------|
| `search_std` | 智谱基础版：满足日常查询需求，性价比极高 | 0.01元/次 |
| `search_pro` | 智谱高级版：多引擎协作，召回率和准确率大幅提升 | 0.03元/次 |
| `search_pro_sogou` | 搜狗：覆盖腾讯生态和知乎内容 | 0.05元/次 |
| `search_pro_quark` | 夸克：精准触达垂直内容 | 0.05元/次 |

## 测试建议

1. **启用联网搜索**：点击聊天界面的搜索按钮
2. **配置搜索参数**：选择搜索引擎、结果数量和内容长度
3. **测试查询**：
   - "2026年1月的最新科技新闻"
   - "今天的天气如何"
   - "最新的AI技术发展"
4. **验证结果**：
   - AI回答应该包含最新信息
   - 回答中应该标注来源链接
   - 搜索结果应该相关且准确

## 部署步骤

1. 确保修改已保存
2. 重启Flask应用
3. 清除浏览器缓存
4. 测试联网搜索功能

## 注意事项

- 确保API Key有足够的余额
- 搜索功能会消耗额外的API调用费用
- 建议使用 `search_pro` 引擎以获得最佳效果
- `search_prompt` 参数对AI如何使用搜索结果至关重要

## 参考文档

- [智谱AI联网搜索文档](https://docs.bigmodel.cn/cn/guide/tools/web-search)
- [Web Search API参考](https://docs.bigmodel.cn/api-reference/%E5%B7%A5%E5%85%B7-api/%E7%BD%91%E7%BB%9C%E6%90%9C%E7%B4%A2)
- [对话中的网络搜索](https://docs.bigmodel.cn/api-reference/%E6%A8%A1%E5%9E%8B-api/%E5%AF%B9%E8%AF%9D%E8%A1%A5%E5%85%A8)
