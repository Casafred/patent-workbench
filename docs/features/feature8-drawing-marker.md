# 功能八：专利附图标记识别

## 功能概述

专利附图标记识别功能可以自动识别专利附图中的数字序号，并与说明书中的附图标记对应，在图上标注出部件名称。

## 主要特性

1. **多格式说明书解析**
   - 支持 `1. 底座` 或 `1、底座` 格式
   - 支持 `1电动工具、2外壳` 格式（数字直接连接文字）
   - 支持 `1…电动工具、2…外壳` 格式（省略号分隔）
   - 支持带字母的编号，如 `2L左侧外壳`、`10A工具孔`

2. **智能OCR识别**
   - 使用多种图像预处理方法提高识别率
   - 支持识别数字和字母组合（如 1、2L、10A）
   - 自动去重，保留置信度最高的结果

3. **可视化标注**
   - 在原图上标注识别到的序号
   - 显示对应的部件名称
   - 支持拖拽、编辑和删除标注

## 使用步骤

### 步骤 1: 上传专利附图

- 点击"上传专利附图"按钮选择图片文件
- 或直接将图片粘贴到粘贴区域
- 支持 JPG、PNG 等常见图片格式
- 可以上传多张图片

### 步骤 2: 输入说明书内容

在说明书输入框中输入完整的附图标记说明，支持以下格式：

**格式1：标准格式（带分隔符）**
```
1. 电动工具
2. 外壳
3. 后盖
```

**格式2：紧凑格式（顿号分隔）**
```
1电动工具、2外壳、2L左侧外壳、2R右侧外壳、3后盖、3S螺钉
```

**格式3：省略号格式**
```
1…电动工具、2…外壳、2L…左侧外壳、2R…右侧外壳
```

**格式4：混合格式**
```
1、电动工具
2、外壳
2L、左侧外壳
```

### 步骤 3: 开始处理

点击"开始处理"按钮，系统将：
1. 解析说明书内容，提取附图标记映射
2. 对每张图片进行OCR识别
3. 匹配识别结果与说明书标记
4. 在图上标注识别到的序号和名称

## 处理结果

处理完成后，系统会显示：

1. **处理统计**
   - 识别到的数字序号总数
   - 匹配率（匹配数量/说明书标记总数）

2. **标注后的附图**
   - 原图上叠加标注框
   - 显示序号和对应的部件名称
   - 支持交互操作（拖拽、编辑、删除）

## 注意事项

1. **图片质量要求**
   - 图片清晰度要高，数字序号清晰可见
   - 避免图片过度压缩或模糊
   - 建议使用原始分辨率的图片

2. **说明书格式**
   - 确保说明书内容完整
   - 编号要与图上的序号一致
   - 支持带字母的编号（如 2L、10A）

3. **OCR识别限制**
   - 手写数字识别率较低，建议使用打印体
   - 数字与背景对比度要高
   - 避免数字被遮挡或重叠

## 常见问题

### Q: 为什么识别率为 0%？

**可能原因：**
1. 说明书格式不正确
2. 图片质量太差，OCR无法识别
3. 图片上的数字与说明书中的编号不匹配

**解决方法：**
1. 检查说明书格式，确保使用支持的格式
2. 使用更清晰的图片
3. 确认图片上的数字与说明书编号一致

### Q: 识别到的数字不准确怎么办？

**解决方法：**
1. 提高图片分辨率
2. 增强图片对比度
3. 手动编辑标注结果

### Q: 支持哪些编号格式？

**支持的格式：**
- 纯数字：1、2、3、10、20
- 数字+字母：2L、2R、10A、10B
- 分隔符：`.`、`、`、`…`（点号、顿号、省略号）
- 不支持：罗马数字、中文数字

## 技术实现

### 后端API

**端点：** `POST /api/drawing-marker/process`

**请求体：**
```json
{
  "drawings": [
    {
      "name": "drawing1.png",
      "type": "image/png",
      "size": 1024,
      "data": "base64encodeddata"
    }
  ],
  "specification": "1电动工具、2外壳、3后盖"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "drawings": [...],
    "reference_map": {"1": "电动工具", "2": "外壳", "3": "后盖"},
    "total_numbers": 3,
    "match_rate": 100,
    "message": "成功处理 1 张图片，识别出 3 个数字序号，匹配率 100%"
  }
}
```

### OCR技术

- 使用 Tesseract OCR 引擎
- 多种图像预处理方法：
  - 灰度图
  - 自适应阈值
  - Otsu二值化
  - 简单阈值
- 智能去重和置信度筛选

### 说明书解析

使用正则表达式匹配多种格式：
- 模式1：`数字 + 分隔符 + 名称`
- 模式2：`数字 + 中文（顿号分隔）`

## 更新日志

### v1.0.0 (2026-01-25)
- ✅ 初始版本发布
- ✅ 支持多格式说明书解析
- ✅ 智能OCR识别
- ✅ 可视化标注功能
- ✅ 修复说明书解析问题（支持紧凑格式）
- ✅ 改进OCR配置和图像预处理
- ✅ 添加调试日志
- ✅ 支持省略号分隔格式（`1…电动工具、2…外壳`）
