# AI说明书处理器 - 用户指南

## 功能概述

AI说明书处理器是功能八(专利附图标注)的增强功能,提供两种处理模式来从专利说明书中提取附图标记和部件名称:

- **规则模式**: 使用jieba分词的传统规则处理方式(默认)
- **AI模式**: 使用人工智能模型进行智能语言检测、翻译和抽取

### 主要优势

✅ **多语言支持**: 自动检测语言并翻译为中文  
✅ **智能抽取**: AI理解上下文,提取更准确的标记  
✅ **灵活配置**: 可选择不同AI模型和自定义提示词  
✅ **向后兼容**: 保留原有规则模式,无缝切换

---

## 快速开始

### 1. 打开功能八界面

访问专利附图标注功能页面,找到"AI处理控制面板"。

### 2. 选择处理模式

**使用规则模式(默认)**:
- 保持"说明书AI处理"开关关闭
- 直接输入中文说明书文本
- 点击"开始处理"

**使用AI模式**:
1. 打开"说明书AI处理"开关
2. 选择AI模型(如 GLM-4-Flash)
3. (可选)自定义提示词
4. 输入说明书文本(支持中文、英文、日文等)
5. 点击"开始处理"

---

## AI模式 vs 规则模式对比

| 特性 | 规则模式 | AI模式 |
|------|---------|--------|
| **处理速度** | 快速(毫秒级) | 较慢(3-10秒) |
| **语言支持** | 仅中文 | 多语言(自动翻译) |
| **准确性** | 依赖分词规则 | 理解上下文,更准确 |
| **成本** | 免费 | 消耗API调用额度 |
| **适用场景** | 标准中文说明书 | 外文说明书、复杂描述 |

### 何时使用AI模式?

✅ **推荐使用AI模式**:
- 说明书为英文、日文等外语
- 说明书描述复杂,规则模式效果不佳
- 需要更高的抽取准确率

❌ **不推荐使用AI模式**:
- 标准中文说明书且规则模式效果良好
- 需要快速批量处理
- API调用额度有限

---

## 模型选择指南

系统支持多个AI模型,各有特点:

### GLM-4-Flash (推荐)
- **速度**: 快速
- **成本**: 低
- **适用**: 日常使用,性价比高

### GLM-4-Plus
- **速度**: 中等
- **成本**: 中等
- **适用**: 需要更高准确率的场景

### GLM-4-Air
- **速度**: 最快
- **成本**: 最低
- **适用**: 大批量处理

### 选择建议

1. **首次使用**: 选择 GLM-4-Flash 测试效果
2. **效果不佳**: 尝试 GLM-4-Plus 提升准确率
3. **批量处理**: 使用 GLM-4-Air 降低成本

---

## 提示词自定义

### 默认提示词模板

系统预置了优化的提示词模板:

```
你是一个专利文档分析专家。请从以下专利说明书文本中提取所有的附图标记和对应的部件名称。

附图标记通常是数字(如10、20、30)或带图号的标记(如图1、Fig. 1)。

请以JSON格式返回结果:
{
  "components": [
    {"marker": "10", "name": "外壳"},
    {"marker": "20", "name": "显示屏"}
  ]
}

说明书文本:
{description_text}
```

### 自定义提示词

点击"编辑提示词"按钮可以自定义提示词:

**必须包含的占位符**:
- `{description_text}` - 说明书文本将插入此处

**自定义示例 - 强调数字标记**:

```
你是专利分析AI。从下面的说明书中提取数字标记(如10、20)和部件名称。

重点关注:
1. 纯数字标记(10、20、30等)
2. 忽略图号(图1、Fig. 1等)
3. 提取完整的部件名称

返回JSON格式:
{"components": [{"marker": "标记", "name": "名称"}]}

文本:
{description_text}
```

**自定义示例 - 包含图号标记**:

```
从专利说明书中提取所有标记和部件:

标记类型:
- 数字标记: 10, 20, 30
- 图号标记: 图1, Fig. 1, FIG. 2

JSON格式返回:
{"components": [{"marker": "标记", "name": "部件名称"}]}

说明书:
{description_text}
```

### 提示词优化技巧

1. **明确任务**: 清楚说明要提取什么
2. **指定格式**: 要求JSON格式输出
3. **举例说明**: 提供标记和名称的示例
4. **限制范围**: 说明要包含或排除的内容
5. **保留占位符**: 必须包含 `{description_text}`

---

## 处理结果说明

### 成功处理

处理成功后会显示:

1. **检测语言**: 识别的原文语言(如 "en", "zh-cn", "ja")
2. **翻译文本**: 如果原文非中文,显示翻译后的中文文本
3. **处理时间**: 总处理耗时(秒)
4. **抽取的部件标记**: 标记和名称的列表

**示例输出**:

```
检测语言: en
翻译文本: 本发明涉及一种显示装置...
处理时间: 4.2秒

抽取的部件标记 (3):
• 10 - 外壳
• 20 - 显示屏
• 30 - 控制电路
```

### 警告信息

可能出现的警告:

- **"语言检测失败,假定为中文"**: 文本过短或语言不明确
- **"翻译服务不可用"**: API调用失败,使用原文继续处理
- **"AI抽取失败,返回空结果"**: AI未能识别有效标记

### 错误处理

常见错误及解决方法:

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| "请选择AI模型" | 未选择模型 | 在模型下拉框中选择一个模型 |
| "API密钥未配置" | 缺少API密钥 | 联系管理员配置环境变量 |
| "请求超时" | 处理时间过长 | 缩短文本长度或稍后重试 |
| "JSON解析失败" | AI返回格式错误 | 优化提示词或更换模型 |

---

## API使用示例

### 基本调用

```javascript
// AI模式
const response = await fetch('/api/drawing-marker/extract', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer YOUR_API_KEY'
    },
    body: JSON.stringify({
        description_text: "The display device includes a housing 10...",
        ai_mode: true,
        model_name: "GLM-4-Flash",
        custom_prompt: null  // 使用默认提示词
    })
});

const result = await response.json();
```

### 规则模式调用

```javascript
// 规则模式(向后兼容)
const response = await fetch('/api/drawing-marker/extract', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        description_text: "该显示装置包括外壳10、显示屏20...",
        ai_mode: false  // 或省略此参数
    })
});
```

### 响应格式

```json
{
    "success": true,
    "data": {
        "components": [
            {"marker": "10", "name": "外壳"},
            {"marker": "20", "name": "显示屏"}
        ],
        "language": "en",
        "translated_text": "该显示装置包括...",
        "processing_time": 4.2,
        "warning": null
    }
}
```

---

## 故障排查

### 问题: AI模式无响应

**可能原因**:
1. API密钥未配置或已过期
2. 网络连接问题
3. AI服务暂时不可用

**解决步骤**:
1. 检查浏览器控制台错误信息
2. 尝试切换到规则模式验证基本功能
3. 联系管理员检查API配置
4. 稍后重试

### 问题: 抽取结果不准确

**可能原因**:
1. 说明书格式不标准
2. 提示词不适合当前文本
3. 选择的模型能力不足

**解决步骤**:
1. 检查说明书文本格式是否清晰
2. 尝试自定义提示词,增加更多示例
3. 更换更强大的模型(如 GLM-4-Plus)
4. 对比规则模式的结果

### 问题: 翻译质量差

**可能原因**:
1. 原文包含大量专业术语
2. 文本过长导致翻译不完整

**解决步骤**:
1. 分段处理长文本
2. 在提示词中要求保留专业术语
3. 手动检查并修正关键术语翻译

### 问题: 处理速度慢

**可能原因**:
1. 文本过长
2. 选择的模型速度较慢
3. API服务负载高

**解决步骤**:
1. 缩短输入文本长度
2. 切换到 GLM-4-Air 或 GLM-4-Flash
3. 避开高峰时段使用
4. 考虑使用规则模式

---

## 最佳实践

### 1. 合理选择处理模式

- **中文标准文本**: 优先使用规则模式
- **外文文本**: 使用AI模式
- **混合场景**: 先用规则模式测试,效果不佳再用AI模式

### 2. 优化输入文本

- 保留完整的句子结构
- 确保标记和名称在同一句中
- 移除无关的页眉页脚
- 文本长度控制在5000字以内

### 3. 提示词管理

- 保存有效的自定义提示词
- 针对不同类型专利使用不同提示词
- 定期测试和优化提示词效果

### 4. 结果验证

- 对比AI模式和规则模式的结果
- 人工检查关键标记的准确性
- 记录问题案例用于优化

### 5. 成本控制

- 批量处理时优先使用规则模式
- 仅对规则模式失败的案例使用AI模式
- 选择性价比高的模型(GLM-4-Flash)

---

## 配置说明

### 环境变量

系统需要以下环境变量:

```bash
# 智谱AI API密钥
ZHIPU_API_KEY=your_api_key_here

# API基础URL(可选,使用默认值)
ZHIPU_API_BASE=https://open.bigmodel.cn/api/paas/v4/
```

### 模型配置文件

模型列表在 `config/models.json` 中配置:

```json
{
  "models": [
    {
      "name": "GLM-4-Flash",
      "display_name": "GLM-4-Flash (推荐)",
      "description": "快速、经济的模型",
      "max_tokens": 4096
    },
    {
      "name": "GLM-4-Plus",
      "display_name": "GLM-4-Plus",
      "description": "高性能模型",
      "max_tokens": 8192
    }
  ]
}
```

---

## 常见问题 (FAQ)

**Q: AI模式会替代规则模式吗?**  
A: 不会。两种模式各有优势,系统会长期保留两种模式供用户选择。

**Q: 处理一次大约消耗多少API额度?**  
A: 取决于文本长度和模型选择,通常一次处理消耗0.001-0.01元。

**Q: 可以同时使用多个模型吗?**  
A: 当前版本每次只能选择一个模型,未来可能支持模型对比功能。

**Q: 自定义提示词会保存吗?**  
A: 是的,自定义提示词保存在浏览器本地存储中,下次访问时自动加载。

**Q: 支持哪些语言?**  
A: 理论上支持所有主流语言,包括英语、日语、韩语、德语、法语等。

**Q: 翻译后的文本可以导出吗?**  
A: 当前版本仅显示翻译文本,未来版本可能增加导出功能。

---

## 技术支持

如遇到问题或有功能建议,请联系:

- **技术文档**: 查看 `docs/` 目录下的其他文档
- **API文档**: 参考 `backend/routes/drawing_marker.py` 的注释
- **测试页面**: 访问 `test_ai_description_processor.html` 进行功能测试

---

## 更新日志

### v1.0.0 (2026-02-01)
- ✨ 首次发布AI说明书处理器
- ✨ 支持多语言自动检测和翻译
- ✨ 支持多模型选择
- ✨ 支持自定义提示词
- ✨ 保持与规则模式的向后兼容

---

**最后更新**: 2026-02-01  
**文档版本**: 1.0.0
