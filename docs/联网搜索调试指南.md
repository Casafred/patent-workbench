# 联网搜索功能调试指南

## 📋 问题描述
联网搜索功能不起作用，结果不显示联网搜索的内容。

## 🔧 已添加的调试信息

### 前端调试信息（浏览器控制台）

现在在浏览器控制台（F12）中，你会看到以下调试信息：

#### 1. 点击搜索按钮时
```
🔍 [联网搜索] 搜索模式切换: {
  enabled: true/false,
  searchEngine: "search_pro",
  count: 5,
  contentSize: "medium"
}
```

#### 2. 发送消息时
```
🔍 [联网搜索] 准备发送请求，当前搜索模式状态: {
  enabled: true,
  searchEngine: "search_pro",
  count: 5,
  contentSize: "medium"
}
```

如果启用了搜索：
```
🔍 [联网搜索] 已启用！请求参数: {
  enable_web_search: true,
  search_engine: "search_pro",
  count: 5,
  content_size: "medium",
  search_prompt: "..."
}
```

如果未启用：
```
🔍 [联网搜索] 未启用，使用普通对话模式
```

#### 3. 收到搜索结果时
```
🔍 [联网搜索] 收到工具调用: [...]
🔍 [联网搜索] 检测到网络搜索工具调用: {...}
🔍 [联网搜索] 成功获取搜索结果，共 X 条: [...]
```

#### 4. 显示搜索结果时
```
🔍 [联网搜索] 添加搜索来源到UI，共 X 条
```

或者：
```
🔍 [联网搜索] 没有搜索结果可显示
```

### 后端调试信息（服务器日志）

在后端日志中，你会看到：

#### 1. 收到请求时
```
🔍 [后端-联网搜索] 收到请求，enable_web_search=True/False
```

#### 2. 如果启用了搜索
```
🔍 [后端-联网搜索] 已启用！配置: {
  "type": "web_search",
  "web_search": {
    "enable": True,
    "search_engine": "search_pro",
    "search_result": True,
    "count": 5,
    "content_size": "medium"
  }
}
```

或者：
```
🔍 [后端-联网搜索] 未启用，使用普通对话模式
```

#### 3. 发送给API时
```
🔍 [后端-联网搜索] 发送给智谱API的参数: model=..., tools=[...]
```

#### 4. 收到工具调用时
```
🔍 [后端-联网搜索] 收到工具调用: {...}
```

## 🔍 诊断步骤

### 步骤1：检查搜索按钮状态
1. 打开浏览器控制台（F12）
2. 点击聊天界面的搜索按钮（🔍图标）
3. 查看控制台输出：
   - 应该看到 `🔍 [联网搜索] 搜索模式切换: { enabled: true, ... }`
   - 搜索按钮应该变成蓝色背景
   - 输入框上方应该显示"联网搜索已启用"的提示

**如果没有看到这些：**
- 检查 `chatSearchBtn` 元素是否存在
- 检查 `handleSearch` 函数是否正确绑定

### 步骤2：检查发送请求时的参数
1. 启用搜索后，发送一条消息
2. 查看控制台输出：
   - 应该看到 `🔍 [联网搜索] 准备发送请求，当前搜索模式状态: { enabled: true, ... }`
   - 应该看到 `🔍 [联网搜索] 已启用！请求参数: { enable_web_search: true, ... }`

**如果 enabled 是 false：**
- 搜索按钮可能没有正确切换状态
- 检查 `appState.chat.searchMode.enabled` 的值

**如果看到"未启用"：**
- 搜索模式没有正确开启
- 重新点击搜索按钮

### 步骤3：检查后端是否收到搜索参数
1. 查看后端日志（服务器控制台）
2. 应该看到：
   - `🔍 [后端-联网搜索] 收到请求，enable_web_search=True`
   - `🔍 [后端-联网搜索] 已启用！配置: {...}`

**如果后端显示 enable_web_search=False：**
- 前端没有正确发送参数
- 检查 `requestPayload` 对象的构建

**如果后端显示"未启用"：**
- 请求参数在传输过程中丢失
- 检查网络请求（Network标签）

### 步骤4：检查API响应
1. 查看浏览器控制台
2. 应该看到：
   - `🔍 [联网搜索] 收到工具调用: [...]`
   - `🔍 [联网搜索] 检测到网络搜索工具调用: {...}`
   - `🔍 [联网搜索] 成功获取搜索结果，共 X 条: [...]`

**如果没有收到工具调用：**
- 智谱API可能没有返回搜索结果
- 检查API密钥是否有权限使用网络搜索功能
- 检查后端日志中是否有错误信息

### 步骤5：检查搜索结果显示
1. 查看浏览器控制台
2. 应该看到：
   - `🔍 [联网搜索] 添加搜索来源到UI，共 X 条`

**如果显示"没有搜索结果可显示"：**
- `searchResults` 变量为空或未定义
- 检查步骤4中是否成功获取搜索结果

## 🐛 常见问题排查

### 问题1：搜索按钮点击无反应
**检查：**
- 控制台是否有 JavaScript 错误
- `chatSearchBtn` 元素是否正确绑定事件监听器
- `handleSearch` 函数是否存在

### 问题2：搜索按钮变蓝但没有搜索结果
**检查：**
- 控制台中 `enabled` 是否为 `true`
- 后端是否收到 `enable_web_search=True`
- API密钥是否有网络搜索权限

### 问题3：后端收到参数但没有返回搜索结果
**检查：**
- 后端日志中是否有错误信息
- 智谱API是否返回了工具调用
- 检查 `tools` 参数格式是否正确

### 问题4：收到搜索结果但不显示
**检查：**
- `searchResults` 变量是否正确赋值
- `addMessageToDOM` 函数是否正确传递 `searchResults`
- CSS样式 `.search-sources` 是否正确加载

## 📝 测试步骤

1. **清除缓存并刷新页面**
2. **打开浏览器控制台（F12）**
3. **点击搜索按钮**
   - 观察控制台输出
   - 确认按钮变蓝
4. **发送测试消息**（例如："今天的新闻"）
   - 观察控制台输出
   - 观察后端日志
5. **等待AI回复**
   - 观察是否显示"正在联网搜索..."
   - 观察是否显示搜索结果来源

## 🔗 相关文件

- 前端：`js/chat.js`
- 后端：`backend/routes/chat.py`
- 样式：`frontend/css/pages/chat.css`（搜索来源样式）

## 📞 获取帮助

如果问题仍然存在，请提供：
1. 浏览器控制台的完整输出
2. 后端日志的完整输出
3. 网络请求的详细信息（Network标签）
4. 使用的API密钥是否有网络搜索权限

---

**更新时间：** 2026-01-24
**版本：** v1.0
