# 用户缓存导出导入系统

## 版本: v26.1 (2026-02-21)

## 概述

本次更新实现了用户个人账号数据隔离和缓存导出导入系统，解决了以下问题：
- 不同用户在同一浏览器登录时数据混淆
- 换设备/浏览器后数据无法同步
- 用户无法备份/恢复自己的配置

## 新增文件

### 核心模块 (`js/core/`)

| 文件 | 功能 |
|------|------|
| `user-cache-storage.js` | 底层存储层，封装localStorage，实现用户数据隔离 |
| `user-cache-manager.js` | 核心管理器，统一入口，协调各模块 |
| `user-cache-exporter.js` | 导出模块，收集数据生成JSON文件下载 |
| `user-cache-importer.js` | 导入模块，解析验证JSON文件 |
| `user-cache-merger.js` | 智能合并模块，时间戳验证+冲突处理 |

### UI模块 (`js/modules/user-data/`)

| 文件 | 功能 |
|------|------|
| `user-data-ui.js` | 数据管理面板UI，统计展示 |
| `user-data-modal.js` | 导出/导入选项弹窗组件 |

## 修改文件

| 文件 | 修改内容 |
|------|---------|
| `js/modules/chat/chat-conversation.js` | 对话历史用户隔离 |
| `js/modules/chat/chat-persona.js` | 自定义角色用户隔离 |
| `js/modules/patent-batch/patent-cache.js` | 专利缓存用户隔离 |
| `js/modules/patent-batch/patent-history.js` | 爬取历史用户隔离 |
| `js/modules/large-batch/template-manager.js` | 大批量模板用户隔离 |
| `js/modules/pdf-ocr/pdf-ocr-cache.js` | PDF OCR缓存用户隔离 |
| `frontend/js/drawingCacheManager.js` | 附图OCR缓存用户隔离 |
| `backend/routes/auth.py` | 注入用户名到前端 |
| `frontend/index.html` | 添加模块脚本引用 |
| `js/state.js` | 添加缓存管理器初始化 |

## 功能说明

### 1. 用户数据隔离

所有用户数据存储在独立的localStorage键名下：
```
格式: user_{username}_{原键名}
示例: user_alfred777_chatConversations
```

### 2. 数据导出

- **入口**: 用户操作区 → "📦 数据" → "导出数据"
- **选项**:
  - 全部数据
  - 仅配置（模板、角色等）
  - 对话历史
  - 专利缓存
  - OCR缓存
- **安全**: API密钥等敏感信息不导出
- **格式**: JSON文件，包含校验和

### 3. 数据导入

- **入口**: 用户操作区 → "📦 数据" → "导入数据"
- **方式**: 点击选择或拖拽文件
- **验证**: 文件格式、完整性、用户名匹配
- **合并策略**:
  - 智能合并（保留较新数据）
  - 保留本地
  - 覆盖导入
  - 仅添加新项

### 4. 智能合并

- 时间戳验证，自动保留较新数据
- 内容变化检测
- 差异分析报告

## 数据类型

| 类型 | 键名 | 说明 |
|------|------|------|
| 对话历史 | `chatConversations` | 即时对话记录 |
| 自定义角色 | `chatPersonas` | AI角色配置 |
| 文件解析缓存 | `parsedFilesCache` | 文件解析结果 |
| 专利数据缓存 | `patent_cache_*` | 专利爬取数据 |
| 解读结果缓存 | `patent_analysis_*` | 专利解读结果 |
| 爬取历史 | `patent_crawl_history` | 专利号历史记录 |
| 大批量模板 | `large_batch_custom_templates` | 自定义模板 |
| 附图OCR缓存 | `drawing_ocr_cache` | 附图识别结果 |
| PDF OCR缓存 | `pdf_ocr_cache_*` | PDF识别结果 |

## 使用方法

### 导出数据
1. 登录系统
2. 点击右上角 "📦 数据" 按钮
3. 选择 "导出数据"
4. 选择导出选项
5. 点击 "导出" 下载JSON文件

### 导入数据
1. 登录系统
2. 点击右上角 "📦 数据" 按钮
3. 选择 "导入数据"
4. 选择或拖拽JSON文件
5. 选择合并策略
6. 点击 "导入" 完成合并

### 清除缓存
1. 登录系统
2. 点击右上角 "📦 数据" 按钮
3. 选择 "清除缓存"
4. 确认清除（建议先导出备份）

## 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                    用户缓存管理系统架构                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────┐     登录验证      ┌──────────────────┐  │
│   │   用户登录    │ ──────────────►  │  后端 Session    │  │
│   │   (auth.py)  │                   │  session['user'] │  │
│   └──────────────┘                   └──────────────────┘  │
│          │                                                  │
│          │ 用户名注入前端                                    │
│          ▼                                                  │
│   ┌──────────────────────────────────────────────────────┐ │
│   │              前端缓存管理器                            │ │
│   │  ┌────────────────────────────────────────────────┐  │ │
│   │  │  UserCacheManager                              │  │ │
│   │  │  ├─ UserCacheStorage (存储层)                   │  │ │
│   │  │  ├─ UserCacheExporter (导出)                    │  │ │
│   │  │  ├─ UserCacheImporter (导入)                    │  │ │
│   │  │  └─ UserCacheMerger (合并)                      │  │ │
│   │  └────────────────────────────────────────────────┘  │ │
│   └──────────────────────────────────────────────────────┘ │
│          │                                                  │
│          ▼                                                  │
│   ┌──────────────────────────────────────────────────────┐ │
│   │              localStorage（浏览器本地存储）            │ │
│   │  user_alfred777_chatConversations                    │ │
│   │  user_alfred777_patent_cache_*                       │ │
│   │  user_fredmate001_chatConversations                  │ │
│   │  ...                                                 │ │
│   └──────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 注意事项

1. **数据安全**: 导出文件包含用户数据，请妥善保管
2. **浏览器限制**: localStorage有大小限制（通常5-10MB）
3. **兼容性**: 导出文件仅兼容同版本系统
4. **敏感信息**: API密钥不会导出，需手动配置

## 更新日志

### v26.1 (2026-02-21)
- 新增用户数据隔离功能
- 新增数据导出功能
- 新增数据导入功能
- 新增智能合并功能
- 新增数据管理UI
