# 功能七多语言支持 - 调试指南

## 最新修复（2026-02-05）

### 已修复的问题
1. ✅ **语言检测优化**：关键词检测提前到字符统计之前，避免法文被误判为英文
2. ✅ **取消按钮可见性**：修改按钮样式，使用灰色背景和深色文字
3. ✅ **API Key配置**：从全局状态（window.state.apiKey）获取并添加到Authorization header

### 修复详情

#### 1. 语言检测逻辑优化
**问题**：法文文本包含大量英文字母，在关键词检测之前就被判定为英文。

**修复**：
```javascript
// 修复前：字符统计 → 关键词检测
// 修复后：关键词检测 → 字符统计

function detectTextLanguage(text) {
    // 法语关键词检测（最优先）
    if (/\b(revendication|selon|caractérisé|comprenant|dispositif)\b/i.test(text)) return 'fr';
    
    // 德语关键词检测
    if (/\b(anspruch|ansprüche|gemäß|dadurch|gekennzeichnet)\b/i.test(text)) return 'de';
    
    // 然后才是字符统计...
}
```

#### 2. 取消按钮样式修复
**问题**：白色背景 + 白色文字 = 看不见

**修复**：
```javascript
// 修复前：background: white; color: #333;
// 修复后：background: #f5f5f5; color: #333; border: 1px solid #ccc;
```

#### 3. API Key配置修复
**问题**：后端从Authorization header获取API Key，但前端没有发送。

**修复**：
```javascript
// 从全局状态获取API Key
const apiKey = window.state?.apiKey;
if (!apiKey) {
    showClaimsTextMessage('请先在设置中配置API Key', 'error');
    return;
}

// 添加到请求头
headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${apiKey}`
}
```

---

## 测试验证

### 快速测试步骤
1. **清除浏览器缓存**（Ctrl + Shift + Delete）
2. **强制刷新页面**（Ctrl + F5）
3. **打开功能七文本分析**
4. **输入法文测试文本**：
   ```
   Revendication 1. Un dispositif comprenant un processeur.
   ```
5. **点击"开始分析"**
6. **应该弹出对话框**："检测到法语文本"
7. **取消按钮应该清晰可见**（灰色背景）
8. **点击"开启AI模式"**
9. **应该成功调用AI翻译**

### 控制台测试
打开浏览器控制台（F12 → Console），输入：

```javascript
// 测试1：检查函数是否存在
console.log('detectTextLanguage:', typeof detectTextLanguage);
// 应该返回: "function"

// 测试2：测试法文检测
console.log('法文检测:', detectTextLanguage("Revendication 1. Un dispositif"));
// 应该返回: "fr"

// 测试3：测试德文检测
console.log('德文检测:', detectTextLanguage("Anspruch 1. Eine Vorrichtung"));
// 应该返回: "de"

// 测试4：测试中文检测
console.log('中文检测:', detectTextLanguage("权利要求1. 一种装置"));
// 应该返回: "zh"

// 测试5：测试英文检测
console.log('英文检测:', detectTextLanguage("Claim 1. A device comprising a processor"));
// 应该返回: "en"

// 测试6：检查API Key是否配置
console.log('API Key配置:', window.state?.apiKey ? '已配置' : '未配置');
```

---

## 问题描述（已解决）
输入法文文本后点击"开始分析"，直接显示结果但都是错的，没有弹出AI模式提示。

## 原因分析

### 1. 语言检测逻辑问题（已修复）
法文文本包含大量英文字母（如 "Revendication", "dispositif"），在关键词检测之前就被字符统计判定为英文。

**修复前的逻辑顺序**：
1. 统计字符（中文、日文、英文）
2. 如果英文字符 > 50%，返回 'en'
3. 检查关键词（法文、德文）← 永远执行不到

**修复后的逻辑顺序**：
1. 检查关键词（法文、德文）← 优先执行
2. 统计字符（中文、日文、韩文）
3. 如果英文字符 > 50%，返回 'en'

### 2. 取消按钮可见性问题（已修复）
按钮样式设置为白色背景 + 白色文字，导致看不见。

**修复**：改为灰色背景（#f5f5f5）+ 深色文字（#333）+ 边框（#ccc）

### 3. API Key配置问题（已修复）
后端从Authorization header获取API Key，但前端没有发送。

**修复**：从 window.state.apiKey 获取并添加到请求头。

---

## 浏览器缓存清除

如果修复后仍然不工作，请清除浏览器缓存：

### 方法1：清除缓存
```
1. 按 Ctrl + Shift + Delete
2. 选择"缓存的图片和文件"
3. 时间范围选择"全部时间"
4. 点击"清除数据"
5. 强制刷新页面（Ctrl + F5）
```

### 方法2：使用无痕模式
```
Ctrl + Shift + N (Chrome)
Ctrl + Shift + P (Firefox)
```

### 方法3：禁用缓存
```
1. 打开开发者工具（F12）
2. 切换到 Network 标签
3. 勾选 "Disable cache"
4. 刷新页面
```

---

## 完整测试流程

### 测试1：法文文本
```
输入：Revendication 1. Un dispositif comprenant un processeur.
预期：弹出"检测到法语文本"对话框
```

### 测试2：德文文本
```
输入：Anspruch 1. Eine Vorrichtung mit einem Prozessor.
预期：弹出"检测到德语文本"对话框
```

### 测试3：中文文本
```
输入：权利要求1. 一种包括处理器的装置。
预期：直接分析，不弹出对话框
```

### 测试4：英文文本
```
输入：Claim 1. A device comprising a processor.
预期：直接分析，不弹出对话框
```

---

## 常见问题排查

### Q1: 仍然直接显示结果，不弹出对话框
**原因**：浏览器缓存
**解决**：
1. 清除缓存（Ctrl + Shift + Delete）
2. 强制刷新（Ctrl + F5）
3. 或使用无痕模式测试

### Q2: 弹出对话框但取消按钮看不清
**原因**：浏览器缓存了旧样式
**解决**：清除缓存并刷新

### Q3: 点击"开启AI模式"后报错"请先在设置中配置API Key"
**原因**：API Key未配置
**解决**：
1. 点击页面右上角的设置图标
2. 输入智谱AI的API Key
3. 保存后重试

### Q4: 点击"开启AI模式"后报错"Authorization header with Bearer token is required"
**原因**：前端没有发送API Key
**解决**：
1. 确认已清除缓存
2. 检查控制台：`console.log(window.state?.apiKey)`
3. 如果返回 undefined，说明API Key未保存到全局状态

---

## 获取帮助

如果以上方法都不能解决问题，请提供以下信息：

1. **浏览器控制台截图**（F12 → Console）
2. **Network标签截图**（显示API请求）
3. **测试结果**：
   ```javascript
   console.log('detectTextLanguage存在:', typeof detectTextLanguage);
   console.log('测试法文:', detectTextLanguage("Revendication 1"));
   console.log('API Key:', window.state?.apiKey ? '已配置' : '未配置');
   ```

---

**修复完成时间**：2026-02-05  
**修复内容**：语言检测逻辑优化 + 取消按钮样式修复 + API Key配置修复
