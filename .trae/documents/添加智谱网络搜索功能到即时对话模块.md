# 实现方案：添加智谱网络搜索功能

## 1. 功能概述

为即时对话模块添加联网搜索功能，允许用户在发送消息时选择启用网络搜索，将搜索结果作为上下文发送给AI，增强AI的回答能力。

## 2. 实现步骤

### 2.1 后端实现

#### 2.1.1 添加搜索API端点

* **文件**: `backend/routes/chat.py`

* **功能**: 添加`/search` POST端点，调用智谱网络搜索API

* **参数**:

  * `search_query`: 搜索关键词

  * `search_engine`: 搜索引擎类型（默认：search\_std）

  * `count`: 返回结果条数（默认：5）

  * `content_size`: 内容长度（默认：medium）

* **返回**: 格式化的搜索结果

#### 2.1.2 实现搜索逻辑

* **文件**: `backend/routes/chat.py`

* **功能**: 调用智谱网络搜索API，处理响应并返回格式化结果

* **认证**: 使用Authorization头中的API密钥

* **错误处理**: 处理API调用错误，返回友好错误信息

### 2.2 前端实现

#### 2.2.1 添加搜索按钮

* **文件**: `frontend/index.html`

* **位置**: 聊天输入区域（id="chat\_input\_area"）

* **功能**: 添加一个搜索图标按钮，用于触发搜索功能

#### 2.2.2 实现搜索功能

* **文件**: `js/chat.js`

* **功能**:

  * 添加`handleSearch`函数，处理搜索按钮点击事件

  * 显示搜索结果弹窗

  * 允许用户选择是否将搜索结果作为上下文

  * 将搜索结果整合到消息中

#### 2.2.3 修改聊天发送逻辑

* **文件**: `js/chat.js`

* **功能**: 修改`handleStreamChatRequest`函数，支持将搜索结果作为上下文发送给AI

## 3. 技术细节

### 3.1 智谱网络搜索API参数

* **认证方式**: Bearer Token

* **请求格式**: JSON

* **主要参数**:

  * `search_query`: 搜索内容

  * `search_engine`: 搜索引擎类型

  * `count`: 返回结果条数

  * `content_size`: 返回内容长度

### 3.2 搜索结果格式

```json
{
  "search_intent": {
    "query": "原始搜索词",
    "intent": "SEARCH_ALL",
    "keywords": "优化后的搜索词"
  },
  "search_result": [
    {
      "title": "搜索结果标题",
      "content": "搜索结果内容摘要",
      "link": "搜索结果链接",
      "media": "网站名称",
      "icon": "网站图标",
      "publish_date": "发布时间"
    }
  ]
}
```

### 3.3 前端UI设计

* 搜索按钮：位于聊天输入框左侧，使用搜索图标

* 搜索结果弹窗：显示搜索结果列表，允许用户选择是否使用

* 搜索状态指示：显示搜索中、搜索完成或搜索失败状态

## 4. 集成方式

### 4.1 搜索流程

1. 用户输入问题
2. 点击搜索按钮或发送消息时选择搜索
3. 前端发送搜索请求到后端
4. 后端调用智谱网络搜索API
5. 后端返回搜索结果
6. 前端显示搜索结果，用户选择是否使用
7. 将搜索结果作为上下文发送给AI
8. AI基于搜索结果生成回答

### 4.2 上下文整合

将搜索结果格式化为以下格式，作为用户消息的一部分发送给AI：

```
用户问题：{用户输入}

网络搜索结果：
1. [{标题1}]({链接1})
{内容1}

2. [{标题2}]({链接2})
{内容2}

...
```

## 5. 测试计划

1. 测试搜索按钮的显示和点击事件
2. 测试搜索请求的发送和响应
3. 测试搜索结果的显示和选择
4. 测试搜索结果作为上下文发送给AI
5. 测试AI基于搜索结果生成的回答
6. 测试错误处理（无效API密钥、搜索失败等）

## 6. 预期效果

1. 用户可以方便地使用网络搜索功能
2. 搜索结果可以作为上下文增强AI的回答
3. 界面美观，操作流畅
4. 错误处理完善，用户体验良好

## 7. 代码修改点

### 后端

* `backend/routes/chat.py`: 添加搜索API端点

* `backend/services/api_service.py`: 可能需要调整API密钥处理

### 前端

* `frontend/index.html`: 添加搜索按钮

* `js/chat.js`: 添加搜索功能和修改聊天发送逻辑

* `frontend/css/main.css`: 添加搜索相关样式（如果需要）

