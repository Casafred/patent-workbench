# 游客模式功能实现计划

## 一、需求总结

### 核心功能
1. **登录入口** - 登录页面添加"游客模式"按钮，无需账号密码即可进入
2. **模型限制** - 只能使用免费的 `glm-4-flash` 模型
3. **功能限制** - 隐藏修改密码、修改用户名、数据缓存导出功能
4. **缓存机制** - 每次游客登录时自动清空所有缓存和自定义配置
5. **内置API Key** - 后端预置，前端不可见
6. **提示信息** - 进入后显示游客模式限制说明

### 补充优化
- 游客模式明显标识（页面顶部提示条）
- 游客会话较短有效期
- 游客数据使用特殊前缀隔离

---

## 二、文件修改清单

### 后端文件 (4个)

#### 1. `backend/routes/auth.py`
- 添加游客登录路由 `/guest-login`
- 修改 `serve_app()` 注入游客模式标识和限制UI
- 游客模式下隐藏修改密码/用户名按钮和数据导出功能
- 添加游客模式提示条

#### 2. `backend/middleware/auth_middleware.py`
- 修改 `validate_api_request()` 支持游客模式
- 游客模式跳过IP验证

#### 3. `backend/services/api_service.py`
- 添加 `get_guest_zhipu_client()` 函数
- 游客请求使用内置API Key

#### 4. `backend/config.py`
- 添加游客模式配置项（内置API Key、会话时长等）

### 前端文件 (3个)

#### 5. `js/state.js`
- 添加 `isGuestMode` 状态标识
- 添加 `guestModelRestriction()` 函数限制模型选择
- 游客模式下自动设置隐藏的API Key

#### 6. `js/core/user-cache-manager.js`
- 添加 `clearGuestData()` 方法清空游客数据
- 游客数据使用 `guest_` 前缀

#### 7. `js/modules/user-data/user-data-ui.js`
- 游客模式下隐藏数据管理按钮

---

## 三、实现细节

### 3.1 登录页面修改
在登录表单下方添加"游客模式"按钮，点击后：
- 直接创建游客会话
- 重定向到主应用页面

### 3.2 游客会话管理
```python
# 游客登录时设置
session['user'] = 'guest'
session['is_guest'] = True
session.permanent = False  # 关闭浏览器即失效
```

### 3.3 模型限制实现
```javascript
// 游客模式下更新模型选择器
function applyGuestModelRestriction() {
    const guestModel = 'glm-4-flash';
    // 所有模型选择器只显示 glm-4-flash
    // 设置为只读/禁用状态
}
```

### 3.4 API Key 内置方案
- API Key 存储在后端环境变量或配置文件
- 游客请求通过后端代理转发，前端不接触API Key
- 前端 `appState.apiKey` 设为 `'GUEST_MODE'` 标识

### 3.5 缓存清空机制
```javascript
// 游客登录时执行
function clearGuestCache() {
    // 清除所有 guest_ 前缀的数据
    // 重置所有自定义配置
}
```

---

## 四、用户界面变化

### 游客模式下的界面差异：
1. **顶部提示条** - 显示"游客模式：缓存不保留，模型仅限glm-4-flash"
2. **用户信息区** - 显示"游客用户"，无修改密码/用户名按钮
3. **数据管理** - 无数据导出按钮，仅显示清除缓存
4. **模型选择** - 所有功能模型选择器固定为 glm-4-flash

---

## 五、安全考虑

1. API Key 完全隐藏在后端
2. 游客会话不持久化（关闭浏览器失效）
3. 游客数据与其他用户隔离
4. 可考虑添加游客请求频率限制

---

## 六、实施顺序

1. 后端配置和API服务修改
2. 认证路由和中间件修改
3. 前端状态管理修改
4. 缓存管理修改
5. UI组件修改
6. 测试验证