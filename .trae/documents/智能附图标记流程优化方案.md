## 问题分析

**当前流程的问题**：
1. 当说明书过长时，整个说明书被发送给AI处理，导致超时
2. 前端进度显示是假的，只是循环显示固定文本，与后端实际状态不同步
3. 超时时间设置不合理（AI模式60秒可能不够长文本处理）
4. 单一API请求处理所有步骤，无法分阶段反馈

## 优化方案

### 1. 重构处理流程（分阶段处理）

**新流程**：
```
阶段1: OCR识别序号 → 显示"OCR识别中..."
阶段2: 提取相关句段 → 显示"提取说明书相关内容..."
阶段3: AI处理 → 显示"AI智能匹配中..."
```

### 2. 后端修改 (drawing_marker.py)

新增API端点 `/drawing-marker/process-staged`：
- **Step 1**: 先执行OCR识别，返回识别到的序号列表
- **Step 2**: 根据OCR序号，在说明书中查找包含这些序号的句子/段落
- **Step 3**: 只将提取的相关句段（而非完整说明书）发送给AI处理

新增工具函数 `extract_relevant_segments(specification, ocr_numbers)`：
- 在说明书中查找所有包含OCR序号的句子
- 提取连续的上下文（前后各1-2句话），避免切断语义
- 返回精简后的文本

### 3. 前端修改 (frontend/index.html)

修改 `startProcessing()` 函数：
- 分阶段调用API
- 每个阶段完成后更新状态显示
- 根据实际后端返回更新进度文本

### 4. 超时时间优化

- OCR阶段: 30秒
- 提取句段: 5秒
- AI处理: 120秒（因为文本已精简，实际处理时间会大幅缩短）

### 5. 状态显示对应

| 阶段 | 状态文本 | 预计耗时 |
|------|---------|---------|
| OCR识别 | "正在识别图片中的序号..." | 5-30秒 |
| 提取句段 | "正在提取说明书相关内容..." | 1-5秒 |
| AI处理 | "正在AI智能匹配..." | 10-60秒 |

## 涉及文件

1. `backend/routes/drawing_marker.py` - 新增分阶段处理API
2. `backend/utils/text_segment_extractor.py` - 新增文本段提取工具
3. `frontend/index.html` - 修改前端处理流程和状态显示