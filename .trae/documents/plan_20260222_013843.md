# 功能二与功能三合并实施计划

## 一、文件结构规划

### 新建模块目录结构
```
js/modules/unified-batch/
├── config.js              (~50行) - 配置常量
├── router.js              (~80行) - 智能路由模块
├── input-handler.js       (~200行) - 统一输入处理
├── template-manager.js    (~250行) - 统一模板管理
├── engines/
│   ├── async-engine.js    (~300行) - 小批量异步引擎
│   └── batch-engine.js    (~350行) - 大批量延时引擎
├── output-handler.js      (~150行) - 统一输出处理
├── state.js               (~100行) - 状态管理
└── index.js               (~100行) - 模块入口
```

### 新建HTML组件
```
frontend/components/tabs/unified-batch.html  (~250行) - 统一批量处理界面
```

### 需要修改的文件
1. `js/state.js` - 添加统一批量处理状态
2. `js/main.js` - 更新初始化逻辑
3. `frontend/components/tab-navigation.html` - 更新导航标签

### 保留但不修改的文件（向后兼容）
1. `js/asyncBatch.js` - 标记为deprecated
2. `js/largeBatch.js` - 标记为deprecated
3. `frontend/components/tabs/async-batch.html` - 保留
4. `frontend/components/tabs/large-batch.html` - 保留

---

## 二、实施步骤

### 阶段1：创建基础模块（预计创建 ~580 行代码）
1. 创建 `js/modules/unified-batch/config.js` - 配置常量
2. 创建 `js/modules/unified-batch/state.js` - 状态管理
3. 创建 `js/modules/unified-batch/router.js` - 智能路由

### 阶段2：创建核心处理模块（预计创建 ~900 行代码）
4. 创建 `js/modules/unified-batch/input-handler.js` - 输入处理
5. 创建 `js/modules/unified-batch/template-manager.js` - 模板管理
6. 创建 `js/modules/unified-batch/output-handler.js` - 输出处理

### 阶段3：创建处理引擎（预计创建 ~650 行代码）
7. 创建 `js/modules/unified-batch/engines/async-engine.js`
8. 创建 `js/modules/unified-batch/engines/batch-engine.js`

### 阶段4：创建入口和UI（预计创建 ~350 行代码）
9. 创建 `js/modules/unified-batch/index.js` - 模块入口
10. 创建 `frontend/components/tabs/unified-batch.html` - 统一界面

### 阶段5：集成和测试
11. 修改 `js/state.js` - 添加新状态结构
12. 修改 `js/main.js` - 添加新模块初始化
13. 修改 `frontend/components/tab-navigation.html` - 添加新标签

---

## 三、关键设计决策

### 1. 智能路由阈值
- 默认阈值：50条
- 用户可手动切换模式

### 2. 状态结构
```javascript
unifiedBatch: {
    mode: 'auto',           // 'auto' | 'async' | 'batch'
    inputs: [],
    template: {...},
    taskState: {...},
    results: []
}
```

### 3. 向后兼容策略
- 保留原有文件和功能
- 新功能作为独立模块添加
- 用户可选择使用新界面或旧界面

---

## 四、风险评估

| 风险 | 影响 | 缓解措施 |
|-----|-----|---------|
| 状态冲突 | 中 | 使用独立的状态命名空间 |
| 样式冲突 | 低 | 使用统一的CSS类名前缀 |
| API兼容 | 低 | 复用现有API端点 |
| DOM ID冲突 | 中 | 使用新的ID前缀 `unified_` |

---

## 五、预计工作量

- 新建文件：11个
- 新增代码：约2480行
- 修改文件：3个
- 修改代码：约100行
- 预计时间：1-2天