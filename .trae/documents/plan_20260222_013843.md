# 功能二与功能三合并实施计划

## 核心变更

### 标签页合并方案
- **合并后名称**: "文本批量智能分析"
- **合并前**: 功能二（小批量异步）+ 功能三（大批量延时）两个独立标签页
- **合并后**: 单一统一标签页，根据数据量自动适配处理模式

---

## 一、两种模式的进度显示差异

### 小批量异步模式进度
- **显示方式**: 实时表格，每行一个请求
- **轮询频率**: 5秒/次
- **状态粒度**: 每个请求独立状态（排队中/处理中/成功/失败/重试中）
- **进度信息**: "已成功 X / 总数 Y"
- **支持操作**: 中途导出、停止轮询、恢复任务

### 大批量延时模式进度
- **显示方式**: 整体进度条 + 日志面板
- **轮询频率**: 60秒/次
- **状态粒度**: Batch任务整体状态（pending/running/completed/failed）
- **进度信息**: "进度: 已完成 X / 总数 Y (成功: X, 失败: Y)"
- **支持操作**: 手动检查状态、停止自动检查、恢复Batch ID

---

## 二、文件结构规划

### 新建模块目录结构
```
js/modules/unified-batch/
├── config.js              (~50行) - 配置常量（阈值、轮询间隔等）
├── router.js              (~80行) - 智能路由模块
├── input-handler.js       (~200行) - 统一输入处理
├── template-manager.js    (~250行) - 统一模板管理
├── engines/
│   ├── async-engine.js    (~300行) - 小批量异步引擎（含实时表格进度）
│   └── batch-engine.js    (~350行) - 大批量延时引擎（含整体进度条）
├── output-handler.js      (~150行) - 统一输出处理
├── state.js               (~100行) - 状态管理
└── index.js               (~100行) - 模块入口
```

### 新建HTML组件
```
frontend/components/tabs/unified-batch.html  (~350行)
```

### 需要修改的文件
1. `js/state.js` - 更新状态结构
2. `js/main.js` - 更新初始化逻辑
3. `frontend/components/tab-navigation.html` - 更新导航标签

### 将被移除的文件
- `js/asyncBatch.js`
- `js/largeBatch.js`
- `js/modules/init/init-async-batch.js`
- `js/modules/init/init-large-batch.js`
- `js/modules/large-batch/` 目录
- `frontend/components/tabs/async-batch.html`
- `frontend/components/tabs/large-batch.html`

---

## 三、统一界面设计

### 步骤流程
```
步骤1: 输入数据
步骤2: 配置模板
步骤3: 选择处理模式（智能推荐 + 手动切换）
步骤4: 处理与结果（根据模式显示不同进度UI）
```

### 进度UI区分
```
小批量异步模式:
┌────────────────────────────────────────────┐
│ 进度: 已成功 15 / 20                        │
│ [停止轮询] [导出当前结果]                    │
├────────────────────────────────────────────┤
│ 表格: 请求ID | 输入预览 | 状态 | 结果        │
│       req-1  | xxx...   | 成功 | {...}      │
│       req-2  | xxx...   | 处理中 | -        │
└────────────────────────────────────────────┘

大批量延时模式:
┌────────────────────────────────────────────┐
│ Batch ID: xxx-xxx-xxx                       │
│ 状态: RUNNING | 进度: 45/100 (成功:45,失败:0)│
│ [████████░░░░░░░░░░] 45%                    │
│ [手动检查] [停止自动检查]                    │
├────────────────────────────────────────────┤
│ 执行日志:                                    │
│ [10:30:01] 任务状态: RUNNING                 │
│ [10:31:01] 进度: 45/100                     │
└────────────────────────────────────────────┘
```

---

## 四、实施步骤

### 阶段1：创建基础模块
1. 创建 `config.js` - 配置常量
2. 创建 `state.js` - 状态管理
3. 创建 `router.js` - 智能路由

### 阶段2：创建核心处理模块
4. 创建 `input-handler.js`
5. 创建 `template-manager.js`
6. 创建 `output-handler.js`

### 阶段3：创建处理引擎（区分进度显示）
7. 创建 `engines/async-engine.js` - 实时表格进度
8. 创建 `engines/batch-engine.js` - 整体进度条+日志

### 阶段4：创建入口和UI
9. 创建 `index.js`
10. 创建 `unified-batch.html`

### 阶段5：集成和清理
11. 修改 `tab-navigation.html`
12. 修改 `state.js`
13. 修改 `main.js`
14. 删除旧文件

---

## 五、预计工作量

- 新建文件：10个（约2480行代码）
- 修改文件：3个（约150行修改）
- 删除文件：7个
- 预计时间：1-2天