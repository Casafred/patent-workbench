## 功能六增强改进计划

### 需求分析
用户提出了三个主要改进点：
1. **批量爬取缓存机制** - 避免重复爬取，提示用户使用缓存数据
2. **自动批量解读开关** - 爬取完成后自动进入解读模式
3. **实时加载显示** - 爬取和解读结果边获取边显示

---

### 改动点 ①：批量爬取缓存机制

**目标**：对已爬取的专利进行缓存，避免重复爬取

**实现方案**：

1. **缓存存储结构**（使用 localStorage）
   ```javascript
   // 缓存键: patent_cache_{patentNumber}
   // 缓存值: {
   //   patentNumber: "CN123456789A",
   //   data: { ...专利数据... },
   //   timestamp: 1707654321000, // 缓存时间戳
   //   selectedFields: [...] // 当时选择的字段
   // }
   ```

2. **缓存检查逻辑**（修改 `performPatentSearch` 函数）
   - 在爬取前检查每个专利号是否有缓存
   - 如果有缓存，弹窗提示用户：
     - 显示缓存时间（如："该专利数据缓存于 2024-01-15 14:30"）
     - 提供"使用缓存"和"重新爬取"两个选项
   - 如果缓存超过30天，提示"缓存数据较旧"

3. **缓存保存逻辑**
   - 爬取成功后自动保存到 localStorage
   - 设置缓存过期时间（如30天）

4. **UI 弹窗设计**
   - 创建 `CacheConfirmModal` 组件
   - 显示专利号、缓存时间、使用/重新爬取按钮

---

### 改动点 ②：自动批量解读开关

**目标**：添加一个开关，开启后爬取完毕自动进入解读

**实现方案**：

1. **UI 添加开关**（修改 `patent-batch.html`）
   - 在"批量查询专利"按钮旁边添加切换开关
   - 开关文字："自动批量解读"
   - 默认状态：开启（根据用户需求）

2. **状态管理**（修改 `state.js`）
   ```javascript
   patentBatch: {
       // ... 现有字段
       autoAnalyze: true, // 新增：自动解读开关状态
   }
   ```

3. **自动触发逻辑**（修改 `main.js` 中的 `performPatentSearch`）
   - 爬取完成后检查 `autoAnalyze` 状态
   - 如果为 true，自动调用 `analyzeAllBtn.click()`
   - 添加状态提示："爬取完成，自动开始解读..."

---

### 改动点 ③：实时加载显示

**目标**：爬取和解读结果实时显示，无需等待全部完成

**实现方案**：

1. **后端 API 修改**（`backend/routes/patent.py`）
   - 修改 `/patent/search` 接口支持流式返回
   - 或使用 WebSocket 实时推送每个专利的爬取结果
   - 保持原有批量接口兼容性

2. **前端实时爬取显示**（修改 `main.js`）
   - 修改 `performPatentSearch` 函数：
     - 改为串行处理（一个完成再处理下一个）
     - 每个专利爬取完成后立即调用 `displayPatentResult` 显示
     - 保持用户输入顺序（使用索引控制）
   - 添加进度显示："正在爬取第 3/10 个专利..."

3. **前端实时解读显示**（修改 `main.js` 中的解读逻辑）
   - 修改 `analyzeAllBtn` 点击事件：
     - 改为串行处理（一个完成再处理下一个）
     - 每个专利解读完成后立即更新对应位置的占位符
     - 保持用户输入顺序

4. **UI 优化**
   - 添加加载动画/进度条
   - 每个专利条目显示独立的状态（爬取中/解读中/完成）

---

### 文件修改清单

| 文件路径 | 修改内容 |
|---------|---------|
| `js/main.js` | 核心逻辑修改：缓存检查、自动解读、实时显示 |
| `js/state.js` | 添加 `autoAnalyze` 状态字段 |
| `frontend/components/tabs/patent-batch.html` | 添加自动解读开关UI |
| `frontend/css/components/patent-config.css` | 添加开关样式、缓存提示样式 |
| `backend/routes/patent.py` | （可选）流式API支持 |

---

### 实施顺序建议

1. **第一步**：实现缓存机制（改动点①）
   - 风险低，独立功能
   - 用户可以立即受益

2. **第二步**：实现自动解读开关（改动点②）
   - 依赖第一步的缓存机制
   - 简单的UI+逻辑绑定

3. **第三步**：实现实时显示（改动点③）
   - 改动较大，需要仔细测试
   - 涉及前后端协调

---

### 注意事项

1. **缓存清理**：定期清理过期缓存，避免 localStorage 溢出
2. **错误处理**：实时显示模式下，单个专利失败不应影响其他专利
3. **取消功能**：考虑添加"取消"按钮，允许用户中断批量操作
4. **性能优化**：大量专利时，注意DOM渲染性能