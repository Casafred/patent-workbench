## PDF查看器交互功能实现方案

基于您的需求，我将实现以下功能：

### 一、划词选中功能

**实现方式：**
1. 在PDF渲染的canvas/图片上添加透明的文本选择层
2. 监听鼠标拖拽事件，计算选中的坐标范围
3. 根据OCR结果的区块坐标，判断选中了哪些内容
4. 支持跨区块选中多个文本块

**技术方案：**
- 创建一个透明的 `selection-layer` 覆盖在PDF渲染层之上
- 使用 `mousedown`/`mousemove`/`mouseup` 事件跟踪选择区域
- 通过坐标比对找出被选中的OCR区块
- 显示高亮覆盖层表示选中区域

### 二、悬浮工具栏

**实现方式：**
1. 选中内容后，在选中区域上方/下方弹出工具栏
2. 工具栏包含：复制、翻译、对话、引用 四个按钮
3. 工具栏自动定位，避免超出视口

**UI设计：**
```
┌─────────────────────────┐
│ 📋复制  🌐翻译  💬对话  📎引用 │
└─────────────────────────┘
```

### 三、悬浮对话窗口

**实现方式：**
1. 点击"对话"按钮后弹出可拖动的悬浮窗口
2. 窗口包含：标题栏（可拖动）、对话历史、输入框、发送按钮
3. 自动携带选中的文本作为上下文
4. 支持最小化、关闭、调整大小

**窗口结构：**
```
┌─────────────────────────────┐
│ 💬 AI对话              ─ □ ✕ │  ← 可拖动标题栏
├─────────────────────────────┤
│ 🤖 我是AI助手，请问有什么... │  ← 对话历史区
│ 👤 请解释这段内容           │
│ 🤖 这段内容的意思是...      │
├─────────────────────────────┤
│ [选中的内容摘要...]         │  ← 上下文提示
├─────────────────────────────┤
│ [输入您的问题...        ] [发送]│ ← 输入区
└─────────────────────────────┘
```

### 四、OCR区块点击交互

**现有功能增强：**
1. 点击区块显示更丰富的右键菜单
2. 添加"添加到对话"选项
3. 支持多选（Ctrl+点击）多个区块
4. 显示区块详细信息卡片

### 五、具体实现步骤

#### 1. 创建 `pdf-ocr-selection.js` 新模块
- 处理划词选中逻辑
- 计算选中区域与OCR区块的交集
- 管理选中状态

#### 2. 创建 `pdf-ocr-floating-toolbar.js` 新模块
- 渲染悬浮工具栏
- 处理工具栏按钮点击事件
- 自动定位逻辑

#### 3. 创建 `pdf-ocr-floating-chat.js` 新模块
- 渲染悬浮对话窗口
- 实现拖动功能
- 管理对话历史
- 与AI API集成

#### 4. 修改 `pdf-ocr-viewer.js`
- 集成新的选择功能
- 增强区块点击交互
- 添加多选支持

#### 5. 修改 `pdf-ocr-reader.html`
- 添加选择层容器
- 添加悬浮工具栏模板
- 添加悬浮对话窗口模板

#### 6. 添加CSS样式
- 选中高亮样式
- 工具栏样式
- 悬浮窗口样式

### 六、交互流程图

```
用户打开PDF
    │
    ├── 方式1: 划词选中 ──► 显示悬浮工具栏 ──► 选择操作
    │                           ├── 复制 ► 复制到剪贴板
    │                           ├── 翻译 ► 显示翻译结果
    │                           ├── 对话 ► 打开悬浮对话窗口
    │                           └── 引用 ► 添加到引用列表
    │
    └── 方式2: 点击区块 ──► 显示右键菜单 ──► 选择操作
                                ├── 复制
                                ├── 翻译
                                ├── 对话
                                └── 多选
```

### 七、新增文件清单

1. **js/modules/pdf-ocr/pdf-ocr-selection.js** - 划词选中功能
2. **js/modules/pdf-ocr/pdf-ocr-floating-toolbar.js** - 悬浮工具栏
3. **js/modules/pdf-ocr/pdf-ocr-floating-chat.js** - 悬浮对话窗口
4. **frontend/css/components/pdf-ocr-interaction.css** - 交互样式

### 八、修改文件清单

1. **js/modules/pdf-ocr/pdf-ocr-viewer.js** - 集成选择功能
2. **js/modules/pdf-ocr/pdf-ocr-init.js** - 初始化新模块
3. **frontend/components/tabs/pdf-ocr-reader.html** - 添加新UI元素

### 九、预期效果

1. ✅ 在PDF查看器上可以自由划词选中任意内容
2. ✅ 选中后自动弹出工具栏，一键复制/翻译/对话
3. ✅ 悬浮对话窗口可拖动，不影响PDF阅读
4. ✅ 点击OCR区块也能进行同样操作
5. ✅ 对话自动携带选中内容作为上下文

请确认此方案后，我将开始实施具体的代码实现。