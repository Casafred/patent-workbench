## 调研结果总结

### 一、智谱服务文件上传解析功能失败原因分析

经过代码分析，发现当前实现存在以下问题：

**核心问题：文件解析服务仅支持智谱API Key**

查看 `backend/routes/file_parser.py` 和 `backend/services/file_parser_service.py`：
- `FileParserService` 类硬编码使用智谱AI的文件解析API (`https://open.bigmodel.cn/api/paas/v4`)
- 当用户切换到阿里云服务时，前端传递的是阿里云API Key，但后端仍然调用智谱的文件解析接口
- 这导致使用阿里云服务时文件解析必然失败

**解决方案**：
1. 当选择阿里云服务时，禁用文件上传功能或提示用户切换到智谱服务
2. 或者集成阿里云的文件解析服务

---

### 二、阿里云文件解析服务调研结果

**阿里云百炼确实提供文件解析服务：DashScopeParse**

- 支持格式：`.doc`, `.docx`, `.pdf`
- 文件大小限制：100MB以内
- 页数限制：1000页以内
- 需要通过 LlamaIndex 框架使用
- 文档地址：https://help.aliyun.com/zh/model-studio/build-rag-applications-based-on-llamaindex

**与智谱的区别**：
- 智谱：独立API接口，直接调用，支持更多格式（包括图片）
- 阿里云：需要通过LlamaIndex框架，主要用于RAG场景，格式支持较少

---

### 三、阿里云联网搜索功能配置

**阿里云支持两种联网搜索方式**：

1. **enable_search 参数**（简单模式）
   - 在请求中设置 `extra_body["enable_search"] = True`
   - 模型会利用互联网信息丰富生成内容
   - 不会完全依赖或返回搜索结果

2. **夸克搜索插件**（完整模式）
   - 工具ID：`quark_search`
   - 返回网页标题、关键词和摘要
   - 需要在百炼控制台开通

**当前代码已部分支持**：
- `backend/services/llm_service.py` 的 `build_aliyun_request_params` 已有 `enable_search` 参数
- `backend/services/llm/aliyun_provider.py` 的 `_build_extra_body` 已实现
- 但前端UI没有阿里云联网搜索的配置入口

---

## 实施计划

### 任务1：修复智谱文件解析问题
- 在前端 `chat-file-handler.js` 中添加服务商检测
- 当使用阿里云服务时，禁用文件上传按钮并显示提示
- 提示用户"文件解析功能仅支持智谱AI服务"

### 任务2：添加阿里云联网搜索配置
- 修改 `chat-search.js`，根据当前服务商显示不同的配置选项
- 阿里云服务下显示：
  - enable_search 开关（简单联网搜索）
  - 搜索引擎选项可以隐藏或显示"阿里云联网搜索"
- 修改 `chat.py` 后端，确保阿里云请求正确传递 `enable_search` 参数

### 任务3：（可选）集成阿里云文件解析
- 需要安装额外依赖 `llama-index-readers-dashscope`
- 创建新的阿里云文件解析服务类
- 此任务较复杂，建议作为后续优化