# 功能八OCR诊断工具使用说明

## 问题描述

当功能八显示"识别出 0 个数字序号，匹配率 0%"时，说明OCR没有识别到任何内容。

## 诊断工具

我们提供了两种诊断工具来帮助你找出问题所在：

### 方法1: Web诊断工具（推荐）

**文件:** `test_drawing_marker_debug.html`

**使用步骤:**

1. 启动应用：
   ```bash
   python run_app.py
   ```

2. 在浏览器中打开诊断工具：
   ```
   http://localhost:5000/test_drawing_marker_debug.html
   ```

3. 按照页面提示操作：
   - **步骤1:** 上传专利附图
   - **步骤2:** 输入说明书内容，点击"测试说明书解析"
   - **步骤3:** 点击"开始完整测试"

4. 查看诊断结果：
   - ✅ 绿色：成功
   - ❌ 红色：失败
   - ⚠️ 黄色：警告
   - 💡 蓝色：提示

**优点:**
- 可视化界面，操作简单
- 实时查看每个步骤的结果
- 直接调用后端API，结果准确

### 方法2: 命令行诊断工具

**文件:** `test_drawing_marker_ocr.py`

**使用步骤:**

1. 准备测试图片和说明书文本

2. 运行诊断脚本：
   ```bash
   python test_drawing_marker_ocr.py <图片路径> "<说明书文本>"
   ```

   **示例:**
   ```bash
   python test_drawing_marker_ocr.py test.png "1电动工具、2外壳、2L左侧外壳、2R右侧外壳、3后盖"
   ```

3. 查看诊断结果：
   - 步骤1: 检查Tesseract是否安装
   - 步骤2: 测试说明书解析
   - 步骤3: 测试图片加载
   - 步骤4: 测试图像预处理
   - 步骤5: 测试OCR识别
   - 步骤6: 测试匹配

4. 查看预处理图片：
   - 诊断工具会在 `ocr_debug_output/` 目录生成预处理后的图片
   - 可以查看这些图片来判断预处理效果

**优点:**
- 详细的步骤输出
- 生成预处理图片供查看
- 可以离线测试（不需要启动服务器）

## 常见问题诊断

### 问题1: 说明书解析失败（提取到0个标记）

**症状:**
```
❌ 未能提取到任何附图标记
```

**原因:**
- 说明书格式不正确

**解决方法:**
1. 检查说明书格式，确保使用支持的格式：
   - ✅ `1电动工具、2外壳、3后盖`
   - ✅ `1…电动工具、2…外壳、3…后盖`
   - ✅ `1. 电动工具\n2. 外壳\n3. 后盖`
   - ❌ `一、电动工具` (不支持中文数字)

2. 使用测试脚本验证：
   ```bash
   python test_drawing_marker_parser.py
   ```

### 问题2: OCR识别失败（识别到0个文本）

**症状:**
```
❌ 所有方法都未能识别到文本
```

**可能原因:**

1. **Tesseract未安装或配置错误**
   
   **检查方法:**
   ```bash
   tesseract --version
   ```
   
   **解决方法:**
   - Windows: 下载安装 https://github.com/UB-Mannheim/tesseract/wiki
   - 安装后添加到系统PATH
   - 或在代码中设置路径：
     ```python
     pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'
     ```

2. **图片质量太差**
   
   **检查方法:**
   - 查看 `ocr_debug_output/` 目录中的预处理图片
   - 如果预处理后的图片中数字仍然不清晰，说明原图质量太差
   
   **解决方法:**
   - 使用更高分辨率的图片
   - 确保图片清晰，数字清晰可见
   - 增强图片对比度

3. **数字与背景对比度不足**
   
   **检查方法:**
   - 查看预处理图片，数字应该是黑色或白色，背景是相反的颜色
   
   **解决方法:**
   - 调整图片对比度
   - 使用图像编辑软件增强对比度

4. **数字太小**
   
   **解决方法:**
   - 放大图片
   - 裁剪出包含数字的区域

### 问题3: 匹配失败（识别到文本但匹配率为0%）

**症状:**
```
✅ 识别到 X 个文本
❌ 没有任何匹配！
```

**原因:**
- OCR识别的文本与说明书中的编号不一致

**检查方法:**
1. 查看OCR识别到的文本
2. 查看说明书中的编号
3. 对比两者是否一致

**示例:**
```
OCR识别: ['1', '2', '3', 'L', 'R']
说明书编号: ['1', '2', '2L', '2R', '3']
问题: OCR将 '2L' 识别成了 '2' 和 'L' 两个独立的文本
```

**解决方法:**
1. 提高图片质量，让数字和字母更紧密
2. 调整OCR配置
3. 手动编辑识别结果

## 调试日志

后端会输出详细的调试日志，启动应用后查看控制台输出：

```
[DEBUG] 从说明书中提取到 41 个附图标记
[DEBUG] 附图标记映射: {'1': '电动工具', '2': '外壳', ...}
[DEBUG] 图片 drawing1.png OCR识别到 15 个数字/标记
  - 1 (置信度: 95%)
  - 2 (置信度: 87%)
  - 2L (置信度: 82%)
  ...
```

**关键信息:**
- 提取到的附图标记数量
- OCR识别到的数字/标记数量
- 每个识别结果的置信度

## 优化建议

### 1. 图片质量优化

**推荐设置:**
- 分辨率: ≥ 1000px
- 格式: PNG（无损压缩）
- 对比度: 高
- 清晰度: 清晰，无模糊

**不推荐:**
- 低分辨率图片（< 500px）
- 过度压缩的JPEG
- 模糊或失焦的图片
- 对比度低的图片

### 2. 说明书格式优化

**推荐格式:**
```
1电动工具、2外壳、2L左侧外壳、2R右侧外壳、3后盖、3S螺钉
```

**也支持:**
```
1…电动工具、2…外壳、2L…左侧外壳
```

```
1. 电动工具
2. 外壳
2L. 左侧外壳
```

### 3. OCR配置优化

如果默认配置识别率低，可以尝试调整：

**在 `backend/routes/drawing_marker.py` 中:**

```python
# 当前配置
custom_config = r'--oem 3 --psm 6 -c tessedit_char_whitelist=0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'

# 可以尝试的其他配置
# PSM 模式:
# --psm 6: 假设单个文本块
# --psm 11: 稀疏文本
# --psm 13: 原始行

# 置信度阈值:
# 当前: > 50
# 可以降低到: > 30 (会识别更多，但可能有误识别)
```

## 测试用例

### 测试用例1: 基本功能测试

**图片:** 清晰的专利附图，包含数字 1、2、3

**说明书:**
```
1电动工具、2外壳、3后盖
```

**预期结果:**
- 说明书解析: 提取到 3 个标记
- OCR识别: 识别到 3 个数字
- 匹配率: 100%

### 测试用例2: 带字母编号测试

**图片:** 包含 1、2、2L、2R、3

**说明书:**
```
1电动工具、2外壳、2L左侧外壳、2R右侧外壳、3后盖
```

**预期结果:**
- 说明书解析: 提取到 5 个标记
- OCR识别: 识别到 5 个标记
- 匹配率: 100%

### 测试用例3: 省略号格式测试

**说明书:**
```
1…电动工具、2…外壳、2L…左侧外壳
```

**预期结果:**
- 说明书解析: 提取到 3 个标记
- 标记名称中不包含省略号

## 联系支持

如果使用诊断工具后仍然无法解决问题，请提供以下信息：

1. 诊断工具的完整输出
2. 测试图片（如果可以分享）
3. 说明书内容
4. `ocr_debug_output/` 目录中的预处理图片
5. 后端控制台的调试日志

---

**文档版本:** v1.0.0  
**更新日期:** 2026-01-25
