# 功能八 v6.3 大字号 + 边界限制

## 🎯 优化内容

### 1. 默认字号增大5倍

**需求**：默认标注字体要比现在的大五倍

**实现**：默认字号从 24px 增大到 120px

#### 修改详情

```javascript
// 修改前 (v6.2)
fontSize: options.fontSize || 24

// 修改后 (v6.3)
fontSize: options.fontSize || 120  // 5倍大小
```

#### 效果对比

| 版本 | 默认字号 | 倍数 | 效果 |
|------|:--------:|:----:|:----:|
| v6.1 | 18px | 1.0x | 较小 |
| v6.2 | 24px | 1.3x | 一般 |
| v6.3 | 120px | 6.7x | 超大 ✅ |

#### 视觉效果

- ✅ 标注文字非常醒目
- ✅ 远距离也能清晰看到
- ✅ 适合大尺寸专利附图
- ✅ 提升整体可读性

### 2. 添加标注边界限制

**需求**：拖拽标注框时，标注框的边缘不能超出原图的边缘，到边缘只会在边缘滑动

**实现**：添加边界检测和限制逻辑

#### 边界限制逻辑

```javascript
// 计算标注文字的宽度和高度
const text = `${annotation.number}: ${annotation.name}`;
const fontSize = annotation.fontSize || 120;
const textWidth = ctx.measureText(text).width;
const textHeight = fontSize * 1.5;

// 限制X坐标（左右边界）
newX = Math.max(0, Math.min(newX, originalWidth - textWidth));

// 限制Y坐标（上下边界）
newY = Math.max(textHeight/2, Math.min(newY, originalHeight - textHeight/2));
```

#### 边界规则

1. **左边界**：`labelX >= 0`
   - 标注左边缘不能超出图片左边缘

2. **右边界**：`labelX + textWidth <= originalWidth`
   - 标注右边缘不能超出图片右边缘

3. **上边界**：`labelY >= textHeight/2`
   - 标注上边缘不能超出图片上边缘

4. **下边界**：`labelY + textHeight/2 <= originalHeight`
   - 标注下边缘不能超出图片下边缘

#### 边缘滑动效果

当拖拽到边界时：
- ✅ 标注会沿着边缘滑动
- ✅ 不会超出图片范围
- ✅ 保持标注完全可见
- ✅ 主界面和弹窗都生效

## 🎨 使用体验

### 大字号效果

#### 场景1：大尺寸附图
- **v6.2**: 24px字号，需要放大才能看清
- **v6.3**: 120px字号，直接清晰可见 ✅

#### 场景2：远距离查看
- **v6.2**: 24px字号，需要靠近屏幕
- **v6.3**: 120px字号，远距离也能看清 ✅

#### 场景3：演示展示
- **v6.2**: 24px字号，投影不够清晰
- **v6.3**: 120px字号，投影效果极佳 ✅

### 边界限制效果

#### 场景1：拖拽到左边缘
```
拖拽前：标注在中间
拖拽中：标注向左移动
到达边界：标注停在左边缘，继续拖拽只能上下滑动
```

#### 场景2：拖拽到右上角
```
拖拽前：标注在中间
拖拽中：标注向右上移动
到达边界：标注停在右上角，不能再移动
```

#### 场景3：拖拽超长标注
```
标注文字很长：自动限制在图片宽度内
拖拽时：始终保持完整显示
不会：部分文字超出图片
```

## 🔧 技术实现

### 边界检测算法

```javascript
function constrainToBounds(x, y, textWidth, textHeight, imageWidth, imageHeight) {
    // 计算允许的X坐标范围
    const minX = 0;
    const maxX = imageWidth - textWidth;
    
    // 计算允许的Y坐标范围
    const minY = textHeight / 2;
    const maxY = imageHeight - textHeight / 2;
    
    // 限制坐标
    const constrainedX = Math.max(minX, Math.min(x, maxX));
    const constrainedY = Math.max(minY, Math.min(y, maxY));
    
    return { x: constrainedX, y: constrainedY };
}
```

### 实时计算

每次拖拽时：
1. 计算标注文字的实际宽度（考虑字号）
2. 计算标注文字的实际高度（考虑字号）
3. 根据图片尺寸计算边界
4. 限制标注位置在边界内

### 动态适应

- ✅ 不同字号自动适应
- ✅ 不同文字长度自动适应
- ✅ 不同图片尺寸自动适应
- ✅ 主界面和弹窗都适应

## 📊 对比测试

### 字号对比

| 测试项 | v6.2 (24px) | v6.3 (120px) | 提升 |
|--------|:-----------:|:------------:|:----:|
| 可读性 | 一般 | 优秀 | ⬆️⬆️⬆️ |
| 醒目度 | 一般 | 极佳 | ⬆️⬆️⬆️ |
| 远距离 | 困难 | 清晰 | ⬆️⬆️⬆️ |
| 演示效果 | 一般 | 优秀 | ⬆️⬆️⬆️ |

### 边界限制对比

| 测试项 | v6.2 | v6.3 | 改进 |
|--------|:----:|:----:|:----:|
| 左边界 | ❌ 可超出 | ✅ 限制 | 修复 |
| 右边界 | ❌ 可超出 | ✅ 限制 | 修复 |
| 上边界 | ❌ 可超出 | ✅ 限制 | 修复 |
| 下边界 | ❌ 可超出 | ✅ 限制 | 修复 |
| 边缘滑动 | ❌ 无 | ✅ 有 | 新增 |

## 📋 测试清单

### 大字号测试
- [ ] 新标注默认120px，非常醒目
- [ ] 远距离查看，标注清晰可见
- [ ] 缩小视图，标注仍然可读
- [ ] 多个标注，不会过于拥挤
- [ ] 字号调整按钮正常工作

### 边界限制测试

#### 左边界
- [ ] 拖拽标注到左边缘
- [ ] 标注左边不超出图片
- [ ] 继续向左拖，标注不动或上下滑动

#### 右边界
- [ ] 拖拽标注到右边缘
- [ ] 标注右边不超出图片
- [ ] 继续向右拖，标注不动或上下滑动

#### 上边界
- [ ] 拖拽标注到上边缘
- [ ] 标注上边不超出图片
- [ ] 继续向上拖，标注不动或左右滑动

#### 下边界
- [ ] 拖拽标注到下边缘
- [ ] 标注下边不超出图片
- [ ] 继续向下拖，标注不动或左右滑动

#### 角落测试
- [ ] 拖拽到左上角，标注完全在图内
- [ ] 拖拽到右上角，标注完全在图内
- [ ] 拖拽到左下角，标注完全在图内
- [ ] 拖拽到右下角，标注完全在图内

#### 弹窗测试
- [ ] 弹窗中边界限制正常
- [ ] 弹窗中拖拽到边缘，标注不超出
- [ ] 弹窗修改同步到主界面

## 💡 使用建议

### 字号调整建议

1. **默认使用**
   - 120px适合大多数专利附图
   - 标注清晰醒目

2. **需要缩小**
   - 标注很多时：减小到60-80px
   - 图片较小时：减小到40-60px

3. **需要放大**
   - 演示展示时：保持120px或更大
   - 重要标注：单独放大到150px+

### 边界处理建议

1. **避免边缘**
   - 尽量将标注放在图片中央区域
   - 边缘位置可能被裁剪

2. **利用边界**
   - 需要整齐排列时，可以靠边对齐
   - 边界限制确保不会超出

3. **长文字处理**
   - 文字太长会自动限制在图片宽度内
   - 考虑缩短标注名称
   - 或减小字号

## 🚀 部署步骤

### 1. 服务器部署
```bash
ssh root@47.115.230.206
cd /www/wwwroot/ipx.asia
git pull origin main
sudo systemctl restart patent_app
sudo systemctl reload nginx
```

### 2. 验证部署
```bash
git log --oneline -1
# 应该显示: 6e0f6c9 功能八v6.3: 默认字号增大5倍(24→120px) + 添加标注边界限制
```

### 3. 清除缓存
- Ctrl + Shift + Delete
- Ctrl + F5

## 🎯 验证方法

### 验证大字号

1. **上传新图片**
   - OCR识别
   - 观察标注字号
   - 应该非常大

2. **对比测试**
   - v6.2: 24px（小）
   - v6.3: 120px（超大）✅

### 验证边界限制

1. **拖拽到左边**
   - 标注不超出左边缘 ✅
   - 到边缘后只能上下滑动 ✅

2. **拖拽到右边**
   - 标注不超出右边缘 ✅
   - 到边缘后只能上下滑动 ✅

3. **拖拽到上边**
   - 标注不超出上边缘 ✅
   - 到边缘后只能左右滑动 ✅

4. **拖拽到下边**
   - 标注不超出下边缘 ✅
   - 到边缘后只能左右滑动 ✅

## 🎉 总结

v6.3版本带来两个重要改进：

### 1. 超大字号
- ✅ 默认120px（5倍于v6.2）
- ✅ 标注超级醒目
- ✅ 远距离清晰可见
- ✅ 演示效果极佳

### 2. 边界限制
- ✅ 标注不会超出图片
- ✅ 边缘滑动效果
- ✅ 保持标注完全可见
- ✅ 主界面和弹窗都生效

### 核心价值
1. **可读性提升**: 字号增大5倍
2. **专业性提升**: 标注不超出边界
3. **用户体验**: 拖拽更智能
4. **适用场景**: 大尺寸附图、演示展示

---

**版本**: v6.3  
**提交**: 6e0f6c9  
**日期**: 2026-01-31  
**状态**: ✅ 已完成并推送
