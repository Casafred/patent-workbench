# 功能八问题综合解决方案 🔧

## 📋 当前问题清单

### 1. OCR识别返回0结果 ❌
- **症状**: 识别出 0 个数字序号，匹配率 0%
- **状态**: 代码已修复，但可能未部署到服务器
- **优先级**: 🔴 最高

### 2. Gunicorn代码缓存问题 ⚠️
- **症状**: 更新代码后服务仍使用旧代码
- **原因**: preload_app机制导致worker进程缓存
- **优先级**: 🔴 最高

### 3. 图片质量和识别率问题 📊
- **症状**: 即使OCR正常，识别率仍然较低
- **原因**: 图片预处理不足、参数未优化
- **优先级**: 🟡 中等

### 4. 超时和性能问题 ⏱️
- **症状**: 处理大图片时超时
- **原因**: 超时设置过短、内存不足
- **优先级**: 🟡 中等

## 🚀 一键修复方案

### 方案A: 完全重启服务（推荐）⭐⭐⭐⭐⭐

这是最可靠的方法，确保所有代码更新生效：

```bash
# 1. 完全停止服务
ssh root@43.99.101.195 "systemctl stop patent-app"

# 2. 强制杀死所有相关进程
ssh root@43.99.101.195 "pkill -9 -f 'gunicorn.*patent'"

# 3. 清除Python缓存
ssh root@43.99.101.195 "find /home/appuser/patent-app -name '*.pyc' -delete && find /home/appuser/patent-app -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true"

# 4. 拉取最新代码
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && git pull origin main'"

# 5. 确认依赖安装
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && source venv311/bin/activate && pip install rapidocr-onnxruntime opencv-python Pillow numpy'"

# 6. 启动服务
ssh root@43.99.101.195 "systemctl start patent-app"

# 7. 等待5秒
timeout /t 5

# 8. 验证服务状态
ssh root@43.99.101.195 "systemctl status patent-app --no-pager"

# 9. 查看日志
ssh root@43.99.101.195 "journalctl -u patent-app -n 20 --no-pager"
```

### 方案B: 快速修复脚本

创建一个批处理文件 `一键修复功能八.bat`:

```batch
@echo off
echo ========================================
echo 功能八OCR问题一键修复
echo ========================================
echo.

echo [1/9] 停止服务...
ssh root@43.99.101.195 "systemctl stop patent-app"
if errorlevel 1 (
    echo ❌ 停止服务失败
    pause
    exit /b 1
)
echo ✅ 服务已停止

echo.
echo [2/9] 清理进程...
ssh root@43.99.101.195 "pkill -9 -f 'gunicorn.*patent' 2>/dev/null || true"
echo ✅ 进程已清理

echo.
echo [3/9] 清除Python缓存...
ssh root@43.99.101.195 "find /home/appuser/patent-app -name '*.pyc' -delete 2>/dev/null || true"
ssh root@43.99.101.195 "find /home/appuser/patent-app -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true"
echo ✅ 缓存已清除

echo.
echo [4/9] 拉取最新代码...
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && git pull origin main'"
if errorlevel 1 (
    echo ⚠️ Git拉取失败，尝试强制更新...
    ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && git fetch --all && git reset --hard origin/main'"
)
echo ✅ 代码已更新

echo.
echo [5/9] 检查Python环境...
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && source venv311/bin/activate && python --version'"
echo ✅ Python环境正常

echo.
echo [6/9] 安装/更新依赖...
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && source venv311/bin/activate && pip install --upgrade rapidocr-onnxruntime opencv-python Pillow numpy'"
echo ✅ 依赖已更新

echo.
echo [7/9] 启动服务...
ssh root@43.99.101.195 "systemctl start patent-app"
timeout /t 5 /nobreak >nul
echo ✅ 服务已启动

echo.
echo [8/9] 验证服务状态...
ssh root@43.99.101.195 "systemctl status patent-app --no-pager | head -20"

echo.
echo [9/9] 查看最新日志...
ssh root@43.99.101.195 "journalctl -u patent-app -n 30 --no-pager"

echo.
echo ========================================
echo ✅ 修复完成！
echo ========================================
echo.
echo 下一步：
echo 1. 访问 http://43.99.101.195
echo 2. 进入功能八
echo 3. 上传测试图片
echo 4. 检查识别结果
echo.
pause
```

## 🧪 验证修复

### 1. 服务器端验证

```bash
# 检查服务状态
ssh root@43.99.101.195 "systemctl status patent-app | grep Active"
# 应该显示: Active: active (running)

# 检查Python版本
ssh root@43.99.101.195 "ps aux | grep python | grep gunicorn | head -1"
# 应该包含: python3.11

# 检查RapidOCR
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && source venv311/bin/activate && python -c \"from rapidocr_onnxruntime import RapidOCR; print(\\\"✅ RapidOCR OK\\\")\"'"

# 查看实时日志
ssh root@43.99.101.195 "journalctl -u patent-app -f"
```

### 2. 功能测试

1. **访问网站**: http://43.99.101.195
2. **登录系统**
3. **进入功能八**: "专利附图标记识别"
4. **上传测试图片**: 选择清晰的专利附图
5. **输入说明书**:
   ```
   1. 底座
   2. 旋转臂
   3. 夹紧装置
   10. 固定螺栓
   11. 连接件
   ```
6. **点击"开始识别"**
7. **检查结果**:
   - ✅ 识别出 > 0 个数字序号
   - ✅ 匹配率 > 0%
   - ✅ Canvas显示标注框
   - ✅ 显示置信度和部件名称

### 3. 日志验证

在日志中应该看到：

```
INFO:backend.utils.ocr_utils:Initializing RapidOCR engine...
INFO:backend.utils.ocr_utils:RapidOCR engine ready
INFO:backend.utils.ocr_utils:Starting OCR on image of size 800x600
INFO:backend.utils.ocr_utils:OCR completed in 3.45s
INFO:backend.utils.ocr_utils:OCR completed: 15 markers detected
[DEBUG] OCR detected 15 markers
[DEBUG] Detected numbers: ['1', '2', '3', '10', '11']
[DEBUG] After filtering: 15 detections remain
[DEBUG] Matched 5 numbers with reference_map
```

## 🔍 问题诊断

如果修复后仍有问题，按以下顺序诊断：

### 诊断1: 代码是否更新？

```bash
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && git log --oneline -1'"
```

应该看到最新的提交信息。

### 诊断2: 服务是否使用新代码？

```bash
# 查看进程启动时间
ssh root@43.99.101.195 "ps aux | grep gunicorn | grep patent"

# 查看服务重启时间
ssh root@43.99.101.195 "systemctl status patent-app | grep Active"
```

服务重启时间应该在代码更新之后。

### 诊断3: RapidOCR是否正常？

```bash
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && source venv311/bin/activate && python quick_ocr_test.py'"
```

应该显示所有检查通过。

### 诊断4: 图片是否有问题？

- 检查图片是否清晰
- 数字标记是否可见
- 对比度是否足够
- 尝试使用不同的测试图片

## 📊 性能优化建议

### 1. 图片预处理优化

如果识别率仍然较低，可以添加更多预处理：

```python
# 在 backend/utils/ocr_utils.py 的 perform_ocr() 中添加

# 增强对比度
gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8,8))
enhanced = clahe.apply(gray)

# 二值化
_, binary = cv2.threshold(enhanced, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)

# 使用增强后的图片进行OCR
result, elapse = ocr_engine(binary)
```

### 2. 降低置信度阈值

如果识别到标记但被过滤掉：

```python
# 在 backend/routes/drawing_marker.py 中
# 从 50 降低到 30
all_detected_numbers = filter_by_confidence(all_detected_numbers, min_confidence=30)
```

### 3. 增加超时时间

如果处理大图片超时：

```python
# 在 backend/routes/drawing_marker.py 中
# 从 60 增加到 120
all_detected_numbers = perform_ocr(image_data, timeout_seconds=120)
```

## 🔄 回滚方案

如果修复后出现新问题，可以快速回滚：

```bash
# 1. 查看提交历史
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && git log --oneline -5'"

# 2. 回滚到上一版本
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && git reset --hard HEAD^'"

# 3. 重启服务
ssh root@43.99.101.195 "systemctl restart patent-app"
```

## 📞 获取支持

如果问题仍未解决，收集以下信息：

```bash
# 1. 服务状态
ssh root@43.99.101.195 "systemctl status patent-app --no-pager" > service_status.txt

# 2. 最近日志
ssh root@43.99.101.195 "journalctl -u patent-app -n 100 --no-pager" > service_logs.txt

# 3. Python环境
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && source venv311/bin/activate && pip list'" > pip_list.txt

# 4. 进程信息
ssh root@43.99.101.195 "ps aux | grep python" > process_info.txt

# 5. Git状态
ssh root@43.99.101.195 "su - appuser -c 'cd ~/patent-app && git status && git log --oneline -5'" > git_status.txt
```

## ✅ 成功标志

修复成功后，你应该看到：

- ✅ 服务状态: Active (running)
- ✅ Python版本: 3.11
- ✅ RapidOCR: 可以导入
- ✅ OCR识别: > 0 个标记
- ✅ 匹配率: > 0%
- ✅ 日志: 无错误信息

---

**创建时间**: 2026-01-31
**版本**: 1.0
**状态**: 待执行
