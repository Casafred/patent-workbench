# 阿里云服务器回滚指南

## 第一步：找到项目目录

```bash
# SSH连接后，先找到项目位置
cd ~
ls -la

# 常见的项目路径：
# /www/wwwroot/patent_system
# /home/patent_system
# /opt/patent_system
# 或者搜索：
find / -name "app.py" -type f 2>/dev/null | grep patent
```

## 快速回滚步骤

### 方法1：回滚到上一个版本（最简单）

```bash
# 1. SSH连接到服务器
ssh root@你的服务器IP

# 2. 找到并进入项目目录（根据实际路径修改）
cd /www/wwwroot/patent_system  # 或其他实际路径

# 3. 查看当前状态
git status
git log --oneline -5

# 4. 回滚到上一个commit
git reset --hard HEAD~1

# 5. 重启服务
sudo systemctl restart patent_system

# 6. 验证服务状态
sudo systemctl status patent_system
```

### 方法2：回滚到指定版本（精确控制）

```bash
# 1. SSH连接到服务器
ssh root@你的服务器IP

# 2. 进入项目目录
cd /root/patent_system

# 3. 查看提交历史，找到你想回滚到的版本
git log --oneline -20
# 或者查看详细信息
git log -10

# 4. 复制你想回滚到的commit hash（例如：abc1234）

# 5. 回滚到指定版本
git reset --hard abc1234

# 6. 重启服务
sudo systemctl restart patent_system

# 7. 验证服务状态
sudo systemctl status patent_system
```

### 方法3：创建备份后回滚（最安全）

```bash
# 1. SSH连接到服务器
ssh root@你的服务器IP

# 2. 进入项目目录
cd /root/patent_system

# 3. 创建当前版本的备份分支
git branch backup-$(date +%Y%m%d-%H%M%S)

# 4. 查看提交历史
git log --oneline -20

# 5. 回滚到指定版本
git reset --hard [commit_hash]

# 6. 重启服务
sudo systemctl restart patent_system
```

## 常用Git回滚命令

### 查看历史
```bash
# 查看简洁的提交历史
git log --oneline -20

# 查看详细的提交历史
git log -10

# 查看某个文件的修改历史
git log --follow -- 文件路径

# 查看提交的详细内容
git show [commit_hash]
```

### 回滚操作
```bash
# 回滚到上一个版本
git reset --hard HEAD~1

# 回滚到上N个版本
git reset --hard HEAD~N

# 回滚到指定commit
git reset --hard [commit_hash]

# 查看reflog（可以找回"丢失"的commit）
git reflog
```

### 撤销回滚（如果回滚错了）
```bash
# 1. 查看reflog找到回滚前的commit
git reflog

# 2. 恢复到回滚前的状态
git reset --hard [之前的commit_hash]
```

## 服务管理命令

```bash
# 重启服务
sudo systemctl restart patent_system

# 查看服务状态
sudo systemctl status patent_system

# 查看服务日志
sudo journalctl -u patent_system -f

# 停止服务
sudo systemctl stop patent_system

# 启动服务
sudo systemctl start patent_system
```

## 验证回滚是否成功

```bash
# 1. 查看当前commit
git log -1

# 2. 查看服务状态
sudo systemctl status patent_system

# 3. 查看应用日志
tail -f /root/patent_system/logs/app.log

# 4. 测试网站是否正常
curl http://localhost:5000
```

## 注意事项

1. **回滚前建议创建备份分支**
   ```bash
   git branch backup-before-rollback
   ```

2. **回滚会丢失未提交的更改**
   - `git reset --hard` 会丢失所有未提交的修改
   - 如果有重要的未提交更改，先用 `git stash` 保存

3. **数据库回滚**
   - 如果数据库结构有变化，可能需要单独处理
   - 检查 `backend/user_management/users.json` 等数据文件

4. **依赖包回滚**
   - 如果 requirements.txt 有变化，需要重新安装依赖：
   ```bash
   pip install -r requirements.txt
   ```

5. **配置文件检查**
   - 回滚后检查 `.env` 配置是否正确
   - 检查 `config/` 目录下的配置文件

## 常见问题

### Q: 如何找到同步前的commit？
A: 使用 `git log --oneline -20` 查看历史，找到同步操作之前的commit

### Q: 回滚后服务无法启动？
A: 检查日志 `sudo journalctl -u patent_system -n 50`，可能需要重新安装依赖

### Q: 如何确认当前版本？
A: 使用 `git log -1` 查看当前commit信息

### Q: 回滚错了怎么办？
A: 使用 `git reflog` 找到之前的commit，然后 `git reset --hard [commit_hash]` 恢复

## 快速命令参考

```bash
# 一键回滚到上一个版本并重启
cd /root/patent_system && git reset --hard HEAD~1 && sudo systemctl restart patent_system

# 查看当前版本和服务状态
cd /root/patent_system && git log -1 && sudo systemctl status patent_system
```
