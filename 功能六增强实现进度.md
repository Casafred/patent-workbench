# åŠŸèƒ½å…­æ‰¹é‡ä¸“åˆ©è§£è¯»å¢å¼º - å®ç°è¿›åº¦

## å·²å®Œæˆå·¥ä½œ

### 1. éœ€æ±‚å’Œè®¾è®¡æ–‡æ¡£ âœ…
- [x] åˆ›å»ºéœ€æ±‚æ–‡æ¡£ `.kiro/specs/patent-batch-enhancement/requirements.md`
- [x] åˆ›å»ºè®¾è®¡æ–‡æ¡£ `.kiro/specs/patent-batch-enhancement/design.md`
- [x] åˆ›å»ºä»»åŠ¡æ¸…å• `.kiro/specs/patent-batch-enhancement/tasks.md`

### 2. æ ¸å¿ƒJavaScriptæ¨¡å— âœ…
- [x] åˆ›å»ºæ¨¡æ¿ç®¡ç†æ¨¡å— `js/patentTemplate.js`
  - é¢„è®¾æ¨¡æ¿å®šä¹‰ï¼ˆé»˜è®¤ã€æŠ€æœ¯åˆ†æã€å•†ä¸šä»·å€¼ã€æ³•å¾‹åˆ†æï¼‰
  - æ¨¡æ¿CRUDæ“ä½œ
  - æ¨¡æ¿å¯¼å…¥/å¯¼å‡º
  - å­—æ®µé…ç½®ç®¡ç†
  - è§£è¯»æç¤ºè¯æ„å»º

- [x] åˆ›å»ºå¯¹è¯åŠŸèƒ½æ¨¡å— `js/patentChat.js`
  - æ‰“å¼€/å…³é—­å¯¹è¯çª—å£
  - å‘é€æ¶ˆæ¯å’Œæ¥æ”¶å›å¤
  - å¯¹è¯å†å²ç®¡ç†
  - å¯¹è¯å¯¼å‡ºåŠŸèƒ½

### 3. CSSæ ·å¼æ–‡ä»¶ âœ…
- [x] åˆ›å»ºæ¨¡æ¿ç®¡ç†æ ·å¼ `frontend/css/components/patent-template.css`
  - æ¨¡æ¿é€‰æ‹©å™¨æ ·å¼
  - å­—æ®µé…ç½®å™¨æ ·å¼
  - å“åº”å¼å¸ƒå±€

- [x] åˆ›å»ºå¯¹è¯åŠŸèƒ½æ ·å¼ `frontend/css/components/patent-chat.css`
  - é—®ä¸€é—®æŒ‰é’®æ ·å¼
  - å¯¹è¯å¼¹çª—æ ·å¼
  - æ¶ˆæ¯æ°”æ³¡æ ·å¼
  - åŠ è½½åŠ¨ç”»

### 4. çŠ¶æ€ç®¡ç†æ›´æ–° âœ…
- [x] åœ¨ `js/state.js` ä¸­æ·»åŠ  `patentBatch` çŠ¶æ€å¯¹è±¡

## å¾…å®Œæˆå·¥ä½œ

### Phase 1: æ ¸å¿ƒåŠŸèƒ½é›†æˆï¼ˆä¼˜å…ˆçº§ï¼šP0ï¼‰

#### 1. HTMLç•Œé¢æ›´æ–°
**æ–‡ä»¶**: `frontend/index.html`

éœ€è¦åœ¨åŠŸèƒ½å…­åŒºåŸŸæ·»åŠ ï¼š

```html
<!-- åœ¨ä¸“åˆ©å·è¾“å…¥åŒºåæ·»åŠ æ¨¡æ¿ç®¡ç†åŒº -->
<div class="template-management-section">
    <div class="template-header">
        <label for="patent_template_selector">è§£è¯»æ¨¡æ¿ï¼š</label>
        <select id="patent_template_selector"></select>
        <button id="manage_template_btn" class="small-button">ç®¡ç†æ¨¡æ¿</button>
    </div>
    
    <div id="template_editor" style="display: none;">
        <div class="template-info">
            <input type="text" id="template_name" placeholder="æ¨¡æ¿åç§°">
            <textarea id="template_description" placeholder="æ¨¡æ¿æè¿°"></textarea>
        </div>
        
        <div class="fields-container">
            <h5>å­—æ®µé…ç½®ï¼š</h5>
            <div id="fields_list"></div>
            <button class="small-button" id="add_field_btn">+ æ·»åŠ å­—æ®µ</button>
        </div>
        
        <div class="template-actions">
            <button class="small-button" id="save_template_btn">ä¿å­˜æ¨¡æ¿</button>
            <button class="small-button" id="new_template_btn">æ–°å»ºæ¨¡æ¿</button>
            <button class="small-button delete-button" id="delete_template_btn">åˆ é™¤æ¨¡æ¿</button>
            <button class="small-button" id="export_template_btn">å¯¼å‡ºæ¨¡æ¿</button>
            <button class="small-button" id="import_template_btn">å¯¼å…¥æ¨¡æ¿</button>
            <button class="small-button" id="cancel_edit_btn">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ å¯¹è¯å¼¹çª— -->
<div id="patent_chat_modal" class="modal" style="display: none;">
    <div class="modal-content patent-chat-modal">
        <div class="modal-header">
            <div class="patent-info">
                <h4 class="patent-chat-title">ä¸“åˆ©å¯¹è¯</h4>
                <p class="patent-chat-subtitle"></p>
            </div>
            <button class="close-btn" id="patent_chat_close_btn">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="chat-actions">
                <button id="patent_chat_clear_btn">æ¸…ç©ºå¯¹è¯</button>
                <button id="patent_chat_export_btn">å¯¼å‡ºå¯¹è¯</button>
            </div>
            
            <div id="patent_chat_history" class="chat-history"></div>
            
            <div class="chat-input-area">
                <textarea id="patent_chat_input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
                <button id="patent_chat_send_btn" class="small-button">å‘é€</button>
            </div>
        </div>
    </div>
</div>

<!-- åœ¨headä¸­å¼•å…¥CSS -->
<link rel="stylesheet" href="css/components/patent-template.css">
<link rel="stylesheet" href="css/components/patent-chat.css">

<!-- åœ¨bodyåº•éƒ¨å¼•å…¥JS -->
<script src="js/patentTemplate.js"></script>
<script src="js/patentChat.js"></script>
```

#### 2. ä¿®æ”¹ `js/main.js` ä¸­çš„åŠŸèƒ½å…­å®ç°

**éœ€è¦ä¿®æ”¹çš„å‡½æ•°**:

1. **åˆå§‹åŒ–å‡½æ•°** - æ·»åŠ æ¨¡æ¿å’Œå¯¹è¯åˆå§‹åŒ–
```javascript
function initPatentBatch() {
    // ç°æœ‰ä»£ç ...
    
    // æ–°å¢ï¼šåˆå§‹åŒ–æ¨¡æ¿ç®¡ç†
    initPatentTemplate();
    
    // æ–°å¢ï¼šåˆå§‹åŒ–å¯¹è¯åŠŸèƒ½
    initPatentChat();
    
    // ç°æœ‰ä»£ç ...
}
```

2. **displayPatentResultså‡½æ•°** - æ·»åŠ "é—®ä¸€é—®"æŒ‰é’®
```javascript
function displayPatentResults(results) {
    // ä¿å­˜åˆ°çŠ¶æ€
    appState.patentBatch.patentResults = results;
    
    results.forEach(result => {
        // åœ¨æ ‡é¢˜æ æ·»åŠ é—®ä¸€é—®æŒ‰é’®
        htmlContent += `
            <div class="patent-card-header">
                <h5>${result.patent_number} - ${data.title || 'æ— æ ‡é¢˜'}</h5>
                <button class="ask-patent-btn" onclick="openPatentChat('${result.patent_number}')">
                    ğŸ’¬ é—®ä¸€é—®
                </button>
            </div>
        `;
        // å…¶ä»–å†…å®¹...
    });
}
```

3. **analyzeAllBtnäº‹ä»¶å¤„ç†** - ä½¿ç”¨æ¨¡æ¿æ„å»ºæç¤ºè¯
```javascript
analyzeAllBtn.addEventListener('click', async () => {
    // è·å–å½“å‰æ¨¡æ¿
    const template = appState.patentBatch.currentTemplate;
    if (!template) {
        alert('è¯·å…ˆé€‰æ‹©è§£è¯»æ¨¡æ¿');
        return;
    }
    
    // ä½¿ç”¨æ¨¡æ¿æ„å»ºæç¤ºè¯
    for (let i = 0; i < successfulResults.length; i++) {
        const patent = successfulResults[i];
        
        // æ„å»ºè§£è¯»æç¤ºè¯
        const userPrompt = buildAnalysisPrompt(template, patent.data, includeSpecification);
        
        // è°ƒç”¨API
        const analysisResult = await apiCall('/patent/analyze', {
            patent_data: patent.data,
            template: {
                fields: template.fields,
                system_prompt: template.systemPrompt
            },
            user_prompt: userPrompt,
            include_specification: includeSpecification
        });
        
        // åŠ¨æ€æ˜¾ç¤ºç»“æœï¼ˆæ ¹æ®æ¨¡æ¿å­—æ®µï¼‰
        displayAnalysisResult(patent, analysisResult, template);
    }
});
```

4. **Excelå¯¼å‡º** - åŠ¨æ€é€‚é…æ¨¡æ¿å­—æ®µ
```javascript
exportAnalysisExcelBtn.addEventListener('click', async () => {
    const template = appState.patentBatch.currentTemplate;
    
    const exportData = analysisResults.map(result => {
        const row = {
            'ä¸“åˆ©å·': result.patent_number,
            'æ ‡é¢˜': result.patent_data.title || '',
            // åŸºæœ¬å­—æ®µ...
        };
        
        // åŠ¨æ€æ·»åŠ æ¨¡æ¿å­—æ®µ
        template.fields.forEach(field => {
            row[field.name] = analysisJson[field.id] || '';
        });
        
        return row;
    });
    
    // å¯¼å‡ºExcel...
});
```

#### 3. åç«¯APIæ›´æ–°

**æ–‡ä»¶**: `backend/routes/patent.py`

1. **æ›´æ–° `/patent/analyze` è·¯ç”±**
```python
@patent_bp.route('/analyze', methods=['POST'])
def analyze_patent():
    """
    åˆ†æä¸“åˆ©å†…å®¹ï¼ˆæ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿ï¼‰
    """
    try:
        req_data = request.get_json()
        patent_data = req_data.get('patent_data', {})
        template = req_data.get('template', None)
        user_prompt = req_data.get('user_prompt', '')
        include_specification = req_data.get('include_specification', False)
        
        # å¦‚æœæä¾›äº†æ¨¡æ¿ï¼Œä½¿ç”¨æ¨¡æ¿çš„system_prompt
        if template and 'system_prompt' in template:
            system_prompt = template['system_prompt']
        else:
            # ä½¿ç”¨é»˜è®¤æç¤ºè¯
            system_prompt = "ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ä¸“åˆ©åˆ†æå¸ˆ..."
        
        # è°ƒç”¨AI API
        response = call_zhipu_api(
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            model="GLM-4.7-Flash",
            temperature=0.3
        )
        
        return create_response(data=response)
        
    except Exception as e:
        return create_response(error=str(e), status_code=500)
```

2. **æ·»åŠ  `/patent/chat` è·¯ç”±**
```python
@patent_bp.route('/chat', methods=['POST'])
def patent_chat():
    """
    ä¸“åˆ©å¯¹è¯åŠŸèƒ½
    """
    try:
        req_data = request.get_json()
        patent_number = req_data.get('patent_number')
        patent_data = req_data.get('patent_data', {})
        messages = req_data.get('messages', [])
        
        # æ„å»ºä¸“åˆ©ä¸Šä¸‹æ–‡
        patent_context = f"""
ä¸“åˆ©å·ï¼š{patent_number}
æ ‡é¢˜ï¼š{patent_data.get('title', 'æœªçŸ¥')}
æ‘˜è¦ï¼š{patent_data.get('abstract', 'æœªçŸ¥')}

æƒåˆ©è¦æ±‚ï¼š
{chr(10).join(patent_data.get('claims', []))}
"""
        
        # æ„å»ºå®Œæ•´æ¶ˆæ¯åˆ—è¡¨
        full_messages = [
            {
                "role": "system",
                "content": f"ä½ æ˜¯ä¸€ä½ä¸“åˆ©åˆ†æä¸“å®¶ã€‚ä»¥ä¸‹æ˜¯ä¸“åˆ©çš„è¯¦ç»†ä¿¡æ¯ï¼š\n\n{patent_context}\n\nè¯·åŸºäºè¿™äº›ä¿¡æ¯å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚"
            }
        ] + messages
        
        # è°ƒç”¨AI API
        response = call_zhipu_api(
            messages=full_messages,
            model="GLM-4.7-Flash",
            temperature=0.7
        )
        
        return create_response(data=response)
        
    except Exception as e:
        return create_response(error=str(e), status_code=500)
```

### Phase 2: æµ‹è¯•å’Œä¼˜åŒ–

#### 1. åŠŸèƒ½æµ‹è¯•
- [ ] æµ‹è¯•æ¨¡æ¿åˆ›å»ºå’Œç¼–è¾‘
- [ ] æµ‹è¯•æ¨¡æ¿åˆ‡æ¢
- [ ] æµ‹è¯•è‡ªå®šä¹‰å­—æ®µè§£è¯»
- [ ] æµ‹è¯•è§£è¯»ç»“æœæ˜¾ç¤º
- [ ] æµ‹è¯•Excelå¯¼å‡º
- [ ] æµ‹è¯•ä¸“åˆ©å¯¹è¯åŠŸèƒ½
- [ ] æµ‹è¯•å¤šè½®å¯¹è¯
- [ ] æµ‹è¯•æ¨¡æ¿å¯¼å…¥/å¯¼å‡º

#### 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- [ ] æ·»åŠ åŠ è½½çŠ¶æ€æç¤º
- [ ] æ·»åŠ é”™è¯¯å¤„ç†å’Œå‹å¥½æç¤º
- [ ] ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤º
- [ ] æ·»åŠ å¿«æ·æ“ä½œ

#### 3. æ–‡æ¡£æ›´æ–°
- [ ] æ›´æ–° `frontend/help.html` åŠŸèƒ½å…­éƒ¨åˆ†
- [ ] åˆ›å»ºåŠŸèƒ½è¯´æ˜æ–‡æ¡£
- [ ] åˆ›å»ºä½¿ç”¨æ•™ç¨‹

### Phase 3: éƒ¨ç½²

#### 1. éƒ¨ç½²å‡†å¤‡
- [ ] æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- [ ] æ›´æ–°éƒ¨ç½²è„šæœ¬
- [ ] å‡†å¤‡éƒ¨ç½²æ–‡æ¡£

#### 2. éƒ¨ç½²æ‰§è¡Œ
- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
- [ ] éªŒè¯åŠŸèƒ½
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

## å¿«é€Ÿå¼€å§‹æŒ‡å—

### 1. é›†æˆåˆ°ç°æœ‰ä»£ç 

1. åœ¨ `frontend/index.html` çš„ `<head>` ä¸­æ·»åŠ CSSå¼•ç”¨ï¼š
```html
<link rel="stylesheet" href="css/components/patent-template.css">
<link rel="stylesheet" href="css/components/patent-chat.css">
```

2. åœ¨ `frontend/index.html` çš„ `</body>` å‰æ·»åŠ JSå¼•ç”¨ï¼š
```html
<script src="js/patentTemplate.js"></script>
<script src="js/patentChat.js"></script>
```

3. åœ¨åŠŸèƒ½å…­çš„HTMLåŒºåŸŸæ·»åŠ æ¨¡æ¿ç®¡ç†UIå’Œå¯¹è¯å¼¹çª—ï¼ˆè§ä¸Šæ–‡HTMLä»£ç ï¼‰

4. ä¿®æ”¹ `js/main.js` ä¸­çš„ `initPatentBatch()` å‡½æ•°ï¼Œæ·»åŠ åˆå§‹åŒ–è°ƒç”¨

5. ä¿®æ”¹ `displayPatentResults()` å‡½æ•°ï¼Œæ·»åŠ "é—®ä¸€é—®"æŒ‰é’®

6. ä¿®æ”¹è§£è¯»å’Œå¯¼å‡ºé€»è¾‘ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿

7. æ›´æ–°åç«¯APIï¼ˆè§ä¸Šæ–‡Pythonä»£ç ï¼‰

### 2. æµ‹è¯•æ­¥éª¤

1. æ‰“å¼€åŠŸèƒ½å…­
2. ç‚¹å‡»"ç®¡ç†æ¨¡æ¿"æŒ‰é’®
3. åˆ›å»ºä¸€ä¸ªæ–°æ¨¡æ¿ï¼Œæ·»åŠ è‡ªå®šä¹‰å­—æ®µ
4. ä¿å­˜æ¨¡æ¿
5. è¾“å…¥ä¸“åˆ©å·å¹¶æŸ¥è¯¢
6. é€‰æ‹©è‡ªå®šä¹‰æ¨¡æ¿è¿›è¡Œè§£è¯»
7. æŸ¥çœ‹è§£è¯»ç»“æœï¼ˆåº”æ˜¾ç¤ºè‡ªå®šä¹‰å­—æ®µï¼‰
8. ç‚¹å‡»æŸä¸ªä¸“åˆ©çš„"é—®ä¸€é—®"æŒ‰é’®
9. åœ¨å¯¹è¯çª—å£ä¸­æé—®
10. æŸ¥çœ‹AIå›å¤
11. å¯¼å‡ºExcelï¼ˆåº”åŒ…å«è‡ªå®šä¹‰å­—æ®µï¼‰

## é¢„è®¡å·¥ä½œé‡

- HTMLé›†æˆï¼š1-2å°æ—¶
- JSé€»è¾‘ä¿®æ”¹ï¼š2-3å°æ—¶
- åç«¯APIæ›´æ–°ï¼š1-2å°æ—¶
- æµ‹è¯•å’Œè°ƒè¯•ï¼š2-3å°æ—¶
- æ–‡æ¡£æ›´æ–°ï¼š1å°æ—¶

**æ€»è®¡**ï¼š7-11å°æ—¶

## æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“
2. **é”™è¯¯å¤„ç†**ï¼šæ·»åŠ å®Œå–„çš„é”™è¯¯æç¤º
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤§é‡ä¸“åˆ©æ—¶æ³¨æ„æ€§èƒ½
4. **ç§»åŠ¨ç«¯é€‚é…**ï¼šç¡®ä¿ç§»åŠ¨ç«¯å¯ç”¨
5. **æ•°æ®æŒä¹…åŒ–**ï¼šæ¨¡æ¿å’Œå¯¹è¯å†å²çš„å­˜å‚¨ç­–ç•¥

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. æŒ‰ç…§ä¸Šè¿°æŒ‡å—é›†æˆHTMLå’ŒJSä»£ç 
2. æ›´æ–°åç«¯API
3. è¿›è¡ŒåŠŸèƒ½æµ‹è¯•
4. ä¿®å¤å‘ç°çš„é—®é¢˜
5. æ›´æ–°æ–‡æ¡£
6. éƒ¨ç½²ä¸Šçº¿
