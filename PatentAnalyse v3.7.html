<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专利分析智能工作台 v3.7</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #28a745; /* 主色调 - 绿色 */
            --primary-hover-color: #218838; /* 悬停/激活色 */
            --primary-dark-color: #1e7e34; /* 标题/深色 */
            --background-color: #f4f8f5; /* 背景色 */
            --container-bg-color: #ffffff;
            --border-color: #dce5dd;
            --text-color: #333;
            --light-info-bg: #e9f5ec;
            --white-glow-color: rgba(255, 255, 255, 0.8);
            --code-bg-color: #2d2d2d;
            --code-text-color: #e6e6e6;
            --error-color: #dc3545;
            --success-color: #28a745;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; line-height: 1.6; color: var(--text-color); background-color: var(--background-color); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: var(--container-bg-color); padding: 0; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: hidden; }
        .app-banner { display: flex; flex-direction: column; align-items: center; padding: 15px 20px; background-color: var(--primary-dark-color); color: #fff; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .banner-text-logo { font-family: 'Orbitron', sans-serif; font-size: 2.8rem; font-weight: 900; margin: 0; padding: 0; letter-spacing: 4px; background: linear-gradient(145deg, #ffffff, #e0ffe8); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 6px var(--white-glow-color), 0 0 15px rgba(255, 255, 255, 0.5); }
        .copyright-info { margin-top: 8px; display: flex; flex-direction: column; align-items: center; font-size: 11px; font-weight: normal; color: rgba(255, 255, 255, 0.7); }
        .version-number { font-size: 10px; opacity: 0.8; margin-top: 2px; }
        .main-content { padding: 25px; }
        .tab-container { border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-button { background-color: transparent; border: 1px solid transparent; border-bottom: none; padding: 10px 20px; cursor: pointer; font-size: 1.1em; border-radius: 5px 5px 0 0; color: #495057; }
        .tab-button.active { background-color: var(--container-bg-color); border-color: var(--border-color); border-bottom: 1px solid var(--container-bg-color); margin-bottom: -1px; font-weight: bold; color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .step { margin-bottom: 25px; padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; background-color: #ffffff; }
        .step-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #495057; }
        input[type="file"] { border: 1px solid #ccc; display: inline-block; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; text-align: center; }
        button:hover { background-color: var(--primary-hover-color); }
        button:disabled { background-color: #a0c7af; cursor: not-allowed; }
        .action-button { width: 240px; display: inline-block; }
        .config-item { margin-bottom: 15px; display: flex; align-items: flex-start; }
        .config-item label { display: inline-block; width: 170px; font-weight: 500; flex-shrink: 0; padding-top: 8px; }
        .config-item .input-wrapper { width: 100%; }
        .config-item select, .config-item input, .config-item textarea { padding: 8px; border-radius: 4px; border: 1px solid #ced4da; width: 100%; box-sizing: border-box; }
        .preview-output { background-color: var(--code-bg-color); color: var(--code-text-color); padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-family: "Courier New", Courier, monospace; white-space: pre-wrap; word-break: break-all; }
        .preview-item { padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px dashed #4a4a4a; }
        .preview-item:last-child { border-bottom: none; margin-bottom: 0; }
        .info { font-size: 0.9em; color: var(--primary-dark-color); margin-top: 15px; background-color: var(--light-info-bg); padding: 10px; border-radius: 4px; border-left: 4px solid var(--primary-color); }
        .reporter-uploads { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        details { border: 1px solid var(--border-color); border-radius: 5px; margin-top: 25px; background-color: #fafdfb; }
        summary { font-size: 1.2em; font-weight: bold; color: #495057; padding: 15px 20px; cursor: pointer; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: '▶ '; font-size: 0.8em; margin-right: 8px; transition: transform 0.2s; display: inline-block; }
        details[open] > summary::before { transform: rotate(90deg); }
        #batch_log { margin-top: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 4px; min-height: 100px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; font-family: monospace; }
        .log-entry { margin-bottom: 8px; }
        .log-entry.error { color: var(--error-color); }
        .log-entry.success { color: var(--success-color); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header class="app-banner">
        <h1 class="banner-text-logo">ALFRED X IP</h1>
        <div class="copyright-info">
            <span>Copyright © 2025 Alfred Shi 保留所有权利.</span>
            <span class="version-number">版本号: v3.7 (集成版)</span>
        </div>
    </header>

    <div class="main-content">
        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('generator')">功能一：生成请求文件</button>
            <button class="tab-button" onclick="switchTab('batch')">功能二：批量请求与结果获取</button>
            <button class="tab-button" onclick="switchTab('reporter')">功能三：解析结果生成报告</button>
        </div>

        <!-- 功能一 (与v3.6相同) -->
        <div id="generator-tab" class="tab-content active">
            <!-- 内容与v3.6相同，此处省略以保持简洁，但实际代码中应包含 -->
            <div class="step">
                <div class="step-header">第一步：上传原始Excel文件</div>
                <input type="file" id="gen-excel-input" accept=".xlsx, .xls">
            </div>
            <div class="step" id="gen-sheet-selection-area" style="display:none;">
                <div class="step-header">第二步：选择要处理的工作表(Sheet)</div>
                <div id="gen-sheet-list"></div>
            </div>
            <div class="step" id="gen-column-config-area" style="display:none;">
                <div class="step-header">第三步：配置数据列</div>
                <div class="config-item"><label for="gen-select-id-col">专利号所在列:</label><select id="gen-select-id-col"></select></div>
                <div class="config-item"><label for="gen-select-abstract-col">摘要所在列:</label><select id="gen-select-abstract-col"></select></div>
                <div class="config-item"><label for="gen-select-claims-col">权利要求所在列:</label><select id="gen-select-claims-col"></select></div>
                <br>
                <button id="gen-process-btn" class="action-button">处理并预览</button>
            </div>
            <div class="step" id="gen-preview-area" style="display:none;">
                <div class="step-header">第四步：预览生成的数据（最多显示前3条）</div>
                <pre class="preview-output" id="gen-preview-output"></pre>
                <p class="info" style="margin-top: 15px;">请确认预览内容无误。后续步骤将直接使用全部生成的数据，无需手动下载。</p>
            </div>
            <details>
                <summary>API模板配置 (点击展开/收起)</summary>
                <div class="details-content">
                    <div class="step" style="margin-top: 20px;">
                        <div><strong>预设模板:</strong><div id="preset-buttons-container" style="margin-top: 10px;"></div></div><hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                        <div class="config-item"><label for="api-model">Model:</label><div class="input-wrapper"><input type="text" id="api-model"></div></div>
                        <div class="config-item"><label for="api-temperature">Temperature:</label><div class="input-wrapper"><input type="number" id="api-temperature" step="0.1"></div></div>
                        <div class="config-item"><label for="api-system-prompt">System Role:</label><div class="input-wrapper"><textarea id="api-system-prompt"></textarea></div></div>
                        <div class="config-item"><label for="api-user-prompt">User Role:</label><div class="input-wrapper"><textarea id="api-user-prompt"></textarea></div></div>
                    </div>
                </div>
            </details>
        </div>
        
        <!-- 功能二 (全新，集成后端交互) -->
        <div id="batch-tab" class="tab-content">
            <div class="step">
                <div class="step-header">准备工作：输入您的API Key</div>
                <div class="config-item"><label for="batch_api_key_input">API Key:</label><div class="input-wrapper"><input type="password" id="batch_api_key_input" placeholder="请在此处粘贴您的API Key"></div></div>
                <p class="info">您的API Key将发送到本地后端服务进行处理，不会存储在浏览器中。</p>
            </div>
            <div class="step">
                <div class="step-header">批量任务工作流</div>
                <p>请按照1-4的顺序执行。点击按钮将直接与您的本地后端服务通信，以执行相应操作。</p>
                <button id="batch_step1_upload" class="action-button">1. 上传请求文件</button>
                <button id="batch_step2_create" class="action-button" disabled>2. 创建Batch任务</button>
                <button id="batch_step3_check" class="action-button" disabled>3. 检查任务状态</button>
                <button id="batch_step4_download" class="action-button" disabled>4. 下载结果文件</button>
            </div>
            <div class="step">
                <div class="step-header">执行日志与结果</div>
                <div id="batch_log">等待操作...</div>
            </div>
        </div>

        <!-- 功能三 (与v3.6相同) -->
        <div id="reporter-tab" class="tab-content">
            <!-- 内容与v3.6相同，此处省略以保持简洁，但实际代码中应包含 -->
             <div class="step">
                <div class="step-header">第一步：上传文件</div>
                <div class="reporter-uploads">
                    <div>
                        <label for="rep-excel-input"><strong>1. 原始Excel文件</strong> (用于匹配行)</label><br>
                        <input type="file" id="rep-excel-input" accept=".xlsx, .xls" style="width: 100%;">
                    </div>
                    <div>
                        <label for="rep-jsonl-input"><strong>2. API返回的JSONL结果文件</strong></label><br>
                        <input type="file" id="rep-jsonl-input" accept=".jsonl" style="width: 100%;">
                    </div>
                </div>
                 <p class="info">注意：结果文件通常在您运行后端服务的目录下的 `batch_downloads` 文件夹中。</p>
            </div>
            <div class="step" id="rep-sheet-selection-area" style="display:none;">
                <div class="step-header">第二步：选择要处理的原始数据工作表(Sheet)</div>
                <div id="rep-sheet-list"></div>
            </div>
            <div class="step" id="rep-config-area" style="display:none;">
                <div class="step-header">第三步：配置报告列</div>
                <div class="config-item"><label for="rep-select-id-col">选择专利号所在列:</label><select id="rep-select-id-col"></select></div>
                <button id="rep-process-btn" class="action-button">生成并预览报告</button>
            </div>
            <div class="step" id="rep-preview-area" style="display:none;">
                <div class="step-header">第四步：预览最终报告数据（最多显示前3行）</div>
                <pre class="preview-output" id="rep-preview-output"></pre><br>
                <button id="rep-download-btn" class="action-button" style="display:none;">下载完整Excel报告</button>
            </div>
            <div class="step" id="rep-status-area" style="display:none;">
                <div class="step-header">处理状态日志</div>
                <pre id="rep-status-log" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>
</div>

<script>
// --- 全局配置 ---
// !!! 关键修改 !!!
// 部署完后端服务后，Render会给你一个URL，例如：https://your-app-name.onrender.com
// 你需要将它粘贴到这里。部署前端之前，这里必须是正确的后端URL。
const BACKEND_URL = 'https://patent-workbench-backend.onrender.com'; // <-- 部署完后端后，到这里来填写URL

// --- 预设模板等与v3.6相同，此处省略 ---
const PRESET_TEMPLATES = [{name:"核心发明点提取",model:"glm-4",temperature:0.4,systemPrompt:"你是一位资深专利技术分析专家...",userPrompt:`...`},{name:"摘要和权要翻译",model:"glm-4",temperature:0.1,systemPrompt:"你是一个专业的科技文献翻译引擎...",userPrompt:`...`}];

// --- 全局变量 ---
let gen_workbook=null, gen_currentSheetData=null, gen_jsonlContent="";
let rep_workbook=null, rep_sheetData=null, rep_jsonlData=null;
let rep_finalOutputData=[], rep_outputHeaders=[];
let batch_fileId = null, batch_batchId = null, batch_outputFileId = null, batch_errorFileId = null;

const apiModelInput=document.getElementById('api-model'), apiTempInput=document.getElementById('api-temperature'), apiSystemInput=document.getElementById('api-system-prompt'), apiUserInput=document.getElementById('api-user-prompt');

// =================================================================================
// 初始化
// =================================================================================
document.addEventListener('DOMContentLoaded', ()=>{
    // 省略模板相关代码的显示，但功能保留
    createPresetButtons(); loadPreset(0);
    // 功能一
    document.getElementById('gen-excel-input').addEventListener('change',(e)=>handleFileSelect(e,'gen'));document.getElementById('gen-process-btn').addEventListener('click',processDataForJsonl);
    // 功能二 (Batch)
    document.getElementById('batch_step1_upload').addEventListener('click', runStep1_Upload);
    document.getElementById('batch_step2_create').addEventListener('click', runStep2_Create);
    document.getElementById('batch_step3_check').addEventListener('click', runStep3_Check);
    document.getElementById('batch_step4_download').addEventListener('click', runStep4_Download);
    // 功能三
    document.getElementById('rep-excel-input').addEventListener('change',(e)=>handleFileSelect(e,'rep'));document.getElementById('rep-jsonl-input').addEventListener('change',(e)=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(e)=>{rep_jsonlData=e.target.result};r.readAsText(f)});document.getElementById('rep-process-btn').addEventListener('click',previewReport);document.getElementById('rep-download-btn').addEventListener('click',downloadReport);
});

// =================================================================================
// 功能二：批量请求 (全新交互逻辑)
// =================================================================================
const batchLog = document.getElementById('batch_log');
const btnUpload = document.getElementById('batch_step1_upload');
const btnCreate = document.getElementById('batch_step2_create');
const btnCheck = document.getElementById('batch_step3_check');
const btnDownload = document.getElementById('batch_step4_download');

async function apiCall(endpoint, body) {
    if (!BACKEND_URL) {
        alert("错误：后端URL未配置！请联系管理员修改 patent_workbench_v3.8.html 文件中的 BACKEND_URL 常量。");
        return null;
    }
    // ... rest of the function is the same
    try {
        const response = await fetch(`${BACKEND_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error);
        }
        return result.data;
    } catch (error) {
        addLog(`请求失败: ${error.message}`, 'error');
        console.error(`API Call Error to ${endpoint}:`, error);
        return null;
    }
}

function addLog(message, type = 'info') {
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    batchLog.appendChild(entry);
    batchLog.scrollTop = batchLog.scrollHeight;
}

async function apiCall(endpoint, body) {
    try {
        const response = await fetch(`${BACKEND_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error);
        }
        return result.data;
    } catch (error) {
        addLog(`请求失败: ${error.message}`, 'error');
        console.error(`API Call Error to ${endpoint}:`, error);
        return null;
    }
}

async function runStep1_Upload() {
    addLog('开始执行步骤1：上传请求文件...');
    if (!gen_jsonlContent) {
        addLog('错误：请先在【功能一】中生成请求文件内容。', 'error');
        return;
    }
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey) {
        addLog('错误：请输入API Key。', 'error');
        return;
    }
    
    this.disabled = true;
    const data = await apiCall('/api/upload', { 
        apiKey: apiKey,
        jsonlContent: gen_jsonlContent,
        fileName: `patent_requests_${Date.now()}.jsonl`
    });
    this.disabled = false;

    if (data) {
        batch_fileId = data.fileId;
        addLog(`成功: ${data.message}`, 'success');
        addLog(`获取到 File ID: ${batch_fileId}`);
        btnCreate.disabled = false;
    }
}

async function runStep2_Create() {
    addLog('开始执行步骤2：创建Batch任务...');
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey || !batch_fileId) {
        addLog('错误：API Key 或 File ID 缺失。', 'error');
        return;
    }

    this.disabled = true;
    const data = await apiCall('/api/create_batch', { apiKey, fileId: batch_fileId });
    this.disabled = false;

    if (data) {
        batch_batchId = data.id;
        addLog(`成功: Batch任务创建成功！`, 'success');
        addLog(`获取到 Batch ID: ${batch_batchId}`);
        addLog(`任务当前状态: ${data.status}`);
        btnCheck.disabled = false;
    }
}

async function runStep3_Check() {
    addLog('开始执行步骤3：检查任务状态...');
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey || !batch_batchId) {
        addLog('错误：API Key 或 Batch ID 缺失。', 'error');
        return;
    }

    this.disabled = true;
    const data = await apiCall('/api/check_status', { apiKey, batchId: batch_batchId });
    this.disabled = false;

    if (data) {
        addLog(`任务状态: ${data.status}`, data.status === 'completed' ? 'success' : 'info');
        if (data.status === 'completed') {
            batch_outputFileId = data.output_file_id;
            batch_errorFileId = data.error_file_id;
            addLog(`任务完成! Output File ID: ${batch_outputFileId}`);
            if(batch_errorFileId) addLog(`错误文件 ID: ${batch_errorFileId}`);
            btnDownload.disabled = false;
        } else if (['failed', 'expired', 'cancelled'].includes(data.status)) {
            addLog(`任务失败或已终止。`, 'error');
        } else {
            addLog(`任务仍在进行中，请稍后重试。`);
        }
    }
}

async function runStep4_Download() {
    addLog('开始执行步骤4：下载结果文件...');
    const apiKey = document.getElementById('batch_api_key_input').value.trim();
    if (!apiKey) {
        addLog('错误：API Key 缺失。', 'error');
        return;
    }
    
    let success = true;
    this.disabled = true;

    if (batch_outputFileId) {
        addLog(`正在下载成功结果文件 (ID: ${batch_outputFileId})...`);
        const data = await apiCall('/api/download_result', { apiKey, fileId: batch_outputFileId, fileType: 'output' });
        if (data) addLog(`成功: ${data.message}`, 'success'); else success = false;
    }
    if (batch_errorFileId) {
        addLog(`正在下载错误结果文件 (ID: ${batch_errorFileId})...`);
        const data = await apiCall('/api/download_result', { apiKey, fileId: batch_errorFileId, fileType: 'error' });
        if (data) addLog(`成功: ${data.message}`, 'success'); else success = false;
    }
    
    this.disabled = false;

    if (success) {
        addLog('所有文件下载完成。请前往【功能三】上传 `batch_downloads` 文件夹中的结果文件进行解析。');
    }
}

// --- 其他功能的JS代码 (与v3.6相同，此处为保持完整性而包含，可折叠) ---
function createPresetButtons(){const c=document.getElementById('preset-buttons-container');c.innerHTML='';PRESET_TEMPLATES.forEach((p,i)=>{const b=document.createElement('button');b.textContent=p.name;b.className='preset-button';b.onclick=()=>loadPreset(i);c.appendChild(b)})}
function loadPreset(i){const p=PRESET_TEMPLATES[i];if(!p)return;apiModelInput.value=p.model;apiTempInput.value=p.temperature;apiSystemInput.value=p.systemPrompt.trim();apiUserInput.value=p.userPrompt.trim()}
function switchTab(t){document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));document.getElementById(t+'-tab').classList.add('active');document.querySelector(`.tab-button[onclick="switchTab('${t}')"]`).classList.add('active')}
function handleFileSelect(e,p){const f=e.target.files[0];if(!f)return;const s=document.getElementById(`${p}-sheet-selection-area`),c=(p==='gen')?document.getElementById('gen-column-config-area'):document.getElementById('rep-config-area');s.style.display='none';c.style.display='none';const r=new FileReader();r.onload=function(e){const d=new Uint8Array(e.target.result),w=XLSX.read(d,{type:'array'});if(p==='gen')gen_workbook=w;else rep_workbook=w;const n=w.SheetNames;if(n.length===1)loadSheet(n[0],p);else displaySheetSelection(n,p)};r.readAsArrayBuffer(f)}
function displaySheetSelection(n,p){const l=document.getElementById(`${p}-sheet-list`),a=document.getElementById(`${p}-sheet-selection-area`);l.innerHTML='';n.forEach(name=>{const b=document.createElement('button');b.textContent=name;b.style.margin='5px';b.onclick=()=>loadSheet(name,p);l.appendChild(b)});a.style.display='block'}
function loadSheet(s,p){const w=(p==='gen')?gen_workbook:rep_workbook,k=w.Sheets[s],d=XLSX.utils.sheet_to_json(k,{header:1});if(d.length>0&&d[0].length>0){if(p==='gen'){gen_currentSheetData=d;document.getElementById('gen-column-config-area').style.display='block'}else{rep_sheetData=d;document.getElementById('rep-config-area').style.display='block'}populateColumnSelectors(d[0],p);const l=document.getElementById(`${p}-sheet-list`);if(l.children.length>0){Array.from(l.children).forEach(b=>{b.style.backgroundColor=b.textContent===s?'var(--primary-hover-color)':'var(--primary-color)'})}}else{alert(`工作表 "${s}" 中没有数据或表头为空。`)}}
function populateColumnSelectors(h,p){const m={'gen':['gen-select-id-col','gen-select-abstract-col','gen-select-claims-col'],'rep':['rep-select-id-col']},s=m[p];s.forEach(id=>{const l=document.getElementById(id);l.innerHTML='';h.forEach((hdr,i)=>{if(hdr){const o=document.createElement('option');o.value=i;o.textContent=hdr;l.appendChild(o)}})})}
function downloadFile(c,f,t){const b=new Blob([c],{type:t}),l=document.createElement("a");l.href=URL.createObjectURL(b);l.download=f;l.style.visibility='hidden';document.body.appendChild(l);l.click();document.body.removeChild(l)}
function extractFirstClaimSet(t){if(!t||typeof t!=='string')return "";const l=t.trim().split('\n');let n=0,e=[],f=!1;for(const i of l){const m=i.trim().match(/^\[?(\d+)[\]\.\s]/);if(m){f=!0;const c=parseInt(m[1],10);if(c<=n&&n>0)break;n=c}e.push(i)}return f?e.join('\n').trim():t}
function processDataForJsonl(){if(!gen_currentSheetData||gen_currentSheetData.length<2)return alert('没有可处理的数据行。');const a=document.getElementById('gen-select-abstract-col').value,c=document.getElementById('gen-select-claims-col').value;let r=[];const d=gen_currentSheetData.slice(1);d.forEach((w,x)=>{const b=w[a]||"",p=b.length>=20?b.trim():"",l=w[c]||"",m=l.length>=20?extractFirstClaimSet(l):"";let q={custom_id:`request-${x}`,method:"POST",url:"/v4/chat/completions",body:{model:apiModelInput.value.trim(),messages:[{role:"system",content:apiSystemInput.value.trim()},{role:"user",content:apiUserInput.value.trim()}],temperature:parseFloat(apiTempInput.value)}};let u=q.body.messages[1].content;u=u.replace("{{abstract}}",p.replace(/"/g,'\\"'));u=u.replace("{{claims}}",m.replace(/"/g,'\\"'));q.body.messages[1].content=u;r.push(q)});gen_jsonlContent=r.map(q=>JSON.stringify(q)).join('\n');const v=r.slice(0,3).map(q=>`<div class="preview-item">${JSON.stringify(q,null,2)}</div>`).join('');document.getElementById('gen-preview-output').innerHTML=v||"没有生成任何数据。";document.getElementById('gen-preview-area').style.display='block';if(r.length>0)addLog('请求文件内容已在内存中生成，可以进行下一步上传操作。', 'success');}
function previewReport(){if(!rep_sheetData||!rep_jsonlData){return alert('请上传原始Excel文件（并选择工作表）和API返回的JSONL文件。')}const s=document.getElementById('rep-status-area'),l=document.getElementById('rep-status-log');s.style.display='block';l.textContent='开始处理和生成预览...\n';try{const m=new Map();rep_jsonlData.split('\n').forEach(line=>{if(line.trim()==='')return;try{const e=JSON.parse(line);const c=e.custom_id,i=c.match(/request-(\d+)/);if(i){const r=parseInt(i[1],10),t=e.response?.body?.choices?.[0]?.message?.content;if(t){let p;try{const n=t.replace(/^```json\s*|```\s*$/g,'').trim();p=JSON.parse(n)}catch(jsonError){p={"解析失败的原始回应":t}}m.set(r,p)}}}catch(err){console.warn("Skipping invalid JSONL line:",line,err)}});l.textContent+=`JSONL文件解析完毕，共找到 ${m.size} 条有效结果。\n`;const d=document.getElementById('rep-select-id-col').value,o=rep_sheetData[0],a=rep_sheetData.slice(1);let u=[],h=[o[d]],f=!1;a.forEach((row,x)=>{const p=row[d]||`Row-${x+2}`;let n={[o[d]]:p};if(m.has(x)){const r=m.get(x);if(!f){const k=Object.keys(r);h.push(...k);f=!0;l.textContent+=`已识别并设定报告列: ${k.join(', ')}\n`}for(const key of h){if(key===o[d])continue;if(r.hasOwnProperty(key)){let v=r[key];if(Array.isArray(v))v=v.join('; ');if(typeof v==='string'&&key.toLowerCase().indexOf('翻译')===-1){v=v.replace(/\\n/g,' ').replace(/\n/g,' ').replace(/\s+/g,' ').trim()}n[key]=v}else{n[key]=''}}}u.push(n)});rep_finalOutputData=u;rep_outputHeaders=h;l.textContent+='数据匹配完成，正在生成预览...\n';const c=rep_finalOutputData.slice(0,3).map(row=>`<div class="preview-item">${JSON.stringify(row,null,2)}</div>`).join('');document.getElementById('rep-preview-output').innerHTML=c||"没有可预览的数据。";document.getElementById('rep-preview-area').style.display='block';if(rep_finalOutputData.length>0){document.getElementById('rep-download-btn').style.display='inline-block'}l.textContent+='预览已生成，请检查数据。确认无误后可点击下载完整报告。'}catch(e){l.textContent+=`发生严重错误: ${e.message}\n请检查文件格式或控制台输出。`;console.error("Error during report preview generation:",e)}}
function downloadReport(){if(!rep_finalOutputData||rep_finalOutputData.length===0){alert('没有可下载的数据。请先生成预览。');return}const l=document.getElementById('rep-status-log');l.textContent+='\n\n开始生成并下载Excel文件...\n';try{const w=XLSX.utils.json_to_sheet(rep_finalOutputData,{header:rep_outputHeaders}),b=XLSX.utils.book_new();XLSX.utils.book_append_sheet(b,w,'分析报告');const e=XLSX.write(b,{bookType:'xlsx',type:'array'});downloadFile(new Blob([e]),`patent_report_${Date.now()}.xlsx`,'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');l.textContent+='报告生成成功并已开始下载！'}catch(e){l.textContent+=`下载Excel时发生错误: ${e.message}`;console.error("Error during report download:",e)}}

</script>
</body>
</html>

