<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸèƒ½å…« v7.0 - è°ƒè¯•é¢æ¿æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background-color: #e7f3ff;
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 20px auto;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-container {
            margin-top: 30px;
        }
        
        .canvas-container {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: default;
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .toolbar button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        
        .toolbar button:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .stats-card {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .stats-card h3 {
            color: #007bff;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .stat-item {
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }
        
        .error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 6px;
            color: #721c24;
            margin: 20px 0;
        }
        
        .success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 6px;
            color: #155724;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ åŠŸèƒ½å…« v7.0 - è°ƒè¯•é¢æ¿æµ‹è¯•</h1>
        <p class="subtitle">äº¤äº’å¼é™„å›¾æ ‡æ³¨ + å®Œæ•´è°ƒè¯•ä¿¡æ¯</p>
        
        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="section">
            <h2 class="section-title">ğŸ“¤ 1. ä¸Šä¼ é™„å›¾</h2>
            <div class="upload-area" id="uploadArea">
                <p style="font-size: 18px; color: #667eea; margin-bottom: 10px;">ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ é™„å›¾</p>
                <p style="font-size: 14px; color: #6c757d;">æ”¯æŒ PNG, JPG, JPEG æ ¼å¼</p>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" multiple>
            </div>
            <div id="filePreview" style="margin-top: 15px;"></div>
        </div>
        
        <!-- è¯´æ˜ä¹¦è¾“å…¥ -->
        <div class="section">
            <h2 class="section-title">ğŸ“ 2. è¾“å…¥è¯´æ˜ä¹¦æ–‡æœ¬</h2>
            <textarea id="specInput" placeholder="è¯·è¾“å…¥åŒ…å«é™„å›¾æ ‡è®°çš„è¯´æ˜ä¹¦æ–‡æœ¬ï¼Œä¾‹å¦‚ï¼š&#10;1. åº•åº§&#10;2. æ—‹è½¬è‡‚&#10;3. å¤¹ç´§è£…ç½®&#10;..."></textarea>
        </div>
        
        <!-- å¤„ç†æŒ‰é’® -->
        <button class="btn-primary" id="processBtn" disabled>ğŸš€ å¼€å§‹å¤„ç†</button>
        
        <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="resultsContainer" class="results-container" style="display: none;">
            <h2 class="section-title">ğŸ“Š å¤„ç†ç»“æœ</h2>
            
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div id="statsCard" class="stats-card"></div>
            
            <!-- Canvasæ˜¾ç¤º -->
            <div id="canvasContainer" class="canvas-container"></div>
            
            <!-- è°ƒè¯•é¢æ¿å®¹å™¨ -->
            <div id="debugPanelContainer"></div>
        </div>
    </div>
    
    <script src="js/drawingMarkerInteractive_v6.js"></script>
    <script>
        let selectedFiles = [];
        let markerInstance = null;
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const specInput = document.getElementById('specInput');
        const processBtn = document.getElementById('processBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        
        // ç‚¹å‡»ä¸Šä¼ 
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        // å¤„ç†æ–‡ä»¶
        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => 
                file.type.startsWith('image/')
            );
            
            if (selectedFiles.length === 0) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // æ˜¾ç¤ºé¢„è§ˆ
            filePreview.innerHTML = `
                <div style="background-color: #d4edda; padding: 10px; border-radius: 6px; color: #155724;">
                    âœ… å·²é€‰æ‹© ${selectedFiles.length} ä¸ªæ–‡ä»¶: ${selectedFiles.map(f => f.name).join(', ')}
                </div>
            `;
            
            updateProcessButton();
        }
        
        // ç›‘å¬è¯´æ˜ä¹¦è¾“å…¥
        specInput.addEventListener('input', updateProcessButton);
        
        function updateProcessButton() {
            processBtn.disabled = !(selectedFiles.length > 0 && specInput.value.trim());
        }
        
        // å¤„ç†æŒ‰é’®ç‚¹å‡»
        processBtn.addEventListener('click', async () => {
            processBtn.disabled = true;
            processBtn.textContent = 'â³ å¤„ç†ä¸­...';
            
            try {
                // å‡†å¤‡è¯·æ±‚æ•°æ®
                const drawings = await Promise.all(
                    selectedFiles.map(file => fileToBase64(file))
                );
                
                const requestData = {
                    drawings: drawings,
                    specification: specInput.value.trim()
                };
                
                // å‘é€è¯·æ±‚
                const response = await fetch('/api/drawing-marker/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayResults(result.data);
                } else {
                    throw new Error(result.error || 'å¤„ç†å¤±è´¥');
                }
                
            } catch (error) {
                console.error('å¤„ç†é”™è¯¯:', error);
                resultsContainer.innerHTML = `
                    <div class="error">
                        <strong>âŒ å¤„ç†å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
                resultsContainer.style.display = 'block';
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
            }
        });
        
        // æ–‡ä»¶è½¬Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: base64
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(data) {
            resultsContainer.style.display = 'block';
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            const statsCard = document.getElementById('statsCard');
            statsCard.innerHTML = `
                <h3>ğŸ“ˆ å¤„ç†ç»Ÿè®¡</h3>
                <div class="success" style="margin-bottom: 15px;">
                    ${data.message}
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${data.total_numbers}</div>
                        <div class="stat-label">è¯†åˆ«æ ‡å·æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.match_rate}%</div>
                        <div class="stat-label">åŒ¹é…ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${Math.round(data.avg_confidence)}%</div>
                        <div class="stat-label">å¹³å‡ç½®ä¿¡åº¦</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.debug_info?.total_markers_in_spec || 0}</div>
                        <div class="stat-label">è¯´æ˜ä¹¦éƒ¨ä»¶æ•°</div>
                    </div>
                </div>
            `;
            
            // æ˜¾ç¤ºCanvas
            const canvasContainer = document.getElementById('canvasContainer');
            canvasContainer.innerHTML = '<h3 style="margin-bottom: 15px;">ğŸ–¼ï¸ äº¤äº’å¼æ ‡æ³¨</h3>';
            
            // å¤„ç†ç¬¬ä¸€å¼ å›¾ç‰‡
            if (data.drawings && data.drawings.length > 0) {
                const drawing = data.drawings[0];
                const imageUrl = `data:${drawing.type};base64,${selectedFiles[0] ? await fileToBase64(selectedFiles[0]).then(d => d.data) : ''}`;
                
                // åˆ›å»ºCanvas
                const canvas = document.createElement('canvas');
                canvas.id = 'markerCanvas';
                canvasContainer.appendChild(canvas);
                
                // åˆ›å»ºå·¥å…·æ 
                const toolbar = document.createElement('div');
                toolbar.className = 'toolbar';
                toolbar.innerHTML = `
                    <button style="background-color: #4CAF50;" onclick="markerInstance.increaseFontSize(true)">é€‰ä¸­å­—ä½“+</button>
                    <button style="background-color: #FF9800;" onclick="markerInstance.decreaseFontSize(true)">é€‰ä¸­å­—ä½“-</button>
                    <button style="background-color: #2196F3;" onclick="markerInstance.increaseFontSize(false)">å…¨éƒ¨å­—ä½“+</button>
                    <button style="background-color: #9C27B0;" onclick="markerInstance.decreaseFontSize(false)">å…¨éƒ¨å­—ä½“-</button>
                    <button style="background-color: #607D8B;" onclick="markerInstance.selectAll()">å…¨é€‰</button>
                    <button style="background-color: #795548;" onclick="markerInstance.deselectAll()">å–æ¶ˆé€‰æ‹©</button>
                    <button style="background-color: #f44336;" onclick="markerInstance.openModal()">ğŸ” æ”¾å¤§æŸ¥çœ‹</button>
                `;
                canvasContainer.appendChild(toolbar);
                
                // åˆå§‹åŒ–InteractiveDrawingMarker
                markerInstance = new InteractiveDrawingMarker(
                    'markerCanvas',
                    imageUrl,
                    drawing.detected_numbers,
                    data.reference_map,
                    {
                        enableModal: true,
                        enableDebugPanel: true,
                        debugInfo: drawing.debug_info
                    }
                );
                
                // åˆ›å»ºè°ƒè¯•é¢æ¿
                setTimeout(() => {
                    markerInstance.createDebugPanel('debugPanelContainer');
                }, 500);
            }
            
            // æ»šåŠ¨åˆ°ç»“æœ
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // ç¤ºä¾‹æ•°æ®å¡«å……
        window.addEventListener('load', () => {
            specInput.value = `71. æœºå£³
711. å‰å£³ä½“
712. åå£³ä½“
713. åº•åº§éƒ¨åˆ†
72. ç”µæœº
721. ç”µæœºè½´
722. ç”µæœºå¤–å£³
73. æ§åˆ¶ç”µè·¯æ¿
731. ä¸»æ§èŠ¯ç‰‡
732. ç”µæºæ¨¡å—
74. ä¼ æ„Ÿå™¨ç»„ä»¶
741. æ¸©åº¦ä¼ æ„Ÿå™¨
742. å‹åŠ›ä¼ æ„Ÿå™¨`;
        });
    </script>
</body>
</html>
