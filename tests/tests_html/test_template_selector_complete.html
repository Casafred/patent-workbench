<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åŠŸèƒ½ä¸‰æ¨¡æ¿é€‰æ‹©å™¨ - å®Œæ•´æµ‹è¯•</title>
    <style>
        body { font-family: 'Microsoft YaHei', Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; border-bottom: 3px solid #4a6cf7; padding-bottom: 10px; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-section h3 { color: #4a6cf7; margin-top: 0; }
        select, textarea, input { width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; margin: 5px; background: #4a6cf7; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #3a5cd7; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow: auto; border-left: 4px solid #4a6cf7; }
        .status-box { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status-box.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .status-box.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .step-by-step { background: #e7f3ff; padding: 15px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ åŠŸèƒ½ä¸‰ï¼šå¤§æ‰¹é‡å¤„ç† - æ¨¡æ¿é€‰æ‹©å™¨å®Œæ•´æµ‹è¯•</h1>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤è¯´æ˜</h3>
            <div class="step-by-step">
                <p><strong>è¿™ä¸ªé¡µé¢å°†å¸®åŠ©ä½ éªŒè¯æ¨¡æ¿é€‰æ‹©å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ</strong></p>
                <ol>
                    <li>é¡µé¢åŠ è½½æ—¶ä¼šè‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥</li>
                    <li>æŸ¥çœ‹æ¯ä¸ªæµ‹è¯•éƒ¨åˆ†çš„ç»“æœ</li>
                    <li>å¦‚æœçœ‹åˆ° âœ… è¡¨ç¤ºæˆåŠŸï¼ŒâŒ è¡¨ç¤ºå¤±è´¥</li>
                    <li>æ‰€æœ‰æµ‹è¯•é€šè¿‡åï¼Œå®é™…åº”ç”¨ä¸­çš„æ¨¡æ¿é€‰æ‹©å™¨åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œ</li>
                </ol>
            </div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•1ï¸âƒ£: DOMå…ƒç´ æ£€æŸ¥</h3>
            <p>æ£€æŸ¥ template_selector å…ƒç´ æ˜¯å¦å­˜åœ¨</p>
            <div id="test1-result" class="status-box"></div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•2ï¸âƒ£: appStateæ•°æ®æ£€æŸ¥</h3>
            <p>æ£€æŸ¥ appState.generator.presetTemplates æ•°æ®</p>
            <div id="test2-result" class="status-box"></div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•3ï¸âƒ£: æ¨¡æ¿é€‰æ‹©å™¨åˆå§‹åŒ–</h3>
            <p>æµ‹è¯• updateTemplateSelector() å‡½æ•°</p>
            <label>æ¨¡æ¿é€‰æ‹©å™¨ï¼ˆåº”è¯¥æœ‰5ä¸ªé¢„è®¾æ¨¡æ¿ï¼‰:</label>
            <select id="template_selector"></select>
            <button onclick="testUpdateSelector()">ğŸ”„ é‡æ–°åˆå§‹åŒ–</button>
            <div id="test3-result" class="status-box"></div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•4ï¸âƒ£: æ¨¡æ¿åŠ è½½æµ‹è¯•</h3>
            <p>æµ‹è¯•é€‰æ‹©æ¨¡æ¿åæ˜¯å¦æ­£ç¡®åŠ è½½å†…å®¹</p>
            <button onclick="testLoadTemplate()">ğŸ“¥ åŠ è½½ç¬¬ä¸€ä¸ªæ¨¡æ¿</button>
            <div style="margin-top: 15px;">
                <label>ç³»ç»Ÿæç¤º:</label>
                <textarea id="api-system-prompt" rows="3" readonly></textarea>
                <label>ç”¨æˆ·è§„åˆ™:</label>
                <textarea id="prompt-rules" rows="3" readonly></textarea>
                <div id="output-fields-container"></div>
            </div>
            <div id="test4-result" class="status-box"></div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•5ï¸âƒ£: äº‹ä»¶ç›‘å¬å™¨æµ‹è¯•</h3>
            <p>æµ‹è¯•ä¸‹æ‹‰èœå•çš„ change äº‹ä»¶</p>
            <button onclick="testEventListener()">ğŸ¯ æµ‹è¯•äº‹ä»¶ç›‘å¬</button>
            <div id="test5-result" class="status-box"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            <button onclick="showDebugInfo()">æ˜¾ç¤ºå®Œæ•´è°ƒè¯•ä¿¡æ¯</button>
            <pre id="debug-info"></pre>
        </div>

        <div class="test-section">
            <h3>âœ… éªŒè¯æ¸…å•</h3>
            <div id="checklist">
                <p><input type="checkbox" id="check1"> DOMå…ƒç´ å­˜åœ¨</p>
                <p><input type="checkbox" id="check2"> appStateæ•°æ®æ­£ç¡®</p>
                <p><input type="checkbox" id="check3"> ä¸‹æ‹‰èœå•æœ‰5ä¸ªé¢„è®¾æ¨¡æ¿</p>
                <p><input type="checkbox" id="check4"> å¯ä»¥æ­£ç¡®åŠ è½½æ¨¡æ¿å†…å®¹</p>
                <p><input type="checkbox" id="check5"> changeäº‹ä»¶æ­£å¸¸å·¥ä½œ</p>
            </div>
            <button onclick="checkAllPassed()" style="background: #28a745; margin-top: 10px;">ğŸ‰ æ£€æŸ¥æ˜¯å¦å…¨éƒ¨é€šè¿‡</button>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/state.js"></script>
    <script src="js/dom.js"></script>
    <script>
        // è¾…åŠ©å‡½æ•°
        const getEl = id => document.getElementById(id);

        let testResults = {
            test1: false,
            test2: false,
            test3: false,
            test4: false,
            test5: false
        };

        // æµ‹è¯•1: DOMå…ƒç´ æ£€æŸ¥
        function test1_checkDOM() {
            const result = getEl('test1-result');
            const selector = getEl('template_selector');

            if (selector) {
                result.className = 'status-box success';
                result.innerHTML = '<p class="success">âœ… template_selector å…ƒç´ å­˜åœ¨</p>';
                result.innerHTML += `<p>å…ƒç´ ç±»å‹: ${selector.tagName}</p>`;
                result.innerHTML += `<p>å½“å‰é€‰é¡¹æ•°: ${selector.options.length}</p>`;
                testResults.test1 = true;
                document.getElementById('check1').checked = true;
            } else {
                result.className = 'status-box error';
                result.innerHTML = '<p class="error">âŒ template_selector å…ƒç´ ä¸å­˜åœ¨</p>';
                testResults.test1 = false;
            }
        }

        // æµ‹è¯•2: appStateæ£€æŸ¥
        function test2_checkAppState() {
            const result = getEl('test2-result');

            if (typeof appState === 'undefined') {
                result.className = 'status-box error';
                result.innerHTML = '<p class="error">âŒ appState æœªå®šä¹‰</p>';
                testResults.test2 = false;
                return;
            }

            result.innerHTML = '<p class="success">âœ… appState å·²å®šä¹‰</p>';

            if (!appState.generator) {
                result.className = 'status-box error';
                result.innerHTML += '<p class="error">âŒ appState.generator ä¸å­˜åœ¨</p>';
                testResults.test2 = false;
                return;
            }

            result.innerHTML += '<p class="success">âœ… appState.generator å­˜åœ¨</p>';

            if (!appState.generator.presetTemplates || appState.generator.presetTemplates.length === 0) {
                result.className = 'status-box error';
                result.innerHTML += '<p class="error">âŒ é¢„è®¾æ¨¡æ¿æ•°ç»„ä¸ºç©º</p>';
                testResults.test2 = false;
                return;
            }

            result.className = 'status-box success';
            result.innerHTML += `<p class="success">âœ… æ‰¾åˆ° ${appState.generator.presetTemplates.length} ä¸ªé¢„è®¾æ¨¡æ¿</p>`;
            result.innerHTML += '<ul>';
            appState.generator.presetTemplates.forEach(t => {
                result.innerHTML += `<li>${t.name}</li>`;
            });
            result.innerHTML += '</ul>';
            testResults.test2 = true;
            document.getElementById('check2').checked = true;
        }

        // å¤åˆ¶ä¿®å¤åçš„ updateTemplateSelector å‡½æ•°
        function updateTemplateSelector() {
            const templateSelectorElement = getEl('template_selector');

            if (!templateSelectorElement) {
                console.error('âŒ template_selector å…ƒç´ ä¸å­˜åœ¨');
                return false;
            }

            console.log('âœ… æ‰¾åˆ° template_selector å…ƒç´ ');

            if (typeof appState === 'undefined' || !appState.generator) {
                console.warn('âš ï¸ appState.generator ä¸å­˜åœ¨');
                return false;
            }

            if (!appState.generator.presetTemplates) {
                appState.generator.presetTemplates = [];
            }

            if (!appState.generator.customTemplates) {
                appState.generator.customTemplates = [];
            }

            const selectedValue = templateSelectorElement.value;
            templateSelectorElement.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'é€‰æ‹©é¢„ç½®æ¨¡æ¿æˆ–æ–°å»º';
            templateSelectorElement.appendChild(defaultOption);

            if (appState.generator.presetTemplates.length > 0) {
                console.log('âœ… æ­£åœ¨æ·»åŠ é¢„è®¾æ¨¡æ¿ï¼š', appState.generator.presetTemplates.map(t => t.name));
                appState.generator.presetTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.name;
                    option.textContent = template.name + ' [é¢„è®¾]';
                    templateSelectorElement.appendChild(option);
                });
            } else {
                console.warn('âš ï¸ æ²¡æœ‰é¢„è®¾æ¨¡æ¿å¯ä»¥æ·»åŠ ');
                return false;
            }

            if (appState.generator.customTemplates && appState.generator.customTemplates.length > 0) {
                appState.generator.customTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.name;
                    option.textContent = template.name;
                    templateSelectorElement.appendChild(option);
                });
            }

            if (selectedValue) {
                templateSelectorElement.value = selectedValue;
            }

            console.log(`âœ… æ¨¡æ¿é€‰æ‹©å™¨å·²åˆå§‹åŒ–ï¼Œå…± ${templateSelectorElement.options.length} ä¸ªé€‰é¡¹`);
            return true;
        }

        // æµ‹è¯•3: æ¨¡æ¿é€‰æ‹©å™¨åˆå§‹åŒ–
        function testUpdateSelector() {
            const result = getEl('test3-result');
            const success = updateTemplateSelector();
            const selector = getEl('template_selector');

            if (success && selector.options.length > 1) {
                result.className = 'status-box success';
                result.innerHTML = `<p class="success">âœ… æˆåŠŸåˆå§‹åŒ–æ¨¡æ¿é€‰æ‹©å™¨</p>`;
                result.innerHTML += `<p>æ€»é€‰é¡¹æ•°: ${selector.options.length}</p>`;
                result.innerHTML += `<p>é¢„è®¾æ¨¡æ¿æ•°: ${appState.generator.presetTemplates.length}</p>`;
                testResults.test3 = true;
                document.getElementById('check3').checked = true;
            } else {
                result.className = 'status-box error';
                result.innerHTML = '<p class="error">âŒ æ¨¡æ¿é€‰æ‹©å™¨åˆå§‹åŒ–å¤±è´¥</p>';
                testResults.test3 = false;
            }
        }

        // æµ‹è¯•4: æ¨¡æ¿åŠ è½½
        function testLoadTemplate() {
            const result = getEl('test4-result');

            if (!appState.generator.presetTemplates || appState.generator.presetTemplates.length === 0) {
                result.className = 'status-box error';
                result.innerHTML = '<p class="error">âŒ æ²¡æœ‰å¯ç”¨çš„é¢„è®¾æ¨¡æ¿</p>';
                testResults.test4 = false;
                return;
            }

            const template = appState.generator.presetTemplates[0];

            // åŠ è½½æ¨¡æ¿åˆ°UI
            getEl('api-system-prompt').value = template.system || '';

            if (typeof template.user === 'string') {
                getEl('prompt-rules').value = template.user;
            } else if (template.user && typeof template.user === 'object') {
                getEl('prompt-rules').value = template.user.rules || '';

                const container = getEl('output-fields-container');
                container.innerHTML = '';
                if (template.user.outputFields && template.user.outputFields.length > 0) {
                    container.innerHTML = '<p><strong>è¾“å‡ºå­—æ®µ:</strong></p>';
                    template.user.outputFields.forEach(f => {
                        container.innerHTML += `<div style="padding: 5px; background: #f0f0f0; margin: 5px 0; border-radius: 3px;"><strong>${f.name}:</strong> ${f.desc}</div>`;
                    });
                }
            }

            result.className = 'status-box success';
            result.innerHTML = `<p class="success">âœ… æˆåŠŸåŠ è½½æ¨¡æ¿ "${template.name}"</p>`;
            testResults.test4 = true;
            document.getElementById('check4').checked = true;
        }

        // æµ‹è¯•5: äº‹ä»¶ç›‘å¬å™¨
        function testEventListener() {
            const result = getEl('test5-result');
            const selector = getEl('template_selector');

            if (!selector) {
                result.className = 'status-box error';
                result.innerHTML = '<p class="error">âŒ é€‰æ‹©å™¨å…ƒç´ ä¸å­˜åœ¨</p>';
                testResults.test5 = false;
                return;
            }

            // æµ‹è¯•æ˜¯å¦å¯ä»¥æ‰‹åŠ¨è§¦å‘changeäº‹ä»¶
            let eventFired = false;
            const testHandler = () => { eventFired = true; };
            selector.addEventListener('change', testHandler);

            // é€‰æ‹©ç¬¬ä¸€ä¸ªé¢„è®¾æ¨¡æ¿
            if (selector.options.length > 1) {
                selector.selectedIndex = 1;
                selector.dispatchEvent(new Event('change'));
            }

            selector.removeEventListener('change', testHandler);

            if (eventFired) {
                result.className = 'status-box success';
                result.innerHTML = '<p class="success">âœ… change äº‹ä»¶å¯ä»¥æ­£å¸¸è§¦å‘</p>';
                testResults.test5 = true;
                document.getElementById('check5').checked = true;
            } else {
                result.className = 'status-box error';
                result.innerHTML = '<p class="error">âŒ change äº‹ä»¶æœªè§¦å‘</p>';
                testResults.test5 = false;
            }
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            const info = {
                'DOMå…ƒç´ ': {
                    'template_selectorå­˜åœ¨': !!getEl('template_selector'),
                    'å½“å‰é€‰é¡¹æ•°': getEl('template_selector')?.options.length || 0
                },
                'appState': {
                    'å·²å®šä¹‰': typeof appState !== 'undefined',
                    'generatorå­˜åœ¨': !!appState?.generator,
                    'é¢„è®¾æ¨¡æ¿æ•°é‡': appState?.generator?.presetTemplates?.length || 0,
                    'è‡ªå®šä¹‰æ¨¡æ¿æ•°é‡': appState?.generator?.customTemplates?.length || 0
                },
                'é¢„è®¾æ¨¡æ¿åˆ—è¡¨': appState?.generator?.presetTemplates?.map(t => t.name) || [],
                'æµ‹è¯•ç»“æœ': testResults
            };

            getEl('debug-info').textContent = JSON.stringify(info, null, 2);
        }

        // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨é€šè¿‡
        function checkAllPassed() {
            const allPassed = Object.values(testResults).every(v => v === true);

            if (allPassed) {
                alert('ğŸ‰ æ­å–œï¼æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡äº†ï¼\n\nç°åœ¨å¯ä»¥åœ¨å®é™…åº”ç”¨ä¸­ä½¿ç”¨åŠŸèƒ½ä¸‰çš„æ¨¡æ¿é€‰æ‹©å™¨äº†ã€‚');
            } else {
                const failed = Object.keys(testResults).filter(k => !testResults[k]);
                alert('âŒ è¿˜æœ‰æµ‹è¯•æœªé€šè¿‡:\n\n' + failed.map(k => `- ${k}`).join('\n') + '\n\nè¯·æŸ¥çœ‹ç›¸åº”æµ‹è¯•éƒ¨åˆ†çš„è¯¦ç»†ä¿¡æ¯ã€‚');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæ‰€æœ‰æµ‹è¯•
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨æµ‹è¯•...');

            setTimeout(() => {
                test1_checkDOM();
                test2_checkAppState();
                testUpdateSelector();

                // å»¶è¿Ÿæ‰§è¡Œåç»­æµ‹è¯•
                setTimeout(() => {
                    testLoadTemplate();
                    testEventListener();
                    showDebugInfo();

                    // æ£€æŸ¥æ•´ä½“ç»“æœ
                    const allPassed = Object.values(testResults).every(v => v === true);
                    if (allPassed) {
                        console.log('âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼');
                    } else {
                        console.warn('âš ï¸ éƒ¨åˆ†æµ‹è¯•æœªé€šè¿‡ï¼Œè¯·æŸ¥çœ‹é¡µé¢è¯¦æƒ…');
                    }
                }, 500);
            }, 200);
        });
    </script>
</body>
</html>
