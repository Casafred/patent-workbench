# 测试诊断工具 - 最新修复

## 🔧 最新修复（2026-01-25）

修复了认证绕过逻辑，现在支持：
- ✅ 127.0.0.1 和所有 127.x.x.x
- ✅ localhost
- ✅ ::1 (IPv6)
- ✅ 192.168.x.x (内网IP)
- ✅ 0.0.0.0

## 🚀 测试步骤

### 1. 重启应用

**重要：** 必须重启应用才能加载新代码！

```bash
# 停止当前运行的应用（Ctrl+C）
# 然后重新启动
python run_app.py
```

### 2. 访问诊断工具

打开浏览器，访问：
```
http://localhost:5001/test_drawing_marker_debug.html
```

或者：
```
http://127.0.0.1:5001/test_drawing_marker_debug.html
```

### 3. 查看后端日志

当你点击"开始完整测试"时，后端控制台应该会显示：

```
[DEBUG] 诊断工具请求来自本地IP: 127.0.0.1，绕过认证
[DEBUG] 从说明书中提取到 X 个附图标记
[DEBUG] 附图标记映射: {...}
[DEBUG] 图片 XXX OCR识别到 Y 个数字/标记
```

### 4. 如果还是报错

**如果仍然看到 "Authentication required"：**

1. **确认已重启应用**
   - 停止应用（Ctrl+C）
   - 重新运行 `python run_app.py`

2. **检查后端日志**
   - 查看是否有 `[DEBUG] 诊断工具请求来自本地IP` 的日志
   - 如果没有，说明请求没有到达认证检查

3. **检查IP地址**
   - 后端日志会显示检测到的IP地址
   - 如果IP不是本地IP，可能需要调整代码

4. **尝试不同的访问方式**
   ```
   http://localhost:5001/test_drawing_marker_debug.html
   http://127.0.0.1:5001/test_drawing_marker_debug.html
   http://192.168.x.x:5001/test_drawing_marker_debug.html
   ```

## 📋 完整测试流程

### 步骤1: 准备测试数据

**图片：** 准备一张清晰的专利附图

**说明书：** 例如
```
1电动工具、2外壳、2L左侧外壳、2R右侧外壳、3后盖
```

### 步骤2: 测试说明书解析

1. 在文本框中输入说明书内容
2. 点击"测试说明书解析"
3. 应该看到：✅ 成功提取到 X 个附图标记

### 步骤3: 完整测试

1. 上传图片
2. 点击"开始完整测试"
3. 查看结果

## 🔍 预期结果

### 成功的情况

**前端显示：**
```
✅ 处理成功
已识别 1 张附图中的数字序号
共识别出 X 个数字序号，匹配率 Y%
```

**后端日志：**
```
[DEBUG] 诊断工具请求来自本地IP: 127.0.0.1，绕过认证
[DEBUG] 从说明书中提取到 5 个附图标记
[DEBUG] 附图标记映射: {'1': '电动工具', '2': '外壳', ...}
[DEBUG] 图片 test.png OCR识别到 3 个数字/标记
  - 1 (置信度: 95%)
  - 2 (置信度: 87%)
  - 3 (置信度: 82%)
```

### 失败的情况

**如果识别率为0%：**

1. **说明书解析失败**
   - 检查格式是否正确
   - 使用支持的格式

2. **OCR识别失败**
   - 检查Tesseract是否安装
   - 检查图片质量

3. **匹配失败**
   - 检查图片上的数字与说明书编号是否一致

## 🆘 故障排除

### 问题1: 仍然提示需要登录

**解决方法：**
1. 确认已重启应用
2. 检查后端日志中的IP地址
3. 尝试使用 `127.0.0.1` 而不是 `localhost`

### 问题2: 没有看到调试日志

**解决方法：**
1. 确认应用是在命令行中运行的（不是后台运行）
2. 检查是否有其他错误信息
3. 尝试添加更多日志

### 问题3: OCR识别率为0%

**解决方法：**
1. 检查Tesseract是否安装：`tesseract --version`
2. 使用更清晰的图片
3. 查看后端日志中的详细信息

## 📞 需要帮助？

如果测试后仍有问题，请提供：
1. 后端控制台的完整日志
2. 浏览器控制台的错误信息（F12）
3. 使用的访问地址
4. 测试图片和说明书内容

---

**更新时间：** 2026-01-25  
**版本：** v1.1.0 - 修复认证绕过逻辑
