# 功能八：专利附图标记识别 - 测试指南

## 快速测试

### 1. 测试说明书解析

运行测试脚本：
```bash
python test_drawing_marker_parser.py
```

**预期结果：**
- ✅ 顿号格式：提取到 41 个附图标记
- ✅ 省略号格式：提取到 7 个附图标记（省略号已自动移除）
- ✅ 标准格式：提取到 5 个附图标记

### 2. 测试完整功能

1. 启动应用：
   ```bash
   python run_app.py
   ```

2. 访问功能八页面：
   - 打开浏览器访问 `http://localhost:5000`
   - 点击"功能八：专利附图标记"标签

3. 上传测试图片：
   - 准备一张清晰的专利附图
   - 图片上应有清晰可见的数字序号

4. 输入说明书内容（任选一种格式）：

   **格式1：紧凑格式**
   ```
   1电动工具、2外壳、2L左侧外壳、2R右侧外壳、3后盖
   ```

   **格式2：省略号格式**
   ```
   1…电动工具、2…外壳、2L…左侧外壳、2R…右侧外壳、3…后盖
   ```

   **格式3：标准格式**
   ```
   1. 电动工具
   2. 外壳
   2L. 左侧外壳
   2R. 右侧外壳
   3. 后盖
   ```

5. 点击"开始处理"按钮

6. 查看处理结果：
   - 应显示识别到的数字序号数量
   - 匹配率应 > 0%
   - 标注后的附图应显示在右侧

## 支持的说明书格式

### ✅ 格式1：标准格式（点号或顿号分隔）
```
1. 电动工具
2. 外壳
2L. 左侧外壳
```
或
```
1、电动工具
2、外壳
2L、左侧外壳
```

### ✅ 格式2：紧凑格式（顿号分隔，无空格）
```
1电动工具、2外壳、2L左侧外壳、2R右侧外壳、3后盖、3S螺钉
```

### ✅ 格式3：省略号格式
```
1…电动工具、2…外壳、2L…左侧外壳、2R…右侧外壳
```

### ✅ 格式4：混合格式
```
1电动工具、2. 外壳、2L…左侧外壳、3、后盖
```

## 编号规范

### ✅ 支持的编号格式
- 纯数字：`1`、`2`、`10`、`20`、`100`
- 数字+字母：`2L`、`2R`、`10A`、`10B`、`16A`
- 字母必须大写

### ❌ 不支持的编号格式
- 罗马数字：`I`、`II`、`III`
- 中文数字：`一`、`二`、`三`
- 小写字母：`2l`、`10a`（会被忽略）

## 常见问题排查

### 问题1：识别率为 0%

**可能原因：**
1. 说明书格式不正确
2. 图片质量太差
3. 图片上的数字与说明书编号不匹配

**排查步骤：**
1. 检查后端日志：
   ```
   [DEBUG] 从说明书中提取到 X 个附图标记
   [DEBUG] 附图标记映射: {...}
   [DEBUG] 图片 XXX OCR识别到 Y 个数字/标记
   ```

2. 如果提取到 0 个附图标记：
   - 检查说明书格式
   - 尝试使用测试脚本验证：`python test_drawing_marker_parser.py`

3. 如果OCR识别到 0 个数字：
   - 检查图片质量
   - 确保图片上的数字清晰可见
   - 尝试提高图片分辨率

### 问题2：部分数字未识别

**可能原因：**
1. 数字太小或模糊
2. 数字与背景对比度低
3. 数字被遮挡或重叠

**解决方法：**
1. 使用更高分辨率的图片
2. 增强图片对比度
3. 确保数字清晰可见

### 问题3：识别到错误的数字

**可能原因：**
1. OCR误识别
2. 图片上有其他数字干扰

**解决方法：**
1. 检查后端日志中的置信度
2. 只保留置信度高的结果
3. 手动编辑标注结果

## 测试用例

### 测试用例1：基本功能测试

**说明书内容：**
```
1电动工具、2外壳、3后盖、4锤子壳体、5锤子壳体盖
```

**预期结果：**
- 提取到 5 个附图标记
- 如果图片上有这些数字，应能识别并匹配

### 测试用例2：带字母编号测试

**说明书内容：**
```
1电动工具、2外壳、2L左侧外壳、2R右侧外壳、10砧座、10A工具孔、10B主轴凸部
```

**预期结果：**
- 提取到 7 个附图标记
- 包括 `2L`、`2R`、`10A`、`10B` 等带字母的编号

### 测试用例3：省略号格式测试

**说明书内容：**
```
1…电动工具、2…外壳、2L…左侧外壳、2R…右侧外壳、3…后盖
```

**预期结果：**
- 提取到 5 个附图标记
- 名称中不包含省略号
- `1: 电动工具`（不是 `1: …电动工具`）

### 测试用例4：混合格式测试

**说明书内容：**
```
1. 电动工具
2、外壳
3…后盖
4锤子壳体
```

**预期结果：**
- 提取到 4 个附图标记
- 所有格式都能正确解析

## 性能测试

### 测试场景1：单张图片
- 图片大小：< 5MB
- 预期处理时间：< 10秒

### 测试场景2：多张图片
- 图片数量：5张
- 图片大小：每张 < 5MB
- 预期处理时间：< 30秒

### 测试场景3：大图片
- 图片大小：10-20MB
- 预期处理时间：< 30秒

## 调试技巧

### 1. 查看后端日志

启动应用时，后端会输出调试日志：
```
[DEBUG] 从说明书中提取到 41 个附图标记
[DEBUG] 附图标记映射: {'1': '电动工具', '2': '外壳', ...}
[DEBUG] 图片 drawing1.png OCR识别到 15 个数字/标记
  - 1 (置信度: 95%)
  - 2 (置信度: 87%)
  - 2L (置信度: 82%)
  ...
```

### 2. 使用测试脚本

测试说明书解析功能：
```bash
python test_drawing_marker_parser.py
```

### 3. 检查OCR结果

如果OCR识别率低，可以：
1. 检查图片质量
2. 尝试不同的图片预处理方法
3. 调整OCR置信度阈值（当前为50%）

## 已知限制

1. **OCR识别限制**
   - 手写数字识别率较低
   - 需要数字与背景有足够对比度
   - 数字不能被遮挡或重叠

2. **说明书格式限制**
   - 不支持罗马数字
   - 不支持中文数字
   - 字母必须大写

3. **性能限制**
   - 大图片处理时间较长
   - 多张图片需要逐个处理

## 后续优化建议

1. **OCR引擎升级**
   - 使用更先进的OCR引擎（EasyOCR、PaddleOCR）
   - 训练专门的专利附图识别模型

2. **并行处理**
   - 支持多张图片并行处理
   - 提高处理速度

3. **交互优化**
   - 支持手动调整标注
   - 支持导出标注结果
   - 支持批量处理

---

**文档版本：** v1.0.0  
**更新日期：** 2026-01-25
