<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸèƒ½å…«ç¼“å­˜æ›´æ–°æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .test-section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .result-box {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-success {
            background: #4CAF50;
            color: white;
        }

        .status-warning {
            background: #FF9800;
            color: white;
        }

        .status-error {
            background: #f44336;
            color: white;
        }

        .cache-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .cache-info h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .cache-info ul {
            list-style: none;
            padding-left: 0;
        }

        .cache-info li {
            padding: 5px 0;
            color: #555;
        }

        .cache-info li strong {
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ åŠŸèƒ½å…«ç¼“å­˜æ›´æ–°æµ‹è¯•</h1>
            <p>æµ‹è¯•OCRç»“æœç¼“å­˜æ£€æµ‹å’Œæ›´æ–°ç¡®è®¤åŠŸèƒ½</p>
        </div>

        <div class="content">
            <!-- æµ‹è¯•1ï¼šç¼“å­˜ç®¡ç†å™¨åˆå§‹åŒ– -->
            <div class="test-section">
                <h2>æµ‹è¯•1ï¼šç¼“å­˜ç®¡ç†å™¨åˆå§‹åŒ–</h2>
                <p>æµ‹è¯•å‰ç«¯ç¼“å­˜ç®¡ç†å™¨æ˜¯å¦æ­£å¸¸åŠ è½½å’Œåˆå§‹åŒ–</p>
                <div class="button-group">
                    <button class="btn-primary" onclick="testCacheManagerInit()">è¿è¡Œæµ‹è¯•</button>
                </div>
                <div id="result1" class="result-box"></div>
            </div>

            <!-- æµ‹è¯•2ï¼šç¼“å­˜é”®ç”Ÿæˆ -->
            <div class="test-section">
                <h2>æµ‹è¯•2ï¼šç¼“å­˜é”®ç”Ÿæˆ</h2>
                <p>æµ‹è¯•åŸºäºå›¾ç‰‡å†…å®¹ç”Ÿæˆå”¯ä¸€ç¼“å­˜é”®</p>
                <div class="button-group">
                    <button class="btn-primary" onclick="testCacheKeyGeneration()">è¿è¡Œæµ‹è¯•</button>
                </div>
                <div id="result2" class="result-box"></div>
            </div>

            <!-- æµ‹è¯•3ï¼šç¼“å­˜å­˜å– -->
            <div class="test-section">
                <h2>æµ‹è¯•3ï¼šç¼“å­˜å­˜å–</h2>
                <p>æµ‹è¯•ç¼“å­˜çš„ä¿å­˜å’Œè¯»å–åŠŸèƒ½</p>
                <div class="button-group">
                    <button class="btn-success" onclick="testCacheSetGet()">è¿è¡Œæµ‹è¯•</button>
                </div>
                <div id="result3" class="result-box"></div>
            </div>

            <!-- æµ‹è¯•4ï¼šç¼“å­˜æ›´æ–°å¯¹è¯æ¡† -->
            <div class="test-section">
                <h2>æµ‹è¯•4ï¼šç¼“å­˜æ›´æ–°ç¡®è®¤å¯¹è¯æ¡†</h2>
                <p>æµ‹è¯•ç¼“å­˜æ£€æµ‹æ—¶çš„ç”¨æˆ·ç¡®è®¤å¯¹è¯æ¡†</p>
                <div class="button-group">
                    <button class="btn-warning" onclick="testCacheUpdateDialog()">æ˜¾ç¤ºå¯¹è¯æ¡†</button>
                </div>
                <div id="result4" class="result-box"></div>
            </div>

            <!-- æµ‹è¯•5ï¼šç¼“å­˜è¿‡æœŸæ¸…ç† -->
            <div class="test-section">
                <h2>æµ‹è¯•5ï¼šç¼“å­˜è¿‡æœŸæ¸…ç†</h2>
                <p>æµ‹è¯•è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜åŠŸèƒ½</p>
                <div class="button-group">
                    <button class="btn-warning" onclick="testCacheExpiration()">è¿è¡Œæµ‹è¯•</button>
                </div>
                <div id="result5" class="result-box"></div>
            </div>

            <!-- æµ‹è¯•6ï¼šæ¸…é™¤æ‰€æœ‰ç¼“å­˜ -->
            <div class="test-section">
                <h2>æµ‹è¯•6ï¼šæ¸…é™¤æ‰€æœ‰ç¼“å­˜</h2>
                <p>æµ‹è¯•æ‰‹åŠ¨æ¸…é™¤æ‰€æœ‰ç¼“å­˜åŠŸèƒ½</p>
                <div class="button-group">
                    <button class="btn-danger" onclick="testClearAllCache()">æ¸…é™¤ç¼“å­˜</button>
                </div>
                <div id="result6" class="result-box"></div>
            </div>

            <!-- å½“å‰ç¼“å­˜çŠ¶æ€ -->
            <div class="cache-info">
                <h3>ğŸ“Š å½“å‰ç¼“å­˜çŠ¶æ€</h3>
                <ul id="cacheStatus">
                    <li>åŠ è½½ä¸­...</li>
                </ul>
                <button class="btn-primary" onclick="refreshCacheStatus()" style="margin-top: 10px;">åˆ·æ–°çŠ¶æ€</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ç¼“å­˜ç®¡ç†å™¨ -->
    <script src="frontend/js/drawingCacheManager.js"></script>

    <script>
        // åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨
        const cacheManager = new DrawingCacheManager();

        // æµ‹è¯•1ï¼šç¼“å­˜ç®¡ç†å™¨åˆå§‹åŒ–
        function testCacheManagerInit() {
            const result = document.getElementById('result1');
            try {
                result.textContent = 'æ­£åœ¨æµ‹è¯•...\n';
                
                // æ£€æŸ¥ç¼“å­˜ç®¡ç†å™¨æ˜¯å¦å­˜åœ¨
                if (typeof DrawingCacheManager === 'undefined') {
                    throw new Error('DrawingCacheManager æœªå®šä¹‰');
                }
                
                // æ£€æŸ¥å®ä¾‹æ˜¯å¦åˆ›å»ºæˆåŠŸ
                if (!cacheManager) {
                    throw new Error('ç¼“å­˜ç®¡ç†å™¨å®ä¾‹åˆ›å»ºå¤±è´¥');
                }
                
                // æ£€æŸ¥å…³é”®æ–¹æ³•æ˜¯å¦å­˜åœ¨
                const methods = ['generateCacheKey', 'getCache', 'setCache', 'clearCache', 'cleanupExpired', 'showCacheUpdateDialog'];
                const missingMethods = methods.filter(method => typeof cacheManager[method] !== 'function');
                
                if (missingMethods.length > 0) {
                    throw new Error(`ç¼ºå°‘æ–¹æ³•: ${missingMethods.join(', ')}`);
                }
                
                result.textContent = 'âœ… æµ‹è¯•é€šè¿‡\n\n';
                result.textContent += 'ç¼“å­˜ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ\n';
                result.textContent += `å¯ç”¨æ–¹æ³•: ${methods.join(', ')}\n`;
                result.textContent += `ç¼“å­˜é”®: ${cacheManager.cacheKey}\n`;
                result.textContent += `æœ€å¤§ç¼“å­˜æ—¶é—´: ${cacheManager.maxCacheAge / (24 * 60 * 60 * 1000)} å¤©`;
                
            } catch (error) {
                result.textContent = 'âŒ æµ‹è¯•å¤±è´¥\n\n';
                result.textContent += `é”™è¯¯: ${error.message}`;
            }
        }

        // æµ‹è¯•2ï¼šç¼“å­˜é”®ç”Ÿæˆ
        function testCacheKeyGeneration() {
            const result = document.getElementById('result2');
            try {
                result.textContent = 'æ­£åœ¨æµ‹è¯•...\n';
                
                // æµ‹è¯•æ•°æ®
                const testData1 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
                const testData2 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==';
                const fileName = 'test_image.png';
                
                // ç”Ÿæˆç¼“å­˜é”®
                const key1 = cacheManager.generateCacheKey(testData1, fileName);
                const key2 = cacheManager.generateCacheKey(testData2, fileName);
                const key3 = cacheManager.generateCacheKey(testData1, fileName); // ç›¸åŒæ•°æ®
                
                result.textContent = 'âœ… æµ‹è¯•é€šè¿‡\n\n';
                result.textContent += `ç¼“å­˜é”®1: ${key1}\n`;
                result.textContent += `ç¼“å­˜é”®2: ${key2}\n`;
                result.textContent += `ç¼“å­˜é”®3: ${key3}\n\n`;
                result.textContent += `ç›¸åŒæ•°æ®ç”Ÿæˆç›¸åŒé”®: ${key1 === key3 ? 'âœ“' : 'âœ—'}\n`;
                result.textContent += `ä¸åŒæ•°æ®ç”Ÿæˆä¸åŒé”®: ${key1 !== key2 ? 'âœ“' : 'âœ—'}`;
                
            } catch (error) {
                result.textContent = 'âŒ æµ‹è¯•å¤±è´¥\n\n';
                result.textContent += `é”™è¯¯: ${error.message}`;
            }
        }

        // æµ‹è¯•3ï¼šç¼“å­˜å­˜å–
        function testCacheSetGet() {
            const result = document.getElementById('result3');
            try {
                result.textContent = 'æ­£åœ¨æµ‹è¯•...\n';
                
                // æµ‹è¯•æ•°æ®
                const cacheKey = 'test_cache_key_' + Date.now();
                const testData = {
                    ocr_detected_count: 15,
                    matched_count: 12,
                    timestamp: Date.now()
                };
                
                // ä¿å­˜ç¼“å­˜
                cacheManager.setCache(cacheKey, testData);
                result.textContent += 'âœ“ ç¼“å­˜å·²ä¿å­˜\n';
                
                // è¯»å–ç¼“å­˜
                const retrieved = cacheManager.getCache(cacheKey);
                result.textContent += 'âœ“ ç¼“å­˜å·²è¯»å–\n\n';
                
                // éªŒè¯æ•°æ®
                if (!retrieved) {
                    throw new Error('ç¼“å­˜è¯»å–å¤±è´¥');
                }
                
                if (retrieved.ocr_detected_count !== testData.ocr_detected_count) {
                    throw new Error('OCRè¯†åˆ«æ•°ä¸åŒ¹é…');
                }
                
                if (retrieved.matched_count !== testData.matched_count) {
                    throw new Error('åŒ¹é…æ•°ä¸åŒ¹é…');
                }
                
                result.textContent += 'âœ… æµ‹è¯•é€šè¿‡\n\n';
                result.textContent += 'ä¿å­˜çš„æ•°æ®:\n';
                result.textContent += JSON.stringify(testData, null, 2) + '\n\n';
                result.textContent += 'è¯»å–çš„æ•°æ®:\n';
                result.textContent += JSON.stringify(retrieved, null, 2);
                
                // æ¸…ç†æµ‹è¯•ç¼“å­˜
                cacheManager.clearCache(cacheKey);
                
            } catch (error) {
                result.textContent = 'âŒ æµ‹è¯•å¤±è´¥\n\n';
                result.textContent += `é”™è¯¯: ${error.message}`;
            }
        }

        // æµ‹è¯•4ï¼šç¼“å­˜æ›´æ–°å¯¹è¯æ¡†
        async function testCacheUpdateDialog() {
            const result = document.getElementById('result4');
            try {
                result.textContent = 'æ­£åœ¨æ˜¾ç¤ºå¯¹è¯æ¡†...\n';
                
                const testData = {
                    ocr_detected_count: 15,
                    matched_count: 12,
                    timestamp: Date.now() - 3600000 // 1å°æ—¶å‰
                };
                
                const shouldRefresh = await cacheManager.showCacheUpdateDialog(
                    'test_drawing.png',
                    testData
                );
                
                result.textContent = 'âœ… å¯¹è¯æ¡†å·²å…³é—­\n\n';
                result.textContent += `ç”¨æˆ·é€‰æ‹©: ${shouldRefresh ? 'é‡æ–°åˆ†æ' : 'ä½¿ç”¨ç¼“å­˜'}\n`;
                result.textContent += `è¿”å›å€¼: ${shouldRefresh}`;
                
            } catch (error) {
                result.textContent = 'âŒ æµ‹è¯•å¤±è´¥\n\n';
                result.textContent += `é”™è¯¯: ${error.message}`;
            }
        }

        // æµ‹è¯•5ï¼šç¼“å­˜è¿‡æœŸæ¸…ç†
        function testCacheExpiration() {
            const result = document.getElementById('result5');
            try {
                result.textContent = 'æ­£åœ¨æµ‹è¯•...\n';
                
                // åˆ›å»ºä¸€ä¸ªè¿‡æœŸçš„ç¼“å­˜
                const expiredKey = 'expired_test_' + Date.now();
                const expiredData = {
                    ocr_detected_count: 10,
                    matched_count: 8,
                    timestamp: Date.now() - (8 * 24 * 60 * 60 * 1000) // 8å¤©å‰
                };
                
                // ç›´æ¥ä¿å­˜åˆ°localStorageï¼ˆç»•è¿‡æ—¶é—´æˆ³æ›´æ–°ï¼‰
                const allCache = cacheManager._loadAllCache();
                allCache[expiredKey] = expiredData;
                cacheManager._saveAllCache(allCache);
                
                result.textContent += 'âœ“ å·²åˆ›å»ºè¿‡æœŸç¼“å­˜\n';
                
                // å°è¯•è¯»å–ï¼ˆåº”è¯¥è¿”å›nullï¼‰
                const retrieved = cacheManager.getCache(expiredKey);
                result.textContent += `âœ“ è¯»å–è¿‡æœŸç¼“å­˜: ${retrieved ? 'å­˜åœ¨' : 'å·²è¿‡æœŸ'}\n`;
                
                // æ‰§è¡Œæ¸…ç†
                const cleaned = cacheManager.cleanupExpired();
                result.textContent += `âœ“ æ¸…ç†å®Œæˆï¼Œåˆ é™¤ ${cleaned} ä¸ªè¿‡æœŸç¼“å­˜\n\n`;
                
                result.textContent += 'âœ… æµ‹è¯•é€šè¿‡\n\n';
                result.textContent += 'è¿‡æœŸç¼“å­˜å·²è¢«æ­£ç¡®è¯†åˆ«å’Œæ¸…ç†';
                
            } catch (error) {
                result.textContent = 'âŒ æµ‹è¯•å¤±è´¥\n\n';
                result.textContent += `é”™è¯¯: ${error.message}`;
            }
        }

        // æµ‹è¯•6ï¼šæ¸…é™¤æ‰€æœ‰ç¼“å­˜
        function testClearAllCache() {
            const result = document.getElementById('result6');
            try {
                result.textContent = 'æ­£åœ¨æ¸…é™¤...\n';
                
                // è·å–æ¸…é™¤å‰çš„ç¼“å­˜æ•°é‡
                const beforeCache = cacheManager._loadAllCache();
                const beforeCount = Object.keys(beforeCache).length;
                
                // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
                cacheManager.clearCache();
                
                // è·å–æ¸…é™¤åçš„ç¼“å­˜æ•°é‡
                const afterCache = cacheManager._loadAllCache();
                const afterCount = Object.keys(afterCache).length;
                
                result.textContent = 'âœ… æ¸…é™¤å®Œæˆ\n\n';
                result.textContent += `æ¸…é™¤å‰: ${beforeCount} ä¸ªç¼“å­˜\n`;
                result.textContent += `æ¸…é™¤å: ${afterCount} ä¸ªç¼“å­˜\n`;
                result.textContent += `çŠ¶æ€: ${afterCount === 0 ? 'âœ“ å…¨éƒ¨æ¸…é™¤' : 'âœ— æ¸…é™¤ä¸å®Œæ•´'}`;
                
                refreshCacheStatus();
                
            } catch (error) {
                result.textContent = 'âŒ æ¸…é™¤å¤±è´¥\n\n';
                result.textContent += `é”™è¯¯: ${error.message}`;
            }
        }

        // åˆ·æ–°ç¼“å­˜çŠ¶æ€
        function refreshCacheStatus() {
            const statusEl = document.getElementById('cacheStatus');
            try {
                const allCache = cacheManager._loadAllCache();
                const cacheKeys = Object.keys(allCache);
                
                if (cacheKeys.length === 0) {
                    statusEl.innerHTML = '<li>ğŸ“­ å½“å‰æ— ç¼“å­˜</li>';
                } else {
                    let html = `<li><strong>ç¼“å­˜æ€»æ•°:</strong> ${cacheKeys.length}</li>`;
                    
                    cacheKeys.forEach((key, index) => {
                        const cache = allCache[key];
                        const age = Date.now() - cache.timestamp;
                        const ageHours = Math.floor(age / (60 * 60 * 1000));
                        const ageDays = Math.floor(ageHours / 24);
                        
                        html += `<li>`;
                        html += `<strong>${index + 1}.</strong> ${key.substring(0, 30)}... `;
                        html += `(${ageDays > 0 ? ageDays + 'å¤©' : ageHours + 'å°æ—¶'}å‰)`;
                        html += `</li>`;
                    });
                    
                    statusEl.innerHTML = html;
                }
            } catch (error) {
                statusEl.innerHTML = `<li style="color: red;">âŒ åŠ è½½å¤±è´¥: ${error.message}</li>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆ·æ–°çŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            refreshCacheStatus();
            
            // è‡ªåŠ¨è¿è¡Œæµ‹è¯•1
            setTimeout(() => {
                testCacheManagerInit();
            }, 500);
        });
    </script>
</body>
</html>
