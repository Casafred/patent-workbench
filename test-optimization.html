<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ è½½ä¼˜åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 { color: #22c55e; }
        .test-section {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background: #dcfce7; color: #166534; }
        .status.warning { background: #fef3c7; color: #92400e; }
        .status.error { background: #fee2e2; color: #991b1b; }
        button {
            padding: 10px 20px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #16a34a; }
        #log {
            background: #1e293b;
            color: #4ade80;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ ä¸“åˆ©å·¥ä½œå°åŠ è½½ä¼˜åŒ–æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>æ­¤é¡µé¢ç”¨äºéªŒè¯åŠ è½½ä¼˜åŒ–æ˜¯å¦å½±å“åŠŸèƒ½ã€‚æ‰€æœ‰æµ‹è¯•é€šè¿‡åæ‰èƒ½ç¡®è®¤ä¼˜åŒ–å®‰å…¨ã€‚</p>
    </div>

    <div class="test-section">
        <h2>1. èµ„æºåŠ è½½ç®¡ç†å™¨æµ‹è¯•</h2>
        <button onclick="testResourceLoader()">æµ‹è¯• ResourceLoader</button>
        <div id="resource-loader-status"></div>
    </div>

    <div class="test-section">
        <h2>2. å»¶è¿ŸåŠ è½½åº“æµ‹è¯•</h2>
        <button onclick="testLibraryLoading('xlsx')">æµ‹è¯•åŠ è½½ XLSX</button>
        <button onclick="testLibraryLoading('marked')">æµ‹è¯•åŠ è½½ marked</button>
        <button onclick="testLibraryLoading('d3')">æµ‹è¯•åŠ è½½ D3</button>
        <div id="library-status"></div>
    </div>

    <div class="test-section">
        <h2>3. åº“å¯ç”¨æ€§æ£€æŸ¥</h2>
        <button onclick="checkAllLibraries()">æ£€æŸ¥æ‰€æœ‰åº“çŠ¶æ€</button>
        <div id="library-check-status"></div>
    </div>

    <div id="log"></div>

    <!-- å¼•å…¥ä¼˜åŒ–åçš„ ResourceLoader -->
    <script>
        // å¤åˆ¶è‡ª index.html çš„ ResourceLoader
        window.ResourceLoader = {
            loadedScripts: new Map(),
            loadingPromises: new Map(),
            
            loadScript: function(src, options = {}) {
                if (this.loadingPromises.has(src)) {
                    return this.loadingPromises.get(src);
                }
                if (this.loadedScripts.has(src)) {
                    return Promise.resolve();
                }
                
                const promise = new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = options.async !== false;
                    script.onload = () => {
                        this.loadedScripts.set(src, true);
                        this.loadingPromises.delete(src);
                        log(`âœ… åŠ è½½æˆåŠŸ: ${src}`);
                        resolve();
                    };
                    script.onerror = (err) => {
                        this.loadingPromises.delete(src);
                        log(`âŒ åŠ è½½å¤±è´¥: ${src}`);
                        reject(err);
                    };
                    document.head.appendChild(script);
                });
                
                this.loadingPromises.set(src, promise);
                return promise;
            },
            
            isLibraryAvailable: function(libName) {
                switch(libName) {
                    case 'xlsx': return typeof XLSX !== 'undefined';
                    case 'html2canvas': return typeof html2canvas !== 'undefined';
                    case 'jspdf': return typeof jspdf !== 'undefined';
                    case 'd3': return typeof d3 !== 'undefined';
                    case 'marked': return typeof marked !== 'undefined';
                    default: return false;
                }
            },
            
            ensureLibrary: async function(libName) {
                if (this.isLibraryAvailable(libName)) {
                    return Promise.resolve();
                }
                
                const libUrls = {
                    'xlsx': 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
                    'html2canvas': 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                    'jspdf': 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'd3': 'https://d3js.org/d3.v7.min.js',
                    'marked': 'https://cdn.jsdelivr.net/npm/marked/marked.min.js'
                };
                
                if (libUrls[libName]) {
                    log(`ğŸ”„ æ­£åœ¨æŒ‰éœ€åŠ è½½: ${libName}`);
                    return this.loadScript(libUrls[libName], { async: true });
                }
                return Promise.reject(new Error(`æœªçŸ¥åº“: ${libName}`));
            }
        };

        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function testResourceLoader() {
            log('=== æµ‹è¯• ResourceLoader ===');
            const tests = [
                ['loadedScripts å­˜åœ¨', !!window.ResourceLoader.loadedScripts],
                ['loadingPromises å­˜åœ¨', !!window.ResourceLoader.loadingPromises],
                ['loadScript æ–¹æ³•å­˜åœ¨', typeof window.ResourceLoader.loadScript === 'function'],
                ['isLibraryAvailable æ–¹æ³•å­˜åœ¨', typeof window.ResourceLoader.isLibraryAvailable === 'function'],
                ['ensureLibrary æ–¹æ³•å­˜åœ¨', typeof window.ResourceLoader.ensureLibrary === 'function']
            ];
            
            const allPassed = tests.every(([name, result]) => result);
            const details = tests.map(([name, result]) => `${result ? 'âœ…' : 'âŒ'} ${name}`).join('<br>');
            
            showStatus('resource-loader-status', details, allPassed ? 'success' : 'error');
            log(`ResourceLoader æµ‹è¯•: ${allPassed ? 'é€šè¿‡' : 'å¤±è´¥'}`);
        }

        async function testLibraryLoading(libName) {
            log(`=== æµ‹è¯•åŠ è½½ ${libName} ===`);
            const startTime = Date.now();
            
            try {
                await window.ResourceLoader.ensureLibrary(libName);
                const duration = Date.now() - startTime;
                const isAvailable = window.ResourceLoader.isLibraryAvailable(libName);
                
                showStatus('library-status', 
                    `âœ… ${libName} åŠ è½½æˆåŠŸ (${duration}ms)<br>åº“å¯ç”¨: ${isAvailable ? 'æ˜¯' : 'å¦'}`, 
                    isAvailable ? 'success' : 'warning');
                log(`${libName} åŠ è½½å®Œæˆï¼Œè€—æ—¶ ${duration}ms`);
            } catch (err) {
                showStatus('library-status', `âŒ ${libName} åŠ è½½å¤±è´¥: ${err.message}`, 'error');
                log(`${libName} åŠ è½½å¤±è´¥: ${err.message}`);
            }
        }

        function checkAllLibraries() {
            log('=== æ£€æŸ¥æ‰€æœ‰åº“çŠ¶æ€ ===');
            const libs = ['xlsx', 'html2canvas', 'jspdf', 'd3', 'marked'];
            const results = libs.map(lib => {
                const available = window.ResourceLoader.isLibraryAvailable(lib);
                return `${available ? 'âœ…' : 'âš ï¸'} ${lib}: ${available ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}`;
            });
            
            showStatus('library-check-status', results.join('<br>'), 'success');
            results.forEach(r => log(r));
        }

        // åˆå§‹æ—¥å¿—
        log('é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾…æµ‹è¯•...');
        log('ResourceLoader å·²åˆå§‹åŒ–');
    </script>
</body>
</html>
