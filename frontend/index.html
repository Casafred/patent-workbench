<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>ä¸“åˆ©åˆ†ææ™ºèƒ½å·¥ä½œå° v20</title>
    
    <!-- é¢„è¿æ¥ä¼˜åŒ– -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- é¦–å±å…³é”®CSSå†…è” -->
    <style>
        /* å…³é”®æ¸²æŸ“è·¯å¾„CSS - æœ€å°åŒ–é¦–å±æ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            min-height: 100vh;
            position: relative;
        }
        #vanta-bg { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: -1; pointer-events: none; 
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #d1fae5 100%);
        }
        .container { 
            max-width: 1600px; margin: 0 auto; padding: 20px;
            position: relative; z-index: 1;
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
            z-index: 99999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
            overflow: hidden;
        }
        .loading-overlay.hidden { 
            opacity: 0; 
            visibility: hidden;
            pointer-events: none; 
        }
        .loading-content {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; z-index: 2;
        }
        .tech-welcome-container {
            position: relative;
            padding: 30px 50px;
            margin-bottom: 40px;
            text-align: center;
            overflow: hidden;
        }
        .tech-scan-line {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #22c55e, #10b981, transparent);
            animation: scanLine 2s linear infinite;
        }
        @keyframes scanLine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .tech-welcome-title {
            font-family: 'Orbitron', 'Noto Sans SC', monospace;
            font-size: 42px;
            font-weight: 900;
            color: #166534;
            text-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
            letter-spacing: 8px;
            margin-bottom: 15px;
            position: relative;
        }
        .tech-cursor {
            animation: cursorBlink 0.8s step-end infinite;
            color: #10b981;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .tech-welcome-subtitle {
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            color: #64748b;
            letter-spacing: 3px;
            text-transform: uppercase;
            opacity: 0.8;
        }
        .tech-loading-bar {
            width: 300px;
            height: 4px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 2px;
            margin-top: 25px;
            overflow: hidden;
            position: relative;
        }
        .tech-loading-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.3), transparent);
            animation: loadingShimmer 1.5s infinite;
        }
        @keyframes loadingShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .tech-loading-progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #22c55e, #10b981);
            border-radius: 2px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        .loading-spinner-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin-bottom: 30px;
        }
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 3px solid rgba(34, 197, 94, 0.15);
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-spinner-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 65px;
            height: 65px;
            border: 2px solid transparent;
            border-top-color: #10b981;
            border-right-color: #10b981;
            border-radius: 50%;
            animation: spinReverse 1.5s linear infinite;
        }
        .loading-spinner-ring.ring-2 {
            width: 80px;
            height: 80px;
            border: 1px solid transparent;
            border-bottom-color: rgba(34, 197, 94, 0.3);
            border-left-color: rgba(34, 197, 94, 0.3);
            animation: spin 2s linear infinite;
        }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes spinReverse { to { transform: translate(-50%, -50%) rotate(-360deg); } }
        .loading-text { 
            color: #475569; 
            font-size: 14px; 
            font-family: 'Noto Sans SC', sans-serif;
            letter-spacing: 2px;
        }
        .loading-progress { 
            margin-top: 10px; 
            color: #94a3b8; 
            font-size: 12px;
            font-family: 'Orbitron', monospace;
            letter-spacing: 1px;
        }
        .loading-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(34, 197, 94, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.03) 0%, transparent 50%);
            pointer-events: none;
        }
        .loading-overlay::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(34, 197, 94, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(34, 197, 94, 0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            animation: gridPulse 4s ease-in-out infinite;
        }
        @keyframes gridPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* éª¨æ¶å±æ ·å¼ */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%; animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* æ‚¬æµ®äºŒç»´ç æ ·å¼ */
        .floating-qr-container {
            position: fixed !important;
            right: 20px !important;
            bottom: 20px !important;
            z-index: 99999 !important;
            font-family: 'Noto Sans SC', sans-serif;
        }
        .floating-qr-toggle {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #22C55E, #16A34A);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            transition: all 0.3s ease;
            color: white;
        }
        .floating-qr-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
        }
        .floating-qr-panel {
            position: absolute;
            right: 60px;
            bottom: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            width: 200px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateX(20px);
            transition: all 0.3s ease;
        }
        .floating-qr-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        .floating-qr-header {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 14px;
        }
        .floating-qr-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
        }
        .floating-qr-close:hover { opacity: 1; }
        .floating-qr-content {
            padding: 15px;
            text-align: center;
        }
        .floating-qr-content img {
            width: 130px;
            height: 130px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .floating-qr-title {
            margin: 10px 0 4px;
            font-weight: 600;
            color: #166534;
            font-size: 15px;
        }
        .floating-qr-desc {
            color: #666;
            font-size: 12px;
            margin: 0;
        }
        .floating-qr-tip {
            color: #999;
            font-size: 11px;
            margin: 8px 0 0;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }
        @media (max-width: 768px) {
            .floating-qr-container {
                right: 15px !important;
                bottom: 15px !important;
            }
            .floating-qr-toggle {
                width: 44px;
                height: 44px;
            }
            .floating-qr-toggle svg {
                width: 20px;
                height: 20px;
            }
            .floating-qr-panel {
                right: 54px;
                width: 180px;
            }
            .floating-qr-content img {
                width: 110px;
                height: 110px;
            }
        }
    </style>
    
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- æ¨¡å—åŒ–CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="frontend/css/main.css?v=20260207d">
    <link rel="stylesheet" href="frontend/css/pages/claims.css?v=20260207d">
    <!-- åŠŸèƒ½å…­å¢å¼ºCSS -->
    <link rel="stylesheet" href="frontend/css/components/patent-template.css">
    <link rel="stylesheet" href="frontend/css/components/patent-chat.css">
    <link rel="stylesheet" href="frontend/css/components/patent-config.css">
    <link rel="stylesheet" href="frontend/css/components/patent-timeline.css">
    <link rel="stylesheet" href="frontend/css/components/field-selector.css">
    <!-- AIè¯´æ˜ä¹¦å¤„ç†å™¨CSS -->
    <link rel="stylesheet" href="frontend/css/components/ai-description-processor.css">
    <!-- åŠŸèƒ½ä¹ï¼šPDF-OCRé˜…è¯»å™¨CSS -->
    <link rel="stylesheet" href="frontend/css/components/pdf-ocr-reader.css">
    <!-- åŠŸèƒ½ä¹ï¼šPDF-OCRäº¤äº’åŠŸèƒ½CSS -->
    <link rel="stylesheet" href="frontend/css/components/pdf-ocr-interaction.css">

        <style>
            /* Vanta.js èƒŒæ™¯å®¹å™¨ */
            #vanta-bg {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -1;
                pointer-events: none;
            }
            
            /* ç¡®ä¿ä¸»å®¹å™¨æœ‰é€æ˜èƒŒæ™¯ */
            body {
                position: relative;
            }
            
            .container {
                position: relative;
                z-index: 1;
            }
            
            .preset-badge {
                display: inline-block;
                padding: 2px 6px;
                background-color: #4a6cf7;
                color: white;
                border-radius: 4px;
                font-size: 0.75em;
                margin-left: 6px;
                vertical-align: middle;
            }
        
        /* åŠŸèƒ½ä¸ƒå­æ ‡ç­¾é¡µæ ·å¼ */
        .claims-sub-tab {
            display: none;
        }
        .claims-sub-tab.active {
            display: block;
        }
        
        /* æƒåˆ©è¦æ±‚é¡¹æ ·å¼ */
        .claim-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--border-color);
            transition: all 0.3s;
        }
        
        .claim-item.independent {
            background: linear-gradient(90deg, rgba(74, 108, 247, 0.1), rgba(74, 108, 247, 0.05));
            border-left-color: var(--primary-color);
        }
        
        .claim-item.dependent {
            background: rgba(128, 128, 128, 0.05);
            border-left-color: #999;
            color: #666;
        }
        
        .claim-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .claim-number {
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .claim-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .claim-badge.independent {
            background: var(--primary-color);
            color: white;
        }
        
        .claim-badge.dependent {
            background: #999;
            color: white;
        }
        
        .claim-text {
            line-height: 1.6;
        }
        
        .claim-references {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            font-size: 0.9em;
            color: var(--text-color-secondary);
        }
        
        /* å…¶ä»–æ ·å¼ */
        </style>

</head>
<body>

<!-- å³ä¸‹è§’æ‚¬æµ®äºŒç»´ç  -->
<div id="floating-qr" class="floating-qr-container">
    <div class="floating-qr-toggle" id="qr-toggle" title="è”ç³»ä¸åé¦ˆ">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
    </div>
    <div class="floating-qr-panel" id="qr-panel">
        <div class="floating-qr-header">
            <span>è”ç³»ä¸åé¦ˆ</span>
            <button class="floating-qr-close" id="qr-close">&times;</button>
        </div>
        <div class="floating-qr-content">
            <img src="/frontend/images/QRcode.jpg" alt="å…¬ä¼—å·äºŒç»´ç ">
            <p class="floating-qr-title">IPæ™ºå‹</p>
            <p class="floating-qr-desc">æ‰«ç å…³æ³¨å…¬ä¼—å·</p>
            <p class="floating-qr-tip">åé¦ˆæ„è§ Â· äº¤æµé—®é¢˜ Â· è·å–å¸®åŠ©</p>
        </div>
    </div>
</div>

<!-- åŠ è½½è¿›åº¦é®ç½© -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <div class="tech-welcome-container">
            <div class="tech-scan-line"></div>
            <div class="tech-welcome-title">
                <span class="welcome-text-cn" id="welcome-text-cn"></span>
                <span class="tech-cursor">|</span>
            </div>
            <div class="tech-welcome-subtitle">
                <span class="welcome-text-en" id="welcome-text-en"></span>
            </div>
            <div class="tech-loading-bar">
                <div class="tech-loading-progress" id="tech-loading-progress"></div>
            </div>
        </div>
        <div class="loading-spinner-container">
            <div class="loading-spinner"></div>
            <div class="loading-spinner-ring"></div>
            <div class="loading-spinner-ring ring-2"></div>
        </div>
        <div class="loading-text" id="loading-text">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</div>
        <div id="loading-progress" class="loading-progress">åˆå§‹åŒ–ä¸­</div>
    </div>
</div>

<div id="vanta-bg"></div>

<div class="container">
    <!-- Header Component (loaded dynamically) -->
    <div id="header-component"></div>
    
    <div class="main-content">
        <!-- Tab Navigation Component (loaded dynamically) -->
        <div id="tab-navigation-component"></div>

        <!-- åŠŸèƒ½ä¸€ï¼šå³æ—¶å¯¹è¯ -->

        <!-- åŠŸèƒ½ä¸€ï¼šå³æ—¶å¯¹è¯ (loaded dynamically) -->
        <div id="instant-chat-component"></div>
        
        <!-- ====================================================================== -->
        
        <!-- Feature 2 (Async Batch) (loaded dynamically) -->
        <div id="async-batch-component"></div>
        
        
        <!-- Feature 3 (Large Batch) (loaded dynamically) -->
        <div id="large-batch-component"></div>
        
        
        <!-- Feature 4 (Local Patent Library) (loaded dynamically) -->
        <div id="local-patent-lib-component"></div>
        
        
        <!-- Feature 5 (Claims Comparison) (loaded dynamically) -->
        <div id="claims-comparison-component"></div>
        
        
        <!-- Feature 6 (Patent Batch) (loaded dynamically) -->
        <div id="patent-batch-component"></div>
        
        
        <!-- Feature 7 (Claims Processor) (loaded dynamically) -->
        <div id="claims-processor-component"></div>
        
        <!-- Feature 8 (Drawing Marker) (loaded dynamically) -->
        <div id="drawing-marker-component"></div>
        
        <!-- Feature 9 (PDF OCR Reader) (loaded dynamically) -->
        <div id="pdf-ocr-reader-component"></div>
        

<!-- åŠŸèƒ½å…«ï¼šä¸“åˆ©é™„å›¾æ ‡è®°åŠŸèƒ½ -->
<script src="frontend/js/multiImageViewer_v8.js?v=20260201"></script>
<!-- AIè¯´æ˜ä¹¦å¤„ç†å™¨ -->
<script src="frontend/js/ai_description/ai_processing_panel.js?v=20260201"></script>
<script src="frontend/js/ai_description/prompt_editor.js?v=20260201"></script>
<!-- åŠŸèƒ½å…«ï¼šç¼“å­˜ç®¡ç†å™¨ï¼ˆå¿…é¡»åœ¨é‡æ–°å¤„ç†ç®¡ç†å™¨ä¹‹å‰åŠ è½½ï¼‰ -->
<script src="frontend/js/drawingCacheManager.js?v=20260205"></script>
<!-- åŠŸèƒ½å…«ï¼šé‡æ–°å¤„ç†ç®¡ç†å™¨ -->
<script src="frontend/js/drawingReprocessManager.js?v=20260205"></script>
<!-- åŠŸèƒ½å…«ï¼šåˆå§‹åŒ–æ¨¡å— -->
<script src="js/modules/drawing-marker/drawing-marker-init.js?v=20260207"></script>
<script>
// ä¸“åˆ©é™„å›¾æ ‡è®°åŠŸèƒ½æ•°æ®å­˜å‚¨
let uploadedDrawings = [];
let currentReferenceMap = {}; // å­˜å‚¨è¯´æ˜ä¹¦ä¸­çš„æ ‡è®°æ˜ å°„

// Note: Initialization is now handled by js/modules/drawing-marker/drawing-marker-init.js
// which is called by main.js after the component loads

// å°è¯•æ¢å¤ç¼“å­˜çš„å¤„ç†ç»“æœï¼ˆæ”¹è¿›ç‰ˆï¼šæ£€æµ‹è¾“å…¥å˜åŒ–ï¼‰
function restoreCachedProcessingResult() {
    const specificationInput = document.getElementById('specification_input');
    if (!specificationInput) return;
    
    // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ‰‹åŠ¨ä¿å­˜çš„ç¼“å­˜æ ‡è®°
    const hasSavedCache = localStorage.getItem('drawing_cache_saved') === 'true';
    
    if (!hasSavedCache) {
        console.log('âš ï¸ æ²¡æœ‰æ‰‹åŠ¨ä¿å­˜çš„ç¼“å­˜ï¼Œè·³è¿‡è‡ªåŠ¨æ¢å¤');
        return;
    }
    
    // å°è¯•ä»localStorageæ¢å¤å¤„ç†ç»“æœ
    try {
        console.log('å¼€å§‹æ£€æŸ¥ç¼“å­˜...');
        let latestCache = null;
        let latestCacheKey = null;
        let latestTimestamp = 0;
        
        // éå†æ‰€æœ‰localStorageé¡¹ï¼ŒæŸ¥æ‰¾å¤„ç†ç¼“å­˜
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('processing_cache_')) {
                try {
                    const cacheData = JSON.parse(localStorage.getItem(key));
                    if (cacheData && cacheData.timestamp) {
                        // æ£€æŸ¥ç¼“å­˜æ˜¯å¦åœ¨24å°æ—¶å†…
                        const elapsed = Date.now() - cacheData.timestamp;
                        if (elapsed < 24 * 60 * 60 * 1000) {
                            // æ‰¾åˆ°æœ€æ–°çš„ç¼“å­˜
                            if (cacheData.timestamp > latestTimestamp) {
                                latestTimestamp = cacheData.timestamp;
                                latestCache = cacheData;
                                latestCacheKey = key;
                            }
                        } else {
                            // ç¼“å­˜è¿‡æœŸï¼Œåˆ é™¤
                            localStorage.removeItem(key);
                            console.log('ç¼“å­˜å·²è¿‡æœŸï¼Œå·²åˆ é™¤:', key);
                        }
                    }
                } catch (parseError) {
                    console.warn('è§£æç¼“å­˜å¤±è´¥ï¼Œåˆ é™¤æ— æ•ˆç¼“å­˜:', key);
                    localStorage.removeItem(key);
                }
            }
        }
        
        // å¦‚æœæ‰¾åˆ°æœ€æ–°çš„ç¼“å­˜
        if (latestCache) {
            console.log('âœ… å‘ç°æ‰‹åŠ¨ä¿å­˜çš„ç¼“å­˜ï¼Œå°è¯•æ¢å¤...', latestCacheKey);
            
            // æ¢å¤ä¸Šä¼ çš„å›¾ç‰‡
            if (latestCache.uploadedDrawings) {
                uploadedDrawings = latestCache.uploadedDrawings.map(d => ({
                    ...d,
                    id: Date.now() + Math.random()
                }));
                console.log('å·²æ¢å¤', uploadedDrawings.length, 'å¼ ä¸Šä¼ çš„å›¾ç‰‡');
                
                // æ›´æ–°ä¸Šä¼ å›¾ç‰‡çš„æ˜¾ç¤º
                if (typeof updateUploadedDrawingsDisplay === 'function') {
                    updateUploadedDrawingsDisplay();
                } else if (typeof updateUploadedDrawingsList === 'function') {
                    updateUploadedDrawingsList();
                }
            }
            
            // æ¢å¤è¯´æ˜ä¹¦å†…å®¹
            if (latestCache.specification) {
                specificationInput.value = latestCache.specification;
                console.log('å·²æ¢å¤è¯´æ˜ä¹¦å†…å®¹');
            }
            
            // æ¢å¤å¤„ç†ç»“æœ
            displayProcessingResult(latestCache.data, latestCache.isAIMode);
            console.log('å¤„ç†ç»“æœå·²ä»ç¼“å­˜æ¢å¤');
        } else {
            console.log('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ç¼“å­˜');
        }
    } catch (e) {
        console.warn('æ¢å¤ç¼“å­˜å¤±è´¥:', e);
    }
}

// å¤„ç†å›¾ç‰‡ä¸Šä¼ 
function handleDrawingUpload(event) {
    const files = event.target.files;
    if (files.length === 0) return;

    // å¤„ç†æ¯ä¸ªä¸Šä¼ çš„æ–‡ä»¶
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.type.startsWith('image/')) {
            processImageFile(file);
        } else {
            alert(`æ–‡ä»¶ ${file.name} ä¸æ˜¯å›¾ç‰‡æ ¼å¼ï¼Œè¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ã€‚`);
        }
    }

    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
    event.target.value = '';
}

// å¤„ç†å›¾ç‰‡ç²˜è´´
function handleDrawingPaste(event) {
    const items = event.clipboardData.items;
    if (!items) return;

    // æŸ¥æ‰¾ç²˜è´´çš„å›¾ç‰‡
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.startsWith('image/')) {
            const file = items[i].getAsFile();
            processImageFile(file);
            break;
        }
    }
}

// å¤„ç†å›¾ç‰‡æ–‡ä»¶
function processImageFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = {
            id: Date.now() + Math.random(),
            name: file.name,
            type: file.type,
            size: file.size,
            dataUrl: e.target.result,
            rotation: 0
        };
        
        uploadedDrawings.push(imageData);
        updateUploadedDrawingsList();
        
        // ğŸ”¥ æ–°å¢ï¼šå›¾ç‰‡å˜åŒ–æ—¶æ¸…é™¤ç¼“å­˜æ ‡è®°
        clearCacheOnInputChange('å›¾ç‰‡ä¸Šä¼ ');
    };
    reader.readAsDataURL(file);
}

// ğŸ”¥ æ–°å¢ï¼šå½“è¾“å…¥å‘ç”Ÿå˜åŒ–æ—¶æ¸…é™¤ç¼“å­˜
function clearCacheOnInputChange(changeType) {
    // æ¸…é™¤ä¿å­˜æ ‡è®°
    localStorage.removeItem('drawing_cache_saved');
    
    // æ¸…é™¤æ‰€æœ‰å¤„ç†ç¼“å­˜
    let removedCount = 0;
    for (let i = localStorage.length - 1; i >= 0; i--) {
        const key = localStorage.key(i);
        if (key && (key.startsWith('processing_cache_') || key.startsWith('cache_'))) {
            localStorage.removeItem(key);
            removedCount++;
        }
    }
    
    console.log(`ğŸ”„ ${changeType}å˜åŒ–ï¼Œå·²æ¸…é™¤ ${removedCount} ä¸ªç¼“å­˜`);
    
    // æ¸…ç©ºæ ‡æ³¨ç»“æœæ˜¾ç¤º
    const annotatedDrawingsContainer = document.getElementById('annotated_drawings_container');
    if (annotatedDrawingsContainer) {
        annotatedDrawingsContainer.innerHTML = '<div style="color: #6c757d; font-size: 14px; text-align: center; padding: 40px; background-color: #f8f9fa; border-radius: 6px; border: 2px dashed #dee2e6;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 10px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg><div>å¤„ç†å®Œæˆåï¼Œæ ‡æ³¨åçš„é™„å›¾å°†æ˜¾ç¤ºåœ¨æ­¤å¤„</div></div>';
    }
    
    // æ¸…ç©ºå¤„ç†ç»“æœ
    const processingResult = document.getElementById('processing_result');
    if (processingResult) {
        processingResult.innerHTML = '<div style="color: #6c757d; font-size: 14px; text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 6px;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> è¯·ä¸Šä¼ å›¾ç‰‡å’Œè¾“å…¥è¯´æ˜ä¹¦ï¼Œç„¶åç‚¹å‡»"å¼€å§‹å¤„ç†"</div>';
    }
}

// æ›´æ–°ä¸Šä¼ å›¾ç‰‡åˆ—è¡¨
function updateUploadedDrawingsList() {
    const listContainer = document.getElementById('uploaded_drawings_list');
    if (!listContainer) return;

    if (uploadedDrawings.length === 0) {
        listContainer.innerHTML = '<div style="color: #6c757d; font-size: 12px; text-align: center; padding: 10px;">æš‚æ— å›¾ç‰‡</div>';
        return;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
    uploadedDrawings.forEach((drawing, index) => {
        const sizeKB = (drawing.size / 1024).toFixed(1);
        const rotation = drawing.rotation || 0;
        html += `
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background-color: white; border: 1px solid #dee2e6; border-radius: 6px; position: relative;">
                <div style="position: relative; width: 40px; height: 40px; flex-shrink: 0;">
                    <img src="${drawing.dataUrl}" 
                         alt="${drawing.name}" 
                         class="drawing-thumbnail"
                         data-index="${index}"
                         style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer; transition: transform 0.2s;">
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 12px; color: #495057; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${drawing.name}</div>
                    <div style="font-size: 11px; color: #adb5bd;">${sizeKB} KB | æ—‹è½¬: ${rotation}Â°</div>
                </div>
                <div style="display: flex; gap: 5px; flex-shrink: 0;">
                    <button onclick="rotateDrawing(${index}, -90)" style="padding: 4px 8px; font-size: 11px; background-color: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;" title="é€†æ—¶é’ˆæ—‹è½¬90Â°">â†¶</button>
                    <button onclick="rotateDrawing(${index}, 90)" style="padding: 4px 8px; font-size: 11px; background-color: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;" title="é¡ºæ—¶é’ˆæ—‹è½¬90Â°">â†·</button>
                    <button onclick="previewDrawing(${index})" style="padding: 4px 8px; font-size: 11px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;" title="é¢„è§ˆå¤§å›¾">ğŸ‘</button>
                    <button onclick="removeDrawing(${index})" style="padding: 4px 8px; font-size: 11px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;" title="åˆ é™¤">âœ•</button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    listContainer.innerHTML = html;
    
    // æ·»åŠ é¼ æ ‡æ‚¬æµ®é¢„è§ˆåŠŸèƒ½
    setTimeout(() => {
        document.querySelectorAll('.drawing-thumbnail').forEach(img => {
            img.addEventListener('mouseenter', showImagePreview);
            img.addEventListener('mouseleave', hideImagePreview);
        });
    }, 0);
}

// åˆ é™¤å•ä¸ªå›¾ç‰‡
function removeDrawing(index) {
    uploadedDrawings.splice(index, 1);
    updateUploadedDrawingsList();
    
    // ğŸ”¥ æ–°å¢ï¼šå›¾ç‰‡åˆ é™¤æ—¶æ¸…é™¤ç¼“å­˜
    clearCacheOnInputChange('å›¾ç‰‡åˆ é™¤');
}

// æ—‹è½¬å›¾ç‰‡ï¼ˆä¿®å¤ç‰ˆï¼šæ¯æ¬¡æ—‹è½¬90åº¦ï¼Œç´¯åŠ è§’åº¦ï¼‰
function rotateDrawing(index, degrees) {
    const drawing = uploadedDrawings[index];
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const image = new Image();
    
    image.onload = function() {
        // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç´¯åŠ çš„æ—‹è½¬è§’åº¦
        const currentRotation = drawing.rotation || 0;
        const newRotation = (currentRotation + degrees + 360) % 360; // ç¡®ä¿è§’åº¦åœ¨0-360ä¹‹é—´
        
        // ğŸ”¥ ä¿®å¤ï¼šæ ¹æ®æ—‹è½¬è§’åº¦å†³å®šç”»å¸ƒå°ºå¯¸
        // 90åº¦å’Œ270åº¦æ—¶éœ€è¦äº¤æ¢å®½é«˜
        const isVertical = (newRotation === 90 || newRotation === 270);
        canvas.width = isVertical ? image.height : image.width;
        canvas.height = isVertical ? image.width : image.height;
        
        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // æ—‹è½¬å¹¶ç»˜åˆ¶
        ctx.save();
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate((degrees * Math.PI) / 180); // ğŸ”¥ ä¿®å¤ï¼šåªæ—‹è½¬å¢é‡è§’åº¦
        ctx.drawImage(image, -image.width / 2, -image.height / 2);
        ctx.restore();
        
        // æ›´æ–°å›¾ç‰‡æ•°æ®
        uploadedDrawings[index].dataUrl = canvas.toDataURL('image/png');
        uploadedDrawings[index].rotation = newRotation;
        
        console.log(`å›¾ç‰‡ ${index} æ—‹è½¬: ${currentRotation}Â° â†’ ${newRotation}Â°`);
        
        // æ›´æ–°åˆ—è¡¨æ˜¾ç¤º
        updateUploadedDrawingsList();
        
        // ğŸ”¥ æ–°å¢ï¼šå›¾ç‰‡æ—‹è½¬æ—¶æ¸…é™¤ç¼“å­˜
        clearCacheOnInputChange('å›¾ç‰‡æ—‹è½¬');
    };
    
    // ğŸ”¥ å…³é”®ï¼šä½¿ç”¨å½“å‰å·²æ—‹è½¬çš„å›¾ç‰‡ä½œä¸ºåŸºç¡€
    image.src = drawing.dataUrl;
}

// é¢„è§ˆå›¾ç‰‡å¤§å›¾
function previewDrawing(index) {
    const drawing = uploadedDrawings[index];
    
    // åˆ›å»ºé¢„è§ˆå¼¹çª—
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    `;
    
    // å›¾ç‰‡ä¿¡æ¯
    const info = document.createElement('div');
    info.style.cssText = `
        color: white;
        font-size: 16px;
        margin-bottom: 20px;
        text-align: center;
        padding: 10px 20px;
        background-color: rgba(0, 0, 0, 0.7);
        border-radius: 8px;
    `;
    info.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">${drawing.name}</div>
        <div style="font-size: 14px; color: #aaa;">
            å¤§å°: ${(drawing.size / 1024).toFixed(1)} KB | 
            æ—‹è½¬: ${drawing.rotation || 0}Â° | 
            ç‚¹å‡»ä»»æ„å¤„å…³é—­
        </div>
    `;
    
    // å¤§å›¾
    const img = document.createElement('img');
    img.src = drawing.dataUrl;
    img.style.cssText = `
        max-width: 90%;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    `;
    
    modal.appendChild(info);
    modal.appendChild(img);
    
    // ç‚¹å‡»å…³é—­
    modal.addEventListener('click', () => {
        modal.remove();
    });
    
    // ESCé”®å…³é—­
    const handleEsc = (e) => {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', handleEsc);
        }
    };
    document.addEventListener('keydown', handleEsc);
    
    document.body.appendChild(modal);
}

// é¼ æ ‡æ‚¬æµ®æ˜¾ç¤ºé¢„è§ˆ
let previewTooltip = null;
function showImagePreview(event) {
    const img = event.target;
    const index = parseInt(img.dataset.index);
    const drawing = uploadedDrawings[index];
    
    // åˆ›å»ºé¢„è§ˆæç¤ºæ¡†
    previewTooltip = document.createElement('div');
    previewTooltip.style.cssText = `
        position: fixed;
        z-index: 9999;
        background-color: white;
        border: 2px solid #28a745;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        pointer-events: none;
        max-width: 400px;
    `;
    
    const previewImg = document.createElement('img');
    previewImg.src = drawing.dataUrl;
    previewImg.style.cssText = `
        width: 300px;
        height: auto;
        display: block;
        border-radius: 4px;
    `;
    
    const previewInfo = document.createElement('div');
    previewInfo.style.cssText = `
        margin-top: 8px;
        font-size: 12px;
        color: #666;
        text-align: center;
    `;
    previewInfo.textContent = `${drawing.name} | ${drawing.rotation || 0}Â°`;
    
    previewTooltip.appendChild(previewImg);
    previewTooltip.appendChild(previewInfo);
    document.body.appendChild(previewTooltip);
    
    // å®šä½é¢„è§ˆæ¡†ï¼ˆè·Ÿéšé¼ æ ‡ï¼‰
    const updatePosition = (e) => {
        if (!previewTooltip) return;
        const x = e.clientX + 20;
        const y = e.clientY + 20;
        
        // é˜²æ­¢è¶…å‡ºå±å¹•
        const maxX = window.innerWidth - previewTooltip.offsetWidth - 20;
        const maxY = window.innerHeight - previewTooltip.offsetHeight - 20;
        
        previewTooltip.style.left = Math.min(x, maxX) + 'px';
        previewTooltip.style.top = Math.min(y, maxY) + 'px';
    };
    
    updatePosition(event);
    img.addEventListener('mousemove', updatePosition);
    img.dataset.mousemoveHandler = 'attached';
}

function hideImagePreview(event) {
    if (previewTooltip) {
        previewTooltip.remove();
        previewTooltip = null;
    }
    
    const img = event.target;
    if (img.dataset.mousemoveHandler) {
        delete img.dataset.mousemoveHandler;
    }
}

// æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡
function clearAllDrawings() {
    uploadedDrawings = [];
    updateUploadedDrawingsList();
    
    // æ¸…ç©ºè¯´æ˜ä¹¦è¾“å…¥
    const specificationInput = document.getElementById('specification_input');
    if (specificationInput) {
        specificationInput.value = '';
    }
    
    // æ¸…ç©ºå¤„ç†ç»“æœ
    const processingResult = document.getElementById('processing_result');
    if (processingResult) {
        processingResult.innerHTML = '<div style="color: #6c757d; font-size: 14px; text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 6px;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> è¯·ä¸Šä¼ å›¾ç‰‡å’Œè¾“å…¥è¯´æ˜ä¹¦ï¼Œç„¶åç‚¹å‡»"å¼€å§‹å¤„ç†"</div>';
    }
    
    // æ¸…ç©ºæ ‡æ³¨åçš„é™„å›¾
    const annotatedDrawingsContainer = document.getElementById('annotated_drawings_container');
    if (annotatedDrawingsContainer) {
        annotatedDrawingsContainer.innerHTML = '<div style="color: #6c757d; font-size: 14px; text-align: center; padding: 40px; background-color: #f8f9fa; border-radius: 6px; border: 2px dashed #dee2e6;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 10px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg><div>å¤„ç†å®Œæˆåï¼Œæ ‡æ³¨åçš„é™„å›¾å°†æ˜¾ç¤ºåœ¨æ­¤å¤„</div></div>';
    }
    
    // æ¸…ç©ºå¤„ç†çŠ¶æ€
    const processingStatus = document.getElementById('processing_status');
    if (processingStatus) {
        processingStatus.textContent = '';
    }
}

// ç”Ÿæˆç¼“å­˜é”®çš„è¾…åŠ©å‡½æ•°
function generateProcessingCacheKey(drawings, specification) {
    // åŸºäºæ–‡ä»¶åã€æ•°é‡ã€é¡ºåºå’Œè¯´æ˜ä¹¦å†…å®¹ç”Ÿæˆå”¯ä¸€ç¼“å­˜é”®
    const drawingInfo = drawings.map(d => {
        return d.name + '_' + d.size + '_' + (d.id || Date.now() + Math.random());
    }).sort().join('|');
    const specHash = specification.length + '_' + (specification.substring(0, 200) || 'empty') + '_' + Math.random().toString(36).substr(2, 9);
    const timestamp = Date.now();
    
    // å®‰å…¨ç”Ÿæˆç¼“å­˜é”®ï¼Œå¤„ç†éASCIIå­—ç¬¦
    try {
        // å…ˆç¼–ç ä¸ºUTF-8ï¼Œå†è¿›è¡Œbase64ç¼–ç 
        const input = drawingInfo + '_' + specHash + '_' + timestamp;
        const encoded = btoa(unescape(encodeURIComponent(input)));
        return 'cache_' + encoded.substring(0, 100);
    } catch (error) {
        // å¦‚æœç¼–ç å¤±è´¥ï¼Œä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ
        console.warn('ç¼“å­˜é”®ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ:', error);
        // ä½¿ç”¨ç®€å•çš„å“ˆå¸Œæ–¹æ¡ˆ
        let hash = 0;
        const input = drawingInfo + '_' + specHash + '_' + timestamp;
        for (let i = 0; i < input.length; i++) {
            const char = input.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return 'cache_' + Math.abs(hash).toString(36) + '_' + timestamp.toString(36).substr(0, 8);
    }
}

// å¼€å§‹å¤„ç†
function startProcessing() {
    // è¡¨å•éªŒè¯
    if (uploadedDrawings.length === 0) {
        alert('è¯·å…ˆä¸Šä¼ æˆ–ç²˜è´´ä¸“åˆ©é™„å›¾ã€‚');
        return;
    }
    
    const specificationInput = document.getElementById('specification_input');
    if (!specificationInput || specificationInput.value.trim() === '') {
        alert('è¯·è¾“å…¥è¯´æ˜ä¹¦å†…å®¹ã€‚');
        return;
    }
    
    // ğŸ”¥ ä¿®æ”¹ï¼šä¸å†è‡ªåŠ¨æ¸…é™¤ç¼“å­˜ï¼Œè€Œæ˜¯åœ¨è¾“å…¥å˜åŒ–æ—¶æ¸…é™¤
    console.log('å¼€å§‹å¤„ç†ï¼Œä½¿ç”¨å½“å‰è¾“å…¥...');
    
    // è·å–AIå¤„ç†é…ç½®
    const aiConfig = window.aiProcessingPanel ? window.aiProcessingPanel.getConfig() : { aiMode: false };
    
    // å¦‚æœå¯ç”¨AIæ¨¡å¼ä½†æœªé€‰æ‹©æ¨¡å‹,æç¤ºç”¨æˆ·
    if (aiConfig.aiMode && !aiConfig.model) {
        alert('è¯·é€‰æ‹©AIæ¨¡å‹ã€‚');
        return;
    }
    
    // ç¦ç”¨å¼€å§‹å¤„ç†æŒ‰é’®,é˜²æ­¢é‡å¤æäº¤
    const startBtn = document.getElementById('start_processing_btn');
    if (startBtn) {
        startBtn.disabled = true;
        startBtn.style.opacity = '0.6';
        startBtn.style.cursor = 'not-allowed';
    }
    
    // æ˜¾ç¤ºè¿›åº¦åé¦ˆ
    const processingStatus = document.getElementById('processing_status');
    if (processingStatus) {
        if (aiConfig.aiMode) {
            // AIæ¨¡å¼æ˜¾ç¤ºè¯¦ç»†è¿›åº¦
            processingStatus.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div class="spinner" style="width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #28a745; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span id="progress_text">æ­£åœ¨æ£€æµ‹è¯­è¨€...</span>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            // ä¼˜åŒ–è¿›åº¦æ›´æ–°é€»è¾‘ï¼Œæ›´é¢‘ç¹åœ°æ›´æ–°çŠ¶æ€
            let progressStep = 0;
            const progressTexts = [
                'æ­£åœ¨å¤„ç†æ•°æ®...',
                'æ­£åœ¨åˆ†æé™„å›¾...',
                'æ­£åœ¨AIè¯†åˆ«æ ‡è®°...',
                'æ­£åœ¨ç”Ÿæˆç»“æœ...'
            ];
            
            const progressInterval = setInterval(() => {
                progressStep++;
                if (progressStep < progressTexts.length) {
                    const progressText = document.getElementById('progress_text');
                    if (progressText) {
                        progressText.textContent = progressTexts[progressStep];
                    }
                } else {
                    // å¾ªç¯æ˜¾ç¤ºè¿›åº¦ï¼Œè®©ç”¨æˆ·æ„Ÿè§‰å¤„ç†åœ¨æŒç»­è¿›è¡Œ
                    progressStep = 0;
                    const progressText = document.getElementById('progress_text');
                    if (progressText) {
                        progressText.textContent = progressTexts[progressStep];
                    }
                }
            }, 1000); // æ¯1ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦æ–‡æœ¬ï¼Œæé«˜ç”¨æˆ·æ„ŸçŸ¥
            
            // ä¿å­˜interval IDä»¥ä¾¿åç»­æ¸…é™¤
            window.currentProgressInterval = progressInterval;
        } else {
            // è§„åˆ™æ¨¡å¼æ˜¾ç¤ºç®€å•è¿›åº¦
            processingStatus.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div class="spinner" style="width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #28a745; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span>æ­£åœ¨å¤„ç†...</span>
                </div>
            `;
        }
    }
    
    // å‡†å¤‡æ•°æ®
    const processingData = {
        drawings: uploadedDrawings.map(drawing => {
            // ç§»é™¤data URLå‰ç¼€ï¼Œåªä¿ç•™base64æ•°æ®
            const base64Data = drawing.dataUrl.split(',')[1];
            return {
                name: drawing.name,
                type: drawing.type,
                size: drawing.size,
                data: base64Data
            };
        }),
        specification: specificationInput.value.trim(),
        // æ·»åŠ AIæ¨¡å¼é…ç½®
        ai_mode: aiConfig.aiMode,
        model_name: aiConfig.model,
        custom_prompt: aiConfig.prompt
    };
    
    // è®¾ç½®è¶…æ—¶æ—¶é—´(AIæ¨¡å¼60ç§’,è§„åˆ™æ¨¡å¼30ç§’)
    const timeoutMs = aiConfig.aiMode ? 60000 : 30000;
    const timeoutId = setTimeout(() => {
        // è¶…æ—¶å¤„ç†
        if (window.currentProgressInterval) {
            clearInterval(window.currentProgressInterval);
        }
        
        if (processingStatus) {
            processingStatus.innerHTML = `
                <div style="color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 4px; border: 1px solid #ffeaa7;">
                    âš ï¸ å¤„ç†è¶…æ—¶,è¯·é‡è¯•æˆ–ç¼©çŸ­è¯´æ˜ä¹¦é•¿åº¦
                </div>
            `;
        }
        
        // é‡æ–°å¯ç”¨æŒ‰é’®
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.style.opacity = '1';
            startBtn.style.cursor = 'pointer';
        }
    }, timeoutMs);
    
    // è·å–API Keyï¼ˆAIæ¨¡å¼éœ€è¦ï¼‰
    const apiKey = appState?.apiKey || localStorage.getItem('zhipuai_api_key') || '';
    
    // å‡†å¤‡è¯·æ±‚å¤´
    const headers = {
        'Content-Type': 'application/json'
    };
    
    // å¦‚æœæ˜¯AIæ¨¡å¼ï¼Œå¿…é¡»æ·»åŠ Authorization header
    if (aiConfig.aiMode) {
        if (!apiKey) {
            if (processingStatus) {
                processingStatus.innerHTML = `
                    <div style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                        âŒ AIæ¨¡å¼éœ€è¦API Key
                    </div>
                `;
            }
            alert('AIæ¨¡å¼éœ€è¦é…ç½®API Keyã€‚è¯·ç‚¹å‡»å³ä¸Šè§’âš™ï¸è®¾ç½®å¹¶ä¿å­˜æ‚¨çš„æ™ºè°±AI API Keyã€‚');
            
            // é‡æ–°å¯ç”¨æŒ‰é’®
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                startBtn.style.cursor = 'pointer';
            }
            return;
        }
        headers['Authorization'] = `Bearer ${apiKey}`;
    }
    
    // è°ƒç”¨åç«¯APIè¿›è¡Œå¤„ç†
    fetch('/api/drawing-marker/process', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(processingData)
    })
    .then(response => {
        clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        if (window.currentProgressInterval) {
            clearInterval(window.currentProgressInterval); // æ¸…é™¤è¿›åº¦æ›´æ–°å®šæ—¶å™¨
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.data) {
            displayProcessingResult(data.data, aiConfig.aiMode);
        } else {
            // å¤„ç†å¤±è´¥
            if (processingStatus) {
                processingStatus.innerHTML = `
                    <div style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                        âŒ å¤„ç†å¤±è´¥
                    </div>
                `;
            }
            
            const processingResult = document.getElementById('processing_result');
            if (processingResult) {
                processingResult.innerHTML = `
                    <div style="padding: 15px; background-color: rgba(220, 53, 69, 0.1); border-radius: 8px; border: 1px solid rgba(220, 53, 69, 0.3);">
                        <h4 style="color: var(--error-color); margin-bottom: 10px;">âŒ å¤„ç†å¤±è´¥</h4>
                        <p>${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                    </div>
                `;
            }
        }
    })
    .catch(error => {
        clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        if (window.currentProgressInterval) {
            clearInterval(window.currentProgressInterval); // æ¸…é™¤è¿›åº¦æ›´æ–°å®šæ—¶å™¨
        }
        
        console.error('å¤„ç†å¤±è´¥:', error);
        if (processingStatus) {
            processingStatus.innerHTML = `
                <div style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                    âŒ ç½‘ç»œé”™è¯¯
                </div>
            `;
        }
        
        const processingResult = document.getElementById('processing_result');
        if (processingResult) {
            processingResult.innerHTML = `
                <div style="padding: 15px; background-color: rgba(220, 53, 69, 0.1); border-radius: 8px; border: 1px solid rgba(220, 53, 69, 0.3);">
                    <h4 style="color: var(--error-color); margin-bottom: 10px;">âŒ å¤„ç†å¤±è´¥</h4>
                    <p>ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é—®é¢˜ï¼Œè¯·é‡è¯•ã€‚</p>
                </div>
            `;
        }
    })
    .finally(() => {
        // é‡æ–°å¯ç”¨æŒ‰é’®
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.style.opacity = '1';
            startBtn.style.cursor = 'pointer';
        }
    });
}

// ğŸ†• æ™ºèƒ½é‡æ–°å¤„ç†OCRï¼ˆæ£€æµ‹å›¾ç‰‡å˜åŒ–ï¼Œè‡ªåŠ¨é€‰æ‹©å¤„ç†æ¨¡å¼ï¼‰
function reprocessOCR() {
    // è¡¨å•éªŒè¯
    if (uploadedDrawings.length === 0) {
        alert('è¯·å…ˆä¸Šä¼ æˆ–ç²˜è´´ä¸“åˆ©é™„å›¾ã€‚');
        return;
    }
    
    const specificationInput = document.getElementById('specification_input');
    if (!specificationInput || specificationInput.value.trim() === '') {
        alert('è¯·è¾“å…¥è¯´æ˜ä¹¦å†…å®¹ã€‚');
        return;
    }
    
    // ğŸ” æ™ºèƒ½æ£€æµ‹ï¼šæ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ—‹è½¬æˆ–å˜åŒ–
    const hasRotation = uploadedDrawings.some(d => d.rotation && d.rotation !== 0);
    const hasCache = window.reprocessManager && window.reprocessManager.currentState.hasOCRCache;
    
    let confirmMessage = '';
    if (hasRotation && hasCache) {
        confirmMessage = `æ£€æµ‹åˆ°å›¾ç‰‡å·²æ—‹è½¬ï¼Œå°†æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°è¯†åˆ«OCRã€‚\n\næ—‹è½¬çš„å›¾ç‰‡ï¼š${uploadedDrawings.filter(d => d.rotation).length} å¼ \n\næ˜¯å¦ç»§ç»­ï¼Ÿ`;
    } else if (hasCache) {
        confirmMessage = `æ£€æµ‹åˆ°å·²æœ‰OCRç¼“å­˜ï¼Œå°†æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°è¯†åˆ«ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`;
    }
    
    if (confirmMessage && !confirm(confirmMessage)) {
        return;
    }
    
    // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è¯†åˆ«OCR
    console.log('ğŸ”„ æ™ºèƒ½é‡æ–°è¯†åˆ«OCRï¼šæ¸…é™¤ç¼“å­˜ï¼Œä½¿ç”¨å½“å‰å›¾ç‰‡çŠ¶æ€ï¼ˆåŒ…æ‹¬æ—‹è½¬ï¼‰');
    clearCacheOnInputChange('æ™ºèƒ½é‡æ–°è¯†åˆ«OCR');
    
    // è·å–AIå¤„ç†é…ç½®
    const aiConfig = window.aiProcessingPanel ? window.aiProcessingPanel.getConfig() : { aiMode: false };
    
    if (aiConfig.aiMode && !aiConfig.model) {
        alert('è¯·é€‰æ‹©AIæ¨¡å‹ã€‚');
        return;
    }
    
    // ç¦ç”¨æ‰€æœ‰å¤„ç†æŒ‰é’®
    const reprocessOcrBtn = document.getElementById('reprocess_ocr_btn');
    const reprocessSpecBtn = document.getElementById('reprocess_spec_btn');
    const startBtn = document.getElementById('start_processing_btn');
    
    [reprocessOcrBtn, reprocessSpecBtn, startBtn].forEach(btn => {
        if (btn) {
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
        }
    });
    
    // æ˜¾ç¤ºè¿›åº¦åé¦ˆ
    const processingStatus = document.getElementById('processing_status');
    if (processingStatus) {
        processingStatus.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <div class="spinner" style="width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="color: #2196F3;">æ­£åœ¨é‡æ–°è¯†åˆ«OCR${hasRotation ? 'ï¼ˆå«æ—‹è½¬ï¼‰' : ''}...</span>
            </div>
        `;
    }
    
    // å‡†å¤‡æ•°æ®
    const processingData = {
        drawings: uploadedDrawings.map(drawing => {
            const base64Data = drawing.dataUrl.split(',')[1];
            return {
                name: drawing.name,
                type: drawing.type,
                size: drawing.size,
                data: base64Data,
                rotation: drawing.rotation || 0
            };
        }),
        specification: specificationInput.value.trim(),
        ai_mode: aiConfig.aiMode,
        model_name: aiConfig.model,
        custom_prompt: aiConfig.prompt
    };
    
    console.log(`ğŸ”„ æ™ºèƒ½é‡æ–°è¯†åˆ«OCRï¼š${uploadedDrawings.length} å¼ å›¾ç‰‡`);
    uploadedDrawings.forEach((d, i) => {
        if (d.rotation) {
            console.log(`  å›¾ç‰‡ ${i}: ${d.name} - æ—‹è½¬ ${d.rotation}Â°`);
        }
    });
    
    const timeoutMs = aiConfig.aiMode ? 60000 : 30000;
    const timeoutId = setTimeout(() => {
        if (processingStatus) {
            processingStatus.innerHTML = `
                <div style="color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 4px; border: 1px solid #ffeaa7;">
                    âš ï¸ å¤„ç†è¶…æ—¶,è¯·é‡è¯•
                </div>
            `;
        }
        [reprocessOcrBtn, reprocessSpecBtn, startBtn].forEach(btn => {
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
    }, timeoutMs);
    
    const apiKey = appState?.apiKey || localStorage.getItem('zhipuai_api_key') || '';
    const headers = { 'Content-Type': 'application/json' };
    
    if (aiConfig.aiMode) {
        if (!apiKey) {
            alert('AIæ¨¡å¼éœ€è¦é…ç½®API Keyã€‚');
            [reprocessOcrBtn, reprocessSpecBtn, startBtn].forEach(btn => {
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
            return;
        }
        headers['Authorization'] = `Bearer ${apiKey}`;
    }
    
    fetch('/api/drawing-marker/process', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(processingData)
    })
    .then(response => {
        clearTimeout(timeoutId);
        return response.json();
    })
    .then(data => {
        if (data.success && data.data) {
            displayProcessingResult(data.data, aiConfig.aiMode);
            if (processingStatus) {
                processingStatus.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;"><polyline points="20 6 9 17 4 12"></polyline></svg> OCRè¯†åˆ«å®Œæˆ';
                processingStatus.style.color = '#2196F3';
            }
        } else {
            if (processingStatus) {
                processingStatus.innerHTML = `
                    <div style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                        âŒ OCRè¯†åˆ«å¤±è´¥
                    </div>
                `;
            }
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('OCRè¯†åˆ«å¤±è´¥:', error);
        if (processingStatus) {
            processingStatus.innerHTML = `
                <div style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                    âŒ ç½‘ç»œé”™è¯¯
                </div>
            `;
        }
    })
    .finally(() => {
        [reprocessOcrBtn, reprocessSpecBtn, startBtn].forEach(btn => {
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
    });
}

// ğŸ†• æ™ºèƒ½é‡æ–°åŒ¹é…è¯´æ˜ä¹¦ï¼ˆæ£€æµ‹è¯´æ˜ä¹¦å˜åŒ–ï¼Œä½¿ç”¨ç¼“å­˜OCRï¼‰
function reprocessSpecification() {
    // è¡¨å•éªŒè¯
    const specificationInput = document.getElementById('specification_input');
    if (!specificationInput || specificationInput.value.trim() === '') {
        alert('è¯·è¾“å…¥è¯´æ˜ä¹¦å†…å®¹ã€‚');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„OCRç»“æœ
    let hasCachedOCR = false;
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('processing_cache_')) {
            try {
                const cached = JSON.parse(localStorage.getItem(key));
                if (cached && cached.data && cached.data.ocr_detected_count > 0) {
                    hasCachedOCR = true;
                    break;
                }
            } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
            }
        }
    }
    
    if (!hasCachedOCR) {
        alert('æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜çš„OCRè¯†åˆ«ç»“æœã€‚è¯·å…ˆç‚¹å‡»"è¯†åˆ«OCR"æˆ–"å¼€å§‹å¤„ç†"æŒ‰é’®ã€‚');
        return;
    }
    
    console.log('ğŸ”„ é‡æ–°åŒ¹é…è¯´æ˜ä¹¦ï¼šä½¿ç”¨ç¼“å­˜çš„OCRç»“æœ');
    
    // ç¦ç”¨æ‰€æœ‰å¤„ç†æŒ‰é’®
    const reprocessOcrBtn = document.getElementById('reprocess_ocr_btn');
    const reprocessSpecBtn = document.getElementById('reprocess_spec_btn');
    const startBtn = document.getElementById('start_processing_btn');
    
    [reprocessOcrBtn, reprocessSpecBtn, startBtn].forEach(btn => {
        if (btn) {
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
        }
    });
    
    // æ˜¾ç¤ºè¿›åº¦åé¦ˆ
    const processingStatus = document.getElementById('processing_status');
    if (processingStatus) {
        processingStatus.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <div class="spinner" style="width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #9C27B0; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="color: #9C27B0;">æ­£åœ¨é‡æ–°åŒ¹é…è¯´æ˜ä¹¦...</span>
            </div>
        `;
    }
    
    // ä½¿ç”¨ DrawingReprocessManager é‡æ–°åŒ¹é…è¯´æ˜ä¹¦
    if (window.reprocessManager) {
        const newSpecification = specificationInput.value.trim();
        
        window.reprocessManager.reprocessSpecification(newSpecification)
            .then(result => {
                if (result) {
                    displayProcessingResult(result, false);
                    if (processingStatus) {
                        processingStatus.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;"><polyline points="20 6 9 17 4 12"></polyline></svg> è¯´æ˜ä¹¦åŒ¹é…å®Œæˆ';
                        processingStatus.style.color = '#9C27B0';
                    }
                    console.log('âœ… è¯´æ˜ä¹¦é‡æ–°åŒ¹é…å®Œæˆ');
                } else {
                    if (processingStatus) {
                        processingStatus.innerHTML = `
                            <div style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                                âŒ è¯´æ˜ä¹¦åŒ¹é…å¤±è´¥
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('è¯´æ˜ä¹¦åŒ¹é…å¤±è´¥:', error);
                if (processingStatus) {
                    processingStatus.innerHTML = `
                        <div style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                            âŒ å¤„ç†å¤±è´¥: ${error.message}
                        </div>
                    `;
                }
            })
            .finally(() => {
                [reprocessOcrBtn, reprocessSpecBtn, startBtn].forEach(btn => {
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                });
            });
    } else {
        alert('é‡æ–°å¤„ç†ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
        [reprocessOcrBtn, reprocessSpecBtn, startBtn].forEach(btn => {
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
    }
}

// æ˜¾ç¤ºå¤„ç†ç»“æœ - ä½¿ç”¨çœŸå®APIè¿”å›çš„æ•°æ®
function displayProcessingResult(data, isAIMode = false) {
    // ä¿å­˜reference_mapä¾›äº¤äº’å¼æ ‡æ³¨ä½¿ç”¨
    currentReferenceMap = data.reference_map || {};
    
    // ç¼“å­˜å¤„ç†ç»“æœï¼Œä»¥ä¾¿é¡µé¢åˆ·æ–°åä»ç„¶å¯ç”¨
    // ğŸ”¥ ä¿®æ”¹ï¼šæ·»åŠ æ‰‹åŠ¨ä¿å­˜æ ‡è®°
    const specificationInput = document.getElementById('specification_input');
    if (specificationInput && uploadedDrawings.length > 0) {
        const specificationText = specificationInput.value.trim();
        const cacheKey = generateProcessingCacheKey(uploadedDrawings, specificationText);
        const cacheData = {
            timestamp: Date.now(),
            data: data,
            isAIMode: isAIMode,
            specification: specificationText,
            uploadedDrawings: uploadedDrawings.map(d => ({
                name: d.name,
                type: d.type,
                size: d.size,
                dataUrl: d.dataUrl,
                rotation: d.rotation || 0
            }))
        };
        
        try {
            // ä½¿ç”¨ç»Ÿä¸€çš„ç¼“å­˜é”®æ ¼å¼
            const finalCacheKey = 'processing_cache_' + cacheKey;
            localStorage.setItem(finalCacheKey, JSON.stringify(cacheData));
            
            // ğŸ”¥ æ–°å¢ï¼šè®¾ç½®ä¿å­˜æ ‡è®°ï¼ˆè¡¨ç¤ºè¿™æ˜¯å¤„ç†åçš„ç»“æœï¼Œå¯ä»¥æ¢å¤ï¼‰
            localStorage.setItem('drawing_cache_saved', 'true');
            
            console.log('âœ… å¤„ç†ç»“æœå·²ç¼“å­˜ï¼ˆå¯æ¢å¤ï¼‰ï¼Œç¼“å­˜é”®:', finalCacheKey);
        } catch (e) {
            console.warn('ç¼“å­˜å¤±è´¥:', e);
        }
    }
    
    // æ›´æ–°å¤„ç†çŠ¶æ€
    const processingStatus = document.getElementById('processing_status');
    if (processingStatus) {
        processingStatus.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;"><polyline points="20 6 9 17 4 12"></polyline></svg> å¤„ç†å®Œæˆ';
        processingStatus.style.color = '#28a745';
    }
    
    // æ›´æ–°å¤„ç†ç»“æœç»Ÿè®¡
    const processingResult = document.getElementById('processing_result');
    if (processingResult) {
        const hasResults = data.total_numbers > 0;
        const statusColor = hasResults ? '#d4edda' : '#fff3cd';
        const borderColor = hasResults ? '#c3e6cb' : '#ffeaa7';
        const textColor = hasResults ? '#155724' : '#856404';
        const icon = hasResults ? 
            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;"><polyline points="20 6 9 17 4 12"></polyline></svg>' : 
            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
        
        let html = `
            <div style="padding: 15px; background-color: ${statusColor}; border-radius: 6px; border: 1px solid ${borderColor}; color: ${textColor};">
                <h4 style="margin: 0 0 10px 0; font-size: 16px;">${icon} ${data.message || 'å¤„ç†å®Œæˆ'}</h4>
        `;
        
        // å¦‚æœæ˜¯AIæ¨¡å¼,æ˜¾ç¤ºAIå¤„ç†ä¿¡æ¯
        if (isAIMode && data.language) {
            html += `
                <div style="margin-bottom: 10px; padding: 10px; background-color: rgba(13, 110, 253, 0.1); border-radius: 4px; border: 1px solid rgba(13, 110, 253, 0.2);">
                    <div style="font-size: 13px; color: #0d6efd; margin-bottom: 5px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <strong>AIå¤„ç†ä¿¡æ¯</strong>
                    </div>
                    <div style="font-size: 12px; color: #495057;">
                        <div>æ£€æµ‹è¯­è¨€: <strong>${data.language}</strong></div>
            `;
            
            if (data.translated_text) {
                html += `<div style="margin-top: 5px;">å·²ç¿»è¯‘ä¸ºä¸­æ–‡</div>`;
            }
            
            if (data.processing_time) {
                html += `<div style="margin-top: 5px;">å¤„ç†æ—¶é—´: <strong>${data.processing_time.toFixed(2)}ç§’</strong></div>`;
            }
            
            if (data.warning) {
                html += `<div style="margin-top: 5px; color: #856404;">âš ï¸ ${data.warning}</div>`;
            }
            
            html += `
                    </div>
                </div>
            `;
        }
        
        html += `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                    <div style="text-align: center; padding: 10px; background-color: white; border-radius: 4px;">
                        <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${data.ocr_detected_count || data.total_numbers}</div>
                        <div style="font-size: 12px; color: #6c757d;">OCRè¯†åˆ«</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background-color: white; border-radius: 4px;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.matched_count || data.total_numbers}</div>
                        <div style="font-size: 12px; color: #6c757d;">è¯´æ˜ä¹¦åŒ¹é…</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background-color: white; border-radius: 4px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${Math.round(data.avg_confidence || 0)}%</div>
                        <div style="font-size: 12px; color: #6c757d;">å¹³å‡ç½®ä¿¡åº¦</div>
                    </div>
                </div>
        `;
        
        // æ˜¾ç¤ºå»ºè®®
        if (data.suggestions && data.suggestions.length > 0) {
            html += `<div style="margin-top: 10px; padding: 10px; background-color: rgba(40, 167, 69, 0.1); border-radius: 4px; font-size: 13px;">`;
            html += `<strong><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> å»ºè®®:</strong><ul style="margin: 5px 0; padding-left: 20px;">`;
            data.suggestions.forEach(suggestion => {
                html += `<li>${suggestion}</li>`;
            });
            html += `</ul></div>`;
        }
        
        html += `</div>`;
        processingResult.innerHTML = html;
    }
    
    // æ›´æ–°æ ‡æ³¨åçš„é™„å›¾ - ä½¿ç”¨ v8.0 å¤šå›¾æŸ¥çœ‹å™¨
    const annotatedDrawingsContainer = document.getElementById('annotated_drawings_container');
    if (annotatedDrawingsContainer) {
        // ğŸ”¥ ä¼˜åŒ–ï¼šæ£€æŸ¥æ˜¯å¦æœ‰OCRè¯†åˆ«ç»“æœï¼ˆè€Œä¸ä»…ä»…æ˜¯åŒ¹é…ç»“æœï¼‰
        const hasOcrResults = data.ocr_detected_count > 0 || data.total_numbers > 0;
        const hasMatchedResults = data.matched_count > 0 || data.total_numbers > 0;
        
        // ğŸ”¥ ä¼˜åŒ–ï¼šå³ä½¿æ²¡æœ‰åŒ¹é…ç»“æœï¼Œåªè¦æœ‰OCRè¯†åˆ«ç»“æœï¼Œä¹Ÿå…è®¸æ‰“å¼€è°ƒè¯•é¢æ¿
        if (!hasOcrResults) {
            // å®Œå…¨æ²¡æœ‰OCRè¯†åˆ«ç»“æœ
            annotatedDrawingsContainer.innerHTML = `
                <div style="color: #856404; background-color: #fff3cd; padding: 20px; border-radius: 6px; border: 1px solid #ffeaa7; text-align: center;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 10px;">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 15px;">âŒ OCRæœªè¯†åˆ«åˆ°ä»»ä½•æ ‡è®°</div>
                    <div style="font-size: 14px; color: #856404; line-height: 1.8;">
                        <strong>å¯èƒ½çš„åŸå› ï¼š</strong><br>
                        â€¢ å›¾ç‰‡æ¸…æ™°åº¦ä¸è¶³ï¼Œæ ‡è®°æ¨¡ç³Šä¸æ¸…<br>
                        â€¢ å›¾ç‰‡ä¸­æ²¡æœ‰æ•°å­—æˆ–å­—æ¯æ ‡è®°<br>
                        â€¢ æ ‡è®°å­—ä½“è¿‡å°æˆ–è¿‡äºè‰ºæœ¯åŒ–<br>
                        â€¢ å›¾ç‰‡å¯¹æ¯”åº¦å¤ªä½ï¼Œæ ‡è®°éš¾ä»¥è¯†åˆ«<br><br>
                        <strong>å»ºè®®ï¼š</strong><br>
                        â€¢ ä½¿ç”¨æ›´é«˜åˆ†è¾¨ç‡çš„å›¾ç‰‡<br>
                        â€¢ ç¡®è®¤å›¾ç‰‡åŒ…å«æ¸…æ™°çš„æ•°å­—åºå·ï¼ˆå¦‚10ã€20ã€30ï¼‰<br>
                        â€¢ å°è¯•è°ƒæ•´å›¾ç‰‡äº®åº¦å’Œå¯¹æ¯”åº¦
                    </div>
                </div>
            `;
            return;
        }
        
        // å‡†å¤‡å¤šå›¾æŸ¥çœ‹å™¨æ•°æ®
        const viewerImages = [];
        data.drawings.forEach((processedDrawing, index) => {
            const originalDrawing = uploadedDrawings.find(d => d.name === processedDrawing.name);
            if (originalDrawing) {
                viewerImages.push({
                    url: originalDrawing.dataUrl,
                    title: processedDrawing.name,
                    detectedNumbers: processedDrawing.detected_numbers || [],
                    referenceMap: currentReferenceMap
                });
            }
        });
        
        // ä¿å­˜åˆ°å…¨å±€ä¾›åç»­ä½¿ç”¨
        window.currentViewerImages = viewerImages;

        // åˆ›å»ºåˆ†æä»»åŠ¡
        const taskName = `åˆ†æä»»åŠ¡_${new Date().toLocaleString()}`;
        window.currentTaskId = MultiImageViewerV8.TaskManager.createTask(taskName, viewerImages);
        console.log('Created task:', window.currentTaskId);
        
        // ğŸ”¥ ä¼˜åŒ–ï¼šæ ¹æ®åŒ¹é…æƒ…å†µæ˜¾ç¤ºä¸åŒçš„æç¤º
        let buttonText = `æ‰“å¼€å¤šå›¾æŸ¥çœ‹å™¨ (${viewerImages.length}å¼ å›¾ç‰‡)`;
        let buttonStyle = 'padding: 15px 30px; font-size: 16px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4); transition: transform 0.2s;';
        let tipHtml = '';
        
        if (!hasMatchedResults && hasOcrResults) {
            // æœ‰OCRè¯†åˆ«ä½†æ²¡æœ‰åŒ¹é…
            buttonText = `ğŸ” æŸ¥çœ‹OCRè¯†åˆ«ç»“æœ (${viewerImages.length}å¼ å›¾ç‰‡)`;
            buttonStyle = 'padding: 15px 30px; font-size: 16px; background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(255, 165, 0, 0.4); transition: transform 0.2s;';
            tipHtml = `
                <div style="margin-bottom: 15px; padding: 12px; background-color: #fff3e0; border-left: 4px solid #FFA500; border-radius: 4px; color: #856404;">
                    <strong>âš ï¸ æç¤ºï¼š</strong> OCRè¯†åˆ«åˆ° ${data.ocr_detected_count} ä¸ªæ ‡è®°ï¼Œä½†è¯´æ˜ä¹¦æœªåŒ¹é…ã€‚<br>
                    ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯æŸ¥çœ‹OCRè¯†åˆ«çš„æ‰€æœ‰æ ‡è®°ï¼ˆæ©™è‰²æ˜¾ç¤ºï¼‰ï¼Œå¹¶ä½¿ç”¨è°ƒè¯•é¢æ¿äº†è§£è¯¦æƒ…ã€‚
                </div>
            `;
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡ç¼©ç•¥å›¾å’Œæ‰“å¼€æŒ‰é’®
        let html = tipHtml + `
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="openMultiImageViewer()" style="${buttonStyle}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    ${buttonText}
                </button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
        `;
        
        viewerImages.forEach((img, index) => {
            const detectedCount = img.detectedNumbers.length;
            html += `
                <div onclick="openMultiImageViewer(${index})" style="cursor: pointer; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; background-color: white; transition: transform 0.2s, box-shadow 0.2s;" onmouseenter="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="width: 100%; height: 150px; background-color: #f8f9fa; border-radius: 4px; display: flex; justify-content: center; align-items: center; overflow: hidden; margin-bottom: 10px;">
                        <img src="${img.url}" alt="${img.title}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    <div style="font-size: 13px; font-weight: bold; color: #495057; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${img.title}</div>
                    <div style="font-size: 12px; color: #28a745;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                        </svg>
                        ${detectedCount} ä¸ªæ ‡è®°
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        // ğŸ†• æ·»åŠ é‡æ–°å¤„ç†æŒ‰é’®åŒºåŸŸ
        html += `
            <div id="reprocessSection" style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 12px; border-left: 4px solid #2196F3;">
                <h4 style="color: #2196F3; margin: 0 0 10px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    <span>å¿«é€Ÿé‡æ–°å¤„ç†</span>
                </h4>
                <p style="color: #666; font-size: 13px; margin: 0 0 15px 0; line-height: 1.6;">
                    å·²æ£€æµ‹åˆ°ç¼“å­˜æ•°æ®ï¼Œå¯ä»¥å•ç‹¬æ›´æ–°è¯´æ˜ä¹¦æˆ–å›¾ç‰‡ï¼Œæ— éœ€å®Œæ•´é‡æ–°å¤„ç†ï¼Œå¤§å¹…æå‡é€Ÿåº¦ã€‚
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="reprocessSpecBtn" onclick="handleReprocessSpecification()" style="flex: 1; min-width: 200px; padding: 12px 20px; background-color: #2196F3; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        <span>é‡æ–°å¤„ç†è¯´æ˜ä¹¦</span>
                    </button>
                    <button id="reprocessDrawingsBtn" onclick="handleReprocessDrawings()" style="flex: 1; min-width: 200px; padding: 12px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <span>é‡æ–°è¯†åˆ«å›¾ç‰‡æ ‡å·</span>
                    </button>
                </div>
                <div id="cacheInfoTip" style="margin-top: 12px; padding: 10px; background-color: #e3f2fd; border-radius: 6px; font-size: 12px; color: #1565C0; line-height: 1.6;">
                    <strong>æç¤ºï¼š</strong>
                    <span id="cacheInfoText">å·²ç¼“å­˜ ${data.ocr_detected_count || 0} ä¸ªOCRè¯†åˆ«ç»“æœå’Œ ${Object.keys(data.reference_map || {}).length} ä¸ªè¯´æ˜ä¹¦æ ‡è®°ï¼Œå¯å¿«é€Ÿé‡æ–°å¤„ç†ã€‚</span>
                </div>
            </div>
        `;
        
        annotatedDrawingsContainer.innerHTML = html;
    }
    
    // ğŸ†• åˆå§‹åŒ–é‡æ–°å¤„ç†ç®¡ç†å™¨çŠ¶æ€
    if (window.reprocessManager && uploadedDrawings.length > 0) {
        const specificationInput = document.getElementById('specification_input');
        const specificationText = specificationInput ? specificationInput.value.trim() : '';
        window.reprocessManager.updateState(data, specificationText, uploadedDrawings);
    }
}

// ğŸ†• é‡æ–°å¤„ç†è¯´æ˜ä¹¦ï¼ˆåº•éƒ¨æŒ‰é’® - è°ƒç”¨é¡¶éƒ¨æ™ºèƒ½æŒ‰é’®ï¼‰
async function handleReprocessSpecification() {
    // ç›´æ¥è°ƒç”¨é¡¶éƒ¨çš„æ™ºèƒ½é‡æ–°åŒ¹é…è¯´æ˜ä¹¦æŒ‰é’®
    const reprocessSpecBtn = document.getElementById('reprocess_spec_btn');
    if (reprocessSpecBtn) {
        reprocessSpecBtn.click();
    } else {
        // å¦‚æœé¡¶éƒ¨æŒ‰é’®ä¸å­˜åœ¨ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
        reprocessSpecification();
    }
}

// ğŸ†• é‡æ–°è¯†åˆ«å›¾ç‰‡æ ‡å·ï¼ˆåº•éƒ¨æŒ‰é’® - è°ƒç”¨é¡¶éƒ¨æ™ºèƒ½æŒ‰é’®ï¼‰
async function handleReprocessDrawings() {
    // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æ—‹è½¬æˆ–å˜åŒ–
    const hasRotation = uploadedDrawings.some(d => d.rotation && d.rotation !== 0);
    
    if (hasRotation) {
        // å¦‚æœæœ‰æ—‹è½¬ï¼Œæç¤ºç”¨æˆ·ä½¿ç”¨é¡¶éƒ¨çš„OCRæŒ‰é’®
        const useTopButton = confirm('æ£€æµ‹åˆ°å›¾ç‰‡å·²æ—‹è½¬ã€‚\n\nå»ºè®®ä½¿ç”¨é¡¶éƒ¨çš„"OCR"æŒ‰é’®é‡æ–°è¯†åˆ«ï¼ˆä¼šä½¿ç”¨å½“å‰æ—‹è½¬çŠ¶æ€ï¼‰ã€‚\n\næ˜¯å¦è·³è½¬åˆ°é¡¶éƒ¨æŒ‰é’®ï¼Ÿ');
        if (useTopButton) {
            const reprocessOcrBtn = document.getElementById('reprocess_ocr_btn');
            if (reprocessOcrBtn) {
                // æ»šåŠ¨åˆ°é¡¶éƒ¨æŒ‰é’®
                reprocessOcrBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // é«˜äº®æŒ‰é’®
                reprocessOcrBtn.style.boxShadow = '0 0 0 3px rgba(33, 150, 243, 0.5)';
                setTimeout(() => {
                    reprocessOcrBtn.style.boxShadow = '';
                }, 2000);
            }
        }
        return;
    }
    
    // å¦‚æœæ²¡æœ‰æ—‹è½¬ï¼Œç›´æ¥è°ƒç”¨é¡¶éƒ¨çš„OCRæŒ‰é’®
    const reprocessOcrBtn = document.getElementById('reprocess_ocr_btn');
    if (reprocessOcrBtn) {
        reprocessOcrBtn.click();
    } else {
        // å¦‚æœé¡¶éƒ¨æŒ‰é’®ä¸å­˜åœ¨ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
        reprocessOCR();
    }
}

// ğŸ†• æ˜¾ç¤ºToastæç¤º
function showToast(message, type = 'info') {
    // ç®€å•çš„alertå®ç°ï¼Œå¯ä»¥åç»­ä¼˜åŒ–ä¸ºæ›´ç¾è§‚çš„toast
    alert(message);
}

// æ‰“å¼€å¤šå›¾æŸ¥çœ‹å™¨
function openMultiImageViewer(startIndex = 0) {
    if (!window.currentViewerImages || window.currentViewerImages.length === 0) {
        alert('æ²¡æœ‰å¯æŸ¥çœ‹çš„å›¾ç‰‡');
        return;
    }

    const viewer = new MultiImageViewerV8(window.currentViewerImages, {
        fontSize: 22,
        highlightColor: '#FFD700'
    });
    viewer.open(startIndex, window.currentTaskId);
}

// å¯¼å‡ºå•ä¸ªé™„å›¾ï¼ˆä»å¤šå›¾æŸ¥çœ‹å™¨ä¸­ï¼‰
function exportDrawing(index) {
    if (!window.currentViewerImages || !window.currentViewerImages[index]) {
        alert('æ— æ³•å¯¼å‡ºå›¾ç‰‡');
        return;
    }
    
    // åˆ›å»ºä¸´æ—¶canvaså¯¼å‡º
    const img = window.currentViewerImages[index];
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    const image = new Image();
    image.onload = function() {
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(image, 0, 0);
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const link = document.createElement('a');
        link.download = `${img.title || 'annotated_drawing'}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    };
    image.src = img.url;
}

// æ—§çš„é™æ€ç»˜åˆ¶å‡½æ•°å·²è¢«äº¤äº’å¼ç³»ç»Ÿæ›¿ä»£

// Note: initDrawingMarker() is now called by main.js after the component loads

</script>

<!-- æ–°å¢ï¼šä¸“åˆ©é™„å›¾å±•ç¤ºå’ŒæŒ‰éœ€çˆ¬å–åŠŸèƒ½ -->
<script>
// ä¸“åˆ©é™„å›¾æ•°æ®å­˜å‚¨
let currentPatentDrawings = [];
let currentDrawingIndex = 0;
let currentPatentNumber = '';

// åˆå§‹åŒ–ä¸“åˆ©é™„å›¾åŠŸèƒ½
function initPatentDrawings() {
    // ç›‘å¬ä¸“åˆ©æœç´¢ç»“æœçš„å±•ç¤ºï¼Œæ·»åŠ é™„å›¾é¢„è§ˆ
    document.addEventListener('DOMContentLoaded', function() {
        // ç­‰å¾…ä¸“åˆ©æœç´¢ç»“æœåŠ è½½å®Œæˆåï¼Œæ·»åŠ é™„å›¾é¢„è§ˆ
        const patentResultsList = document.getElementById('patent_results_list');
        if (patentResultsList) {
            // æ·»åŠ MutationObserverï¼Œç›‘å¬ä¸“åˆ©ç»“æœåˆ—è¡¨çš„å˜åŒ–
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        // ä¸ºæ¯ä¸ªä¸“åˆ©ç»“æœæ·»åŠ é™„å›¾é¢„è§ˆ
                        const patentItems = document.querySelectorAll('.patent-result-item');
                        patentItems.forEach(function(item) {
                            if (!item.querySelector('.patent-drawings-preview')) {
                                addDrawingsPreview(item);
                            }
                        });
                    }
                });
            });
            
            observer.observe(patentResultsList, { childList: true, subtree: true });
        }
    });
}

// ä¸ºä¸“åˆ©ç»“æœé¡¹æ·»åŠ é™„å›¾é¢„è§ˆ
function addDrawingsPreview(patentItem) {
    const patentNumber = patentItem.dataset.patentNumber;
    const patentData = JSON.parse(patentItem.dataset.patentData);
    
    if (patentData.drawings && patentData.drawings.length > 0) {
        // åˆ›å»ºé™„å›¾é¢„è§ˆåŒºåŸŸ
        const drawingsPreview = document.createElement('div');
        drawingsPreview.className = 'patent-drawings-preview';
        drawingsPreview.style.marginTop = '15px';
        drawingsPreview.style.borderTop = '1px solid var(--border-color)';
        drawingsPreview.style.paddingTop = '15px';
        
        // æ·»åŠ é¦–å¼ é™„å›¾é¢„è§ˆ
        const firstDrawing = patentData.drawings[0];
        drawingsPreview.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="flex: 1;">
                    <h5>é™„å›¾é¢„è§ˆ</h5>
                    <img src="${firstDrawing}" style="max-width: 150px; max-height: 100px; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-color);" onclick="showDrawingsModal('${patentNumber}', [])">
                </div>
                <button class="small-button" onclick="viewFullDrawings('${patentNumber}')">æŸ¥çœ‹å®Œæ•´é™„å›¾</button>
            </div>
        `;
        
        // å°†é™„å›¾é¢„è§ˆæ·»åŠ åˆ°ä¸“åˆ©ç»“æœé¡¹
        patentItem.appendChild(drawingsPreview);
    }
}

// æ‰“å¼€é™„å›¾å¼¹çª—
function showDrawingsModal(patentNumber, drawings = []) {
    currentPatentNumber = patentNumber;
    currentPatentDrawings = drawings;
    currentDrawingIndex = 0;
    
    const modal = document.getElementById('drawings_modal');
    const title = document.getElementById('drawings_modal_title');
    const loading = document.getElementById('drawings_loading');
    const container = document.getElementById('drawings_container');
    
    title.textContent = `ä¸“åˆ© ${patentNumber} é™„å›¾`;
    modal.style.display = 'block';
    loading.style.display = 'block';
    container.style.display = 'none';
    
    // å¦‚æœæ²¡æœ‰æä¾›é™„å›¾æ•°æ®ï¼Œä»æœåŠ¡å™¨è·å–
    if (drawings.length === 0) {
        fetchFullDrawings(patentNumber);
    } else {
        displayDrawings();
    }
}

// å…³é—­é™„å›¾å¼¹çª—
function closeDrawingsModal() {
    const modal = document.getElementById('drawings_modal');
    modal.style.display = 'none';
    currentPatentDrawings = [];
    currentDrawingIndex = 0;
    currentPatentNumber = '';
}

// ä»æœåŠ¡å™¨è·å–å®Œæ•´é™„å›¾
function fetchFullDrawings(patentNumber) {
    const loading = document.getElementById('drawings_loading');
    loading.innerHTML = 'æ­£åœ¨è·å–å®Œæ•´é™„å›¾...';
    
    fetch('/api/patent/drawings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ patent_number: patentNumber })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            currentPatentDrawings = data.data.drawings;
            displayDrawings();
        } else {
            loading.innerHTML = `è·å–é™„å›¾å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`;
        }
    })
    .catch(error => {
        console.error('è·å–é™„å›¾å¤±è´¥:', error);
        loading.innerHTML = 'è·å–é™„å›¾å¤±è´¥ï¼Œè¯·é‡è¯•';
    });
}

// æ˜¾ç¤ºé™„å›¾
function displayDrawings() {
    const loading = document.getElementById('drawings_loading');
    const container = document.getElementById('drawings_container');
    const drawingsCount = document.getElementById('drawings_count');
    const currentDrawing = document.getElementById('current_drawing');
    const prevBtn = document.getElementById('prev_drawing');
    const nextBtn = document.getElementById('next_drawing');
    
    loading.style.display = 'none';
    container.style.display = 'block';
    
    drawingsCount.textContent = `ç¬¬ ${currentDrawingIndex + 1} å¼  / å…± ${currentPatentDrawings.length} å¼ `;
    currentDrawing.src = currentPatentDrawings[currentDrawingIndex];
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
    prevBtn.disabled = currentDrawingIndex === 0;
    nextBtn.disabled = currentDrawingIndex === currentPatentDrawings.length - 1;
}

// æ˜¾ç¤ºä¸Šä¸€å¼ é™„å›¾
function showPrevDrawing() {
    if (currentDrawingIndex > 0) {
        currentDrawingIndex--;
        displayDrawings();
    }
}

// æ˜¾ç¤ºä¸‹ä¸€å¼ é™„å›¾
function showNextDrawing() {
    if (currentDrawingIndex < currentPatentDrawings.length - 1) {
        currentDrawingIndex++;
        displayDrawings();
    }
}

// æŸ¥çœ‹å®Œæ•´é™„å›¾
function viewFullDrawings(patentNumber) {
    showDrawingsModal(patentNumber);
}

// åˆå§‹åŒ–ä¸“åˆ©é™„å›¾åŠŸèƒ½
initPatentDrawings();

// åˆå§‹åŒ– Vanta.js NET èƒŒæ™¯åŠ¨ç”»
document.addEventListener('DOMContentLoaded', function() {
    if (typeof VANTA !== 'undefined' && VANTA.NET) {
        VANTA.NET({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            // ç»¿è‰²ç³»é…è‰²
            color: 0x4ade80,           // è§å…‰ç»¿è¿çº¿é¢œè‰²
            backgroundColor: 0xf0fdf4, // ç™½è‰²æ˜äº®çš„è–„è·ç»¿èƒŒæ™¯
            // ç®€æ´é«˜æ ¼è°ƒè®¾ç½®
            points: 8.00,              // è¾ƒä½çš„ç‚¹æ•°é‡ï¼Œä¿æŒç•™ç™½
            maxDistance: 18.00,        // è¾ƒçŸ­çš„è¿çº¿è·ç¦»ï¼Œé¿å…æ‹¥æŒ¤
            spacing: 18.00,            // è¾ƒå¤§çš„é—´è·ï¼Œé¿å…ç½‘æ ¼ç»†ç¢
            showDots: true
        });
    }
});
</script>

    <!-- ä¸“åˆ©å¯¹è¯å¼¹çª— -->
    <div id="patent_chat_modal" style="display: none;">
        <div class="patent-chat-modal">
            <div class="modal-header">
                <div class="patent-info">
                    <h4 class="patent-chat-title">ä¸“åˆ©å¯¹è¯</h4>
                    <p class="patent-chat-subtitle"></p>
                </div>
                <button class="close-btn" id="patent_chat_close_btn">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="chat-actions">
                    <button id="patent_chat_clear_btn">æ¸…ç©ºå¯¹è¯</button>
                    <button id="patent_chat_export_btn">å¯¼å‡ºå¯¹è¯</button>
                </div>
                
                <div id="patent_chat_history" class="chat-history"></div>
                
                <div class="chat-input-area">
                    <textarea id="patent_chat_input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
                    <button id="patent_chat_send_btn" class="small-button">å‘é€</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å³ä¾§å¸®åŠ©æ ‡ç­¾æŒ‰é’® -->
<div class="help-tab-container">
    <a href="frontend/help.html" target="_blank" class="help-tab" title="æ‰“å¼€å¸®åŠ©æ–‡æ¡£">
        <span class="help-tab-text">å¸®åŠ©</span>
        <span class="help-tab-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        </span>
    </a>
</div>

<!-- Core modules - must load before main.js -->
    <script src="js/core/component-loader.js"></script>
    <script src="js/core/api.js"></script>
    <script src="js/modules/navigation/tab-navigation.js"></script>
    
    <!-- Initialization fix - must load before other modules -->
    <script src="js/init-fix.js"></script>
    
    <!-- DOM element references - must load before other modules -->
    <script src="js/dom.js"></script>
    
    <!-- State management - must load before chat modules -->
    <script src="js/state.js?v=20260207e"></script>
    
    <!-- Chat modules - load in dependency order -->
    <script src="js/modules/chat/chat-file-handler.js"></script>
    <script src="js/modules/chat/chat-conversation.js"></script>
    <script src="js/modules/chat/chat-message.js"></script>
    <script src="js/modules/chat/chat-persona.js"></script>
    <script src="js/modules/chat/chat-search.js"></script>
    <script src="js/modules/chat/chat-export.js"></script>
    <script src="js/modules/chat/chat-core.js"></script>
    
    <!-- Feature 2: Async Batch -->
    <script src="js/asyncBatch.js?v=20260207d"></script>
    <script src="js/modules/init/init-async-batch.js?v=20260207d"></script>
    
    <!-- Feature 3: Large Batch -->
    <!-- æ–°æ¨¡å—åŒ–æ¶æ„ -->
    <script type="module" src="js/modules/large-batch/template-manager.js?v=20260207f"></script>
    <script type="module" src="js/modules/large-batch/large-batch-core.js?v=20260207f"></script>
    <!-- æ—§ä»£ç ï¼ˆæš‚æ—¶ä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ -->
    <script src="js/largeBatch.js?v=20260207e"></script>
    <script src="js/modules/init/init-large-batch.js?v=20260207f"></script>
    
    <!-- Feature 4: Local Patent Library -->
    <script src="js/localPatentLib.js?v=20260207"></script>
    <script src="js/modules/init/init-local-patent-lib.js?v=20260207"></script>
    
    <!-- Feature 5: Claims Comparison -->
    <script src="js/claimsComparison.js?v=20260207"></script>
    <script src="js/modules/init/init-claims-comparison.js?v=20260207"></script>
    
    <!-- Feature 6: Patent Batch -->
    <script src="js/patentTemplate.js"></script>
    <script src="js/patentChat.js"></script>
    <script src="js/modules/patent-batch/field-selector.js"></script>
    <script src="js/modules/patent-batch/patent-cache.js"></script>
    <script src="js/modules/patent-batch/patent-history.js"></script>
    <script src="js/modules/patent-batch/cache-confirm-modal.js"></script>
    <script src="js/modules/init/init-patent-batch.js"></script>
    
    <!-- Feature 7: Claims Processor - Modular Version -->
    <script type="module" src="js/modules/claims/claims-file-handler.js?v=20260207c"></script>
    <script type="module" src="js/modules/claims/claims-processor.js?v=20260207c"></script>
    <script type="module" src="js/modules/claims/claims-visualization.js?v=20260207c"></script>
    <script type="module" src="js/modules/claims/claims-text-analyzer.js?v=20260207c"></script>
    <script type="module" src="js/modules/claims/claims-patent-search.js?v=20260207c"></script>
    <script type="module" src="js/modules/claims/claims-core.js?v=20260207c"></script>
    
    <!-- Feature 9: PDF OCR Reader -->
    <script src="js/modules/pdf-ocr/pdf-ocr-core.js?v=20260215c"></script>
    <script src="js/modules/pdf-ocr/pdf-ocr-viewer.js?v=20260215c"></script>
    <script src="js/modules/pdf-ocr/pdf-ocr-parser.js?v=20260215c"></script>
    <script src="js/modules/pdf-ocr/pdf-ocr-chat.js?v=20260215c"></script>
    <script src="js/modules/pdf-ocr/pdf-ocr-selection.js?v=20260215c"></script>
    <script src="js/modules/pdf-ocr/pdf-ocr-floating-toolbar.js?v=20260215c"></script>
    <script src="js/modules/pdf-ocr/pdf-ocr-floating-chat.js?v=20260215c"></script>
    <script src="js/modules/pdf-ocr/pdf-ocr-init.js?v=20260215c"></script>
    
    <!-- Other feature scripts -->
    <script src="js/patentDetailNewTab.js"></script>
    <script src="js/aiDisclaimer.js"></script>
    <script src="js/fileParserHandler.js"></script>
    
    <!-- åŠŸèƒ½å…­ï¼šå…³ç³»ä¸“åˆ©åˆ†ææ ‡ç­¾é¡µæ¨¡å— -->
    <script src="js/modules/patent-batch/tab-manager.js"></script>
    <script src="js/modules/patent-batch/relation-batch-crawler.js"></script>
    
    <!-- Main module files - extracted from main.js -->
    <script src="js/main/patent-detail-html.js"></script>
    <script src="js/main/patent-export.js"></script>
    
    <!-- Main initialization - must load last -->
    <script src="js/main.js?v=20260215a"></script>
    
    <!-- å»¶è¿ŸåŠ è½½éå…³é”®åº“ -->
    <script>
    // èµ„æºåŠ è½½ç®¡ç†å™¨
    window.ResourceLoader = {
        loadedScripts: new Map(),
        loadingPromises: new Map(),
        
        // å»¶è¿ŸåŠ è½½è„šæœ¬
        loadScript: function(src, options = {}) {
            // å¦‚æœå·²ç»åœ¨åŠ è½½ä¸­ï¼Œè¿”å›ç°æœ‰çš„ Promise
            if (this.loadingPromises.has(src)) {
                return this.loadingPromises.get(src);
            }
            
            // å¦‚æœå·²ç»åŠ è½½å®Œæˆï¼Œè¿”å› resolved Promise
            if (this.loadedScripts.has(src)) {
                return Promise.resolve();
            }
            
            const promise = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = options.async !== false;
                script.defer = options.defer === true;
                
                if (options.module) {
                    script.type = 'module';
                }
                
                script.onload = () => {
                    this.loadedScripts.set(src, true);
                    this.loadingPromises.delete(src);
                    console.log(`âœ… è„šæœ¬åŠ è½½å®Œæˆ: ${src}`);
                    resolve();
                };
                script.onerror = (err) => {
                    this.loadingPromises.delete(src);
                    console.warn(`âš ï¸ è„šæœ¬åŠ è½½å¤±è´¥: ${src}`, err);
                    reject(err);
                };
                
                document.head.appendChild(script);
            });
            
            this.loadingPromises.set(src, promise);
            return promise;
        },
        
        // æ£€æŸ¥åº“æ˜¯å¦å¯ç”¨
        isLibraryAvailable: function(libName) {
            switch(libName) {
                case 'xlsx': return typeof XLSX !== 'undefined';
                case 'html2canvas': return typeof html2canvas !== 'undefined';
                case 'jspdf': return typeof jspdf !== 'undefined';
                case 'd3': return typeof d3 !== 'undefined';
                case 'marked': return typeof marked !== 'undefined';
                case 'three': return typeof THREE !== 'undefined';
                case 'vanta': return typeof VANTA !== 'undefined';
                default: return false;
            }
        },
        
        // ç¡®ä¿åº“å·²åŠ è½½ï¼ˆå¦‚æœæœªåŠ è½½åˆ™è‡ªåŠ¨åŠ è½½ï¼‰
        ensureLibrary: async function(libName) {
            if (this.isLibraryAvailable(libName)) {
                return Promise.resolve();
            }
            
            const libUrls = {
                'xlsx': 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
                'html2canvas': 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                'jspdf': 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                'd3': 'https://d3js.org/d3.v7.min.js',
                'marked': 'https://cdn.jsdelivr.net/npm/marked/marked.min.js',
                'three': 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js',
                'vanta': 'https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js'
            };
            
            if (libUrls[libName]) {
                console.log(`ğŸ”„ æ­£åœ¨æŒ‰éœ€åŠ è½½åº“: ${libName}`);
                return this.loadScript(libUrls[libName], { async: true });
            }
            
            return Promise.reject(new Error(`æœªçŸ¥çš„åº“: ${libName}`));
        },
        
        // å»¶è¿ŸåŠ è½½éé¦–å±åº“
        loadDeferredLibraries: function() {
            const deferredLibs = [
                { src: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', name: 'html2canvas' },
                { src: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', name: 'jspdf' },
                { src: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js', name: 'xlsx' },
                { src: 'https://d3js.org/d3.v7.min.js', name: 'd3' },
                { src: 'https://cdn.jsdelivr.net/npm/marked/marked.min.js', name: 'marked' },
            ];
            
            const loadNext = (index) => {
                if (index >= deferredLibs.length) return;
                
                const lib = deferredLibs[index];
                this.loadScript(lib.src, { async: true }).then(() => {
                    setTimeout(() => loadNext(index + 1), 100);
                }).catch(err => {
                    loadNext(index + 1);
                });
            };
            
            if (document.readyState === 'complete') {
                setTimeout(() => loadNext(0), 1000);
            } else {
                window.addEventListener('load', () => {
                    setTimeout(() => loadNext(0), 1000);
                });
            }
        },
        
        // æŒ‰éœ€åŠ è½½èƒŒæ™¯åŠ¨ç”»åº“
        loadBackgroundLibs: async function() {
            try {
                // å…ˆåŠ è½½ Three.jsï¼Œç¡®ä¿å®ƒåœ¨ Vanta ä¹‹å‰åŠ è½½å®Œæˆ
                await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js', { async: false });
                console.log('âœ… Three.js åŠ è½½å®Œæˆ');
                
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ Three.js å®Œå…¨åˆå§‹åŒ–
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // ç„¶ååŠ è½½ Vanta.js
                await this.loadScript('https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js', { async: false });
                console.log('âœ… Vanta.js åŠ è½½å®Œæˆ');
                
                // å†ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ Vanta å®Œå…¨åˆå§‹åŒ–
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // åˆå§‹åŒ– Vanta.js
                if (typeof VANTA !== 'undefined' && VANTA.NET && typeof THREE !== 'undefined') {
                    VANTA.NET({
                        el: "#vanta-bg",
                        mouseControls: true,
                        touchControls: true,
                        gyroControls: false,
                        minHeight: 200.00,
                        minWidth: 200.00,
                        scale: 1.00,
                        scaleMobile: 1.00,
                        color: 0x4ade80,
                        backgroundColor: 0xf0fdf4,
                        points: 8.00,
                        maxDistance: 18.00,
                        spacing: 18.00,
                        showDots: true
                    });
                    console.log('âœ… Vanta.js åˆå§‹åŒ–æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ Vanta æˆ– Three.js æœªåŠ è½½æˆåŠŸï¼Œè·³è¿‡èƒŒæ™¯åŠ¨ç”»');
                }
            } catch (err) {
                console.warn('âš ï¸ èƒŒæ™¯åŠ¨ç”»åŠ è½½å¤±è´¥:', err);
            }
        }
    };
    
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        // å»¶è¿ŸåŠ è½½éå…³é”®åº“
        window.ResourceLoader.loadDeferredLibraries();
        
        // å»¶è¿ŸåŠ è½½èƒŒæ™¯åŠ¨ç”»åº“ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                window.ResourceLoader.loadBackgroundLibs();
            }, { timeout: 5000 });
        } else {
            setTimeout(() => {
                window.ResourceLoader.loadBackgroundLibs();
            }, 3000);
        }
    });
    </script>
    
    <!-- å³ä¸‹è§’æ‚¬æµ®äºŒç»´ç  -->
    <div id="floating-qr" class="floating-qr-container">
        <div class="floating-qr-toggle" id="qr-toggle" title="è”ç³»ä¸åé¦ˆ">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        </div>
        <div class="floating-qr-panel" id="qr-panel">
            <div class="floating-qr-header">
                <span>è”ç³»ä¸åé¦ˆ</span>
                <button class="floating-qr-close" id="qr-close">&times;</button>
            </div>
            <div class="floating-qr-content">
                <img src="/frontend/images/QRcode.jpg" alt="å…¬ä¼—å·äºŒç»´ç ">
                <p class="floating-qr-title">IPæ™ºå‹</p>
                <p class="floating-qr-desc">æ‰«ç å…³æ³¨å…¬ä¼—å·</p>
                <p class="floating-qr-tip">åé¦ˆæ„è§ Â· äº¤æµé—®é¢˜ Â· è·å–å¸®åŠ©</p>
            </div>
        </div>
    </div>
    
    <style>
        .floating-qr-container {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 9999;
            font-family: 'Noto Sans SC', sans-serif;
        }
        .floating-qr-toggle {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #22C55E, #16A34A);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            transition: all 0.3s ease;
            color: white;
        }
        .floating-qr-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
        }
        .floating-qr-panel {
            position: absolute;
            right: 60px;
            bottom: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            width: 200px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateX(20px);
            transition: all 0.3s ease;
        }
        .floating-qr-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        .floating-qr-header {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 14px;
        }
        .floating-qr-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
        }
        .floating-qr-close:hover {
            opacity: 1;
        }
        .floating-qr-content {
            padding: 15px;
            text-align: center;
        }
        .floating-qr-content img {
            width: 130px;
            height: 130px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .floating-qr-title {
            margin: 10px 0 4px;
            font-weight: 600;
            color: #166534;
            font-size: 15px;
        }
        .floating-qr-desc {
            color: #666;
            font-size: 12px;
            margin: 0;
        }
        .floating-qr-tip {
            color: #999;
            font-size: 11px;
            margin: 8px 0 0;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }
        @media (max-width: 768px) {
            .floating-qr-container {
                right: 15px;
                bottom: 15px;
            }
            .floating-qr-toggle {
                width: 44px;
                height: 44px;
            }
            .floating-qr-toggle svg {
                width: 20px;
                height: 20px;
            }
            .floating-qr-panel {
                right: 54px;
                width: 180px;
            }
            .floating-qr-content img {
                width: 110px;
                height: 110px;
            }
        }
    </style>
    
    <script>
    (function() {
        const toggle = document.getElementById('qr-toggle');
        const panel = document.getElementById('qr-panel');
        const closeBtn = document.getElementById('qr-close');
        
        toggle.addEventListener('click', function() {
            panel.classList.toggle('show');
        });
        
        closeBtn.addEventListener('click', function() {
            panel.classList.remove('show');
        });
        
        document.addEventListener('click', function(e) {
            const container = document.getElementById('floating-qr');
            if (!container.contains(e.target)) {
                panel.classList.remove('show');
            }
        });
    })();
    </script>
</body>
</html>
