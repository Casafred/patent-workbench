<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸèƒ½å…«OCRè¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .section-title .step {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 6px;
            cursor: pointer;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .result.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .result-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .result-list {
            margin-left: 20px;
            margin-top: 8px;
        }
        
        .result-list li {
            margin-bottom: 4px;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 10px;
            transition: transform 0.3s ease;
        }
        
        .rotation-controls {
            margin: 10px 0;
            display: flex;
            gap: 10px;
        }
        
        .rotation-controls button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .rotation-controls button:hover {
            background-color: #45a049;
        }
        
        .rotation-controls button:active {
            background-color: #3d8b40;
        }
        
        .debug-info {
            background: #f1f3f5;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .progress {
            margin-top: 15px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            margin-top: 8px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” åŠŸèƒ½å…«OCRè¯Šæ–­å·¥å…·</h1>
        <p class="subtitle">é€æ­¥æ£€æŸ¥æ¯ä¸ªç¯èŠ‚ï¼Œæ‰¾å‡ºè¯†åˆ«ç‡ä¸º0%çš„åŸå› </p>
        
        <!-- æ­¥éª¤1: ä¸Šä¼ å›¾ç‰‡ -->
        <div class="section">
            <div class="section-title">
                <span class="step">1</span>
                ä¸Šä¼ ä¸“åˆ©é™„å›¾
            </div>
            <div class="input-group">
                <label for="imageInput">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶:</label>
                <input type="file" id="imageInput" accept="image/*">
            </div>
            <div id="imagePreview"></div>
            <div id="imageResult"></div>
        </div>
        
        <!-- æ­¥éª¤2: è¾“å…¥è¯´æ˜ä¹¦ -->
        <div class="section">
            <div class="section-title">
                <span class="step">2</span>
                è¾“å…¥è¯´æ˜ä¹¦å†…å®¹
            </div>
            <div class="input-group">
                <label for="specInput">è¯´æ˜ä¹¦å†…å®¹:</label>
                <textarea id="specInput" rows="6" placeholder="ä¾‹å¦‚: 1ç”µåŠ¨å·¥å…·ã€2å¤–å£³ã€2Lå·¦ä¾§å¤–å£³ã€2Rå³ä¾§å¤–å£³ã€3åç›–"></textarea>
            </div>
            <button onclick="testSpecification()">æµ‹è¯•è¯´æ˜ä¹¦è§£æ</button>
            <div id="specResult"></div>
        </div>
        
        <!-- æ­¥éª¤3: è°ƒç”¨APIæµ‹è¯• -->
        <div class="section">
            <div class="section-title">
                <span class="step">3</span>
                å®Œæ•´æµç¨‹æµ‹è¯•
            </div>
            <p style="color: #666; margin-bottom: 15px;">
                ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå°†å›¾ç‰‡å’Œè¯´æ˜ä¹¦å‘é€åˆ°åç«¯APIè¿›è¡Œå®Œæ•´æµ‹è¯•
            </p>
            <button onclick="testFullProcess()" id="testBtn">å¼€å§‹å®Œæ•´æµ‹è¯•</button>
            <div class="progress" id="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">å¤„ç†ä¸­...</div>
            </div>
            <div id="apiResult"></div>
        </div>
        
        <!-- è¯Šæ–­å»ºè®® -->
        <div class="section">
            <div class="section-title">
                <span class="step">ğŸ’¡</span>
                è¯Šæ–­å»ºè®®
            </div>
            <div class="result info">
                <div class="result-title">å¦‚æœè¯†åˆ«ç‡ä¸º0%ï¼Œè¯·æ£€æŸ¥:</div>
                <ul class="result-list">
                    <li><strong>è¯´æ˜ä¹¦æ ¼å¼:</strong> ç¡®ä¿ä½¿ç”¨æ”¯æŒçš„æ ¼å¼ï¼ˆé¡¿å·ã€çœç•¥å·ã€ç‚¹å·åˆ†éš”ï¼‰</li>
                    <li><strong>å›¾ç‰‡è´¨é‡:</strong> å›¾ç‰‡è¦æ¸…æ™°ï¼Œæ•°å­—è¦æ¸…æ™°å¯è§</li>
                    <li><strong>æ•°å­—å¯¹æ¯”åº¦:</strong> æ•°å­—ä¸èƒŒæ™¯è¦æœ‰è¶³å¤Ÿçš„å¯¹æ¯”åº¦</li>
                    <li><strong>Tesseractå®‰è£…:</strong> ç¡®ä¿æœåŠ¡å™¨ä¸Šå·²å®‰è£…Tesseract OCR</li>
                    <li><strong>ç¼–å·åŒ¹é…:</strong> å›¾ç‰‡ä¸Šçš„æ•°å­—è¦ä¸è¯´æ˜ä¹¦ä¸­çš„ç¼–å·ä¸€è‡´</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        let uploadedImage = null;
        let referenceMap = {};
        
        // å›¾ç‰‡ä¸Šä¼ å¤„ç†
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                uploadedImage = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: event.target.result.split(',')[1]
                };
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `
                    <img id="previewImage" src="${event.target.result}" class="image-preview" alt="é¢„è§ˆ">
                    <div class="rotation-controls">
                        <button id="rotateLeft">â†º é€†æ—¶é’ˆæ—‹è½¬</button>
                        <button id="rotateRight">â†» é¡ºæ—¶é’ˆæ—‹è½¬</button>
                    </div>
                `;
                
                // æ˜¾ç¤ºç»“æœ
                const result = document.getElementById('imageResult');
                result.innerHTML = `
                    <div class="result success">
                        <div class="result-title">âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ</div>
                        <ul class="result-list">
                            <li>æ–‡ä»¶å: ${file.name}</li>
                            <li>æ–‡ä»¶å¤§å°: ${(file.size / 1024).toFixed(2)} KB</li>
                            <li>æ–‡ä»¶ç±»å‹: ${file.type}</li>
                        </ul>
                    </div>
                `;
                
                // æ·»åŠ æ—‹è½¬äº‹ä»¶ç›‘å¬å™¨
                document.getElementById('rotateLeft').addEventListener('click', function() {
                    rotateImage(-90);
                });
                
                document.getElementById('rotateRight').addEventListener('click', function() {
                    rotateImage(90);
                });
            };
            reader.readAsDataURL(file);
        });
        
        // æ—‹è½¬è§’åº¦
        let currentRotation = 0;
        
        // æ—‹è½¬å›¾ç‰‡å‡½æ•°
        function rotateImage(angle) {
            const preview = document.getElementById('previewImage');
            if (!preview) return;
            
            currentRotation += angle;
            
            // åº”ç”¨æ—‹è½¬
            preview.style.transform = `rotate(${currentRotation}deg)`;
            
            // é‡æ–°ç”Ÿæˆbase64æ•°æ®
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.src = preview.src;
            
            img.onload = function() {
                // è®¡ç®—æ—‹è½¬åçš„ç”»å¸ƒå°ºå¯¸
                const radians = (currentRotation * Math.PI) / 180;
                const sin = Math.abs(Math.sin(radians));
                const cos = Math.abs(Math.cos(radians));
                const newWidth = img.width * cos + img.height * sin;
                const newHeight = img.width * sin + img.height * cos;
                
                canvas.width = newWidth;
                canvas.height = newHeight;
                
                // æ—‹è½¬ç”»å¸ƒ
                ctx.translate(newWidth / 2, newHeight / 2);
                ctx.rotate(radians);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                
                // æ›´æ–°ä¸Šä¼ çš„å›¾ç‰‡æ•°æ®
                const rotatedDataUrl = canvas.toDataURL('image/png');
                uploadedImage.data = rotatedDataUrl.split(',')[1];
                uploadedImage.type = 'image/png';
                
                // æ›´æ–°é¢„è§ˆå›¾ç‰‡
                preview.src = rotatedDataUrl;
                preview.style.transform = 'rotate(0deg)';
                currentRotation = 0;
                
                // æ˜¾ç¤ºæ—‹è½¬æˆåŠŸæç¤º
                const result = document.getElementById('imageResult');
                result.innerHTML = `
                    <div class="result success">
                        <div class="result-title">âœ… å›¾ç‰‡æ—‹è½¬æˆåŠŸ</div>
                        <ul class="result-list">
                            <li>æ–‡ä»¶å: ${uploadedImage.name}</li>
                            <li>æ–‡ä»¶ç±»å‹: ${uploadedImage.type}</li>
                            <li>çŠ¶æ€: å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹å¤„ç†</li>
                        </ul>
                    </div>
                `;
            };
        }
        
        // æµ‹è¯•è¯´æ˜ä¹¦è§£æ
        function testSpecification() {
            const specText = document.getElementById('specInput').value.trim();
            const resultDiv = document.getElementById('specResult');
            
            if (!specText) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <div class="result-title">âŒ è¯·è¾“å…¥è¯´æ˜ä¹¦å†…å®¹</div>
                    </div>
                `;
                return;
            }
            
            // è§£æè¯´æ˜ä¹¦
            referenceMap = extractReferenceMarkers(specText);
            
            if (Object.keys(referenceMap).length > 0) {
                let html = `
                    <div class="result success">
                        <div class="result-title">âœ… æˆåŠŸæå–åˆ° ${Object.keys(referenceMap).length} ä¸ªé™„å›¾æ ‡è®°</div>
                        <div class="debug-info">
`;
                
                const entries = Object.entries(referenceMap);
                entries.slice(0, 20).forEach(([num, name]) => {
                    html += `${num}: ${name}\n`;
                });
                
                if (entries.length > 20) {
                    html += `... (è¿˜æœ‰ ${entries.length - 20} ä¸ª)\n`;
                }
                
                html += `
                        </div>
                    </div>
                `;
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <div class="result-title">âŒ æœªèƒ½æå–åˆ°ä»»ä½•é™„å›¾æ ‡è®°</div>
                        <p>è¯·æ£€æŸ¥è¯´æ˜ä¹¦æ ¼å¼ï¼Œæ”¯æŒçš„æ ¼å¼:</p>
                        <ul class="result-list">
                            <li>1ç”µåŠ¨å·¥å…·ã€2å¤–å£³ã€3åç›–</li>
                            <li>1â€¦ç”µåŠ¨å·¥å…·ã€2â€¦å¤–å£³ã€3â€¦åç›–</li>
                            <li>1. ç”µåŠ¨å·¥å…·<br>2. å¤–å£³<br>3. åç›–</li>
                        </ul>
                    </div>
                `;
            }
        }
        
        // æå–é™„å›¾æ ‡è®°
        function extractReferenceMarkers(specText) {
            const referenceMap = {};
            
            // æ¨¡å¼1: æ•°å­— + åˆ†éš”ç¬¦(. ã€ â€¦) + åç§°
            const pattern1 = /([0-9]+[A-Z]*)\s*[.ã€â€¦]\s*([^ã€‚ï¼›ï¼Œ,;\nã€â€¦]+)/g;
            let match;
            while ((match = pattern1.exec(specText)) !== null) {
                const number = match[1];
                const name = match[2].trim();
                if (name) {
                    referenceMap[number] = name;
                }
            }
            
            // æ¨¡å¼2: æ•°å­—(å¯èƒ½å¸¦å­—æ¯) + ä¸­æ–‡å­—ç¬¦ï¼Œç”¨é¡¿å·åˆ†éš”
            const parts = specText.split('ã€');
            parts.forEach(part => {
                part = part.trim();
                const match = part.match(/^([0-9]+[A-Z]*)(.+)$/);
                if (match) {
                    const number = match[1];
                    let name = match[2].trim();
                    // ç§»é™¤å¼€å¤´çš„çœç•¥å·ã€ç©ºæ ¼ç­‰åˆ†éš”ç¬¦
                    name = name.replace(/^[â€¦\s.ã€]+/, '');
                    if (name && !referenceMap[number]) {
                        referenceMap[number] = name;
                    }
                }
            });
            
            return referenceMap;
        }
        
        // å®Œæ•´æµç¨‹æµ‹è¯•
        async function testFullProcess() {
            const resultDiv = document.getElementById('apiResult');
            const progressDiv = document.getElementById('progress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const testBtn = document.getElementById('testBtn');
            
            // éªŒè¯è¾“å…¥
            if (!uploadedImage) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <div class="result-title">âŒ è¯·å…ˆä¸Šä¼ å›¾ç‰‡</div>
                    </div>
                `;
                return;
            }
            
            const specText = document.getElementById('specInput').value.trim();
            if (!specText) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <div class="result-title">âŒ è¯·å…ˆè¾“å…¥è¯´æ˜ä¹¦å†…å®¹</div>
                    </div>
                `;
                return;
            }
            
            // æ˜¾ç¤ºè¿›åº¦
            testBtn.disabled = true;
            progressDiv.style.display = 'block';
            progressFill.style.width = '30%';
            progressText.textContent = 'æ­£åœ¨å‘é€è¯·æ±‚...';
            
            try {
                // è°ƒç”¨API
                const response = await fetch('/api/drawing-marker/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        drawings: [uploadedImage],
                        specification: specText
                    })
                });
                
                progressFill.style.width = '70%';
                progressText.textContent = 'æ­£åœ¨å¤„ç†ç»“æœ...';
                
                const data = await response.json();
                
                progressFill.style.width = '100%';
                progressText.textContent = 'å¤„ç†å®Œæˆï¼';
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    testBtn.disabled = false;
                }, 1000);
                
                // æ˜¾ç¤ºç»“æœ
                if (data.success && data.data) {
                    displayResults(data.data);
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <div class="result-title">âŒ å¤„ç†å¤±è´¥</div>
                            <p>${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                progressDiv.style.display = 'none';
                testBtn.disabled = false;
                
                resultDiv.innerHTML = `
                    <div class="result error">
                        <div class="result-title">âŒ ç½‘ç»œé”™è¯¯</div>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(data) {
            const resultDiv = document.getElementById('apiResult');
            
            let html = '';
            
            // æ€»ä½“ç»“æœ
            if (data.total_numbers > 0) {
                html += `
                    <div class="result success">
                        <div class="result-title">âœ… å¤„ç†æˆåŠŸ</div>
                        <ul class="result-list">
                            <li>è¯†åˆ«åˆ°çš„æ•°å­—åºå·: <strong>${data.total_numbers}</strong> ä¸ª</li>
                            <li>è¯´æ˜ä¹¦ä¸­çš„æ ‡è®°: <strong>${Object.keys(data.reference_map).length}</strong> ä¸ª</li>
                            <li>åŒ¹é…ç‡: <strong>${data.match_rate}%</strong></li>
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="result error">
                        <div class="result-title">âŒ è¯†åˆ«ç‡ä¸º 0%</div>
                        <p>OCRæœªèƒ½è¯†åˆ«åˆ°ä»»ä½•æ•°å­—åºå·</p>
                    </div>
                `;
            }
            
            // è¯´æ˜ä¹¦æ ‡è®°
            html += `
                <div class="result info" style="margin-top: 15px;">
                    <div class="result-title">ğŸ“‹ è¯´æ˜ä¹¦ä¸­çš„é™„å›¾æ ‡è®° (${Object.keys(data.reference_map).length}ä¸ª)</div>
                    <div class="debug-info">
`;
            
            const entries = Object.entries(data.reference_map);
            entries.slice(0, 20).forEach(([num, name]) => {
                html += `${num}: ${name}\n`;
            });
            
            if (entries.length > 20) {
                html += `... (è¿˜æœ‰ ${entries.length - 20} ä¸ª)\n`;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // è¯†åˆ«ç»“æœè¯¦æƒ…
            if (data.drawings && data.drawings.length > 0) {
                data.drawings.forEach((drawing, index) => {
                    const detected = drawing.detected_numbers || [];
                    
                    if (detected.length > 0) {
                        html += `
                            <div class="result success" style="margin-top: 15px;">
                                <div class="result-title">ğŸ” å›¾ç‰‡ ${index + 1}: ${drawing.name} - è¯†åˆ«åˆ° ${detected.length} ä¸ªæ ‡è®°</div>
                                <div class="debug-info">
`;
                        
                        detected.forEach(item => {
                            const status = item.unmatched ? 'âŒ æœªåŒ¹é…' : 'âœ… å·²åŒ¹é…';
                            html += `${status} ${item.number}: ${item.name} (ç½®ä¿¡åº¦: ${item.confidence}%)\n`;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="result warning" style="margin-top: 15px;">
                                <div class="result-title">âš ï¸ å›¾ç‰‡ ${index + 1}: ${drawing.name}</div>
                                <p>OCRæœªèƒ½è¯†åˆ«åˆ°ä»»ä½•æ•°å­—åºå·</p>
                                <p style="margin-top: 10px;"><strong>å¯èƒ½çš„åŸå› :</strong></p>
                                <ul class="result-list">
                                    <li>å›¾ç‰‡è´¨é‡å¤ªå·®æˆ–æ¨¡ç³Š</li>
                                    <li>æ•°å­—å¤ªå°æˆ–ä¸æ¸…æ™°</li>
                                    <li>æ•°å­—ä¸èƒŒæ™¯å¯¹æ¯”åº¦ä¸è¶³</li>
                                    <li>Tesseract OCRæœªæ­£ç¡®å®‰è£…æˆ–é…ç½®</li>
                                </ul>
                            </div>
                        `;
                    }
                });
            }
            
            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>
