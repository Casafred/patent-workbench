# 功能七多语言支持 - 调试指南

## 问题描述
输入法文文本后点击"开始分析"，直接显示结果但都是错的，没有弹出AI模式提示。

## 可能的原因

### 1. 浏览器缓存问题（最可能）
浏览器缓存了旧版本的JS文件，没有加载新代码。

**解决方法：**
```
1. 按 Ctrl + Shift + Delete 打开清除浏览器数据
2. 选择"缓存的图片和文件"
3. 时间范围选择"全部时间"
4. 点击"清除数据"
5. 刷新页面（Ctrl + F5 强制刷新）
```

或者使用无痕模式测试：
```
Ctrl + Shift + N (Chrome)
Ctrl + Shift + P (Firefox)
```

### 2. 文件未正确部署
新的JS文件没有上传到服务器。

**检查方法：**
```
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 刷新页面
4. 找到 claimsProcessorIntegrated.js
5. 查看文件大小和修改时间
6. 点击文件查看内容，搜索 "detectTextLanguage"
```

### 3. JavaScript错误
代码执行时出现错误。

**检查方法：**
```
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 输入文本并点击"开始分析"
4. 查看是否有红色错误信息
```

## 快速诊断步骤

### 步骤1：检查函数是否存在
在浏览器控制台（F12 → Console）输入：
```javascript
typeof detectTextLanguage
```
应该返回：`"function"`

如果返回 `"undefined"`，说明新代码没有加载。

### 步骤2：手动测试语言检测
在控制台输入：
```javascript
detectTextLanguage("Revendication 1. Un dispositif comprenant un processeur.")
```
应该返回：`"fr"` 或 `"other"`

### 步骤3：检查analyzeClaimsText是否是async
在控制台输入：
```javascript
analyzeClaimsText.constructor.name
```
应该返回：`"AsyncFunction"`

如果返回 `"Function"`，说明还是旧版本。

### 步骤4：手动触发分析
在控制台输入：
```javascript
// 设置测试文本
document.getElementById('claims_text_input').value = "Revendication 1. Un dispositif comprenant un processeur.";

// 手动调用分析函数
analyzeClaimsText();
```
观察是否弹出AI模式提示对话框。

## 完整测试流程

### 测试1：清除缓存后测试
```
1. 清除浏览器缓存（Ctrl + Shift + Delete）
2. 关闭浏览器
3. 重新打开浏览器
4. 访问页面
5. 打开功能七文本分析
6. 输入法文文本：
   Revendication 1. Un dispositif comprenant un processeur.
7. 点击"开始分析"
8. 应该弹出对话框提示"检测到法语文本"
```

### 测试2：使用无痕模式测试
```
1. 打开无痕窗口（Ctrl + Shift + N）
2. 访问页面
3. 执行测试1的步骤5-8
```

### 测试3：直接访问测试页面
```
1. 打开 test_multilingual_claims_analysis.html
2. 找到"测试4：德文权利要求"部分
3. 点击"分析德文文本（需AI）"
4. 应该弹出确认对话框
```

## 服务器端检查

### 检查文件是否上传
```bash
# SSH到服务器
ssh user@your-server

# 检查文件修改时间
ls -lh js/claimsProcessorIntegrated.js

# 查看文件内容（搜索新函数）
grep -n "detectTextLanguage" js/claimsProcessorIntegrated.js

# 应该看到类似：
# 3050:function detectTextLanguage(text) {
```

### 重启服务
```bash
# 如果使用gunicorn
sudo systemctl restart your-service

# 或者
pkill -f gunicorn
gunicorn -c gunicorn_config.py wsgi:app
```

## 常见问题排查

### Q1: 控制台显示 "detectTextLanguage is not defined"
**原因：** 新代码没有加载
**解决：**
1. 清除浏览器缓存
2. 确认服务器上的文件已更新
3. 检查是否有JS语法错误阻止了文件加载

### Q2: 点击分析后没有任何反应
**原因：** JavaScript错误
**解决：**
1. 打开控制台查看错误信息
2. 检查是否有红色错误
3. 截图错误信息

### Q3: 弹出对话框但点击"开启AI模式"后报错
**原因：** 后端API问题
**解决：**
1. 检查ZHIPU_API_KEY是否配置
2. 查看后端日志
3. 检查网络请求（F12 → Network）

### Q4: 法文文本被识别为英文
**原因：** 语言检测逻辑问题
**解决：**
在控制台测试：
```javascript
const text = "Revendication 1. Un dispositif";
const englishChars = (text.match(/[a-zA-Z]/g) || []).length;
const totalChars = text.replace(/\s/g, '').length;
console.log('英文字符占比:', englishChars / totalChars);
// 如果 > 0.3，会被识别为英文
```

## 临时解决方案

如果清除缓存后仍然不工作，可以尝试：

### 方案1：添加版本号
修改HTML中的JS引用：
```html
<script src="js/claimsProcessorIntegrated.js?v=20260205"></script>
```

### 方案2：直接在控制台注入代码
```javascript
// 在控制台粘贴以下代码
window.detectTextLanguage = function(text) {
    if (!text) return 'other';
    const chineseChars = (text.match(/[\u4e00-\u9fff]/g) || []).length;
    const hiraganaChars = (text.match(/[\u3040-\u309f]/g) || []).length;
    const katakanaChars = (text.match(/[\u30a0-\u30ff]/g) || []).length;
    const englishChars = (text.match(/[a-zA-Z]/g) || []).length;
    const totalChars = text.replace(/\s/g, '').length;
    if (totalChars === 0) return 'other';
    const kanaRatio = (hiraganaChars + katakanaChars) / totalChars;
    if (kanaRatio > 0.05) return 'ja';
    const chineseRatio = chineseChars / totalChars;
    if (chineseRatio > 0.1) return 'zh';
    const englishRatio = englishChars / totalChars;
    if (englishRatio > 0.3) return 'en';
    if (/revendication|selon|caractérisé/i.test(text)) return 'fr';
    if (/anspruch|gemäß|dadurch/i.test(text)) return 'de';
    return 'other';
};

// 测试
console.log(detectTextLanguage("Revendication 1. Un dispositif"));
```

## 获取帮助

如果以上方法都不能解决问题，请提供以下信息：

1. **浏览器控制台截图**（F12 → Console）
2. **Network标签截图**（显示JS文件加载情况）
3. **测试结果**：
   ```javascript
   console.log('detectTextLanguage存在:', typeof detectTextLanguage);
   console.log('analyzeClaimsText类型:', analyzeClaimsText.constructor.name);
   console.log('测试法文:', detectTextLanguage("Revendication 1"));
   ```
4. **服务器文件信息**：
   ```bash
   ls -lh js/claimsProcessorIntegrated.js
   grep -c "detectTextLanguage" js/claimsProcessorIntegrated.js
   ```

---

**最可能的原因：浏览器缓存**  
**最快的解决方法：清除缓存 + 强制刷新（Ctrl + Shift + Delete，然后 Ctrl + F5）**
